<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Will you be my Valentine Andrew Getzow?</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bgA: rgba(255, 182, 193, 0.55);
      --bgB: rgba(255, 105, 180, 0.28);
      --bgC: rgba(147, 197, 253, 0.35);

      --grad0: #fff1f2;
      --grad1: #ffe4e6;
      --grad2: #fdf2f8;
      --grad3: #eff6ff;

      --card: rgba(255,255,255,0.78);
      --cardBorder: rgba(255,255,255,0.65);

      --textHi: rgba(15,23,42,0.86);
      --textLo: rgba(15,23,42,0.70);

      --sprinkleOpacity: 0.22;
      --shadow: 0 22px 70px rgba(0,0,0,0.14);
    }

    body.night-mode{
      --bgA: rgba(147, 51, 234, 0.30);
      --bgB: rgba(59, 130, 246, 0.22);
      --bgC: rgba(244, 63, 94, 0.20);

      --grad0: #070A16;
      --grad1: #0B1022;
      --grad2: #14164A;
      --grad3: #081B2E;

      --card: rgba(14, 18, 40, 0.62);
      --cardBorder: rgba(255,255,255,0.16);

      --textHi: rgba(255,255,255,0.90);
      --textLo: rgba(255,255,255,0.72);

      --sprinkleOpacity: 0.16;
      --shadow: 0 26px 90px rgba(0,0,0,0.35);
    }

    body{
      background:
        radial-gradient(900px 520px at 20% 15%, var(--bgA), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, var(--bgB), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, var(--bgC), transparent 60%),
        linear-gradient(180deg, var(--grad0) 0%, var(--grad1) 40%, var(--grad2) 70%, var(--grad3) 100%);
      overflow-x:hidden;
      color: var(--textHi);
    }

    .glass{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }

    #bg{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 0;
      overflow:hidden;
    }
    .blob{
      position:absolute;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      mix-blend-mode: multiply;
      will-change: transform;
      transform: translateZ(0);
    }
    .blob.a{
      left:-140px; top:-160px;
      background: radial-gradient(circle at 30% 30%, rgba(244,63,94,.55), rgba(255,182,193,.25) 55%, transparent 70%);
      animation: floatA 16s ease-in-out infinite;
    }
    .blob.b{
      right:-160px; top:-120px;
      background: radial-gradient(circle at 30% 30%, rgba(236,72,153,.45), rgba(147,197,253,.22) 55%, transparent 70%);
      animation: floatB 18s ease-in-out infinite;
    }
    .blob.c{
      left:10%; bottom:-210px;
      background: radial-gradient(circle at 30% 30%, rgba(147,197,253,.45), rgba(244,63,94,.18) 55%, transparent 70%);
      animation: floatC 20s ease-in-out infinite;
    }
    @keyframes floatA{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(80px,60px) scale(1.08);}}
    @keyframes floatB{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(-90px,70px) scale(1.06);}}
    @keyframes floatC{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(120px,-60px) scale(1.10);}}

    .noise{
      position:absolute; inset:0; opacity:0.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }

    /* sprinkle overlay */
    .sprinkle-grid{
      position:absolute; inset:0;
      opacity: var(--sprinkleOpacity);
      background-image:
        radial-gradient(circle at 10% 10%, rgba(255,255,255,.65) 0 2px, transparent 3px),
        radial-gradient(circle at 30% 20%, rgba(251,113,133,.7) 0 2px, transparent 3px),
        radial-gradient(circle at 60% 12%, rgba(96,165,250,.7) 0 2px, transparent 3px),
        radial-gradient(circle at 80% 26%, rgba(34,197,94,.7) 0 2px, transparent 3px),
        radial-gradient(circle at 15% 60%, rgba(245,158,11,.75) 0 2px, transparent 3px),
        radial-gradient(circle at 50% 70%, rgba(168,85,247,.7) 0 2px, transparent 3px),
        radial-gradient(circle at 72% 78%, rgba(244,63,94,.75) 0 2px, transparent 3px);
      background-size: 220px 220px;
      mix-blend-mode: overlay;
      filter: saturate(1.1);
    }

    #bigTitle{
      position: relative;
      z-index:3;
      text-align:center;
      font-weight: 900;
      letter-spacing:-0.02em;
      line-height:0.95;
      font-size: clamp(2rem, 5vw, 3.8rem);
      color:#fff;
      text-shadow: 0 4px 0 rgba(0,0,0,0.15), 0 14px 40px rgba(0,0,0,0.25);
      margin-bottom: 0.9rem;
    }
    #bigTitle span{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: .18em .42em;
      border-radius: 999px;
      background: rgba(244,63,94,0.20);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
    }

    /* Mana wrap */
    #manaWrap{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    #manaBarInner{
      width:0%;
      transition: width 160ms ease;
    }

    /* Button hearts */
    .svg-heart{
      width: 56px; height: 50px;
      border:0; background:transparent; padding:0;
      cursor:pointer;
      position:relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .svg-heart svg{width:100%;height:100%;display:block;}
    .svg-heart.yes path{fill:#ef4444;}
    .svg-heart.no path{fill:#f43f5e;}
    .svg-heart span{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      transform: translateY(-4px);
      color:#fff; font-weight:900; font-size:11px;
      letter-spacing:.7px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      pointer-events:none;
    }

    /* Big event popup */
    #eventPop{
      position:fixed; inset:0;
      z-index: 80;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    #eventPop.show{display:flex;}
    #eventPop .card{
      width:min(720px, 92vw);
      padding: 28px 26px;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.35);
      background: linear-gradient(135deg, rgba(251,113,133,0.95), rgba(236,72,153,0.95), rgba(96,165,250,0.95));
      box-shadow: 0 30px 120px rgba(0,0,0,0.35);
      text-align:center;
      transform: scale(0.92);
      opacity:0;
    }
    #eventPop.show .card{
      animation: popBoom 820ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes popBoom{
      0%{ transform: scale(0.92) translateY(16px); opacity:0;}
      35%{ transform: scale(1.03) translateY(0px); opacity:1;}
      70%{ transform: scale(1.0); opacity:1;}
      100%{ transform: scale(0.985); opacity:0;}
    }

    /* Rick icon */
    #rickIcon{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 12px 28px rgba(0,0,0,0.22);
      cursor:pointer;
      pointer-events:auto;
      user-select:none;
      background: rgba(255,255,255,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Canvas sizing */
    canvas{ touch-action:none; }

    /* TCG art */
    .artBox{
      height: 176px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid rgba(15,23,42,0.12);
      background: rgba(255,255,255,0.30);
    }
    body.night-mode .artBox{
      border-color: rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
    <div class="blob c"></div>
    <div class="noise"></div>
    <div class="sprinkle-grid"></div>
  </div>

  <div id="eventPop" aria-hidden="true">
    <div class="card">
      <div class="text-white font-black text-4xl sm:text-5xl drop-shadow-lg">üíñ EVENT STARTED üíñ</div>
      <div class="text-white/95 font-extrabold mt-3 text-base sm:text-lg">Defeat the boss. Survive the platformer. Unlock the ultimate YES.</div>
      <div class="text-white/90 font-black mt-4 text-sm">Bonus: click the little face for a surprise üòà</div>
    </div>
  </div>

  <!-- Title -->
  <div class="relative z-[3] px-4 pt-6">
    <div class="max-w-7xl mx-auto">
      <h1 id="bigTitle" class="w-full">
        <span>
          Love Beyond the Multiverse üíò
          <span id="rickIcon" title="click me">
            <!-- simple ‚Äúimage 2‚Äù style icon recreated -->
            <svg width="28" height="28" viewBox="0 0 28 28" aria-hidden="true">
              <rect x="3" y="7" width="22" height="18" rx="7" fill="#93c5fd"/>
              <rect x="8" y="4" width="12" height="7" rx="3.5" fill="#fda4af"/>
              <circle cx="11" cy="16" r="2" fill="#0f172a"/>
              <circle cx="17" cy="16" r="2" fill="#0f172a"/>
              <path d="M10 20 C12 22, 16 22, 18 20" stroke="#0f172a" stroke-width="2" stroke-linecap="round" fill="none"/>
            </svg>
          </span>
        </span>
      </h1>

      <!-- Mana / toggles -->
      <div id="manaWrap" class="rounded-2xl glass px-4 py-3 mb-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="text-sm font-extrabold" style="color: var(--textLo);">
            Affection Mana: <span id="manaPct">0</span>%
          </div>

          <div class="flex items-center gap-2">
            <button id="toggleTheme"
              class="rounded-full px-4 py-2 text-sm font-black text-white shadow active:scale-95 transition"
              style="background: linear-gradient(135deg,#fb7185,#60a5fa);">
              Toggle Day/Night
            </button>

            <button id="shinyStar"
              class="rounded-full px-4 py-2 text-sm font-black text-white shadow active:scale-95 transition"
              style="background: linear-gradient(135deg,#f59e0b,#ec4899);"
              title="click 3x">
              ‚≠ê Shiny Chance
            </button>
          </div>
        </div>

        <div class="mt-2 h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
          <div id="manaBarInner" class="h-full bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
        </div>
      </div>

      <div class="text-center font-extrabold tracking-wide drop-shadow-sm mb-5"
           style="color: rgba(255,255,255,0.92);">
        Two universes. One question.
        <span class="block text-sm font-semibold mt-1" style="color: rgba(255,255,255,0.82);">A limited-time crossover has appeared‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="relative z-[3] max-w-7xl mx-auto px-4 pb-10">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5 items-start">

      <!-- LEFT: Valentine card -->
      <aside class="lg:sticky lg:top-24">
        <div class="glass rounded-3xl p-6 text-center">
          <div class="font-black mb-3" style="color: var(--textLo);">
            Will you be my Valentine Andrew Getzow?
          </div>

          <div class="w-full h-64 rounded-xl mb-4 flex items-center justify-center"
               style="background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));">
            <div class="text-6xl">üíù</div>
          </div>

          <div class="flex gap-6 justify-center mt-2">
            <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>YES</span>
            </button>

            <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>NO</span>
            </button>
          </div>

          <p id="hint" class="text-sm mt-4 font-semibold" style="color: var(--textLo);">
            Both buttons are locked üòà Beat the boss first.
          </p>
        </div>
      </aside>

      <!-- RIGHT -->
      <main class="space-y-5">

        <!-- EVENT START -->
        <section class="glass rounded-3xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-2xl font-black" style="color: var(--textHi);">Begin the Event</div>
              <div class="text-sm font-semibold mt-1" style="color: var(--textLo);">
                Defeat the boss to unlock YES + NO. Survive the platformer for extra glory.
              </div>
            </div>
            <button id="beginEvent"
              class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);">
              Begin the Event
            </button>
          </div>
        </section>

        <!-- BOSS FIGHT -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black" style="color: var(--textLo);">üëæ Boss Fight (Love Edition)</div>
            <div class="text-xs font-black" style="color: var(--textLo);">Move: WASD/Arrows ‚Ä¢ Shoot: Space/Tap</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-xs font-black mb-1" style="color: var(--textLo);">YOU üíñ</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black mb-1" style="color: var(--textLo);">BOSS ‚òÑÔ∏è</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black mb-1" style="color: var(--textLo);">LOVE METER üíò</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
                </div>
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="bossCanvas" class="w-full block h-[420px]"></canvas>

              <div id="bossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div style="color: var(--textHi);">
                  <div class="text-3xl font-extrabold">A wild boss appeared!</div>
                  <div class="text-sm font-semibold mt-2" style="color: var(--textLo);">This one is harder now üòà</div>
                </div>
              </div>

              <button id="bossStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
                Start Boss Fight
              </button>
            </div>

            <div id="bossMsg" class="mt-3 text-sm font-semibold" style="color: var(--textLo);">
              Beat the boss to unlock YES + NO.
            </div>
          </div>
        </section>

        <!-- PLATFORMER -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black" style="color: var(--textLo);">üïπÔ∏è Platformer: Chocolate Strawberry Gauntlet</div>
            <div class="text-xs font-black" style="color: var(--textLo);">
              Move: A/D or ‚Üê/‚Üí ‚Ä¢ Jump: W/‚Üë/Space ‚Ä¢ Dash: Shift/X ‚Ä¢ Walljump: Jump on wall
            </div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3 items-center">
              <div class="sm:col-span-2 text-sm font-semibold" style="color: var(--textLo);" id="platMsg">
                Collect <b>12</b> chocolate strawberries üçìüç´ and reach the <b>love letter</b> üíå.
              </div>
              <div class="text-xs font-black text-right" style="color: var(--textLo);">
                Strawberries: <span id="platCount">0</span>/12
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="platCanvas" class="w-full block h-[360px]"></canvas>

              <div id="platOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div style="color: var(--textHi);">
                  <div class="text-3xl font-extrabold">Celeste Mode: ON</div>
                  <div class="text-sm font-semibold mt-2" style="color: var(--textLo);">
                    Spikes + moving platforms + dash + walljump. Good luck üòà
                  </div>
                </div>
              </div>

              <button id="platStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #ec4899, #60a5fa);">
                Start Platformer
              </button>
            </div>
          </div>
        </section>

        <!-- TCG CARD -->
        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3 mb-4">
            <div>
              <div class="text-2xl font-black" style="color: var(--textHi);">Custom TCG Card: ‚ÄúBe My Valentine‚Äù</div>
              <div class="text-sm font-semibold mt-1" style="color: var(--textLo);">Click reveal to toggle alt art üëÄ</div>
            </div>
            <button id="altArtBtn"
              class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #6366f1);">
              Reveal Alt Art
            </button>
          </div>

          <div class="rounded-2xl border border-white/60 bg-white/60 p-4">
            <div class="flex items-center justify-between gap-2 font-black" style="color: var(--textLo);">
              <div>Andrew Getzow, Keeper of My Heart</div>
              <div class="text-xs">Cost: üç´ ‚ù§Ô∏è üçì</div>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-[240px_1fr] gap-3">
              <div class="artBox" id="tcgArtBox"></div>
              <div class="rounded-xl bg-white/70 border border-white/60 p-4">
                <div class="text-sm font-semibold leading-relaxed" style="color: var(--textHi);">
                  <div><b>Whenever you smile</b>, create a <b>Chocolate Strawberry token</b>.</div>
                  <div class="mt-1"><b>{T}:</b> Go on a date. If it‚Äôs Valentine‚Äôs Day, also get dessert.</div>
                  <div class="mt-1"><b>Partner</b> with <b>You, Hopeless Romantic</b>.</div>
                </div>
                <div class="mt-3 text-xs italic font-bold" style="color: var(--textLo);">
                  ‚ÄúI‚Äôd dash through spikes for you.‚Äù
                </div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

<script>
/* ============================================================
   PERFORMANCE + UTIL
============================================================ */
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const rand = (a,b)=>a+Math.random()*(b-a);

function fitCanvasToCSS(canvas, ctx){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const r = canvas.getBoundingClientRect();
  canvas.width = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

/* ============================================================
   THEME (DAY/NIGHT)
============================================================ */
const toggleThemeBtn = document.getElementById("toggleTheme");
function setTheme(mode){
  document.body.classList.toggle("night-mode", mode === "night");
  localStorage.setItem("vday_theme", mode);
  themeMode = mode;
}
let themeMode = localStorage.getItem("vday_theme");
if (!themeMode){
  const hr = new Date().getHours();
  themeMode = (hr >= 19 || hr < 7) ? "night" : "day";
}
setTheme(themeMode);

toggleThemeBtn.addEventListener("click", ()=>{
  setTheme(document.body.classList.contains("night-mode") ? "day" : "night");
});

/* ============================================================
   RICKROLL ICON
============================================================ */
document.getElementById("rickIcon").addEventListener("click", ()=>{
  window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ", "_blank", "noopener,noreferrer");
});

/* ============================================================
   MANA BAR
============================================================ */
const manaBarInner = document.getElementById("manaBarInner");
const manaPctEl = document.getElementById("manaPct");
function updateMana(){
  const doc = document.documentElement;
  const scrollTop = doc.scrollTop || document.body.scrollTop;
  const max = (doc.scrollHeight - doc.clientHeight) || 1;
  const pct = clamp((scrollTop / max)*100, 0, 100);
  manaBarInner.style.width = pct.toFixed(1) + "%";
  manaPctEl.textContent = String(Math.round(pct));
}
window.addEventListener("scroll", updateMana, {passive:true});
updateMana();

/* ============================================================
   SHINY STAR
============================================================ */
const shinyStar = document.getElementById("shinyStar");
let shinyClicks = 0;
shinyStar.addEventListener("click", ()=>{
  shinyClicks++;
  if (shinyClicks >= 3){
    shinyClicks = 0;
    try{ confetti({particleCount: 120, spread: 80, origin:{y:0.2}}); }catch{}
  } else {
    shinyStar.animate([{transform:"scale(1)"},{transform:"scale(1.15)"},{transform:"scale(1)"}], {duration:240});
  }
});

/* ============================================================
   LOCK YES/NO UNTIL BOSS BEATEN
============================================================ */
const yesBtn = document.getElementById("yesBtn");
const noBtn  = document.getElementById("noBtn");
const hint = document.getElementById("hint");
let yesLocked = true, noLocked = true;

function lockBtn(btn, label){
  btn.disabled = true;
  btn.style.opacity = "0.55";
  btn.style.cursor = "not-allowed";
  const span = btn.querySelector("span");
  if (span) span.textContent = label;
}
function unlockBtn(btn, label){
  btn.disabled = false;
  btn.style.opacity = "1";
  btn.style.cursor = "pointer";
  const span = btn.querySelector("span");
  if (span) span.textContent = label;
}
function lockYesNo(){
  yesLocked = true; noLocked = true;
  lockBtn(yesBtn, "LOCKED");
  lockBtn(noBtn, "LOCKED");
}
function unlockYesNo(){
  yesLocked = false; noLocked = false;
  unlockBtn(yesBtn, "YES");
  unlockBtn(noBtn, "NO");
  hint.textContent = "Unlocked! üò≥ Now choose wisely...";
}
lockYesNo();

/* ============================================================
   NO HEART "FIGHT" (JUMPS AROUND THE SCREEN)
============================================================ */
let noFight = {
  active: false,
  raf: null,
  x: 0,
  y: 0,
  vx: 0,
  vx: 6,
  vy: 5,
  speedMul: 1,
  anger: 0,
  w: 56,
  h: 50,
  px: window.innerWidth / 2,
  py: window.innerHeight / 2
};

function measureNoBtn(){
  const r = noBtn.getBoundingClientRect();
  noFight.w = r.width || 56;
  noFight.h = r.height || 50;
}

window.addEventListener("pointermove", (e)=>{
  noFight.px = e.clientX;
  noFight.py = e.clientY;
}, {passive:true});

window.addEventListener("resize", ()=>{
  if (!noFight.active) return;
  measureNoBtn();
  noFight.x = clamp(noFight.x, 8, window.innerWidth - noFight.w - 8);
  noFight.y = clamp(noFight.y, 8, window.innerHeight - noFight.h - 8);
}, {passive:true});

window.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") stopNoHeartFight();
});

function startNoHeartFight(){
  if (noFight.active){
    // each click makes it nastier
    noFight.anger = Math.min(12, noFight.anger + 1);
    noFight.speedMul = 1 + noFight.anger * 0.12;

    // dash away from pointer
    const dx = (noFight.x + noFight.w/2) - noFight.px;
    const dy = (noFight.y + noFight.h/2) - noFight.py;
    const d = Math.max(1, Math.hypot(dx, dy));
    noFight.vx += (dx/d) * 10;
    noFight.vy += (dy/d) * 10;

    hint.textContent = `NO is fighting back üòà (anger: ${noFight.anger})`;
    try{ confetti({particleCount: 60, spread: 70, origin:{y:0.6}}); }catch{}
    return;
  }

  noFight.active = true;
  noFight.anger = 1;
  noFight.speedMul = 1.12;

  // detach from layout and roam the screen
  noBtn.style.position = "fixed";
  noBtn.style.left = "0px";
  noBtn.style.top = "0px";
  noBtn.style.zIndex = "9999";
  noBtn.style.willChange = "transform";
  noBtn.style.transition = "filter 120ms ease";
  noBtn.style.filter = "drop-shadow(0 18px 22px rgba(0,0,0,.22))";

  measureNoBtn();
  const r = noBtn.getBoundingClientRect();
  noFight.x = clamp(r.left, 8, window.innerWidth - noFight.w - 8);
  noFight.y = clamp(r.top, 8, window.innerHeight - noFight.h - 8);

  noFight.vx = (Math.random() < 0.5 ? -1 : 1) * (6 + Math.random()*2);
  noFight.vy = (Math.random() < 0.5 ? -1 : 1) * (5 + Math.random()*2);

  hint.textContent = "YOU PRESSED NO üò≥ ‚Ä¶now catch it if you can.";
  try{ confetti({particleCount: 120, spread: 90, origin:{y:0.6}}); }catch{}

  const loop = ()=>{
    if (!noFight.active) return;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    // dodge cursor/finger
    const cx = noFight.x + noFight.w/2;
    const cy = noFight.y + noFight.h/2;
    const dx = cx - noFight.px;
    const dy = cy - noFight.py;
    const dist = Math.max(1, Math.hypot(dx, dy));

    const fear = 170;
    if (dist < fear){
      const push = (1 - dist/fear) * (1.8 + noFight.anger*0.22);
      noFight.vx += (dx/dist) * push * 2.6;
      noFight.vy += (dy/dist) * push * 2.6;
    } else {
      // tiny drift
      noFight.vx += Math.sin(performance.now()/550) * 0.02;
      noFight.vy += Math.cos(performance.now()/620) * 0.02;
    }

    // clamp velocity
    const maxV = 10 + noFight.anger * 0.8;
    const sp = Math.hypot(noFight.vx, noFight.vy) || 1;
    if (sp > maxV){
      noFight.vx = (noFight.vx/sp) * maxV;
      noFight.vy = (noFight.vy/sp) * maxV;
    }

    // move
    noFight.x += noFight.vx * noFight.speedMul;
    noFight.y += noFight.vy * noFight.speedMul;

    // bounce edges
    const pad = 8;
    const maxX = vw - noFight.w - pad;
    const maxY = vh - noFight.h - pad;

    if (noFight.x < pad){ noFight.x = pad; noFight.vx *= -1; }
    if (noFight.x > maxX){ noFight.x = maxX; noFight.vx *= -1; }
    if (noFight.y < pad){ noFight.y = pad; noFight.vy *= -1; }
    if (noFight.y > maxY){ noFight.y = maxY; noFight.vy *= -1; }

    // bigger with anger (capped)
    const scale = 1 + Math.min(0.9, noFight.anger * 0.06);

    // transform only (fast)
    noBtn.style.transform = `translate3d(${noFight.x}px, ${noFight.y}px, 0) scale(${scale})`;

    // little ‚Äúglow pulse‚Äù
    if ((performance.now()/280|0) % 12 === 0){
      noBtn.style.filter = "drop-shadow(0 22px 30px rgba(244,63,94,.35))";
    } else {
      noBtn.style.filter = "drop-shadow(0 18px 22px rgba(0,0,0,.22))";
    }

    noFight.raf = requestAnimationFrame(loop);
  };

  noFight.raf = requestAnimationFrame(loop);
}

function stopNoHeartFight(){
  if (!noFight.active) return;
  noFight.active = false;
  if (noFight.raf) cancelAnimationFrame(noFight.raf);
  noFight.raf = null;

  // restore to normal layout
  noBtn.style.position = "";
  noBtn.style.left = "";
  noBtn.style.top = "";
  noBtn.style.zIndex = "";
  noBtn.style.willChange = "";
  noBtn.style.transform = "";
  noBtn.style.filter = "";
  noBtn.style.transition = "";

  hint.textContent = "NO fight stopped. (Press NO again to restart üòà)";
}

/* ============================================================
   YES / NO CLICK HANDLERS
============================================================ */
yesBtn.addEventListener("click", ()=>{
  if (yesLocked){
    hint.textContent = "YES is locked üòà Beat the boss first!";
    yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:280});
    return;
  }

  stopNoHeartFight(); // important: stop fight before hiding/moving anything

  hint.textContent = "You are now my Valentine üíû";
  noBtn.style.display = "none";
  try{ confetti({particleCount: 260, spread: 90, origin:{y:0.6}}); }catch{}
});

noBtn.addEventListener("click", ()=>{
  if (noLocked){
    hint.textContent = "NO is locked üòà Beat the boss first!";
    noBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:280});
    return;
  }
  startNoHeartFight();
});

/* ============================================================
   BIG BEGIN EVENT POPUP
============================================================ */
const eventPop = document.getElementById("eventPop");
const beginEvent = document.getElementById("beginEvent");
beginEvent.addEventListener("click", ()=>{
  eventPop.classList.add("show");
  try{ confetti({particleCount: 140, spread: 80, origin:{y:0.25}}); }catch{}
  setTimeout(()=>eventPop.classList.remove("show"), 900);

  // scroll to boss start
  bossStartBtn.scrollIntoView({behavior:"smooth", block:"center"});
  bossStartBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:520});
});

/* ============================================================
   TCG CARD ART (MAIN + ALT)
============================================================ */
const altArtBtn = document.getElementById("altArtBtn");
const tcgArtBox = document.getElementById("tcgArtBox");
let altArt = false;

// Cute ‚Äúmain art‚Äù SVG
const MAIN_ART = `data:image/svg+xml;utf8,` + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="440" viewBox="0 0 600 440">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#fb7185"/>
      <stop offset="0.5" stop-color="#ec4899"/>
      <stop offset="1" stop-color="#60a5fa"/>
    </linearGradient>
    <pattern id="spr" width="40" height="40" patternUnits="userSpaceOnUse">
      <circle cx="8" cy="10" r="2.2" fill="#fff" opacity="0.9"/>
      <circle cx="22" cy="12" r="2.2" fill="#f59e0b" opacity="0.9"/>
      <circle cx="30" cy="26" r="2.2" fill="#22c55e" opacity="0.9"/>
      <circle cx="12" cy="30" r="2.2" fill="#a78bfa" opacity="0.9"/>
    </pattern>
  </defs>
  <rect width="600" height="440" rx="28" fill="url(#g)"/>
  <rect width="600" height="440" rx="28" fill="url(#spr)" opacity="0.25"/>
  <g transform="translate(110 90)">
    <path d="M190 260 C80 170 40 110 40 65 C40 25 70 0 105 0 C130 0 152 12 170 35
             C188 12 210 0 235 0 C270 0 300 25 300 65
             C300 110 260 170 150 260 Z"
          fill="rgba(255,255,255,0.92)"/>
    <text x="150" y="150" text-anchor="middle" font-size="34" font-family="system-ui" font-weight="900" fill="#0f172a">
      Be My Valentine
    </text>
    <text x="150" y="190" text-anchor="middle" font-size="18" font-family="system-ui" font-weight="800" fill="#334155">
      (rare pull)
    </text>
  </g>
  <text x="300" y="400" text-anchor="middle" font-size="18" font-family="system-ui" font-weight="800" fill="rgba(255,255,255,0.92)">
    Chocolate ‚Ä¢ Sprinkles ‚Ä¢ Strawberries
  </text>
</svg>
`);

// Alt art SVG (Lotad cameo)
const ALT_ART = `data:image/svg+xml;utf8,` + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="440" viewBox="0 0 600 440">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#0b1022"/>
      <stop offset="1" stop-color="#14164a"/>
    </linearGradient>
    <radialGradient id="glow" cx="50%" cy="35%" r="60%">
      <stop offset="0" stop-color="#fb7185" stop-opacity="0.55"/>
      <stop offset="1" stop-color="#000" stop-opacity="0"/>
    </radialGradient>
  </defs>
  <rect width="600" height="440" rx="28" fill="url(#bg)"/>
  <rect width="600" height="440" rx="28" fill="url(#glow)"/>
  <g transform="translate(300 250)">
    <ellipse cx="0" cy="58" rx="120" ry="30" fill="rgba(0,0,0,0.35)"/>
    <!-- lilypad -->
    <path d="M-140 0 C-90 -95, 90 -95, 140 0 C110 50, 60 80, 0 85 C-60 80, -110 50, -140 0 Z"
          fill="#22c55e"/>
    <path d="M-120 0 C-80 -75, 80 -75, 120 0 C95 38, 50 60, 0 64 C-50 60, -95 38, -120 0 Z"
          fill="#16a34a" opacity="0.95"/>
    <!-- body -->
    <ellipse cx="0" cy="85" rx="70" ry="55" fill="#60a5fa"/>
    <ellipse cx="0" cy="92" rx="58" ry="42" fill="#93c5fd" opacity="0.95"/>
    <!-- beak -->
    <path d="M-78 82 C-110 72, -110 98, -78 92 Z" fill="#f59e0b"/>
    <!-- eyes -->
    <circle cx="-18" cy="72" r="10" fill="#0f172a"/>
    <circle cx="18" cy="72" r="10" fill="#0f172a"/>
    <circle cx="-21" cy="68" r="3" fill="#fff"/>
    <circle cx="15" cy="68" r="3" fill="#fff"/>
    <!-- valentine sparkle -->
    <text x="0" y="-20" text-anchor="middle" font-size="34">üíñ</text>
  </g>
  <text x="300" y="70" text-anchor="middle" font-size="28" font-family="system-ui" font-weight="900" fill="rgba(255,255,255,0.92)">
    ALT ART: Lotad of Love
  </text>
</svg>
`);

function renderTCGArt(){
  tcgArtBox.innerHTML = `
    <img alt="tcg art" src="${altArt ? ALT_ART : MAIN_ART}" style="width:100%;height:100%;object-fit:cover;display:block;"/>
  `;
}
renderTCGArt();

altArtBtn.addEventListener("click", ()=>{
  altArt = !altArt;
  renderTCGArt();
  try{ confetti({particleCount: 90, spread: 65, origin:{y:0.25}}); }catch{}
});

/* ============================================================
   INPUT (shared)
============================================================ */
const keys = new Set();
window.addEventListener("keydown", (e)=>{
  const k = e.key;
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," ","Shift","x","X"].includes(k)){
    keys.add(k);
    if (k === " " || k === "ArrowUp") e.preventDefault();
  }
});
window.addEventListener("keyup", (e)=> keys.delete(e.key));

document.addEventListener("visibilitychange", ()=>{
  // stop loops if tab hidden
  if (document.hidden){
    stopBossFight(true);
    stopPlatformer(true);
  }
});

/* ============================================================
   BOSS FIGHT (HARDER)
============================================================ */
const bossCanvas = document.getElementById("bossCanvas");
const bossCtx = bossCanvas.getContext("2d");
const bossStartBtn = document.getElementById("bossStart");
const bossOverlay = document.getElementById("bossOverlay");
const bossMsg = document.getElementById("bossMsg");
const playerHPBar = document.getElementById("playerHPBar");
const bossHPBar = document.getElementById("bossHPBar");
const loveBar = document.getElementById("loveBar");

fitCanvasToCSS(bossCanvas, bossCtx);

let bossRAF = null;
let bossLast = 0;

const bossGame = {
  running:false,
  t:0,
  player:{x:120,y:300,r:10,hp:5,maxHp:5,inv:0},
  boss:{x:320,y:90,r:30,hp:140,maxHp:140, wob:0},
  bullets:[],
  beams:[],
  particles:[],
  phase2:false,
  pattern:"spray",
  patTimer:0,
  lastShot:0
};

function setBossBars(){
  playerHPBar.style.width = (bossGame.player.hp/bossGame.player.maxHp*100)+"%";
  bossHPBar.style.width = (bossGame.boss.hp/bossGame.boss.maxHp*100)+"%";
  loveBar.style.width = ((1-bossGame.boss.hp/bossGame.boss.maxHp)*100).toFixed(1)+"%";
}

function resetBossFight(){
  bossGame.running=false;
  bossGame.t=0;
  bossGame.player.x=120; bossGame.player.y=300;
  bossGame.player.hp=bossGame.player.maxHp=5;
  bossGame.player.inv=0;

  bossGame.boss.hp=bossGame.boss.maxHp=140;
  bossGame.boss.wob=0;
  bossGame.phase2=false;
  bossGame.pattern="spray";
  bossGame.patTimer=0;
  bossGame.lastShot=0;

  bossGame.bullets.length=0;
  bossGame.beams.length=0;
  bossGame.particles.length=0;

  bossOverlay.style.opacity="1";
  bossStartBtn.style.opacity="1";
  bossStartBtn.style.pointerEvents="auto";
  bossStartBtn.textContent="Start Boss Fight";
  bossMsg.textContent="Beat the boss to unlock YES + NO.";
  setBossBars();
}

function dist2(ax,ay,bx,by){
  const dx=ax-bx, dy=ay-by;
  return dx*dx+dy*dy;
}

function spawnParticle(x,y,emoji){
  if (bossGame.particles.length > 140) bossGame.particles.splice(0, 30);
  bossGame.particles.push({x,y,vx:rand(-1.2,1.2),vy:rand(-2.0,-0.4),life:rand(24,48),emoji});
}

function bossShoot(){
  const now = performance.now();
  if (now - bossGame.lastShot < 95) return; // harder: faster fire
  bossGame.lastShot = now;
  bossGame.beams.push({x:bossGame.player.x,y:bossGame.player.y-12,vx:0,vy:-8.6,r:6});
  spawnParticle(bossGame.player.x, bossGame.player.y-10, "üíû");
}

function fireBossBullet(angle, speed, kind){
  // cap bullets for performance
  if (bossGame.bullets.length > 600) bossGame.bullets.splice(0, 120);
  bossGame.bullets.push({
    x: bossGame.boss.x,
    y: bossGame.boss.y,
    vx: Math.cos(angle)*speed,
    vy: Math.sin(angle)*speed,
    r: kind==="orb" ? 8 : kind==="mini" ? 5 : 7,
    kind
  });
}

function chooseBossPattern(){
  const hpPct = bossGame.boss.hp/bossGame.boss.maxHp;
  const pool = hpPct > 0.70 ? ["spray","ring","burst"]
            : hpPct > 0.35 ? ["spray","ring","burst","spiral"]
            : ["spray","ring","burst","spiral","dash"];
  bossGame.pattern = pool[(Math.random()*pool.length)|0];
  bossGame.patTimer = 0;
}

function updateBoss(dt){
  bossGame.t += dt;
  bossGame.patTimer += dt;

  const w = bossCanvas.getBoundingClientRect().width;
  const h = bossCanvas.getBoundingClientRect().height;

  // boss float
  bossGame.boss.wob += dt;
  bossGame.boss.x = w*0.5 + Math.cos(bossGame.boss.wob*0.95)*110;
  bossGame.boss.y = 88 + Math.sin(bossGame.boss.wob*1.2)*18;

  // player move
  let mx=0,my=0;
  if (keys.has("ArrowLeft")||keys.has("a")) mx -= 1;
  if (keys.has("ArrowRight")||keys.has("d")) mx += 1;
  if (keys.has("ArrowUp")||keys.has("w")) my -= 1;
  if (keys.has("ArrowDown")||keys.has("s")) my += 1;
  const speed = 4.8;
  bossGame.player.x = clamp(bossGame.player.x + mx*speed, 18, w-18);
  bossGame.player.y = clamp(bossGame.player.y + my*speed, 120, h-18);
  if (keys.has(" ")) bossShoot();

  // phase2 trigger
  if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp*0.55){
    bossGame.phase2 = true;
    bossMsg.textContent = "PHASE 2 üò≥ Homing hearts unlocked.";
    spawnParticle(bossGame.boss.x, bossGame.boss.y, "üñ§");
    try{ confetti({particleCount: 120, spread: 70, origin:{y:0.25}}); }catch{}
  }

  if (bossGame.patTimer > 1.55) chooseBossPattern();

  const intensity = 1 + (1 - bossGame.boss.hp/bossGame.boss.maxHp)*2.2;
  const aim = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);

  if (bossGame.pattern === "spray"){
    if ((bossGame.t*18|0) !== ((bossGame.t-dt)*18|0)){
      const spread = 0.32 + intensity*0.12;
      fireBossBullet(aim + rand(-spread,spread), 3.6 + intensity*1.2, "heart");
      if (Math.random() < 0.35) fireBossBullet(aim + rand(-spread,spread), 4.0 + intensity*1.25, "mini");
    }
  } else if (bossGame.pattern === "ring"){
    if (bossGame.patTimer < dt + 0.02){
      const n = 14 + Math.floor(intensity*5);
      for (let i=0;i<n;i++){
        fireBossBullet((Math.PI*2)*(i/n), 2.7 + intensity*1.0, "orb");
      }
      spawnParticle(bossGame.boss.x, bossGame.boss.y, "üíó");
    }
  } else if (bossGame.pattern === "burst"){
    if ((bossGame.t*4.2|0) !== ((bossGame.t-dt)*4.2|0)){
      for (let i=-2;i<=2;i++){
        fireBossBullet(aim + i*(0.12 + intensity*0.02), 4.2 + intensity*1.0, "heart");
      }
      spawnParticle(bossGame.boss.x, bossGame.boss.y, "üí•");
    }
  } else if (bossGame.pattern === "spiral"){
    if ((bossGame.t*22|0) !== ((bossGame.t-dt)*22|0)){
      fireBossBullet(bossGame.boss.wob*2.4, 2.6 + intensity*1.0, "mini");
    }
  } else if (bossGame.pattern === "dash"){
    if ((bossGame.t*6|0) !== ((bossGame.t-dt)*6|0)){
      const laneY = 140 + Math.random()*(h-190);
      bossGame.bullets.push({x:-40,y:laneY,vx: 7.0 + intensity*1.9, vy:0, r:9, kind:"dash"});
    }
  }

  if (bossGame.phase2 && (bossGame.t*5|0) !== ((bossGame.t-dt)*5|0)){
    const a = aim + rand(-0.4,0.4);
    fireBossBullet(a, 3.2 + intensity*0.8, "homing");
  }

  for (const b of bossGame.bullets){
    if (b.kind === "homing"){
      const dx = bossGame.player.x - b.x;
      const dy = bossGame.player.y - b.y;
      const d = Math.max(1, Math.sqrt(dx*dx+dy*dy));
      b.vx = b.vx*0.94 + (dx/d)*0.55;
      b.vy = b.vy*0.94 + (dy/d)*0.55;
      const sp = Math.sqrt(b.vx*b.vx + b.vy*b.vy);
      const cap = 4.6;
      if (sp > cap){ b.vx = b.vx/sp*cap; b.vy=b.vy/sp*cap; }
    }
    b.x += b.vx;
    b.y += b.vy;
  }
  bossGame.bullets = bossGame.bullets.filter(b => b.x > -80 && b.x < w+80 && b.y > -80 && b.y < h+80);

  for (const p of bossGame.beams){ p.x += p.vx; p.y += p.vy; }
  bossGame.beams = bossGame.beams.filter(p => p.y > -60);

  for (const pt of bossGame.particles){
    pt.x += pt.vx; pt.y += pt.vy;
    pt.vy += 0.05;
    pt.life -= 1;
  }
  bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

  for (let i=bossGame.beams.length-1;i>=0;i--){
    const p = bossGame.beams[i];
    if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r)**2){
      bossGame.beams.splice(i,1);
      bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
      spawnParticle(bossGame.boss.x, bossGame.boss.y, "‚ú®");
      spawnParticle(bossGame.boss.x, bossGame.boss.y, "üíò");
      setBossBars();
      if (bossGame.boss.hp <= 0) winBossFight();
    }
  }

  if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
  for (let i=bossGame.bullets.length-1;i>=0;i--){
    const b = bossGame.bullets[i];
    if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r)**2){
      bossGame.bullets.splice(i,1);
      if (bossGame.player.inv <= 0){
        bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
        bossGame.player.inv = 0.85;
        spawnParticle(bossGame.player.x, bossGame.player.y, "üí•");
        spawnParticle(bossGame.player.x, bossGame.player.y, "üíî");
        setBossBars();
        if (bossGame.player.hp <= 0) loseBossFight();
      }
    }
  }
}

function rrPath(ctx,x,y,w,h,r){
  const rr = Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y, x+w,y+h, rr);
  ctx.arcTo(x+w,y+h, x,y+h, rr);
  ctx.arcTo(x,y+h, x,y, rr);
  ctx.arcTo(x,y, x+w,y, rr);
  ctx.closePath();
}

function heartShape(ctx, x, y, s){
  ctx.beginPath();
  ctx.moveTo(x, y + s*0.25);
  ctx.bezierCurveTo(x - s, y - s*0.35, x - s*0.6, y - s, x, y - s*0.45);
  ctx.bezierCurveTo(x + s*0.6, y - s, x + s, y - s*0.35, x, y + s*0.25);
  ctx.closePath();
}

function drawBoss(){
  const w = bossCanvas.getBoundingClientRect().width;
  const h = bossCanvas.getBoundingClientRect().height;
  bossCtx.clearRect(0,0,w,h);

  const g = bossCtx.createLinearGradient(0,0,0,h);
  if (document.body.classList.contains("night-mode")){
    g.addColorStop(0,"rgba(2,6,23,0.82)");
    g.addColorStop(1,"rgba(88,28,135,0.42)");
  } else {
    g.addColorStop(0,"rgba(255,192,203,0.22)");
    g.addColorStop(1,"rgba(173,216,230,0.22)");
  }
  bossCtx.fillStyle = g;
  bossCtx.fillRect(0,0,w,h);

  bossCtx.globalAlpha = document.body.classList.contains("night-mode") ? 0.38 : 0.28;
  bossCtx.fillStyle = "#ffffff";
  for (let i=0;i<22;i++){
    const sx = (i*97)%w;
    const sy = (i*53)%(h*0.6);
    bossCtx.fillRect(sx,sy,2,2);
  }
  bossCtx.globalAlpha = 1;

  bossCtx.save();
  bossCtx.translate(bossGame.boss.x, bossGame.boss.y);

  bossCtx.globalAlpha = 0.24;
  bossCtx.beginPath();
  bossCtx.ellipse(0, 16, 58, 30, 0, 0, Math.PI*2);
  bossCtx.fillStyle = "#111827";
  bossCtx.fill();
  bossCtx.globalAlpha = 1;

  bossCtx.beginPath();
  bossCtx.ellipse(0, -4, 44, 38, 0, 0, Math.PI*2);
  bossCtx.fillStyle = "#2563eb";
  bossCtx.fill();

  bossCtx.beginPath();
  bossCtx.ellipse(0, -4, 30, 24, 0, 0, Math.PI*2);
  bossCtx.fillStyle = "#0b1020";
  bossCtx.fill();

  bossCtx.beginPath();
  bossCtx.ellipse(-10, -8, 5, 12, 0, 0, Math.PI*2);
  bossCtx.ellipse( 10, -8, 5, 12, 0, 0, Math.PI*2);
  bossCtx.fillStyle = "#fde047";
  bossCtx.fill();

  rrPath(bossCtx, -44, 6, 88, 22, 12);
  bossCtx.fillStyle = "#f8fafc";
  bossCtx.fill();

  bossCtx.restore();

  bossCtx.save();
  bossCtx.translate(bossGame.player.x, bossGame.player.y);
  const blink = bossGame.player.inv > 0 ? ((performance.now()/90|0)%2 ? 0.35 : 1) : 1;
  bossCtx.globalAlpha = blink;
  heartShape(bossCtx,0,0,14);
  bossCtx.fillStyle = "#ef4444";
  bossCtx.fill();
  bossCtx.restore();
  bossCtx.globalAlpha = 1;

  for (const b of bossGame.bullets){
    bossCtx.save();
    bossCtx.translate(b.x,b.y);
    if (b.kind === "orb"){
      bossCtx.beginPath();
      bossCtx.arc(0,0,b.r,0,Math.PI*2);
      bossCtx.fillStyle = "#a78bfa";
      bossCtx.fill();
    } else if (b.kind === "dash"){
      rrPath(bossCtx, -14, -5, 28, 10, 6);
      bossCtx.fillStyle = "#fb7185";
      bossCtx.fill();
    } else if (b.kind === "homing"){
      heartShape(bossCtx,0,0,b.r);
      bossCtx.fillStyle = "#f43f5e";
      bossCtx.globalAlpha = 0.9;
      bossCtx.fill();
      bossCtx.globalAlpha = 1;
      bossCtx.globalAlpha = 0.22;
      bossCtx.beginPath();
      bossCtx.arc(0,0,b.r+10,0,Math.PI*2);
      bossCtx.fillStyle = "#fb7185";
      bossCtx.fill();
      bossCtx.globalAlpha = 1;
    } else {
      heartShape(bossCtx,0,0,b.r);
      bossCtx.fillStyle = "#f43f5e";
      bossCtx.fill();
    }
    bossCtx.restore();
  }

  for (const p of bossGame.beams){
    bossCtx.save();
    bossCtx.translate(p.x,p.y);
    rrPath(bossCtx, -3, -12, 6, 24, 6);
    bossCtx.fillStyle = "#22c55e";
    bossCtx.globalAlpha = 0.88;
    bossCtx.fill();
    bossCtx.restore();
  }
  bossCtx.globalAlpha = 1;

  bossCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
  for (const pt of bossGame.particles){
    bossCtx.globalAlpha = clamp(pt.life/34, 0, 1);
    bossCtx.fillText(pt.emoji, pt.x, pt.y);
  }
  bossCtx.globalAlpha = 1;
}

function bossLoop(ts){
  if (!bossGame.running) return;
  if (!bossLast) bossLast = ts;
  const dt = Math.min(0.033, (ts-bossLast)/1000);
  bossLast = ts;

  updateBoss(dt);
  drawBoss();

  bossRAF = requestAnimationFrame(bossLoop);
}

function startBossFight(){
  resetBossFight();
  bossGame.running = true;
  bossOverlay.style.opacity="0";
  bossStartBtn.style.opacity="0";
  bossStartBtn.style.pointerEvents="none";

  bossMsg.textContent = "Hard mode: faster bullets + phase2 homing üòà";
  bossLast = 0;
  bossRAF = requestAnimationFrame(bossLoop);
}

function stopBossFight(silent=false){
  bossGame.running = false;
  if (bossRAF) cancelAnimationFrame(bossRAF);
  bossRAF = null;
  if (!silent){
    bossOverlay.style.opacity="1";
    bossStartBtn.style.opacity="1";
    bossStartBtn.style.pointerEvents="auto";
  }
}

function winBossFight(){
  stopBossFight(true);
  bossOverlay.style.opacity="1";
  bossOverlay.innerHTML = `
    <div class="text-white drop-shadow-lg">
      <div class="text-4xl font-extrabold">BOSS DEFEATED üíò</div>
      <div class="text-sm font-semibold mt-2">Unlocked! Now click YES üò§üíû</div>
    </div>`;
  bossStartBtn.style.opacity="1";
  bossStartBtn.style.pointerEvents="auto";
  bossStartBtn.textContent="Rematch (optional)";
  bossMsg.textContent="Unlocked! YES + NO are now available.";
  unlockYesNo();
  try{ confetti({particleCount: 220, spread: 85, origin:{y:0.6}}); }catch{}
}

function loseBossFight(){
  stopBossFight(true);
  bossOverlay.style.opacity="1";
  bossOverlay.innerHTML = `
    <div class="text-white drop-shadow-lg">
      <div class="text-4xl font-extrabold">You got bonked üí•</div>
      <div class="text-sm font-semibold mt-2">Try again‚Ä¶</div>
    </div>`;
  bossStartBtn.style.opacity="1";
  bossStartBtn.style.pointerEvents="auto";
  bossStartBtn.textContent="Try Again";
  bossMsg.textContent="Tip: strafe + shoot constantly.";
}

bossStartBtn.addEventListener("click", startBossFight);
resetBossFight();

bossCanvas.addEventListener("pointerdown", ()=>{
  if (bossGame.running) bossShoot();
});

/* ============================================================
   PLATFORMER (INSANELY HARD + LOTAD + CHOCOLATE WORLD)
============================================================ */
const platCanvas = document.getElementById("platCanvas");
const platCtx = platCanvas.getContext("2d");
const platStartBtn = document.getElementById("platStart");
const platOverlay = document.getElementById("platOverlay");
const platMsg = document.getElementById("platMsg");
const platCountEl = document.getElementById("platCount");

fitCanvasToCSS(platCanvas, platCtx);

let platRAF = null;
let platLast = 0;

const platGame = {
  running:false,
  camX:0,
  levelW: 3400,
  gravity: 0.62,
  target: 12,
  got: 0,
  deaths: 0,

  coyoteMax: 0.085,
  jumpBufMax: 0.095,
  dashTimeMax: 0.14,
  dashCooldownMax: 0.05,
  wallSlideMaxVy: 2.1,

  player:{
    x: 70, y: 120,
    w: 20, h: 22,
    vx: 0, vy: 0,
    onGround:false,
    coyote:0,
    jumpBuf:0,
    face:1,
    canDash:true,
    dashTime:0,
    dashCd:0,
    dashVx:0,
    dashVy:0,
    wallLeft:false,
    wallRight:false
  },

  platforms: [],
  movers: [],
  spikes: [],
  berries: [],
  goal: {x: 3320, y: 112, w: 26, h: 26}
};

function rectsOverlap(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

function resetPlatformer(){
  platGame.running=false;
  platGame.got=0;
  platCountEl.textContent="0";
  platMsg.innerHTML = `Collect <b>${platGame.target}</b> chocolate strawberries üçìüç´ and reach the <b>love letter</b> üíå. <span class="ml-2 font-black">Deaths: <span id="deathCount">${platGame.deaths}</span></span>`;
  platOverlay.style.opacity="1";
  platStartBtn.style.opacity="1";
  platStartBtn.style.pointerEvents="auto";
  platStartBtn.textContent="Start Platformer";

  const p = platGame.player;
  p.x=70; p.y=120; p.vx=0; p.vy=0;
  p.onGround=false; p.coyote=0; p.jumpBuf=0;
  p.face=1; p.canDash=true; p.dashTime=0; p.dashCd=0;
  p.wallLeft=false; p.wallRight=false;
  platGame.camX=0;

  platGame.platforms = [
    {x:0,y:300,w:420,h:70},
    {x:560,y:310,w:260,h:60},
    {x:980,y:310,w:240,h:60},
    {x:1350,y:315,w:260,h:55},
    {x:1820,y:310,w:260,h:60},
    {x:2300,y:310,w:250,h:60},
    {x:2720,y:310,w:220,h:60},
    {x:3050,y:315,w:350,h:55},

    {x:420,y:240,w:120,h:16},
    {x:565,y:210,w:110,h:14},
    {x:715,y:180,w:90,h:14},
    {x:835,y:150,w:80,h:14},
    {x:930,y:120,w:70,h:14},

    {x:1120,y:250,w:18,h:120},
    {x:1240,y:210,w:18,h:160},

    {x:1010,y:210,w:80,h:12},
    {x:1085,y:175,w:60,h:12},
    {x:1160,y:145,w:70,h:12},
    {x:1240,y:115,w:60,h:12},

    {x:1400,y:260,w:90,h:12},
    {x:1520,y:235,w:70,h:12},
    {x:1620,y:210,w:60,h:12},
    {x:1710,y:180,w:70,h:12},
    {x:1795,y:150,w:60,h:12},

    {x:2050,y:250,w:90,h:12},
    {x:2180,y:225,w:70,h:12},
    {x:2290,y:200,w:60,h:12},
    {x:2400,y:170,w:80,h:12},
    {x:2530,y:150,w:80,h:12},

    {x:2620,y:240,w:90,h:12},
    {x:2740,y:215,w:70,h:12},
    {x:2850,y:190,w:60,h:12},
    {x:2960,y:160,w:80,h:12},

    {x:3120,y:240,w:120,h:12},
    {x:3260,y:200,w:90,h:12},
    {x:3340,y:160,w:70,h:12},
  ];

  platGame.movers = [
    {x:520,y:265,w:70,h:12, baseX:520, baseY:265, t:0, ax:0, ay:-38, sp:1.1},
    {x:1880,y:220,w:80,h:12, baseX:1880, baseY:220, t:0, ax:0, ay:-55, sp:1.0},
    {x:2520,y:240,w:80,h:12, baseX:2520, baseY:240, t:0, ax:95, ay:0, sp:1.15},
    {x:2920,y:235,w:70,h:12, baseX:2920, baseY:235, t:0, ax:0, ay:-60, sp:1.25}
  ];

  platGame.spikes = [
    {x:300,y:288,w:120,h:12, dir:"up"},
    {x:600,y:298,w:80,h:12, dir:"up"},
    {x:1040,y:298,w:120,h:12, dir:"up"},
    {x:1138,y:260,w:12,h:90, dir:"right"},
    {x:1222,y:240,w:12,h:110, dir:"left"},
    {x:1650,y:168,w:60,h:12, dir:"up"},
    {x:2320,y:188,w:60,h:12, dir:"up"},
    {x:2760,y:298,w:80,h:12, dir:"up"},
    {x:3110,y:303,w:110,h:12, dir:"up"}
  ];

  const berries = [
    {x:150,y:250},{x:410,y:205},{x:580,y:175},{x:735,y:145},
    {x:920,y:110},{x:1040,y:185},{x:1180,y:120},{x:1460,y:235},
    {x:1715,y:160},{x:2065,y:225},{x:2535,y:145},{x:2968,y:155},
  ];
  platGame.berries = berries.map(p=>({x:p.x,y:p.y,taken:false}));
}

function killPlayer(reason="oops"){
  platGame.deaths++;
  const dc = document.getElementById("deathCount");
  if (dc) dc.textContent = String(platGame.deaths);

  const p = platGame.player;
  p.x=70; p.y=120; p.vx=0; p.vy=0;
  p.onGround=false; p.coyote=0; p.jumpBuf=0;
  p.canDash=true; p.dashTime=0; p.dashCd=0;
  p.wallLeft=false; p.wallRight=false;

  platMsg.innerHTML = `üíÄ ${reason}. Try again. Strawberries: <b>${platGame.got}/${platGame.target}</b> ‚Ä¢ Deaths: <b>${platGame.deaths}</b>`;
}

function updatePlatformer(dt){
  const w = platCanvas.getBoundingClientRect().width;
  const p = platGame.player;

  for (const m of platGame.movers){
    m.t += dt*m.sp;
    m.x = m.baseX + Math.sin(m.t)*m.ax;
    m.y = m.baseY + Math.sin(m.t)*m.ay;
  }

  const left = keys.has("ArrowLeft")||keys.has("a");
  const right= keys.has("ArrowRight")||keys.has("d");
  const jump = keys.has("ArrowUp")||keys.has("w")||keys.has(" ");
  const dash = keys.has("Shift")||keys.has("x")||keys.has("X");

  if (jump) p.jumpBuf = platGame.jumpBufMax;
  else p.jumpBuf = Math.max(0, p.jumpBuf - dt);

  p.dashCd = Math.max(0, p.dashCd - dt);

  const accel = 0.62;
  const maxV = 5.2;
  const friction = p.onGround ? 0.80 : 0.90;

  if (p.dashTime <= 0){
    if (left)  p.vx -= accel;
    if (right) p.vx += accel;
    if (!left && !right) p.vx *= friction;
    p.vx = clamp(p.vx, -maxV, maxV);
  }

  if (left) p.face = -1;
  if (right) p.face = 1;

  p.wallLeft = false;
  p.wallRight = false;

  if (dash && p.canDash && p.dashCd <= 0 && p.dashTime <= 0){
    let dx = (right?1:0) - (left?1:0);
    let dy = ( (keys.has("ArrowDown")||keys.has("s")) ? 1 : 0 ) - ( (keys.has("ArrowUp")||keys.has("w")) ? 1 : 0 );

    if (dx === 0 && dy === 0) dx = p.face;
    const mag = Math.hypot(dx,dy) || 1;
    dx/=mag; dy/=mag;

    p.dashVx = dx * 11.2;
    p.dashVy = dy * 11.2;
    p.dashTime = platGame.dashTimeMax;
    p.canDash = false;
    p.vx = p.dashVx;
    p.vy = p.dashVy;
    try{ confetti({particleCount: 16, spread: 45, origin:{y:0.7}}); }catch{}
  }

  const oldX = p.x, oldY = p.y;

  if (p.dashTime > 0){
    p.dashTime = Math.max(0, p.dashTime - dt);
    p.vx = p.dashVx;
    p.vy = p.dashVy;
    if (p.dashTime <= 0){
      p.dashCd = platGame.dashCooldownMax;
      p.vx *= 0.65;
      p.vy *= 0.45;
    }
  } else {
    p.vy += platGame.gravity;
    p.vy = clamp(p.vy, -18, 14);
  }

  p.x += p.vx;
  p.y += p.vy;

  p.x = clamp(p.x, 0, platGame.levelW - p.w);
  if (p.y > 520) killPlayer("fell into the chocolate abyss");

  const solids = platGame.platforms.concat(platGame.movers);

  p.onGround = false;

  let pb = {x:p.x,y:p.y,w:p.w,h:p.h};
  for (const s of solids){
    const sb = {x:s.x,y:s.y,w:s.w,h:s.h};
    if (rectsOverlap(pb,sb)){
      if (oldX + p.w <= s.x + 0.5){
        p.x = s.x - p.w;
        p.vx = 0;
        p.wallRight = true;
      } else if (oldX >= s.x + s.w - 0.5){
        p.x = s.x + s.w;
        p.vx = 0;
        p.wallLeft = true;
      }
      pb.x = p.x;
    }
  }

  pb = {x:p.x,y:p.y,w:p.w,h:p.h};
  for (const s of solids){
    const sb = {x:s.x,y:s.y,w:s.w,h:s.h};
    if (rectsOverlap(pb,sb)){
      if (oldY + p.h <= s.y + 0.5){
        p.y = s.y - p.h;
        p.vy = 0;
        p.onGround = true;
        p.coyote = platGame.coyoteMax;
        p.canDash = true;
      } else if (oldY >= s.y + s.h - 0.5){
        p.y = s.y + s.h;
        p.vy = 0.6;
      }
      pb.y = p.y;
    }
  }

  if (p.onGround) p.coyote = platGame.coyoteMax;
  else p.coyote = Math.max(0, p.coyote - dt);

  if (!p.onGround && p.vy > 0){
    if (p.wallLeft || p.wallRight){
      p.vy = Math.min(p.vy, platGame.wallSlideMaxVy);
    }
  }

  if (p.jumpBuf > 0){
    if (p.coyote > 0){
      p.vy = -10.3;
      p.onGround = false;
      p.coyote = 0;
      p.jumpBuf = 0;
    } else if (p.wallLeft || p.wallRight){
      p.vy = -10.5;
      p.vx = (p.wallLeft ? 1 : -1) * 6.6;
      p.face = (p.wallLeft ? 1 : -1);
      p.jumpBuf = 0;
    }
  }

  const playerRect = {x:p.x,y:p.y,w:p.w,h:p.h};
  for (const sp of platGame.spikes){
    const sb = {x:sp.x, y:sp.y, w:sp.w, h:sp.h};
    if (rectsOverlap(playerRect, sb)){
      killPlayer("spiked üíÄ");
      break;
    }
  }

  // collect berries
  for (const b of platGame.berries){
    if (b.taken) continue;
    const bb = {x:b.x-10, y:b.y-14, w:20, h:22};
    if (rectsOverlap(playerRect, bb)){
      b.taken = true;
      platGame.got++;
      platCountEl.textContent = String(platGame.got);
      platMsg.innerHTML = `Awww üçìüç´ ${platGame.got}/${platGame.target} collected! ‚Ä¢ Deaths: <b>${platGame.deaths}</b>`;
      try{ confetti({particleCount: 24, spread: 45, origin:{y:0.75}}); }catch{}
    }
  }

  if (platGame.got >= platGame.target){
    const gb = platGame.goal;
    if (rectsOverlap(playerRect, gb)){
      winPlatformer();
    }
  }

  platGame.camX = clamp(p.x + p.w/2 - w/2, 0, platGame.levelW - w);
}

function drawStrawberry(ctx, x, y, scale=1){
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(scale, scale);

  ctx.fillStyle = "#5b341f";
  rrPath(ctx, -9, -8, 18, 12, 6);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(-6, 4, 3, 0, Math.PI*2); ctx.arc(0, 5, 3, 0, Math.PI*2); ctx.arc(6, 4, 3, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = "#fb7185";
  ctx.beginPath();
  ctx.moveTo(0, 14);
  ctx.bezierCurveTo(-11, 10, -10, -2, 0, -1);
  ctx.bezierCurveTo(10, -2, 11, 10, 0, 14);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.75)";
  for (let i=0;i<9;i++){
    const sx = -6 + (i%3)*6 + (i===4?1:0);
    const sy = 2 + Math.floor(i/3)*4;
    ctx.fillRect(sx, sy, 1.5, 1.5);
  }

  ctx.fillStyle = "#22c55e";
  ctx.beginPath();
  ctx.moveTo(0,-6);
  ctx.lineTo(-7,-1);
  ctx.lineTo(0,-2);
  ctx.lineTo(7,-1);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function drawLotad(ctx, x, y, face=1){
  ctx.save();
  ctx.translate(x, y);

  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "#0f172a";
  ctx.beginPath();
  ctx.ellipse(0, 18, 16, 6, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  ctx.fillStyle = "#22c55e";
  ctx.beginPath();
  ctx.ellipse(0, -2, 18, 12, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = "#16a34a";
  ctx.beginPath();
  ctx.ellipse(0, -2, 13, 8, 0, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = document.body.classList.contains("night-mode") ? "rgba(11,16,34,0.55)" : "rgba(255,255,255,0.55)";
  ctx.beginPath();
  ctx.arc(9, -4, 6, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = "#60a5fa";
  rrPath(ctx, -10, 4, 20, 18, 10);
  ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.30)";
  rrPath(ctx, -7, 7, 14, 12, 8);
  ctx.fill();

  ctx.fillStyle = "#f59e0b";
  ctx.beginPath();
  const bx = face>0 ? -12 : 12;
  ctx.moveTo(bx, 12);
  ctx.quadraticCurveTo(bx + (face>0?-8:8), 9, bx, 7);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#0f172a";
  ctx.beginPath();
  ctx.arc(-4, 10, 2.3, 0, Math.PI*2);
  ctx.arc( 4, 10, 2.3, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.fillRect(-5.1, 9.2, 1, 1);
  ctx.fillRect( 2.9, 9.2, 1, 1);

  ctx.restore();
}

function drawPlatformer(){
  const w = platCanvas.getBoundingClientRect().width;
  const h = platCanvas.getBoundingClientRect().height;
  platCtx.clearRect(0,0,w,h);

  const night = document.body.classList.contains("night-mode");

  const g = platCtx.createLinearGradient(0,0,0,h);
  if (night){
    g.addColorStop(0,"rgba(2,6,23,0.90)");
    g.addColorStop(1,"rgba(30,41,59,0.55)");
  } else {
    g.addColorStop(0,"rgba(186,230,253,0.90)");
    g.addColorStop(1,"rgba(255,228,230,0.55)");
  }
  platCtx.fillStyle = g;
  platCtx.fillRect(0,0,w,h);

  platCtx.globalAlpha = night ? 0.45 : 0.40;
  platCtx.fillStyle = "#ffffff";
  for (let i=0;i<10;i++){
    const sx = ((i*271) % 1600) - platGame.camX*0.25;
    const sy = 50 + ((i*97) % 120);
    const x = ((sx % (w+260)) + (w+260)) - 130;
    if (night){
      platCtx.fillRect(x, sy, 2, 2);
      platCtx.fillRect(x+40, sy+20, 2, 2);
    } else {
      rrPath(platCtx, x, sy, 70, 18, 9);
      platCtx.fill();
      rrPath(platCtx, x+25, sy-10, 52, 18, 9);
      platCtx.fill();
    }
  }
  platCtx.globalAlpha = 1;

  function drawChocoRect(x,y,wid,hei){
    platCtx.fillStyle = "#5b341f";
    rrPath(platCtx, x, y, wid, hei, 8);
    platCtx.fill();

    platCtx.fillStyle = "#7c4a2a";
    rrPath(platCtx, x, y, wid, Math.min(10,hei), 8);
    platCtx.fill();

    platCtx.globalAlpha = 0.75;
    for (let i=0;i<Math.min(24, (wid/18)|0); i++){
      const sx = x + 10 + (i*17)%Math.max(14,wid-20);
      const sy = y + 4 + ((i*29)%6);
      platCtx.fillStyle = ["#fb7185","#60a5fa","#22c55e","#f59e0b","#a78bfa"][i%5];
      rrPath(platCtx, sx, sy, 6, 2, 1);
      platCtx.fill();
    }
    platCtx.globalAlpha = 1;
  }

  platCtx.save();
  platCtx.translate(-platGame.camX, 0);

  for (const s of platGame.platforms){
    drawChocoRect(s.x, s.y, s.w, s.h);
  }
  for (const m of platGame.movers){
    drawChocoRect(m.x, m.y, m.w, m.h);
    platCtx.globalAlpha = 0.18;
    platCtx.fillStyle = "#fb7185";
    rrPath(platCtx, m.x-2, m.y-2, m.w+4, m.h+4, 10);
    platCtx.fill();
    platCtx.globalAlpha = 1;
  }

  for (const sp of platGame.spikes){
    platCtx.fillStyle = night ? "rgba(244,63,94,0.85)" : "rgba(244,63,94,0.78)";
    const step = 10;
    if (sp.dir === "up"){
      for (let x=sp.x; x<sp.x+sp.w; x+=step){
        platCtx.beginPath();
        platCtx.moveTo(x, sp.y+sp.h);
        platCtx.lineTo(x+step/2, sp.y);
        platCtx.lineTo(x+step, sp.y+sp.h);
        platCtx.closePath();
        platCtx.fill();
      }
    } else if (sp.dir === "left"){
      for (let y=sp.y; y<sp.y+sp.h; y+=step){
        platCtx.beginPath();
        platCtx.moveTo(sp.x+sp.w, y);
        platCtx.lineTo(sp.x, y+step/2);
        platCtx.lineTo(sp.x+sp.w, y+step);
        platCtx.closePath();
        platCtx.fill();
      }
    } else if (sp.dir === "right"){
      for (let y=sp.y; y<sp.y+sp.h; y+=step){
        platCtx.beginPath();
        platCtx.moveTo(sp.x, y);
        platCtx.lineTo(sp.x+sp.w, y+step/2);
        platCtx.lineTo(sp.x, y+step);
        platCtx.closePath();
        platCtx.fill();
      }
    }
  }

  for (const b of platGame.berries){
    if (b.taken) continue;
    drawStrawberry(platCtx, b.x, b.y, 0.95);
  }

  const gb = platGame.goal;
  platCtx.save();
  platCtx.translate(gb.x, gb.y);
  rrPath(platCtx, 0, 0, gb.w, gb.h, 6);
  platCtx.fillStyle = "rgba(255,255,255,0.92)";
  platCtx.fill();
  platCtx.fillStyle = "#ef4444";
  heartShape(platCtx, gb.w/2, gb.h/2+1, 7);
  platCtx.fill();
  if (platGame.got < platGame.target){
    platCtx.globalAlpha = 0.85;
    platCtx.fillStyle = night ? "rgba(255,255,255,0.75)" : "rgba(15,23,42,0.65)";
    platCtx.font = "12px system-ui";
    platCtx.fillText(`${platGame.target-platGame.got} left`, -6, -8);
    platCtx.globalAlpha = 1;
  }
  platCtx.restore();

  const p = platGame.player;
  drawLotad(platCtx, p.x + p.w/2, p.y + p.h/2, p.face);

  platCtx.restore();

  platCtx.fillStyle = night ? "rgba(255,255,255,0.82)" : "rgba(15,23,42,0.70)";
  platCtx.font = "12px system-ui";
  platCtx.fillText(`Deaths: ${platGame.deaths}`, 12, 18);
}

function platLoop(ts){
  if (!platGame.running) return;
  if (!platLast) platLast = ts;
  const dt = Math.min(0.033, (ts-platLast)/1000);
  platLast = ts;

  updatePlatformer(dt);
  drawPlatformer();

  platRAF = requestAnimationFrame(platLoop);
}

function startPlatformer(){
  resetPlatformer();
  platGame.running = true;
  platOverlay.style.opacity="0";
  platStartBtn.style.opacity="0";
  platStartBtn.style.pointerEvents="none";
  platLast = 0;
  platRAF = requestAnimationFrame(platLoop);
}

function stopPlatformer(silent=false){
  platGame.running = false;
  if (platRAF) cancelAnimationFrame(platRAF);
  platRAF = null;
  if (!silent){
    platOverlay.style.opacity="1";
    platStartBtn.style.opacity="1";
    platStartBtn.style.pointerEvents="auto";
  }
}

function winPlatformer(){
  stopPlatformer(true);
  platOverlay.style.opacity="1";
  platOverlay.innerHTML = `
    <div class="text-white drop-shadow-lg">
      <div class="text-4xl font-extrabold">YOU DID IT üçìüç´üíå</div>
      <div class="text-sm font-semibold mt-2">Insane mode cleared. Respect.</div>
    </div>`;
  platStartBtn.style.opacity="1";
  platStartBtn.style.pointerEvents="auto";
  platStartBtn.textContent="Replay (why?)";
  try{ confetti({particleCount: 240, spread: 90, origin:{y:0.7}}); }catch{}
}

platStartBtn.addEventListener("click", startPlatformer);
resetPlatformer();

// touch controls (lightweight):
let touchLeft=false, touchRight=false;
let lastTap = 0;
platCanvas.addEventListener("pointerdown", (e)=>{
  if (!platGame.running) return;
  const r = platCanvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;

  const now = performance.now();
  const dbl = (now - lastTap) < 260;
  lastTap = now;

  if (dbl){
    keys.add("Shift");
    setTimeout(()=>keys.delete("Shift"), 60);
    return;
  }

  if (y > r.height*0.70){
    keys.add(" ");
    setTimeout(()=>keys.delete(" "), 60);
    return;
  }

  if (x < r.width*0.5){
    touchLeft=true; keys.add("a");
  } else {
    touchRight=true; keys.add("d");
  }
});
platCanvas.addEventListener("pointerup", ()=>{
  if (touchLeft){ keys.delete("a"); touchLeft=false; }
  if (touchRight){ keys.delete("d"); touchRight=false; }
});
platCanvas.addEventListener("pointercancel", ()=>{
  if (touchLeft){ keys.delete("a"); touchLeft=false; }
  if (touchRight){ keys.delete("d"); touchRight=false; }
});

/* ============================================================
   RESIZE (prevents ‚Äústopped working‚Äù)
============================================================ */
function safeResize(){
  try{
    fitCanvasToCSS(bossCanvas, bossCtx);
    fitCanvasToCSS(platCanvas, platCtx);
  }catch{}
}
window.addEventListener("resize", safeResize, {passive:true});
setTimeout(safeResize, 40);

/* ============================================================
   7 EASTER EGGS (one is Konami)
============================================================ */
let bossSlowUntil = 0;
let platLowGUntil = 0;
let godUntil = 0;
let sprinkleBoost = false;
let rainbowMode = false;

function nowMs(){ return performance.now(); }
function showToast(text){
  bossMsg.textContent = text;
  bossMsg.animate([{transform:"translateY(0)", opacity:1},{transform:"translateY(-6px)", opacity:0.95},{transform:"translateY(0)",opacity:1}], {duration:420});
}

function applyModifiers(){
  if (bossGame.running && nowMs() < bossSlowUntil){
    for (const b of bossGame.bullets){
      b.vx *= 0.985;
      b.vy *= 0.985;
    }
  }
  platGame.gravity = (platGame.running && nowMs() < platLowGUntil) ? 0.36 : 0.62;

  if (nowMs() < godUntil){
    if (bossGame.running) bossGame.player.inv = 0.2;
  }
}

// hook modifiers into loops
const _bossLoop = bossLoop;
bossLoop = function(ts){
  if (!bossGame.running) return;
  applyModifiers();
  _bossLoop(ts);
};
const _platLoop = platLoop;
platLoop = function(ts){
  if (!platGame.running) return;
  applyModifiers();
  _platLoop(ts);
};

// 1) KONAMI CODE
const KONAMI = ["arrowup","arrowup","arrowdown","arrowdown","arrowleft","arrowright","arrowleft","arrowright","b","a"];
let konamiBuf = [];
window.addEventListener("keydown", (e)=>{
  const k = (e.key || "").toLowerCase();
  konamiBuf.push(k);
  if (konamiBuf.length > KONAMI.length) konamiBuf.shift();
  if (KONAMI.every((v,i)=>konamiBuf[i]===v)){
    godUntil = nowMs() + 10000;
    showToast("KONAMI üí• Invincibility for 10 seconds!");
    try{ confetti({particleCount: 200, spread: 85, origin:{y:0.25}}); }catch{}
  }
});

// 2) Press B = slow boss bullets (6s)
window.addEventListener("keydown", (e)=>{
  if ((e.key||"").toLowerCase() === "b"){
    bossSlowUntil = nowMs() + 6000;
    showToast("Egg: Bullet time activated üï∞Ô∏è");
  }
});

// 3) Press L = low gravity in platformer (8s)
window.addEventListener("keydown", (e)=>{
  if ((e.key||"").toLowerCase() === "l"){
    platLowGUntil = nowMs() + 8000;
    platMsg.innerHTML = `Egg: Low gravity üåô for 8 seconds ‚Ä¢ Strawberries: <b>${platGame.got}/${platGame.target}</b> ‚Ä¢ Deaths: <b>${platGame.deaths}</b>`;
  }
});

// 4) Double-click big title = confetti storm
document.getElementById("bigTitle").addEventListener("dblclick", ()=>{
  try{ confetti({particleCount: 260, spread: 100, origin:{y:0.18}}); }catch{}
  showToast("Egg: Title sparkle unlocked ‚ú®");
});

// 5) Click mana bar = fill animation + tiny confetti
document.getElementById("manaWrap").addEventListener("click", ()=>{
  manaBarInner.style.width = "100%";
  manaPctEl.textContent = "100";
  try{ confetti({particleCount: 60, spread: 60, origin:{y:0.08}}); }catch{}
  showToast("Egg: Max mana üíØ");
});

// 6) Type ‚Äúsprinkles‚Äù anywhere toggles stronger sprinkles
let wordBuf = "";
window.addEventListener("keydown", (e)=>{
  const ch = (e.key || "");
  if (ch.length === 1 && /[a-z]/i.test(ch)){
    wordBuf = (wordBuf + ch.toLowerCase()).slice(-16);
    if (wordBuf.endsWith("sprinkles")){
      sprinkleBoost = !sprinkleBoost;
      const sg = document.querySelector(".sprinkle-grid");
      if (sg) sg.style.opacity = sprinkleBoost ? "0.36" : "";
      showToast(`Egg: Sprinkles ${sprinkleBoost ? "MAXED" : "normal"} üç©`);
    }
  }
});

// 7) Press R toggles ‚Äúrainbow mode‚Äù
window.addEventListener("keydown", (e)=>{
  if ((e.key||"").toLowerCase() === "r"){
    rainbowMode = !rainbowMode;
    document.body.style.filter = rainbowMode ? "hue-rotate(55deg) saturate(1.1)" : "";
    showToast(`Egg: Rainbow ${rainbowMode ? "ON" : "OFF"} üåà`);
  }
});
</script>
</body>
</html>
 
