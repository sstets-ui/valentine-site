<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Will you be my Valentine Andrew Getzow?</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
      /* --------- Complex dreamy background --------- */
      body {
        background:
          radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
          radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
          radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
          linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
      }

      /* Boss mode tint (kicks in when NO gets spicy) */
      body.boss-mode::before{
        content:"";
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        background:
          radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
          linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
        opacity: 0.85;
        mix-blend-mode: multiply;
      }

      /* ---------- BIG FULL-WIDTH TITLE ---------- */
      #bigTitle{
        position: relative;
        z-index: 3;
        text-align: center;
        font-weight: 900;
        letter-spacing: -0.02em;
        line-height: 0.95;
        font-size: clamp(2.2rem, 6vw, 4.6rem);
        color: #ffffff;
        text-shadow:
          0 4px 0 rgba(0,0,0,0.15),
          0 10px 28px rgba(0,0,0,0.22);
        margin-bottom: 1.25rem;
      }

      /* The pink pill behind the title */
      #bigTitle span{
        display: inline-block;
        padding: 0.18em 0.42em;
        border-radius: 999px;
        background: rgba(244, 63, 94, 0.20);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.35);
      }

      /* Make the pink pill a positioning container */
      #titlePill{
        position: relative;
        display: inline-block;
        overflow: hidden; /* keep stamp inside pill */
      }

      /* ‚úÖ Updated: LETS GOOOO off to the side (right), all black */
      #letsGo{
        position: absolute;
        right: 22px;            /* move to the side where there‚Äôs no text */
        top: 50%;
        transform: translateY(-50%) rotate(-12deg) scale(0.7);
        font-weight: 1000;
        font-size: clamp(1.15rem, 3vw, 2.1rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(0,0,0,0.92);           /* all black */
        text-shadow: 0 10px 18px rgba(0,0,0,0.18); /* soft depth */
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
        z-index: 6;
      }
      #letsGo.show{
        opacity: 1;
        animation: letsGoPop 650ms cubic-bezier(.2,.9,.2,1) forwards;
      }
      @keyframes letsGoPop{
        0%   { transform: translateY(-50%) rotate(-12deg) scale(0.55); opacity: 0; }
        60%  { transform: translateY(-50%) rotate(-12deg) scale(1.05); opacity: 1; }
        100% { transform: translateY(-50%) rotate(-12deg) scale(0.92); opacity: 1; }
      }

      #bg {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      .blob {
        position: absolute;
        width: 520px;
        height: 520px;
        border-radius: 999px;
        filter: blur(55px);
        opacity: 0.55;
        transform: translate3d(0,0,0);
        mix-blend-mode: multiply;
        will-change: transform;
      }

      .blob.a {
        left: -140px;
        top: -160px;
        background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
        animation: floatA 14s ease-in-out infinite;
      }

      .blob.b {
        right: -160px;
        top: -120px;
        background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
        animation: floatB 16s ease-in-out infinite;
      }

      .blob.c {
        left: 10%;
        bottom: -210px;
        background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
        animation: floatC 18s ease-in-out infinite;
      }

      @keyframes floatA {
        0%, 100% { transform: translate(0px, 0px) scale(1); }
        50%      { transform: translate(80px, 60px) scale(1.08); }
      }
      @keyframes floatB {
        0%, 100% { transform: translate(0px, 0px) scale(1); }
        50%      { transform: translate(-90px, 70px) scale(1.06); }
      }
      @keyframes floatC {
        0%, 100% { transform: translate(0px, 0px) scale(1); }
        50%      { transform: translate(120px, -60px) scale(1.1); }
      }

      /* Boss mode = faster blobs */
      body.boss-mode .blob.a{ animation-duration: 9s; }
      body.boss-mode .blob.b{ animation-duration: 10s; }
      body.boss-mode .blob.c{ animation-duration: 11s; }

      /* subtle noise overlay */
      .noise {
        position: absolute;
        inset: 0;
        opacity: 0.10;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
        background-size: 180px 180px;
      }

      /* pixel grid overlay */
      .pixel-grid{
        position:absolute;
        inset:0;
        opacity:.08;
        background-image:
          linear-gradient(to right, rgba(15,23,42,.25) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(15,23,42,.25) 1px, transparent 1px);
        background-size: 26px 26px;
        mix-blend-mode: overlay;
      }

      /* Nintendo-ish polish */
      .pixel-vibe { text-shadow: 0 2px 0 rgba(0,0,0,0.08); }
      .mascot-bounce { animation: mascotBounce 1.8s ease-in-out infinite; }
      @keyframes mascotBounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

      /* Power-ups layer */
      #powerups{
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }
      .powerup{
        position: absolute;
        bottom: -40px;
        opacity: 0;
        animation: puFloat linear forwards;
        filter: drop-shadow(0 6px 10px rgba(0,0,0,0.12));
        will-change: transform, opacity;
        user-select: none;
      }
      @keyframes puFloat{
        0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
        12%  { opacity: .9; }
        100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity: 0; }
      }

      /* Hearts */
      #hearts {
        position: fixed;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 2;
      }
      .heart {
        position: absolute;
        bottom: -40px;
        will-change: transform, opacity;
        animation: floatUp linear forwards;
        filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
        user-select: none;
      }
      @keyframes floatUp {
        0%   { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
        10%  { opacity: 0.85; }
        100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity: 0; }
      }

      /* Card */
      .card {
        position: relative;
        z-index: 3;
        background: rgba(255, 255, 255, 0.78);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.65);
        box-shadow: 0 22px 70px rgba(0,0,0,0.14);
      }

      #valImage {
        background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));
      }

      /* Heart buttons (SVG) */
      .svg-heart{
        width: 56px;
        height: 50px;
        border: 0;
        background: transparent;
        padding: 0;
        cursor: pointer;
        position: relative;
        filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
        transition: transform .12s ease, filter .12s ease, opacity .12s ease;
        will-change: transform;
      }

      .svg-heart svg{ width: 100%; height: 100%; display: block; }
      .svg-heart.yes path{ fill: #ef4444; }
      .svg-heart.no  path{ fill: #f43f5e; }

      .svg-heart span{
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(-4px);
        color: white;
        font-weight: 900;
        font-size: 11px;
        letter-spacing: .7px;
        text-shadow: 0 1px 2px rgba(0,0,0,.25);
        user-select: none;
        pointer-events: none;
      }

      .svg-heart:hover{
        transform: scale(1.06);
        filter: drop-shadow(0 12px 18px rgba(0,0,0,.18));
      }
      .svg-heart:active{ transform: scale(.96); }

      .svg-heart:focus-visible{
        outline: 3px solid rgba(239, 68, 68, .35);
        outline-offset: 6px;
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col items-center justify-center p-6">
    <div id="bg" aria-hidden="true">
      <div class="blob a"></div>
      <div class="blob b"></div>
      <div class="blob c"></div>
      <div class="noise"></div>
      <div class="pixel-grid"></div>
    </div>

    <div id="powerups" aria-hidden="true"></div>
    <div id="hearts" aria-hidden="true"></div>

    <h1 id="bigTitle" class="w-full px-4">
      <span id="titlePill">
        Will you be my Valentine Andrew Getzow? I have a heart-box of chocolate for you üíò
        <span id="letsGo">LETS GOOOO</span>
      </span>
    </h1>

    <!-- ===================== BOSS FIGHT PANEL (fills empty space) ===================== -->
    <div class="relative z-[3] w-full max-w-5xl mb-6 px-2">
      <div class="rounded-3xl border border-white/60 bg-white/70 backdrop-blur-xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3">
          <div class="font-extrabold text-slate-700 pixel-vibe">üëæ Boss Fight: MAGALOR</div>
          <div class="flex items-center gap-3 text-xs font-black text-slate-700/80">
            <span>Move: WASD/Arrows</span>
            <span>‚Ä¢</span>
            <span>Attack: Space / Tap</span>
          </div>
        </div>

        <div class="px-5 pb-5">
          <!-- HUD -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <div class="text-xs font-black text-slate-700/80 mb-1">YOU üíñ</div>
              <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
              </div>
            </div>

            <div>
              <div class="text-xs font-black text-slate-700/80 mb-1">MAGALOR ‚òÑÔ∏è</div>
              <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
              </div>
            </div>
          </div>

          <!-- Arena -->
          <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
            <canvas id="bossCanvas" class="w-full block h-[320px]"></canvas>

            <!-- BIG LAUGH FLASH -->
            <div id="laughFlash"
                 class="absolute top-6 left-1/2 -translate-x-1/2 text-3xl sm:text-5xl font-black tracking-widest text-slate-900 drop-shadow-lg opacity-0 pointer-events-none">
              MAGALOR: HAHAHA!
            </div>

            <div id="bossOverlay"
                 class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
              <div class="text-slate-800/80">
                <div class="text-2xl font-extrabold">Defeat MAGALOR to unlock the question üíò</div>
                <div class="text-sm font-semibold mt-2">Dodge the stars. Shoot love beams.</div>
              </div>
            </div>

            <button id="bossStart"
              class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
              Start Boss Fight
            </button>
          </div>

          <div id="bossMsg" class="mt-3 text-sm font-semibold text-slate-700/80">
            Tip: NO is locked üòà Beat MAGALOR first.
          </div>
        </div>
      </div>
    </div>
    <!-- ===================== /BOSS FIGHT PANEL ===================== -->

    <div class="card rounded-3xl p-7 max-w-md w-full text-center">
      <div class="mx-auto mb-3 w-28 mascot-bounce">
        <div class="w-24 h-24 mx-auto">
          <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
            <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
            <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
            <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
            <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
            <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
            <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
            <circle cx="50" cy="55" r="2" fill="#fff"/>
            <circle cx="74" cy="55" r="2" fill="#fff"/>
            <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
            <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                     C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                  fill="#ef4444"/>
            <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                  stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
            <rect x="92" y="70" width="8" height="30" rx="3" fill="#334155"/>
            <rect x="84" y="60" width="26" height="14" rx="6" fill="#475569"/>
            <circle cx="84" cy="67" r="6" fill="#475569"/>
          </svg>
        </div>

        <div class="mt-1 text-center font-extrabold text-sm tracking-wide text-slate-800/80 pixel-vibe">
          2/14/26
        </div>
      </div>

      <img id="valImage" class="w-full h-64 object-cover rounded-xl mb-5" alt="Valentine gif" />

      <div class="flex gap-6 justify-center mt-2">
        <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>YES</span>
        </button>

        <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>NO</span>
        </button>
      </div>

      <p id="hint" class="text-sm text-gray-600 mt-4">
        Tip: click a button. If a GIF host blocks embeds, it‚Äôll auto-try another link.
      </p>
    </div>

    <script>
      // ------------------ Moving hearts ------------------
      const heartsLayer = document.getElementById("hearts");

      function spawnHeart() {
        const el = document.createElement("span");
        el.className = "heart";
        el.textContent = Math.random() > 0.25 ? "üíó" : "üíñ";

        const left = Math.random() * 100;
        const size = 14 + Math.random() * 28;
        const dur  = 5 + Math.random() * 7;
        const drift = (Math.random() * 60 - 30) + "px";

        el.style.left = left + "vw";
        el.style.fontSize = size + "px";
        el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
        el.style.animationDuration = dur + "s";
        el.style.setProperty("--drift", drift);

        heartsLayer.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000 + 100);
      }

      for (let i = 0; i < 14; i++) spawnHeart();
      setInterval(spawnHeart, 220);

      // ------------------ Power-ups particles ------------------
      const powerupsLayer = document.getElementById("powerups");

      function spawnPowerup(){
        const el = document.createElement("span");
        el.className = "powerup";
        const items = ["‚≠ê","ü™ô","‚ú®","üíñ","üéÆ"];
        el.textContent = items[Math.floor(Math.random() * items.length)];

        const left = Math.random() * 100;
        const size = 14 + Math.random() * 22;
        const dur  = 6 + Math.random() * 8;
        const drift = (Math.random() * 80 - 40) + "px";
        const rot = (Math.random() * 160 - 80) + "deg";

        el.style.left = left + "vw";
        el.style.fontSize = size + "px";
        el.style.animationDuration = dur + "s";
        el.style.setProperty("--drift", drift);
        el.style.setProperty("--rot", rot);

        powerupsLayer.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000 + 200);
      }

      for (let i = 0; i < 10; i++) spawnPowerup();
      setInterval(spawnPowerup, 600);

      // ------------------ GIF loader ------------------
      const valImage = document.getElementById("valImage");
      const hint = document.getElementById("hint");

      function setImageTry(urls, failMessage) {
        let i = 0;
        const tryNext = () => {
          if (i >= urls.length) { hint.textContent = failMessage; return; }
          const url = urls[i++];

          const probe = new Image();
          probe.onload = () => { valImage.src = url; hint.textContent = ""; };
          probe.onerror = () => tryNext();
          probe.src = url;
        };
        tryNext();
      }

      const yesBtn = document.getElementById("yesBtn");
      const noBtn = document.getElementById("noBtn");

      const GIFS = {
        start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
        yesMain: ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
        yesFinal: [
          "https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif",
          "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcnd5OW94bW81Zzg5MXpyMHB6eTE0azRiMGU5OHhlYTl4MmNiMHh6biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/TqK5V0YnrWaR2/200.gif"
        ],
        no: ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
      };

      setImageTry(GIFS.start, "Start GIF failed to load.");

      // ------------------ Lock NO until boss is beaten ------------------
      let noLocked = true;

      function lockNoButton() {
        noLocked = true;
        noBtn.disabled = true;
        noBtn.style.opacity = "0.55";
        noBtn.style.cursor = "not-allowed";
        noBtn.style.filter = "grayscale(0.15) drop-shadow(0 10px 14px rgba(0,0,0,.16))";
        const label = noBtn.querySelector("span");
        if (label) label.textContent = "LOCKED";
      }

      function unlockNoButton() {
        noLocked = false;
        noBtn.disabled = false;
        noBtn.style.opacity = "1";
        noBtn.style.cursor = "pointer";
        noBtn.style.filter = "drop-shadow(0 10px 14px rgba(0,0,0,.16))";
        const label = noBtn.querySelector("span");
        if (label) label.textContent = "NO";
      }

      lockNoButton();

      // ------------------ Chest-fanfare (original) ------------------
      function playGlueSong() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const ctx = new AudioCtx();
          if (ctx.state === "suspended") ctx.resume();

          const now = ctx.currentTime;
          const bpm = 132;
          const beat = 60 / bpm;

          const delay = ctx.createDelay(1.0);
          delay.delayTime.value = 0.12;

          const feedback = ctx.createGain();
          feedback.gain.value = 0.25;

          const wet = ctx.createGain();
          wet.gain.value = 0.35;

          const dry = ctx.createGain();
          dry.gain.value = 0.85;

          delay.connect(feedback);
          feedback.connect(delay);
          delay.connect(wet);
          wet.connect(ctx.destination);
          dry.connect(ctx.destination);

          const noteToFreq = (note) => {
            if (note === "REST") return null;
            const m = /^([A-G])(#|b)?(\d)$/.exec(note);
            if (!m) return null;

            const [, letter, accidental, octaveStr] = m;
            const octave = Number(octaveStr);
            const SEMI = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };

            let n = SEMI[letter];
            if (accidental === "#") n += 1;
            if (accidental === "b") n -= 1;

            const midi = (octave + 1) * 12 + n;
            return 440 * Math.pow(2, (midi - 69) / 12);
          };

          function schedule(sequence, {
            type = "triangle",
            volume = 0.12,
            offset = 0,
            detune = 0,
            toDelay = true
          } = {}) {
            let t = now + offset;
            for (const step of sequence) {
              const dur = step.beats * beat;
              const freq = noteToFreq(step.note);
              if (freq) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);
                osc.detune.setValueAtTime(detune, t);

                const attack = Math.min(0.012, dur * 0.25);
                const release = Math.min(0.09, dur * 0.45);

                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(volume, t + attack);
                gain.gain.setValueAtTime(volume, t + Math.max(attack, dur - release));
                gain.gain.linearRampToValueAtTime(0, t + dur);

                osc.connect(gain);
                gain.connect(dry);
                if (toDelay) gain.connect(delay);

                osc.start(t);
                osc.stop(t + dur);
              }
              t += dur;
            }
            return t;
          }

          const lead = [
            { note: "C5", beats: 0.5 }, { note: "E5", beats: 0.5 }, { note: "G5", beats: 0.5 }, { note: "C6", beats: 1.5 },
            { note: "B5", beats: 0.5 }, { note: "C6", beats: 2 },
            { note: "G5", beats: 0.5 }, { note: "C6", beats: 2.5 }
          ];
          const harmony = [
            { note: "E4", beats: 0.5 }, { note: "G4", beats: 0.5 }, { note: "C5", beats: 0.5 }, { note: "E5", beats: 1.5 },
            { note: "D5", beats: 0.5 }, { note: "E5", beats: 2 },
            { note: "C5", beats: 0.5 }, { note: "E5", beats: 2.5 }
          ];
          const bass = [
            { note: "C3", beats: 1 }, { note: "REST", beats: 1 },
            { note: "G3", beats: 1 }, { note: "REST", beats: 1 },
            { note: "C3", beats: 2 },
          ];
          const sparkle = [
            { note: "C6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 },
            { note: "B6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "C6", beats: 0.25 },
            { note: "D6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "D7", beats: 0.25 },
            { note: "C7", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "D6", beats: 0.25 },
            { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "E7", beats: 0.25 },
            { note: "D7", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 },
          ];

          const t1 = schedule(lead,    { type: "triangle", volume: 0.14, offset: 0.00, detune: +4 });
          const t2 = schedule(harmony, { type: "sine",     volume: 0.10, offset: 0.02, detune: -3 });
          const t3 = schedule(bass,    { type: "square",   volume: 0.06, offset: 0.00, detune:  0, toDelay: false });
          const t4 = schedule(sparkle, { type: "sine",     volume: 0.07, offset: 0.10, detune: +6 });

          const end = Math.max(t1, t2, t3, t4);
          setTimeout(() => ctx.close().catch(() => {}), Math.ceil((end - now + 0.35) * 1000));
        } catch {}
      }

      let yesFinalTimer = null;

      // ------------------ NO button gets huge + runs away ------------------
      let noScale = 1;
      let noDodges = 0;

      function applyNoTransform(extra = "") {
        const capped = Math.min(noScale, 4.5);
        noBtn.style.transform = `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) ${extra}`;
      }

      noBtn.addEventListener("mouseenter", () => {
        if (noLocked) return;      // ‚úÖ locked: no dodge
        if (noDodges < 2) return;

        const rect = noBtn.getBoundingClientRect();
        const pad = 12;

        const maxX = window.innerWidth - rect.width - pad;
        const maxY = window.innerHeight - rect.height - pad;

        const tx = Math.floor(Math.random() * maxX) - rect.left + pad;
        const ty = Math.floor(Math.random() * maxY) - rect.top + pad;

        noBtn.dataset.tx = tx;
        noBtn.dataset.ty = ty;

        noBtn.style.transition = "transform 0.15s ease";
        applyNoTransform();
      });

      // ------------------ Battle music (original, looped) ------------------
      let battleCtx = null;
      let battleMaster = null;
      let battleInterval = null;
      let battleStep = 0;
      let battleIntensity = 1;

      function noiseHit(ctx, time, duration, volume, cutoffHz) {
        const bufferSize = Math.floor(ctx.sampleRate * duration);
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);

        const src = ctx.createBufferSource();
        src.buffer = buffer;

        const filter = ctx.createBiquadFilter();
        filter.type = "lowpass";
        filter.frequency.setValueAtTime(cutoffHz, time);

        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(volume, time + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);

        src.connect(filter).connect(gain).connect(battleMaster);
        src.start(time);
        src.stop(time + duration);
      }

      function noteToFreqBattle(note) {
        const m = /^([A-G])(#|b)?(\d)$/.exec(note);
        if (!m) return null;
        const [, letter, accidental, octaveStr] = m;
        const octave = Number(octaveStr);
        const SEMI = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
        let n = SEMI[letter];
        if (accidental === "#") n += 1;
        if (accidental === "b") n -= 1;
        const midi = (octave + 1) * 12 + n;
        return 440 * Math.pow(2, (midi - 69) / 12);
      }

      function startBattleMusic(intensity = 1) {
        if (battleCtx) return;

        battleIntensity = intensity;

        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        battleCtx = new AudioCtx();
        if (battleCtx.state === "suspended") battleCtx.resume();

        battleMaster = battleCtx.createGain();
        battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
        battleMaster.connect(battleCtx.destination);

        battleStep = 0;

        const tick = () => {
          if (!battleCtx) return;

          const capped = Math.max(1, Math.min(battleIntensity, 6));
          const bpm = 120 + capped * 10;
          const stepDur = 60 / bpm / 2;
          const t = battleCtx.currentTime + 0.02;

          const riff = ["E3","G3","A3","G3","E3","D3","E3","B2"];
          const lead = ["E4","G4","A4","B4","A4","G4","E4","D4"];

          const bassNote = riff[battleStep % riff.length];
          const bassOsc = battleCtx.createOscillator();
          bassOsc.type = "sawtooth";
          bassOsc.frequency.setValueAtTime(noteToFreqBattle(bassNote), t);

          const bassGain = battleCtx.createGain();
          bassGain.gain.setValueAtTime(0, t);
          bassGain.gain.linearRampToValueAtTime(0.12 + capped * 0.01, t + 0.01);
          bassGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur);

          const bassFilter = battleCtx.createBiquadFilter();
          bassFilter.type = "lowpass";
          bassFilter.frequency.setValueAtTime(600 + capped * 180, t);

          bassOsc.connect(bassFilter).connect(bassGain).connect(battleMaster);
          bassOsc.start(t);
          bassOsc.stop(t + stepDur);

          if (battleStep % 2 === 0) {
            const leadNote = lead[(battleStep / 2) % lead.length];
            const leadOsc = battleCtx.createOscillator();
            leadOsc.type = "square";
            leadOsc.frequency.setValueAtTime(noteToFreqBattle(leadNote), t);

            const leadGain = battleCtx.createGain();
            leadGain.gain.setValueAtTime(0, t);
            leadGain.gain.linearRampToValueAtTime(0.07 + capped * 0.008, t + 0.008);
            leadGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur * 0.9);

            leadOsc.connect(leadGain).connect(battleMaster);
            leadOsc.start(t);
            leadOsc.stop(t + stepDur * 0.9);
          }

          const isKick = battleStep % 4 === 0 || battleStep % 4 === 2;
          const isSnare = battleStep % 4 === 1 || battleStep % 4 === 3;

          if (isKick)  noiseHit(battleCtx, t, 0.06, 0.10 + capped * 0.01, 220 + capped * 20);
          if (isSnare) noiseHit(battleCtx, t, 0.05, 0.06 + capped * 0.008, 1200 + capped * 120);
          noiseHit(battleCtx, t, 0.02, 0.03 + capped * 0.004, 6000 + capped * 300);

          battleStep++;
        };

        battleInterval = setInterval(tick, 90);
        tick();
      }

      function updateBattleIntensity(intensity) {
        battleIntensity = intensity;
        if (!battleCtx) return;
        battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
      }

      function stopBattleMusic() {
        if (battleInterval) clearInterval(battleInterval);
        battleInterval = null;

        if (battleCtx) {
          const ctx = battleCtx;
          battleCtx = null;
          battleMaster = null;
          setTimeout(() => ctx.close().catch(() => {}), 50);
        }
      }

      function maybeBossMode() {
        if (noDodges >= 3) document.body.classList.add("boss-mode");
      }

      // ================== MAGALOR-STYLE BOSS FIGHT (+ phase 2, black hole, laugh, NO locked) ==================
      const bossCanvas = document.getElementById("bossCanvas");
      const bossStartBtn = document.getElementById("bossStart");
      const bossOverlay = document.getElementById("bossOverlay");
      const bossMsg = document.getElementById("bossMsg");
      const playerHPBar = document.getElementById("playerHPBar");
      const bossHPBar = document.getElementById("bossHPBar");
      const laughFlash = document.getElementById("laughFlash");

      const defaultOverlayHTML = `
        <div class="text-slate-800/80">
          <div class="text-2xl font-extrabold">Defeat MAGALOR to unlock the question üíò</div>
          <div class="text-sm font-semibold mt-2">Dodge the stars. Shoot love beams.</div>
        </div>
      `;

      let bossCtx = bossCanvas.getContext("2d");
      let raf = null;

      function fitBossCanvas() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const rect = bossCanvas.getBoundingClientRect();
        bossCanvas.width = Math.floor(rect.width * dpr);
        bossCanvas.height = Math.floor(rect.height * dpr);
        bossCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      fitBossCanvas();
      window.addEventListener("resize", fitBossCanvas);

      const keys = new Set();
      window.addEventListener("keydown", (e) => {
        if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," "].includes(e.key)) {
          keys.add(e.key);
          if (e.key === " ") e.preventDefault();
        }
      });
      window.addEventListener("keyup", (e) => keys.delete(e.key));

      // Touch controls: drag to move; tap to shoot
      let touchActive = false;
      let touchX = 0, touchY = 0;
      bossCanvas.addEventListener("pointerdown", (e) => {
        touchActive = true;
        const r = bossCanvas.getBoundingClientRect();
        touchX = e.clientX - r.left;
        touchY = e.clientY - r.top;
        if (bossGame.running) shoot();
      });
      bossCanvas.addEventListener("pointermove", (e) => {
        if (!touchActive) return;
        const r = bossCanvas.getBoundingClientRect();
        touchX = e.clientX - r.left;
        touchY = e.clientY - r.top;
      });
      window.addEventListener("pointerup", () => (touchActive = false));

      const bossGame = {
        running: false,
        t: 0,
        lastShot: 0,
        phaseTimer: 0,
        pattern: "spray",
        phase2: false,
        blackHole: { active: false, timer: 0, cool: 2.0 },
        bullets: [],
        beams: [],
        particles: [],
        player: { x: 120, y: 220, r: 10, hp: 5, maxHp: 5, inv: 0 },
        boss:   { x: 0, y: 0, r: 26, hp: 100, maxHp: 100, wob: 0 }
      };

      function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
      function dist2(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

      function setBars(){
        playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
        bossHPBar.style.width = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
      }

      function magalorLaugh() {
        if (!laughFlash) return;
        laughFlash.style.opacity = "1";
        try {
          laughFlash.animate(
            [
              { transform: "translateX(-50%) scale(0.85)", opacity: 0 },
              { transform: "translateX(-50%) scale(1.05)", opacity: 1, offset: 0.35 },
              { transform: "translateX(-50%) scale(1.0)", opacity: 1, offset: 0.75 },
              { transform: "translateX(-50%) scale(0.95)", opacity: 0 }
            ],
            { duration: 900, easing: "cubic-bezier(.2,.9,.2,1)" }
          );
        } catch {}
        setTimeout(() => (laughFlash.style.opacity = "0"), 900);
      }

      function resetBossFight(){
        bossGame.running = false;
        bossGame.t = 0;
        bossGame.lastShot = 0;
        bossGame.phaseTimer = 0;
        bossGame.pattern = "spray";
        bossGame.phase2 = false;
        bossGame.blackHole.active = false;
        bossGame.blackHole.timer = 0;
        bossGame.blackHole.cool = 2.0;

        bossGame.bullets.length = 0;
        bossGame.beams.length = 0;
        bossGame.particles.length = 0;

        bossGame.player.x = 120;
        bossGame.player.y = 220;
        bossGame.player.hp = bossGame.player.maxHp = 5;
        bossGame.player.inv = 0;

        bossGame.boss.hp = bossGame.boss.maxHp = 100;
        bossGame.boss.wob = 0;

        setBars();
        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = defaultOverlayHTML;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Start Boss Fight";
      }

      function spawnParticle(x,y,emoji){
        bossGame.particles.push({
          x,y,
          vx:(Math.random()*2-1)*1.2,
          vy:(Math.random()*2-1)*1.2 - 0.8,
          life: 40 + Math.random()*20,
          emoji
        });
      }

      function shoot(){
        const now = performance.now();
        if (now - bossGame.lastShot < 120) return;
        bossGame.lastShot = now;

        bossGame.beams.push({
          x: bossGame.player.x,
          y: bossGame.player.y - 10,
          vx: 0,
          vy: -7.5,
          r: 5
        });

        spawnParticle(bossGame.player.x, bossGame.player.y-10, "üíû");
      }

      function fireBullet(angle, speed, kind="star"){
        const bx = bossGame.boss.x;
        const by = bossGame.boss.y;
        bossGame.bullets.push({
          x: bx,
          y: by,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          r: kind === "orb" ? 7 : 6,
          kind
        });
      }

      function choosePattern(){
        const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
        const pool = hpPct > 0.65 ? ["spray","ring"]
                  : hpPct > 0.30 ? ["spray","ring","dash"]
                  : ["spray","ring","dash","spiral"];
        bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
        bossGame.phaseTimer = 0;
      }

      function roundRectPath(ctx, x, y, w, h, r) {
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }

      function updateBoss(dt){
        bossGame.t += dt;

        const w = bossCanvas.getBoundingClientRect().width;
        const h = bossCanvas.getBoundingClientRect().height;

        // Boss position
        bossGame.boss.wob += dt;
        bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 90;
        bossGame.boss.y = 90 + Math.sin(bossGame.boss.wob * 1.1) * 16;

        // Player movement
        let mx = 0, my = 0;
        if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
        if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
        if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
        if (keys.has("ArrowDown") || keys.has("s")) my += 1;

        if (touchActive){
          const dx = touchX - bossGame.player.x;
          const dy = touchY - bossGame.player.y;
          mx = clamp(dx / 30, -1, 1);
          my = clamp(dy / 30, -1, 1);
        }

        const speed = 4.2;
        bossGame.player.x = clamp(bossGame.player.x + mx * speed, 18, w - 18);
        bossGame.player.y = clamp(bossGame.player.y + my * speed, 120, h - 18);

        // Shoot with space
        if (keys.has(" ")) shoot();

        // Boss patterns
        bossGame.phaseTimer += dt;
        const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.6;
        if (bossGame.phaseTimer > 2.2) choosePattern();

        // ------------------ Phase 2 trigger at 50% HP ------------------
        if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5) {
          bossGame.phase2 = true;
          magalorLaugh();
          bossMsg.textContent = "PHASE 2 üò≥ MAGALOR opened a black hole!";
          try { updateBattleIntensity(5); } catch {}
        }

        // ------------------ Black hole pull mechanic (Phase 2) ------------------
        if (bossGame.phase2) {
          bossGame.blackHole.cool -= dt;

          if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0) {
            bossGame.blackHole.active = true;
            bossGame.blackHole.timer = 1.6;
            bossGame.blackHole.cool = 4.2;
            magalorLaugh();
          }

          if (bossGame.blackHole.active) {
            bossGame.blackHole.timer -= dt;
            if (bossGame.blackHole.timer <= 0) {
              bossGame.blackHole.active = false;
            } else {
              const dx = bossGame.boss.x - bossGame.player.x;
              const dy = bossGame.boss.y - bossGame.player.y;
              const d = Math.sqrt(dx*dx + dy*dy) || 1;
              const pull = 3.2 * (1 - Math.min(d / 520, 1));
              bossGame.player.x += (dx / d) * pull;
              bossGame.player.y += (dy / d) * pull;
              bossGame.player.x = clamp(bossGame.player.x, 18, w - 18);
              bossGame.player.y = clamp(bossGame.player.y, 120, h - 18);
            }
          }
        }

        // Attack patterns
        if (bossGame.pattern === "spray"){
          if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
            const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
            const spread = 0.18 + 0.10 * intensity;
            fireBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.7*intensity, "star");
          }
        } else if (bossGame.pattern === "ring"){
          if (bossGame.phaseTimer < dt + 0.02){
            const n = 10 + Math.floor(intensity*4);
            for (let i=0;i<n;i++){
              const a = (Math.PI*2) * (i/n);
              fireBullet(a, 2.4 + 0.7*intensity, "orb");
            }
          }
        } else if (bossGame.pattern === "dash"){
          if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
            const laneY = 150 + Math.random() * (h - 190);
            bossGame.bullets.push({
              x: -20, y: laneY, vx: 6.2 + 1.2*intensity, vy: 0, r: 8, kind:"dash"
            });
          }
        } else if (bossGame.pattern === "spiral"){
          if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
            const base = bossGame.boss.wob * 2.2;
            fireBullet(base, 2.2 + 0.9*intensity, "star");
          }
        }

        // Update bullets
        for (const b of bossGame.bullets){
          b.x += b.vx;
          b.y += b.vy;
        }
        bossGame.bullets = bossGame.bullets.filter(b => b.x > -60 && b.x < w+60 && b.y > -60 && b.y < h+60);

        // Update beams
        for (const p of bossGame.beams){
          p.x += p.vx;
          p.y += p.vy;
        }
        bossGame.beams = bossGame.beams.filter(p => p.y > -40);

        // Particles
        for (const pt of bossGame.particles){
          pt.x += pt.vx;
          pt.y += pt.vy;
          pt.vy += 0.03;
          pt.life -= 1;
        }
        bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

        // Collisions (beams -> boss)
        for (let i = bossGame.beams.length - 1; i >= 0; i--){
          const p = bossGame.beams[i];
          if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
            bossGame.beams.splice(i,1);
            bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
            spawnParticle(bossGame.boss.x, bossGame.boss.y, "‚ú®");
            setBars();
            if (bossGame.boss.hp <= 0) winBossFight();
          }
        }

        // Collisions (bullets -> player)
        if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
        for (let i = bossGame.bullets.length - 1; i >= 0; i--){
          const b = bossGame.bullets[i];
          if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
            bossGame.bullets.splice(i,1);
            if (bossGame.player.inv <= 0){
              bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
              bossGame.player.inv = 0.9;
              spawnParticle(bossGame.player.x, bossGame.player.y, "üí•");
              setBars();
              if (bossGame.player.hp <= 0) loseBossFight();
            }
          }
        }
      }

      function drawBoss(){
        const w = bossCanvas.getBoundingClientRect().width;
        const h = bossCanvas.getBoundingClientRect().height;

        bossCtx.clearRect(0,0,w,h);

        // Soft arena background
        bossCtx.globalAlpha = 0.25;
        bossCtx.fillStyle = "#ffffff";
        bossCtx.fillRect(0,0,w,h);
        bossCtx.globalAlpha = 1;

        bossCtx.globalAlpha = 0.12;
        bossCtx.strokeStyle = "#0f172a";
        bossCtx.lineWidth = 1;
        for (let x=0;x<w;x+=24){ bossCtx.beginPath(); bossCtx.moveTo(x,0); bossCtx.lineTo(x,h); bossCtx.stroke(); }
        for (let y=0;y<h;y+=24){ bossCtx.beginPath(); bossCtx.moveTo(0,y); bossCtx.lineTo(w,y); bossCtx.stroke(); }
        bossCtx.globalAlpha = 1;

        // Boss
        bossCtx.save();
        bossCtx.translate(bossGame.boss.x, bossGame.boss.y);

        // cape glow
        bossCtx.globalAlpha = 0.25;
        bossCtx.beginPath();
        bossCtx.arc(0, 8, bossGame.boss.r + 18, 0, Math.PI*2);
        bossCtx.fillStyle = "#7c3aed";
        bossCtx.fill();

        // body
        bossCtx.globalAlpha = 1;
        bossCtx.beginPath();
        bossCtx.arc(0, 0, bossGame.boss.r, 0, Math.PI*2);
        bossCtx.fillStyle = "#111827";
        bossCtx.fill();

        // eyes
        bossCtx.beginPath();
        bossCtx.arc(-8, -4, 4, 0, Math.PI*2);
        bossCtx.arc( 8, -4, 4, 0, Math.PI*2);
        bossCtx.fillStyle = "#f472b6";
        bossCtx.fill();

        // crown-ish
        bossCtx.beginPath();
        bossCtx.moveTo(-14, -20);
        bossCtx.lineTo(0, -34);
        bossCtx.lineTo(14, -20);
        bossCtx.closePath();
        bossCtx.fillStyle = "#f59e0b";
        bossCtx.fill();

        // core
        bossCtx.globalAlpha = 0.9;
        bossCtx.fillStyle = "#60a5fa";
        bossCtx.beginPath();
        bossCtx.arc(0, 10, 6, 0, Math.PI*2);
        bossCtx.fill();
        bossCtx.restore();

        // ------------------ Black hole visual ------------------
        if (bossGame.phase2 && bossGame.blackHole.active) {
          bossCtx.save();
          bossCtx.translate(bossGame.boss.x, bossGame.boss.y);

          bossCtx.globalAlpha = 0.25;
          bossCtx.beginPath();
          bossCtx.arc(0, 10, bossGame.boss.r + 34, 0, Math.PI * 2);
          bossCtx.fillStyle = "#0f172a";
          bossCtx.fill();

          bossCtx.globalAlpha = 0.55;
          bossCtx.beginPath();
          bossCtx.arc(0, 10, bossGame.boss.r + 14, 0, Math.PI * 2);
          bossCtx.fillStyle = "#111827";
          bossCtx.fill();

          bossCtx.restore();
          bossCtx.globalAlpha = 1;
        }

        // Player heart
        bossCtx.save();
        bossCtx.translate(bossGame.player.x, bossGame.player.y);
        const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
        bossCtx.globalAlpha = blink;
        bossCtx.fillStyle = "#ef4444";
        bossCtx.beginPath();
        bossCtx.moveTo(0, 8);
        bossCtx.bezierCurveTo(-16, -4, -10, -20, 0, -10);
        bossCtx.bezierCurveTo(10, -20, 16, -4, 0, 8);
        bossCtx.fill();
        bossCtx.restore();

        // Bullets
        for (const b of bossGame.bullets){
          bossCtx.save();
          bossCtx.translate(b.x, b.y);
          if (b.kind === "orb"){
            bossCtx.fillStyle = "#a78bfa";
            bossCtx.globalAlpha = 0.9;
            bossCtx.beginPath(); bossCtx.arc(0,0,b.r,0,Math.PI*2); bossCtx.fill();
            bossCtx.globalAlpha = 0.5;
            bossCtx.beginPath(); bossCtx.arc(-2,-2,2.5,0,Math.PI*2); bossCtx.fillStyle="#fff"; bossCtx.fill();
          } else if (b.kind === "dash"){
            bossCtx.fillStyle = "#fb7185";
            bossCtx.globalAlpha = 0.95;
            roundRectPath(bossCtx, -12, -4, 24, 8, 6);
            bossCtx.fill();
            bossCtx.globalAlpha = 0.5;
            roundRectPath(bossCtx, -18, -2, 10, 4, 4);
            bossCtx.fillStyle="#fff";
            bossCtx.fill();
          } else {
            bossCtx.fillStyle = "#fbbf24";
            bossCtx.globalAlpha = 0.95;
            bossCtx.beginPath();
            for (let i=0;i<5;i++){
              const a = i * (Math.PI*2/5);
              const a2 = a + (Math.PI/5);
              bossCtx.lineTo(Math.cos(a)*b.r, Math.sin(a)*b.r);
              bossCtx.lineTo(Math.cos(a2)*(b.r*0.45), Math.sin(a2)*(b.r*0.45));
            }
            bossCtx.closePath();
            bossCtx.fill();
          }
          bossCtx.restore();
        }

        // Beams
        for (const p of bossGame.beams){
          bossCtx.save();
          bossCtx.translate(p.x, p.y);
          bossCtx.fillStyle = "#22c55e";
          bossCtx.globalAlpha = 0.9;
          roundRectPath(bossCtx, -3, -10, 6, 20, 6);
          bossCtx.fill();
          bossCtx.globalAlpha = 0.6;
          bossCtx.beginPath(); bossCtx.arc(0,-12,4,0,Math.PI*2); bossCtx.fillStyle="#fff"; bossCtx.fill();
          bossCtx.restore();
        }

        // Emoji particles
        for (const pt of bossGame.particles){
          bossCtx.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
          bossCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
          bossCtx.fillText(pt.emoji, pt.x, pt.y);
        }
        bossCtx.globalAlpha = 1;
      }

      let last = 0;
      function loop(ts){
        if (!bossGame.running) return;
        if (!last) last = ts;
        const dt = Math.min(0.033, (ts - last) / 1000);
        last = ts;

        updateBoss(dt);
        drawBoss();
        raf = requestAnimationFrame(loop);
      }

      function startBossFight(){
        resetBossFight();
        bossGame.running = true;

        bossOverlay.style.opacity = "0";
        bossStartBtn.style.opacity = "0";
        bossStartBtn.style.pointerEvents = "none";

        bossMsg.textContent = "MAGALOR is angry üò≥ Defeat him to unlock the Valentine question!";
        document.body.classList.add("boss-mode");
        try { startBattleMusic(3); } catch {}

        last = 0;
        raf = requestAnimationFrame(loop);
      }

      function stopBossFight(){
        bossGame.running = false;
        if (raf) cancelAnimationFrame(raf);
        raf = null;
        try { stopBattleMusic(); } catch {}
        document.body.classList.remove("boss-mode");
      }

      function winBossFight(){
        stopBossFight();

        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = `
          <div class="text-slate-800/80">
            <div class="text-3xl font-extrabold">MAGALOR DEFEATED üíò</div>
            <div class="text-sm font-semibold mt-2">Unlocked! Now click <b>YES</b> üò§üíû</div>
          </div>
        `;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Rematch (optional)";

        bossMsg.textContent = "Unlocked! NO is now available‚Ä¶ but why would you üòå";
        unlockNoButton(); // ‚úÖ unlock NO

        try { confetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } }); } catch {}

        try {
          yesBtn.animate(
            [{ transform: "scale(1)" }, { transform: "scale(1.12)" }, { transform: "scale(1)" }],
            { duration: 700, iterations: 3 }
          );
        } catch {}
      }

      function loseBossFight(){
        stopBossFight();

        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = `
          <div class="text-slate-800/80">
            <div class="text-3xl font-extrabold">You got bonked üí•</div>
            <div class="text-sm font-semibold mt-2">Try again‚Ä¶ MAGALOR is cringe üò§</div>
          </div>
        `;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Try Again";
        bossMsg.textContent = "Tip: Keep moving while shooting!";
      }

      bossStartBtn.addEventListener("click", startBossFight);
      resetBossFight();

      // ------------------ YES / NO click handlers ------------------
      yesBtn.addEventListener("click", () => {
        // ‚úÖ show LETS GOOOO (black, on the right side of pill)
        document.getElementById("letsGo")?.classList.add("show");

        stopBattleMusic();
        document.body.classList.remove("boss-mode");

        setImageTry(GIFS.yesMain, "YES GIF failed to load.");
        hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! üíô";
        noBtn.style.display = "none";

        playGlueSong();
        confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } });

        if (yesFinalTimer) clearTimeout(yesFinalTimer);
        yesFinalTimer = setTimeout(() => {
          setImageTry(GIFS.yesFinal, "Final Eevee GIF failed to load.");
        }, 2000);
      });

      noBtn.addEventListener("click", () => {
        // ‚úÖ locked behavior
        if (noLocked) {
          hint.textContent = "NO is locked üòà Defeat MAGALOR first!";
          try {
            noBtn.animate(
              [
                { transform: "scale(1)" },
                { transform: "scale(1.08) rotate(-6deg)" },
                { transform: "scale(1.08) rotate(6deg)" },
                { transform: "scale(1)" },
              ],
              { duration: 320, iterations: 1 }
            );
          } catch {}
          return;
        }

        setImageTry(GIFS.no, "NO GIF failed to load.");
        hint.textContent = "No (Are you sure about that?) üò≥";

        noScale *= 1.35;
        noDodges += 1;

        startBattleMusic(noDodges);
        updateBattleIntensity(noDodges);
        maybeBossMode();

        const capped = Math.min(noScale, 4.5);

        noBtn.animate(
          [
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(0deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(-7deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(7deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(0deg)` },
          ],
          { duration: 220, iterations: 1 }
        );

        applyNoTransform();
      });
    </script>
  </body>
</html>
