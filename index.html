file<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valentines Day 2026 - Sarah Stets </title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* --------- Dreamy background --------- */
    body {
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
        linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
      overflow-x: hidden;
    }
    body.shiny-mode{
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(167, 139, 250, 0.50), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(34, 211, 238, 0.22), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(250, 204, 21, 0.24), transparent 60%),
        linear-gradient(180deg, #f5f3ff 0%, #e0f2fe 50%, #fff7ed 100%);
    }

    /* Boss mode tint */
    body.boss-mode::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
        linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
      opacity: 0.85;
      mix-blend-mode: multiply;
    }

    /* Background layers */
    #bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .blob {
      position: absolute;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      transform: translate3d(0,0,0);
      mix-blend-mode: multiply;
      will-change: transform;
    }
    .blob.a {
      left: -140px;
      top: -160px;
      background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
      animation: floatA 14s ease-in-out infinite;
    }
    .blob.b {
      right: -160px;
      top: -120px;
      background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
      animation: floatB 16s ease-in-out infinite;
    }
    .blob.c {
      left: 10%;
      bottom: -210px;
      background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
      animation: floatC 18s ease-in-out infinite;
    }
    @keyframes floatA { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(80px,60px) scale(1.08);} }
    @keyframes floatB { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(-90px,70px) scale(1.06);} }
    @keyframes floatC { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(120px,-60px) scale(1.1);} }
    body.boss-mode .blob.a{ animation-duration: 9s; }
    body.boss-mode .blob.b{ animation-duration: 10s; }
    body.boss-mode .blob.c{ animation-duration: 11s; }

    .noise {
      position: absolute;
      inset: 0;
      opacity: 0.10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }

    /* Grid background replaced with your black hole GIF */
    .pixel-grid{
      position:absolute;
      inset:0;
      opacity:.22;
      background-image: url("https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjliOThhaGVlNzMyNWFsa2RhZmdidGdxczU0eDF1bTBxMjZpNXRnMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xUA7b2takylWgFwJYQ/giphy.gif");
      background-size: cover;
      background-position: center;
      mix-blend-mode: overlay;
      filter: saturate(0.95) contrast(1.05);
    }

    /* Floating particles */
    #powerups, #hearts{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }
    #powerups{ z-index: 1; }
    .heart, .powerup{
      position: absolute;
      bottom: -40px;
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
      user-select: none;
      opacity: 0;
    }
    .heart{ animation: floatUp linear forwards; }
    .powerup{ animation: puFloat linear forwards; }
    @keyframes floatUp {
      0%   { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
      10%  { opacity: 0.85; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity: 0; }
    }
    @keyframes puFloat{
      0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
      12%  { opacity: .9; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity: 0; }
    }

    /* Pixel clouds layer (pixel-art SVG) */
    #pixelClouds{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }
    .pixel-cloud{
      position: absolute;
      left: -260px;
      top: var(--top);
      width: 240px;
      height: 120px;
      opacity: 0.30;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.08));
      image-rendering: pixelated;
      background-repeat: no-repeat;
      background-size: 100% 100%;
      animation: cloudDrift linear forwards;
      transform: translateZ(0);
    }
    body.boss-mode .pixel-cloud{ opacity: 0.18; }
    @keyframes cloudDrift{
      from { transform: translateX(0) scale(var(--s)); }
      to   { transform: translateX(calc(100vw + 520px)) scale(var(--s)); }
    }

    /* Big title */
    #bigTitle{
      position: relative;
      z-index: 3;
      text-align: center;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 0.95;
      font-size: clamp(2.0rem, 5vw, 3.8rem);
      color: #ffffff;
      text-shadow: 0 4px 0 rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.22);
      margin-bottom: 0.9rem;
    }
    #bigTitle span{
      display: inline-block;
      padding: 0.18em 0.42em;
      border-radius: 999px;
      background: rgba(244, 63, 94, 0.20);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
    }

    /* card */
    .glass {
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.65);
      box-shadow: 0 22px 70px rgba(0,0,0,0.14);
    }

    /* Mascot bounce */
    .pixel-vibe { text-shadow: 0 2px 0 rgba(0,0,0,0.08); }
    .mascot-bounce { animation: mascotBounce 1.8s ease-in-out infinite; }
    @keyframes mascotBounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

    /* Heart buttons */
    .svg-heart{
      width: 58px;
      height: 54px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      will-change: transform;
    }
    .svg-heart svg{ width: 100%; height: 100%; display: block; }
    .svg-heart.yes path{ fill: #ef4444; }
    .svg-heart.no  path{ fill: #f43f5e; }
    .svg-heart span{
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      transform: translateY(-4px);
      color: white; font-weight: 900; font-size: 11px;
      letter-spacing: .7px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      user-select: none; pointer-events: none;
    }
    .svg-heart:hover{ transform: scale(1.06); filter: drop-shadow(0 12px 18px rgba(0,0,0,.18)); }
    .svg-heart:active{ transform: scale(.96); }

    /* Mana bar */
    #manaWrap{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #manaBarInner{
      width: 0%;
      transition: width 160ms ease;
    }

    /* MTG-ish card frame */
    .tcg-card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.65);
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(255,255,255,0.70));
      box-shadow: 0 18px 60px rgba(0,0,0,0.14);
      overflow: hidden;
      position: relative;
    }
    .tcg-frame{
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      background:
        radial-gradient(600px 220px at 20% 10%, rgba(251, 113, 133, 0.22), transparent 60%),
        radial-gradient(600px 220px at 80% 30%, rgba(99, 102, 241, 0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
    }
    .tcg-titlebar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.10);
      font-weight: 900;
    }
    .tcg-subbar{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(15,23,42,0.10);
    }
    .tcg-rules{
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 12px;
      padding: 12px;
    }
    .mana-pip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15,23,42,0.08);
      border: 1px solid rgba(15,23,42,0.12);
      font-weight: 900;
      font-size: 12px;
      margin-left: 6px;
    }

    /* Encounter (more detailed PokÃ©mon UI) */
    .encounter{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.65);
      background: rgba(255,255,255,0.72);
      box-shadow: 0 18px 60px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .encounter-screen{
      background: linear-gradient(180deg, rgba(34,197,94,0.16), rgba(59,130,246,0.14));
      border-bottom: 1px solid rgba(15,23,42,0.10);
      padding: 16px;
      position: relative;
      overflow:hidden;
    }
    .text-box{
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      font-weight: 800;
      min-height: 58px;
    }
    .hpbar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(255,255,255,0.65);
      overflow:hidden;
    }
    .hpbar > div{
      height: 100%;
      width: 100%;
      transition: width 220ms ease;
      background: linear-gradient(90deg, rgba(34,197,94,0.9), rgba(250,204,21,0.9), rgba(239,68,68,0.9));
    }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.45);
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal-backdrop.show{ display: flex; }

    /* Boss blackhole gif overlay (phase 2 pull) */
    #blackholeGif{
      position: absolute;
      left: 50%;
      top: 44%;
      transform: translate(-50%, -50%);
      width: 170px;
      height: 170px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,0.22));
      mix-blend-mode: screen;
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- BG -->
  <div id="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
    <div class="blob c"></div>
    <div class="noise"></div>
    <div class="pixel-grid"></div>
  </div>

  <div id="powerups" aria-hidden="true"></div>
  <div id="pixelClouds" aria-hidden="true"></div>
  <div id="hearts" aria-hidden="true"></div>

  <!-- Title -->
  <div class="relative z-[3] px-4 pt-6">
    <div class="max-w-7xl mx-auto">
      <h1 id="bigTitle" class="w-full">
        <span>Love Beyond the Multiverse, throughout all Universal Singularities ğŸ’˜</span>
      </h1>

      <!-- Mana / shiny -->
      <div id="manaWrap" class="rounded-2xl glass px-4 py-3 mb-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-extrabold text-slate-800/80">
            Affection Mana: <span id="manaPct">0</span>%
          </div>

          <button id="shinyStar"
            class="text-sm font-black text-slate-700/80 hover:text-slate-900 transition"
            title="psstâ€¦ click me 3x">
            â­ Shiny Chance
          </button>
        </div>
        <div class="mt-2 h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
          <div id="manaBarInner" class="h-full bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
        </div>
      </div>

      <div class="text-center text-white/90 font-extrabold tracking-wide drop-shadow-sm mb-5">
        Two universes. One question.
        <span class="block text-sm font-semibold text-white/80 mt-1">A limited-time crossover has appearedâ€¦</span>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="relative z-[3] max-w-7xl mx-auto px-4 pb-10">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5 items-start">

      <!-- LEFT: Valentine card -->
      <aside class="lg:sticky lg:top-24">
        <div class="glass rounded-3xl p-6 text-center">
          <div class="mx-auto mb-3 w-28 mascot-bounce">
            <div class="w-24 h-24 mx-auto">
              <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
                <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
                <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
                <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
                <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
                <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <circle cx="50" cy="55" r="2" fill="#fff"/>
                <circle cx="74" cy="55" r="2" fill="#fff"/>
                <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
                <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                         C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                      fill="#ef4444"/>
                <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                      stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
                <rect x="92" y="70" width="8" height="30" rx="3" fill="#334155"/>
                <rect x="84" y="60" width="26" height="14" rx="6" fill="#475569"/>
                <circle cx="84" cy="67" r="6" fill="#475569"/>
              </svg>
            </div>
            <div class="mt-1 text-center font-extrabold text-sm tracking-wide text-slate-800/80 pixel-vibe">
              2/14/26
            </div>
          </div>

          <div class="font-black text-slate-800/80 mb-3">
            Will you be my Valentine Andrew Getzow?
          </div>

          <img id="valImage" class="w-full h-64 object-cover rounded-xl mb-4"
               style="background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));"
               alt="Valentine gif" />

          <div class="flex gap-6 justify-center mt-2">
            <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>YES</span>
            </button>

            <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>NO</span>
            </button>
          </div>

          <p id="hint" class="text-sm text-gray-600 mt-4 font-semibold">
            Both buttons are locked ğŸ˜ˆ Beat the boss first.
          </p>
        </div>
      </aside>

      <!-- RIGHT: BIG open space for games + crossover -->
      <main class="space-y-5">

        <!-- EVENT START -->
        <section class="glass rounded-3xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Begin the Event</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                A limited-time crossover has appearedâ€¦ defeat the boss to unlock the ultimate question.
              </div>
            </div>
            <button id="beginEvent"
              class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);">
              Begin the Event
            </button>
          </div>
        </section>

        <!-- BOSS FIGHT -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80">ğŸ‘¾ Boss Fight (Love Edition)</div>
            <div class="text-xs font-black text-slate-700/70">Move: WASD/Arrows â€¢ Attack: Space / Tap</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">YOU ğŸ’–</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">BOSS â˜„ï¸</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">LOVE METER ğŸ’˜</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
                </div>
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="bossCanvas" class="w-full block h-[420px]"></canvas>

              <!-- âœ… blackhole GIF overlay -->
              <img id="blackholeGif" alt="Black hole gif" />

              <div id="laughFlash"
                  class="absolute top-6 left-1/2 -translate-x-1/2 text-3xl sm:text-5xl font-black tracking-widest text-white drop-shadow-lg opacity-0 pointer-events-none">
                MAGALOR LAUGH
              </div>

              <div id="bossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="text-slate-800/80">
                  <div class="text-3xl font-extrabold">A wild boss appeared!</div>
                  <div class="text-sm font-semibold mt-2">Dodge cursed hearts. Shoot love beams.</div>
                </div>
              </div>

              <button id="bossStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
                Start Boss Fight
              </button>
            </div>

            <div id="bossMsg" class="mt-3 text-sm font-semibold text-slate-700/80">
              Beat the boss to unlock YES + NO.
            </div>
          </div>
        </section>

        <!-- PLATFORMER -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80">ğŸ•¹ï¸ Platformer: Collect the Hearts</div>
            <div class="text-xs font-black text-slate-700/70">Move: A/D or â†/â†’ â€¢ Jump: W/â†‘/Space</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3 items-center">
              <div class="sm:col-span-2 text-sm font-semibold text-slate-700/80" id="platMsg">
                Collect <b>7</b> hearts ğŸ’– and touch the <b>love letter</b> ğŸ’Œ.
              </div>
              <div class="text-xs font-black text-slate-700/80 text-right">
                Hearts: <span id="platCount">0</span>/7
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="platCanvas" class="w-full block h-[360px]"></canvas>

              <div id="platOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="text-slate-800/80">
                  <div class="text-3xl font-extrabold">Tiny Love Quest ğŸ’Œ</div>
                  <div class="text-sm font-semibold mt-2">Jump on platforms, grab hearts, reach the letter.</div>
                </div>
              </div>

              <button id="platStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #ec4899, #60a5fa);">
                Start Platformer
              </button>
            </div>
          </div>
        </section>

<!-- ==================== UPGRADED ROMANTIC / COMPLICATED VERSION (DROP-IN) ==================== -->
<style>
  /* ===== Romantic Upgrades (safe add-on) ===== */
  .tcg-frame{ position:relative; user-select:none; cursor:pointer; transform-style:preserve-3d; }
  .tcg-foilOverlay{
    pointer-events:none; position:absolute; inset:0; border-radius:28px;
    background:
      radial-gradient(800px 260px at var(--mx, 50%) var(--my, 50%), rgba(255,255,255,0.45), transparent 60%),
      linear-gradient(135deg, rgba(255,77,141,0.14), rgba(99,102,241,0.12));
    mix-blend-mode: screen; opacity:0.95;
  }
  .tcg-sparkleOverlay{
    pointer-events:none; position:absolute; inset:0; border-radius:28px;
    background-image:
      radial-gradient(circle at 15% 30%, rgba(255,255,255,0.30) 0 2px, transparent 3px),
      radial-gradient(circle at 70% 40%, rgba(255,255,255,0.22) 0 2px, transparent 3px),
      radial-gradient(circle at 45% 70%, rgba(255,255,255,0.18) 0 2px, transparent 3px),
      radial-gradient(circle at 85% 75%, rgba(255,255,255,0.14) 0 2px, transparent 3px);
    opacity:0.55; filter: blur(0.2px);
  }
  .rarity-gem{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:999px;
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(15,23,42,0.10);
    box-shadow:0 10px 30px rgba(236,72,153,0.14);
  }
  .set-symbol{
    display:inline-flex; align-items:center; justify-content:center;
    width:22px; height:22px; border-radius:6px;
    background: rgba(255,255,255,0.72);
    border:1px solid rgba(15,23,42,0.10);
    margin-left:6px;
  }
  .card-art{
    background:
      radial-gradient(600px 120px at 30% 30%, rgba(255,77,141,0.20), transparent 55%),
      radial-gradient(600px 120px at 80% 60%, rgba(99,102,241,0.14), transparent 55%),
      rgba(255,255,255,0.62);
  }
  .art-caption{
    position:absolute; left:10px; bottom:10px;
    padding:6px 10px; border-radius:999px;
    font-weight:900; font-size:11px;
    background: rgba(255,255,255,0.78);
    border:1px solid rgba(15,23,42,0.10);
    color: rgba(15,23,42,0.70);
  }
  .signature{ font-weight:900; font-style:italic; opacity:0.75; }

  .tabbar{ display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
  .tabbtn{
    padding:8px 12px; border-radius:999px;
    font-weight:900; font-size:12px;
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(255,255,255,0.65);
    color: rgba(15,23,42,0.75);
    transition: transform .12s ease;
  }
  .tabbtn:active{ transform: scale(0.98); }
  .tabbtn.is-active{
    background: linear-gradient(135deg, rgba(255,77,141,0.90), rgba(99,102,241,0.82));
    color:white;
    border-color: rgba(255,255,255,0.35);
  }

  .hud-row{ display:grid; grid-template-columns: 88px 1fr 56px; align-items:center; gap:10px; }
  .hud-label{ font-weight:900; color: rgba(15,23,42,0.70); font-size:12px; }
  .hud-value{ font-weight:900; color: rgba(15,23,42,0.70); font-size:12px; text-align:right; }
  .hud-bar{
    height:12px; border-radius:999px; overflow:hidden;
    background: rgba(255,255,255,0.55);
    border:1px solid rgba(15,23,42,0.08);
  }
  .hud-fill{
    height:100%; width:0%;
    background: linear-gradient(135deg, rgba(255,77,141,0.95), rgba(99,102,241,0.86));
  }
  .hud-mini{
    grid-column: 2 / 4;
    border-radius: 16px;
    background: rgba(255,255,255,0.65);
    border: 1px solid rgba(255,255,255,0.60);
    padding: 10px 12px;
    font-weight: 900;
    color: rgba(15,23,42,0.70);
    font-size: 12px;
  }

  .modal{
    position:fixed; inset:0; z-index:50;
    display:grid; place-items:center;
  }
  .modal-backdrop{
    position:absolute; inset:0;
    background: rgba(2,6,23,0.45);
    backdrop-filter: blur(6px);
  }
  .modal-panel{
    position:relative;
    width: min(980px, calc(100vw - 24px));
    max-height: min(82vh, 760px);
    overflow:auto;
    border-radius: 28px;
    padding: 18px;
    background: rgba(255,255,255,0.82);
    border: 1px solid rgba(255,255,255,0.62);
    box-shadow: 0 40px 90px rgba(2,6,23,0.25);
  }

  .cinematic-overlay{
    position:fixed; inset:0; z-index:60;
    display:grid; place-items:center;
    background: rgba(2,6,23,0.62);
    backdrop-filter: blur(8px);
  }
  .cinematic-card{
    width:min(520px, calc(100vw - 24px));
    border-radius: 28px;
    padding: 18px;
    background: rgba(255,255,255,0.88);
    border: 1px solid rgba(255,255,255,0.60);
    box-shadow: 0 40px 90px rgba(2,6,23,0.35);
    text-align:center;
  }
  .cinematic-title{ font-weight:1000; font-size:20px; color: rgba(15,23,42,0.85); }
  .cinematic-line{ margin-top:10px; font-weight:900; color: rgba(15,23,42,0.78); }
  .cinematic-sub{ margin-top:10px; font-weight:900; font-size:12px; opacity:0.65; }

  .hidden{ display:none !important; }

  /* tiny bar variant (for affection/nerves) */
  .hpbar.tiny{ height: 8px; }
</style>

<!-- MTG-STYLE -->
<section class="tcg-card">
  <div class="p-6">
    <div class="flex items-center justify-between gap-3 mb-4">
      <div>
        <div class="text-2xl font-black text-slate-800/80">1) Custom TCG Card: â€œBe My Valentineâ€</div>
        <div class="text-sm font-semibold text-slate-700/80 mt-1">
          Hover/drag to tilt â€¢ Click to â€œflip vibeâ€ â€¢ Reveal Alt Art for a cinematic love moment ğŸ’âœ¨
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="musicBtn"
          class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #22c55e, #60a5fa);">
          Music: Off
        </button>

        <button id="altArtBtn"
          class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #fb7185, #6366f1);">
          Reveal Alt Art
        </button>
      </div>
    </div>

    <!-- Cinematic overlay -->
    <div id="cinematicOverlay" class="cinematic-overlay hidden">
      <div class="cinematic-card">
        <div class="cinematic-title">âœ¨ ALT ART UNLOCKED âœ¨</div>
        <div id="cinematicLine" class="cinematic-line">â€œI would choose you in every draft.â€</div>
        <div class="cinematic-sub">Click anywhere to continue</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[1.2fr_0.8fr] gap-4">
      <!-- Card -->
      <div class="relative">
        <div id="tcgCard" class="tcg-frame">
          <div class="tcg-foilOverlay"></div>
          <div class="tcg-sparkleOverlay"></div>

          <div class="tcg-titlebar">
            <div class="flex items-center gap-2">
              <span class="rarity-gem" title="Mythic Love">ğŸ’</span>
              <div id="cardName">Andrew Getzow, Keeper of My Heart</div>
            </div>
            <div class="text-xs font-black text-slate-700/70">
              Cost:
              <span class="mana-pip">ğŸ«</span>
              <span class="mana-pip">â¤ï¸</span>
              <span class="mana-pip">ğŸ¿</span>
              <span class="set-symbol" title="Set: VAL-14">ğŸ’˜</span>
            </div>
          </div>

          <div class="tcg-subbar">
            <div class="text-xs font-black text-slate-700/70">Legendary Creature â€” Human Nerd</div>
            <div class="text-xs font-black text-slate-700/70">
              P/T: <span class="mana-pip">7</span>/<span class="mana-pip">14</span>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-[220px_1fr] gap-3">
            <div class="rounded-xl overflow-hidden border border-slate-900/10 bg-white/70 relative">
              <div id="cardArt" class="h-44 flex items-center justify-center font-black text-slate-700/70 card-art">
                (Put a cute photo here later)
              </div>
              <div class="art-caption"><span id="artCaption">â€œDinner Date Foilâ€</span></div>
            </div>

            <div class="tcg-rules">
              <div class="tabbar">
                <button class="tabbtn is-active" data-tab="rulesTab">Rules</button>
                <button class="tabbtn" data-tab="loreTab">Lore</button>
                <button class="tabbtn" data-tab="letterTab">Love Letter</button>
              </div>

              <div id="rulesTab" class="tabpane">
                <div class="text-sm font-semibold text-slate-800/80 leading-relaxed">
                  <div><b>Whenever you smile</b>, create a <b>Heart token</b>.</div>
                  <div class="mt-1"><b>{T}:</b> Go on a date. If itâ€™s Valentineâ€™s Day, you may also get dessert.</div>
                  <div class="mt-1"><b>Partner</b> with <b>You, Hopeless Romantic</b>.</div>
                  <div class="mt-2 text-xs font-black text-slate-700/70">
                    Reminder: Heart tokens have â€œ{1}: Make me blush. Scry 1.â€<br>
                    <span class="opacity-80">Secret: If your Nerves are low, your compliments have hexproof.</span>
                  </div>
                </div>
              </div>

              <div id="loreTab" class="tabpane hidden">
                <div class="text-sm font-semibold text-slate-800/80 leading-relaxed">
                  <div><b>Origin:</b> Summoned from the plane of Cozy Evenings.</div>
                  <div class="mt-1"><b>Alignment:</b> Chaotic Sweetheart.</div>
                  <div class="mt-1"><b>Legendary Action:</b> â€œMake a playlist. Pretend itâ€™s casual. It is not casual.â€</div>
                  <div class="mt-2 text-xs font-black text-slate-700/70">
                    Fun fact: Candlelight grants +2 devotion (and +1000 butterflies).
                  </div>
                </div>
              </div>

              <div id="letterTab" class="tabpane hidden">
                <div class="text-sm font-semibold text-slate-800/80 leading-relaxed">
                  <div id="loveLetterLine">â€œIf love were a format, Iâ€™d still pick you first.â€</div>
                  <div class="mt-2 text-xs font-black text-slate-700/70">
                    Unlock more lines by generating tokens + resolving spells ğŸ’Œ
                  </div>
                </div>
              </div>

              <div class="mt-3 text-xs italic font-bold text-slate-700/70">
                <span id="flavorQuote">â€œIâ€™d tap all my mana for you.â€</span>
              </div>

              <div class="mt-3 flex items-center justify-between gap-3">
                <div class="text-xs font-black text-slate-700/70">
                  Artist: <span class="font-extrabold">Cupidâ€™s Studio</span> â€¢ Collector No. <span id="collectorNo">VAL-014</span>
                </div>
                <div class="signature">â€” Signed: â¤ï¸</div>
              </div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-white/70 border border-white/60 p-3">
              <div class="text-xs font-black text-slate-700/70">Flavor</div>
              <div class="text-sm font-semibold text-slate-800/80 mt-1" id="flavor1">â€œTurn 1: I fell. Turn 2: I stayed.â€</div>
            </div>
            <div class="rounded-xl bg-white/70 border border-white/60 p-3">
              <div class="text-xs font-black text-slate-700/70">Synergy</div>
              <div class="text-sm font-semibold text-slate-800/80 mt-1" id="synergy1">If love is a stack, my feelings have split second.</div>
            </div>
            <div class="rounded-xl bg-white/70 border border-white/60 p-3">
              <div class="text-xs font-black text-slate-700/70">Inside Joke Slot</div>
              <div class="text-sm font-semibold text-slate-800/80 mt-1" id="joke1">â€œOur first date was basically a turn 1 love play.â€</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Romance HUD -->
      <div class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl font-black text-slate-800/80">Romance HUD</div>
            <div class="text-sm font-semibold text-slate-700/80 mt-1">Tokens + spells affect battle + unlocks.</div>
          </div>
          <div class="text-xs font-black text-slate-700/70">
            Phase: <span id="romancePhase" class="mana-pip">I</span>
          </div>
        </div>

        <div class="mt-4 space-y-3">
          <div class="hud-row">
            <div class="hud-label">Affection</div>
            <div class="hud-bar"><div id="affectionFill" class="hud-fill"></div></div>
            <div id="affectionText" class="hud-value">0%</div>
          </div>

          <div class="hud-row">
            <div class="hud-label">Nerves</div>
            <div class="hud-bar"><div id="nervesFill" class="hud-fill"></div></div>
            <div id="nervesText" class="hud-value">25%</div>
          </div>

          <div class="hud-row">
            <div class="hud-label">Mana</div>
            <div class="hud-mini" id="manaPoolMini">ğŸ«0 â¤ï¸0 ğŸ¿0 âœ¨0</div>
          </div>

          <div class="hud-row">
            <div class="hud-label">Achv</div>
            <div class="hud-mini" id="achievementsMini">â€” none yet â€”</div>
          </div>

          <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
            <div class="text-xs font-black text-slate-700/70 mb-2">Unlocked Love Lines</div>
            <div class="text-sm font-semibold text-slate-800/80" id="loveLineUnlocks">0/8 unlocked ğŸ’Œ</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Choose a Date -->
<section class="glass rounded-3xl p-6">
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-2xl font-black text-slate-800/80">2) Choose a Date (Cast a Spell)</div>
      <div class="text-sm font-semibold text-slate-700/80 mt-1">
        Pick spells â€” they go on <b>the stack</b> âœ¨ Resolve for romance buffs.
      </div>
    </div>
    <button id="openDateModal"
      class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
      style="background: linear-gradient(135deg, #ec4899, #60a5fa);">
      Open Spellbook
    </button>
  </div>

  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
    <div id="chosenDate" class="text-sm font-semibold text-slate-700/80 rounded-2xl bg-white/70 border border-white/60 p-4">
      Selected spell: <b>None yet</b>
      <div class="mt-2 text-xs font-black text-slate-700/70">Mana pool: <span id="manaSpent">ğŸ«0 â¤ï¸0 ğŸ¿0 âœ¨0</span></div>
      <div class="mt-2 text-xs font-black text-slate-700/70">Combo bonus: <span id="comboBonus">None</span></div>
    </div>

    <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
      <div class="flex items-center justify-between">
        <div class="text-xs font-black text-slate-700/70 mb-2">THE STACK</div>
        <button id="resolveStack"
          class="rounded-full px-3 py-2 text-xs font-black text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
          Resolve âœ¨
        </button>
      </div>
      <div id="spellStack" class="space-y-2 text-sm font-semibold text-slate-800/80">
        <div class="opacity-70">â€” empty â€”</div>
      </div>
    </div>
  </div>

  <!-- Spellbook Modal -->
  <div id="dateModal" class="modal hidden">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-panel">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-black text-slate-800/80">Spellbook of Dates</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-1">
            Build combos like <b>Playlist â†’ Candlelight â†’ Stargaze</b> for huge romance buffs.
          </div>
        </div>
        <button id="closeDateModal"
          class="rounded-full px-3 py-2 font-black bg-white/80 border border-white/60 active:scale-95 transition">
          Close
        </button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-[1fr_0.9fr] gap-3">
        <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70 mb-3">SPELL LIST</div>
          <div id="spellList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>

        <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70 mb-2">CURRENT SYNERGY</div>
          <div id="synergyPanel" class="text-sm font-semibold text-slate-800/80">
            Add spells to see combo effects.
          </div>

          <div class="mt-4 text-xs font-black text-slate-700/70 mb-2">STACK CONTROLS</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="stackUndo" class="rounded-xl px-3 py-2 font-black bg-white/85 border border-white/60 active:scale-95 transition">Undo</button>
            <button id="stackClear" class="rounded-xl px-3 py-2 font-black bg-white/85 border border-white/60 active:scale-95 transition">Clear</button>
          </div>

          <div class="mt-4 text-xs font-black text-slate-700/70 mb-2">ROMANTIC CONSEQUENCE</div>
          <div class="text-sm font-semibold text-slate-800/80">
            Resolving the stack can:
            <ul class="list-disc ml-5 mt-2 opacity-90">
              <li>Increase <b>Affection</b></li>
              <li>Reduce <b>Nerves</b></li>
              <li>Grant battle buffs (Cozy / Confident / Starry-eyed)</li>
              <li>Unlock <b>Love Letter lines</b></li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- Token generator -->
<section class="glass rounded-3xl p-6">
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-2xl font-black text-slate-800/80">3) Heart Token Atelier</div>
      <div class="text-sm font-semibold text-slate-700/80 mt-1">
        Generate tokens with rarity â€¢ Craft gifts â€¢ Buff the romance battle â€¢ Unlock letters ğŸ’
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="craftBtn"
        class="rounded-full px-4 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
        style="background: linear-gradient(135deg, #6366f1, #ec4899);">
        Craft Gift
      </button>
      <button id="tokenBtn"
        class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
        style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
        Create Token
      </button>
    </div>
  </div>

  <div class="mt-4 grid grid-cols-1 lg:grid-cols-[1fr_0.9fr] gap-3">
    <div>
      <div class="mt-2 grid grid-cols-6 sm:grid-cols-10 gap-2" id="tokenGrid"></div>
      <div class="mt-4 text-sm font-semibold text-slate-700/80" id="tokenMsg">
        Tokens: <b id="tokenCount">0</b> â€¢ Crafted gifts: <b id="giftCount">0</b>
      </div>
      <div class="mt-2 text-xs font-black text-slate-700/70" id="tokenLootLog">
        Loot log: â€” â€”
      </div>
    </div>

    <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
      <div class="text-xs font-black text-slate-700/70 mb-2">CRAFTING RECIPE</div>
      <div class="text-sm font-semibold text-slate-800/80">
        <div><b>ğŸ’ Bouquet</b> = ğŸŒ¹ + ğŸŒ¹ + âœ¨</div>
        <div class="mt-1"><b>ğŸ« Chocolate Box</b> = ğŸ« + ğŸ« + â¤ï¸</div>
        <div class="mt-1"><b>ğŸ•¯ï¸ Candle Kit</b> = ğŸ•¯ï¸ + âœ¨ + â¤ï¸</div>
        <div class="mt-1"><b>ğŸŸï¸ Date Ticket</b> = ğŸ¿ + ğŸ¿ + â¤ï¸</div>
      </div>

      <div class="mt-4">
        <div class="text-xs font-black text-slate-700/70 mb-2">INVENTORY</div>
        <div id="inventoryPanel" class="text-sm font-semibold text-slate-800/80 opacity-90">
          â€” empty â€”
        </div>
      </div>
    </div>
  </div>
</section>

<!-- PokÃ©mon battle -->
<section class="encounter">
  <div class="p-6">
    <div class="flex items-center justify-between gap-3 mb-3">
      <div>
        <div class="text-2xl font-black text-slate-800/80">4) Wild Valentine Appeared!</div>
        <div class="text-sm font-semibold text-slate-700/80 mt-1">
          Raise Affection, calm Nerves, and unlock the Proposal finisher. ğŸ’
        </div>
      </div>
      <div class="text-xs font-black text-slate-700/70">Status: <span id="battleStatus">Neutral</span></div>
    </div>

    <div class="encounter-screen rounded-2xl">
      <div class="grid grid-cols-2 gap-3 items-start">
        <div class="rounded-2xl bg-white/70 border border-white/60 p-3">
          <div class="flex items-center justify-between gap-2">
            <div class="font-black text-slate-800/80">Valentine (???)
              <span class="text-xs font-black text-slate-700/70 ml-2">Lv. 14</span>
            </div>
            <div class="text-xs font-black text-slate-700/70">Type: ğŸ’–/âœ¨</div>
          </div>
          <div class="mt-2 hpbar"><div id="enemyHPBar"></div></div>

          <div class="mt-2 text-xs font-black text-slate-700/70 flex items-center justify-between">
            <span>Affection</span><span id="enemyAff">0%</span>
          </div>
          <div class="mt-1 hpbar tiny"><div id="enemyAffBar"></div></div>

          <div class="mt-2 text-4xl text-center select-none" id="enemySprite">ğŸ’˜</div>
        </div>

        <div class="rounded-2xl bg-white/70 border border-white/60 p-3">
          <div class="flex items-center justify-between gap-2">
            <div class="font-black text-slate-800/80">You
              <span class="text-xs font-black text-slate-700/70 ml-2">Trainer</span>
            </div>
            <div class="text-xs font-black text-slate-700/70">Ability: ğŸ’¬ Charm</div>
          </div>
          <div class="mt-2 hpbar"><div id="youHPBar"></div></div>

          <div class="mt-2 text-xs font-black text-slate-700/70 flex items-center justify-between">
            <span>Nerves</span><span id="youNerves">25%</span>
          </div>
          <div class="mt-1 hpbar tiny"><div id="youNervesBar"></div></div>

          <div class="mt-2 text-4xl text-center select-none">ğŸ«¶</div>
        </div>
      </div>

      <div class="mt-3 text-box" id="battleText">A wild Valentine appeared!</div>
    </div>

    <div class="mt-4">
      <div id="battleMenuMain" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
          id="btnFight">FIGHT</button>
        <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
          id="btnBag">BAG</button>
        <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
          id="btnTeam">TEAM</button>
        <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
          id="btnRun">RUN</button>
      </div>

      <div id="battleMenuFight" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #fb7185, #ec4899);" data-move="Compliment Beam">Compliment Beam</button>
        <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #60a5fa, #22c55e);" data-move="Snack Shield">Snack Shield</button>
        <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #f59e0b, #fb7185);" data-move="Laugh Attack">Laugh Attack</button>
        <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
          style="background: linear-gradient(135deg, #6366f1, #ec4899);" data-move="Cozy Aura">Cozy Aura</button>

        <button id="btnProposal"
          class="sm:col-span-2 rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition opacity-50 pointer-events-none"
          style="background: linear-gradient(135deg, #22c55e, #ec4899);">
          ğŸ’ Proposal (Locked)
        </button>

        <button class="sm:col-span-2 rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/85 border border-white/60 shadow active:scale-95 transition"
          id="btnBack">BACK</button>
      </div>

      <div id="battleMenuBag" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3"></div>

      <div id="battleMenuTeam" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
        <div class="rounded-2xl bg-white/80 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70">Partner Slot A</div>
          <div class="text-sm font-semibold text-slate-800/80 mt-1">You, Hopeless Romantic ğŸ«¶</div>
          <div class="text-xs font-black text-slate-700/70 mt-2">Trait: After a successful combo, affection gains are boosted.</div>
        </div>
        <div class="rounded-2xl bg-white/80 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70">Partner Slot B</div>
          <div class="text-sm font-semibold text-slate-800/80 mt-1">Andrew, Keeper of My Heart ğŸ’˜</div>
          <div class="text-xs font-black text-slate-700/70 mt-2">Trait: Candlelight reduces nerves over time.</div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(() => {
  // ==================== ROMANCE ARCADE LOGIC (drop-in) ====================

  // --- Grab elements (safe) ---
  const $ = (id) => document.getElementById(id);

  const tcgCard = $("tcgCard");
  const altArtBtn = $("altArtBtn");
  const cardArt = $("cardArt");
  const artCaption = $("artCaption");
  const flavorQuote = $("flavorQuote");
  const loveLetterLine = $("loveLetterLine");

  const cinematicOverlay = $("cinematicOverlay");
  const cinematicLine = $("cinematicLine");
  const musicBtn = $("musicBtn");

  const affectionFill = $("affectionFill");
  const nervesFill = $("nervesFill");
  const affectionText = $("affectionText");
  const nervesText = $("nervesText");
  const manaPoolMini = $("manaPoolMini");
  const achievementsMini = $("achievementsMini");
  const loveLineUnlocks = $("loveLineUnlocks");
  const romancePhaseEl = $("romancePhase");

  const openDateModal = $("openDateModal");
  const dateModal = $("dateModal");
  const closeDateModal = $("closeDateModal");
  const spellList = $("spellList");
  const spellStack = $("spellStack");
  const chosenDate = $("chosenDate");
  const manaSpent = $("manaSpent");
  const comboBonus = $("comboBonus");
  const synergyPanel = $("synergyPanel");
  const resolveStackBtn = $("resolveStack");
  const stackUndo = $("stackUndo");
  const stackClear = $("stackClear");

  const tokenBtn = $("tokenBtn");
  const craftBtn = $("craftBtn");
  const tokenGrid = $("tokenGrid");
  const tokenCount = $("tokenCount");
  const giftCount = $("giftCount");
  const tokenLootLog = $("tokenLootLog");
  const inventoryPanel = $("inventoryPanel");

  const battleText = $("battleText");
  const battleStatus = $("battleStatus");
  const enemyHPBar = $("enemyHPBar");
  const youHPBar = $("youHPBar");
  const enemyAff = $("enemyAff");
  const enemyAffBar = $("enemyAffBar");
  const youNerves = $("youNerves");
  const youNervesBar = $("youNervesBar");

  const btnFight = $("btnFight");
  const btnBag = $("btnBag");
  const btnTeam = $("btnTeam");
  const btnRun = $("btnRun");
  const btnBack = $("btnBack");
  const btnProposal = $("btnProposal");

  const menuMain = $("battleMenuMain");
  const menuFight = $("battleMenuFight");
  const menuBag = $("battleMenuBag");
  const menuTeam = $("battleMenuTeam");

  // If any major element missing, stop quietly
  if (!tcgCard || !altArtBtn || !openDateModal || !tokenBtn || !btnFight) return;

  // ---- Audio (very simple, optional) ----
  let audioCtx = null;
  let musicOn = false;
  let musicOsc = null;

  function startMusic(){
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = 220;
      gain.gain.value = 0.02;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      musicOsc = { osc, gain };

      let step = 0;
      const chord = [220, 277.18, 329.63, 392.00];
      const timer = setInterval(() => {
        if (!musicOn || !musicOsc) { clearInterval(timer); return; }
        step = (step + 1) % chord.length;
        musicOsc.osc.frequency.setTargetAtTime(chord[step], audioCtx.currentTime, 0.08);
      }, 900);
    } catch {}
  }
  function stopMusic(){
    try{
      if (musicOsc){
        musicOsc.gain.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.05);
        setTimeout(() => {
          try { musicOsc.osc.stop(); } catch {}
          musicOsc = null;
        }, 120);
      }
    } catch {}
  }

  // ---- State ----
  const state = {
    affection: 0,   // 0..100
    nerves: 25,     // 0..100
    phase: 1,

    mana: { choc: 0, heart: 0, popcorn: 0, sparkle: 0 },

    loveLinesUnlocked: 0,
    achievements: new Set(),

    stack: [],

    tokens: [],
    gifts: { bouquet: 0, chocoBox: 0, candleKit: 0, dateTicket: 0 },

    enemyHP: 100,
    youHP: 100,
    enemyAffection: 0,
    status: { cozy: 0, confident: 0, starry: 0 },
    turnLock: false
  };

  const LOVE_LINES = [
    "â€œIf love were a format, Iâ€™d still pick you first.â€",
    "â€œYour laugh is my favorite soundtrack.â€",
    "â€œI brought dessertâ€¦ but youâ€™re the sweetest part.â€",
    "â€œIf my heart had a commander, itâ€™d be you.â€",
    "â€œTonightâ€™s forecast: 100% chance of me adoring you.â€",
    "â€œIâ€™d shuffle the universe just to draw you.â€",
    "â€œYour kindness is the rarest pull.â€",
    "â€œNo matter the matchup, Iâ€™m on your team.â€"
  ];

  const ALT_ARTS = [
    { caption: "â€œDinner Date Foilâ€", art: "ğŸ•¯ï¸ğŸŒ¹ğŸ·âœ¨" },
    { caption: "â€œStargaze Promoâ€", art: "ğŸŒ™âœ¨ğŸ’«ğŸ’–" },
    { caption: "â€œCozy Couch Secret Rareâ€", art: "ğŸ›‹ï¸ğŸ¿ğŸ’ğŸ§¸" },
    { caption: "â€œChocolate Editionâ€", art: "ğŸ«ğŸ’ğŸ“ğŸ’—" }
  ];

  const QUOTES = [
    "â€œI would choose you in every draft.â€",
    "â€œYouâ€™re my favorite top-deck.â€",
    "â€œIâ€™m not bluffing. I like you.â€",
    "â€œLetâ€™s resolve this into forever.â€",
    "â€œYouâ€™re the only combo I need.â€"
  ];

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function fmtMana(m){ return `ğŸ«${m.choc} â¤ï¸${m.heart} ğŸ¿${m.popcorn} âœ¨${m.sparkle}`; }

  function addAchievement(name){
    if (state.achievements.has(name)) return;
    state.achievements.add(name);
    achievementsMini.textContent = [...state.achievements].slice(-3).join(" â€¢ ") || "â€” none yet â€”";
  }

  function unlockLoveLine(){
    if (state.loveLinesUnlocked >= LOVE_LINES.length) return;
    state.loveLinesUnlocked += 1;
    loveLetterLine.textContent = LOVE_LINES[state.loveLinesUnlocked - 1];
    loveLineUnlocks.textContent = `${state.loveLinesUnlocked}/${LOVE_LINES.length} unlocked ğŸ’Œ`;
  }

  function updateHUD(){
    affectionFill.style.width = `${state.affection}%`;
    nervesFill.style.width = `${state.nerves}%`;
    affectionText.textContent = `${Math.round(state.affection)}%`;
    nervesText.textContent = `${Math.round(state.nerves)}%`;
    manaPoolMini.textContent = fmtMana(state.mana);

    let newPhase = 1;
    if (state.affection >= 66) newPhase = 3;
    else if (state.affection >= 33) newPhase = 2;

    if (newPhase !== state.phase){
      state.phase = newPhase;
      romancePhaseEl.textContent = newPhase === 1 ? "I" : (newPhase === 2 ? "II" : "III");
      addAchievement(`Phase ${romancePhaseEl.textContent}`);
      unlockLoveLine();
    }

    const proposalReady = (state.enemyAffection >= 85 && state.affection >= 70 && state.nerves <= 25);
    if (proposalReady){
      btnProposal.classList.remove("opacity-50","pointer-events-none");
      btnProposal.textContent = "ğŸ’ Proposal (Ready!)";
    } else {
      btnProposal.classList.add("opacity-50","pointer-events-none");
      btnProposal.textContent = "ğŸ’ Proposal (Locked)";
    }
  }

  // ---- Card tilt + click flip vibe ----
  function setCardTiltFromEvent(e){
    const r = tcgCard.getBoundingClientRect();
    const px = (e.clientX - r.left) / r.width;
    const py = (e.clientY - r.top) / r.height;
    const rx = (py - 0.5) * -10;
    const ry = (px - 0.5) * 12;

    tcgCard.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    tcgCard.style.setProperty("--mx", `${px*100}%`);
    tcgCard.style.setProperty("--my", `${py*100}%`);
  }
  tcgCard.addEventListener("mousemove", setCardTiltFromEvent);
  tcgCard.addEventListener("mouseleave", () => {
    tcgCard.style.transform = "perspective(900px) rotateX(0deg) rotateY(0deg)";
    tcgCard.style.setProperty("--mx", "50%");
    tcgCard.style.setProperty("--my", "50%");
  });

  let flipped = false;
  tcgCard.addEventListener("click", (e) => {
    if (e.target && e.target.classList && e.target.classList.contains("tabbtn")) return;
    flipped = !flipped;
    flavorQuote.textContent = flipped
      ? "â€œTonight Iâ€™m casting â€˜Hold Handsâ€™ with kicker: never let go.â€"
      : "â€œIâ€™d tap all my mana for you.â€";
    addAchievement("Card flip vibe");
  });

  // Tabs
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");

      const target = btn.getAttribute("data-tab");
      document.querySelectorAll(".tabpane").forEach(p => p.classList.add("hidden"));
      const pane = document.getElementById(target);
      if (pane) pane.classList.remove("hidden");
    });
  });

  // Cinematic
  function showCinematic(line){
    cinematicLine.textContent = line;
    cinematicOverlay.classList.remove("hidden");
  }
  function hideCinematic(){ cinematicOverlay.classList.add("hidden"); }
  cinematicOverlay.addEventListener("click", hideCinematic);

  let altIndex = 0;
  altArtBtn.addEventListener("click", () => {
    showCinematic(QUOTES[Math.floor(Math.random()*QUOTES.length)]);

    altIndex = (altIndex + 1) % ALT_ARTS.length;
    const alt = ALT_ARTS[altIndex];
    cardArt.textContent = alt.art;
    artCaption.textContent = alt.caption;

    state.affection = clamp(state.affection + 2.5, 0, 100);
    state.nerves = clamp(state.nerves - 1.0, 0, 100);
    unlockLoveLine();
    updateHUD();

    try { confetti({ particleCount: 80, spread: 70, origin: { y: 0.4 } }); } catch {}
  });

  // Music toggle
  musicBtn.addEventListener("click", () => {
    musicOn = !musicOn;
    musicBtn.textContent = `Music: ${musicOn ? "On" : "Off"}`;
    if (musicOn) startMusic();
    else stopMusic();
  });

  // ==================== SPELLBOOK ====================
  const SPELLS = [
    { name:"Playlist of Us", rarity:"Uncommon", cost:{ sparkle:1 }, tags:["playlist","cozy"],
      text:"Reduce Nerves and make your next move â€˜Confidentâ€™.",
      onResolve:(ctx)=>{ state.nerves=clamp(state.nerves-8,0,100); state.status.confident+=2; state.affection+=4; } },
    { name:"Candlelight Ritual", rarity:"Rare", cost:{ heart:1, sparkle:1 }, tags:["candle","cozy"],
      text:"Cozy buff. Extra affection if resolved after Playlist.",
      onResolve:(ctx)=>{ state.status.cozy+=3; state.affection+=ctx.hasTag("playlist")?10:6; state.nerves=clamp(state.nerves-4,0,100);} },
    { name:"Stargaze (Two Player)", rarity:"Mythic", cost:{ sparkle:2 }, tags:["stars"],
      text:"Big affection. If resolved after Candlelight, unlock a love line.",
      onResolve:(ctx)=>{ state.affection+=ctx.hasTag("candle")?14:10; state.status.starry+=3; if(ctx.hasTag("candle")) unlockLoveLine(); } },
    { name:"Shared Dessert", rarity:"Common", cost:{ choc:1 }, tags:["dessert"],
      text:"Heal you a little and calm nerves.",
      onResolve:(ctx)=>{ state.youHP=clamp(state.youHP+8,0,100); state.nerves=clamp(state.nerves-3,0,100); state.affection+=3; } },
    { name:"Movie Night (Kicker: Blankets)", rarity:"Uncommon", cost:{ popcorn:1, heart:1 }, tags:["movie","cozy"],
      text:"Cozy buff. If you crafted Candle Kit, double the cozy.",
      onResolve:(ctx)=>{ const bonus=(state.gifts.candleKit>0)?2:1; state.status.cozy+=2*bonus; state.affection+=5; state.nerves=clamp(state.nerves-2,0,100);} },
    { name:"Handhold (Split Second)", rarity:"Rare", cost:{ heart:2 }, tags:["handhold"],
      text:"Huge Nerves reduction. Cannot be â€˜interruptedâ€™ (lol).",
      onResolve:(ctx)=>{ state.nerves=clamp(state.nerves-14,0,100); state.affection+=6; } },
    { name:"Compliment Copy", rarity:"Uncommon", cost:{ sparkle:1, heart:1 }, tags:["copy"],
      text:"Copies the last spellâ€™s affection gain (partially).",
      onResolve:(ctx)=>{ state.affection += Math.max(0, ctx.lastAffGain) * 0.8; } },
    { name:"Surprise Flower Drop", rarity:"Common", cost:{ heart:1 }, tags:["flowers"],
      text:"Small affection now; extra love line if you crafted a Bouquet.",
      onResolve:(ctx)=>{ state.affection+=4; if(state.gifts.bouquet>0) unlockLoveLine(); } },
  ];

  function spellCostText(cost){
    const parts=[];
    if (cost.choc) parts.push(`ğŸ«${cost.choc}`);
    if (cost.heart) parts.push(`â¤ï¸${cost.heart}`);
    if (cost.popcorn) parts.push(`ğŸ¿${cost.popcorn}`);
    if (cost.sparkle) parts.push(`âœ¨${cost.sparkle}`);
    return parts.join(" ");
  }
  function manaEnough(cost){
    return state.mana.choc >= (cost.choc||0) &&
           state.mana.heart >= (cost.heart||0) &&
           state.mana.popcorn >= (cost.popcorn||0) &&
           state.mana.sparkle >= (cost.sparkle||0);
  }
  function spendMana(cost){
    state.mana.choc -= (cost.choc||0);
    state.mana.heart -= (cost.heart||0);
    state.mana.popcorn -= (cost.popcorn||0);
    state.mana.sparkle -= (cost.sparkle||0);
  }

  function computeComboName(){
    const tags = new Set(state.stack.flatMap(s => s.tags));
    const has = (t)=>tags.has(t);
    if (has("playlist") && has("candle") && has("stars")) return "âœ¨ Perfect Date Combo (Big Buff)";
    if (has("movie") && has("cozy")) return "ğŸ›‹ï¸ Cozy Combo";
    if (has("dessert") && has("handhold")) return "ğŸ° Brave Sweetheart Combo";
    return "";
  }

  function updateSynergy(){
    const combo = computeComboName();
    if (!combo){ synergyPanel.textContent="Add spells to see combo effects."; return; }
    if (combo.includes("Perfect Date")){
      synergyPanel.innerHTML = `<div><b>${combo}</b></div>
        <div class="mt-2 opacity-90">On resolve: +Affection, -Nerves, grants Starry-eyed + Cozy + Confident.</div>
        <div class="mt-2 text-xs font-black text-slate-700/70">Bonus: unlocks an extra love line ğŸ’Œ</div>`;
    } else if (combo.includes("Cozy")){
      synergyPanel.innerHTML = `<div><b>${combo}</b></div>
        <div class="mt-2 opacity-90">On resolve: Cozy stacks last longer, battle pressure reduced.</div>`;
    } else {
      synergyPanel.innerHTML = `<div><b>${combo}</b></div>
        <div class="mt-2 opacity-90">On resolve: big nerves drop + affection spike.</div>`;
    }
  }

  function renderSpellList(){
    spellList.innerHTML="";
    SPELLS.forEach(sp=>{
      const btn=document.createElement("button");
      btn.className="rounded-2xl p-4 bg-white/85 border border-white/60 shadow active:scale-95 transition text-left";
      btn.innerHTML=`
        <div class="flex items-center justify-between gap-2">
          <div class="font-black text-slate-800/80">${sp.name}</div>
          <div class="text-xs font-black text-slate-700/70">${sp.rarity}</div>
        </div>
        <div class="mt-1 text-xs font-black text-slate-700/70">Cost: ${spellCostText(sp.cost) || "Free"}</div>
        <div class="mt-2 text-sm font-semibold text-slate-800/80">${sp.text}</div>
        <div class="mt-2 text-xs font-black text-slate-700/70">Tags: ${sp.tags.join(", ")}</div>
      `;
      btn.addEventListener("click", ()=>{
        if(!manaEnough(sp.cost)){
          battleText.textContent="Not enough mana ğŸ’” (Create tokens first!)";
          return;
        }
        spendMana(sp.cost);
        state.stack.push(sp);
        addAchievement("Added to stack");
        renderStack();
        updateSynergy();
        updateHUD();
      });
      spellList.appendChild(btn);
    });
  }

  function renderStack(){
    if(state.stack.length===0){
      spellStack.innerHTML=`<div class="opacity-70">â€” empty â€”</div>`;
      if (manaSpent) manaSpent.textContent = fmtMana(state.mana);
      if (comboBonus) comboBonus.textContent = "None";
      chosenDate.innerHTML = `
        Selected spell: <b>None yet</b>
        <div class="mt-2 text-xs font-black text-slate-700/70">Mana pool: <span id="manaSpent">${fmtMana(state.mana)}</span></div>
        <div class="mt-2 text-xs font-black text-slate-700/70">Combo bonus: <span id="comboBonus">None</span></div>
      `;
      return;
    }

    spellStack.innerHTML="";
    state.stack.slice().reverse().forEach((sp, idx)=>{
      const row=document.createElement("div");
      row.className="rounded-xl bg-white/85 border border-white/60 p-3 shadow flex items-center justify-between gap-2";
      row.innerHTML=`
        <div>
          <div class="font-black">${sp.name}</div>
          <div class="text-xs font-black text-slate-700/70">${sp.rarity} â€¢ ${spellCostText(sp.cost) || "Free"}</div>
        </div>
        <div class="text-xs font-black text-slate-700/70">#${state.stack.length - idx}</div>
      `;
      spellStack.appendChild(row);
    });

    const top = state.stack[state.stack.length-1];
    chosenDate.innerHTML=`
      Selected spell: <b>${top.name}</b>
      <div class="mt-2 text-xs font-black text-slate-700/70">Mana pool: <span id="manaSpent">${fmtMana(state.mana)}</span></div>
      <div class="mt-2 text-xs font-black text-slate-700/70">Combo bonus: <span id="comboBonus">${computeComboName() || "None"}</span></div>
    `;
  }

  function resolveStack(){
    if (state.stack.length===0 || state.turnLock) return;
    state.turnLock=true;
    battleText.textContent="Resolving the stackâ€¦ âœ¨";
    addAchievement("Resolved stack");

    const ctx = {
      tags: new Set(state.stack.flatMap(s=>s.tags)),
      hasTag: (t)=>ctx.tags.has(t),
      lastAffGain: 0
    };

    let i = state.stack.length - 1;
    const tick = () => {
      if (i < 0){
        const combo = computeComboName();
        if (combo.includes("Perfect Date")){
          state.affection += 8;
          state.nerves = clamp(state.nerves - 6, 0, 100);
          state.status.cozy += 2;
          state.status.confident += 2;
          state.status.starry += 2;
          unlockLoveLine();
        }

        state.stack = [];
        renderStack();
        updateSynergy();
        state.affection = clamp(state.affection,0,100);
        state.nerves = clamp(state.nerves,0,100);
        updateHUD();

        battleText.textContent="Stack resolved ğŸ’– Your aura is dangerously charming.";
        try { confetti({ particleCount: 120, spread: 90, origin: { y: 0.7 } }); } catch {}
        state.turnLock=false;
        return;
      }

      const sp = state.stack[i];
      const before = state.affection;
      battleText.textContent = `âœ¨ Resolving: ${sp.name}`;
      sp.onResolve(ctx);

      ctx.lastAffGain = Math.max(0, state.affection - before);
      state.affection = clamp(state.affection,0,100);
      state.nerves = clamp(state.nerves,0,100);
      updateHUD();

      i -= 1;
      setTimeout(tick, 520);
    };
    tick();
  }

  openDateModal.addEventListener("click", ()=>{
    dateModal.classList.remove("hidden");
    renderSpellList();
    renderStack();
    updateSynergy();
  });
  closeDateModal.addEventListener("click", ()=> dateModal.classList.add("hidden"));
  dateModal.addEventListener("click", (e)=>{ if(e.target && e.target.dataset && e.target.dataset.close) dateModal.classList.add("hidden"); });

  stackUndo.addEventListener("click", ()=>{
    if(state.stack.length===0) return;
    const sp = state.stack.pop();
    state.mana.choc += (sp.cost.choc||0);
    state.mana.heart += (sp.cost.heart||0);
    state.mana.popcorn += (sp.cost.popcorn||0);
    state.mana.sparkle += (sp.cost.sparkle||0);
    renderStack(); updateSynergy(); updateHUD();
  });
  stackClear.addEventListener("click", ()=>{
    while(state.stack.length){
      const sp = state.stack.pop();
      state.mana.choc += (sp.cost.choc||0);
      state.mana.heart += (sp.cost.heart||0);
      state.mana.popcorn += (sp.cost.popcorn||0);
      state.mana.sparkle += (sp.cost.sparkle||0);
    }
    renderStack(); updateSynergy(); updateHUD();
  });
  resolveStackBtn.addEventListener("click", resolveStack);

  // ==================== TOKENS + CRAFTING ====================
  const TOKEN_TABLE = [
    { emoji:"ğŸŒ¹", type:"rose",    mana:{ heart:1 },   w:30 },
    { emoji:"ğŸ«", type:"choc",    mana:{ choc:1 },    w:26 },
    { emoji:"ğŸ¿", type:"popcorn", mana:{ popcorn:1 }, w:18 },
    { emoji:"âœ¨", type:"sparkle", mana:{ sparkle:1 }, w:22 },
    { emoji:"ğŸ•¯ï¸", type:"candle", mana:{ sparkle:1 }, w:12 },
  ];
  const RARITIES = [
    { name:"Common", chance:0.70, glow:"none" },
    { name:"Uncommon", chance:0.22, glow:"0 10px 30px rgba(99,102,241,0.20)" },
    { name:"Rare", chance:0.07, glow:"0 12px 38px rgba(236,72,153,0.22)" },
    { name:"Mythic", chance:0.01, glow:"0 16px 55px rgba(34,197,94,0.22)" },
  ];
  function rollRarity(){
    const r=Math.random(); let acc=0;
    for(const rr of RARITIES){ acc+=rr.chance; if(r<=acc) return rr; }
    return RARITIES[0];
  }
  function weightedPick(items){
    const total = items.reduce((a,i)=>a+i.w,0);
    let r = Math.random()*total;
    for(const it of items){ r-=it.w; if(r<=0) return it; }
    return items[0];
  }
  function addManaFromToken(tok){
    if(tok.mana.choc) state.mana.choc += tok.mana.choc;
    if(tok.mana.heart) state.mana.heart += tok.mana.heart;
    if(tok.mana.popcorn) state.mana.popcorn += tok.mana.popcorn;
    if(tok.mana.sparkle) state.mana.sparkle += tok.mana.sparkle;
  }
  function logLoot(msg){ tokenLootLog.textContent = `Loot log: ${msg}`; }

  function renderInventory(){
    const counts = {};
    for(const t of state.tokens) counts[t.type]=(counts[t.type]||0)+1;

    const lines = Object.keys(counts).map(k=>{
      const emoji = (TOKEN_TABLE.find(x=>x.type===k)?.emoji) || "ğŸ’–";
      return `${emoji} ${k}: <b>${counts[k]}</b>`;
    });

    const g = state.gifts;
    const giftsLine = [
      `ğŸ’ Bouquet: <b>${g.bouquet}</b>`,
      `ğŸ« Chocolate Box: <b>${g.chocoBox}</b>`,
      `ğŸ•¯ï¸ Candle Kit: <b>${g.candleKit}</b>`,
      `ğŸŸï¸ Date Ticket: <b>${g.dateTicket}</b>`
    ].join(" â€¢ ");

    inventoryPanel.innerHTML = `
      <div>${lines.length ? lines.join(" â€¢ ") : "â€” empty â€”"}</div>
      <div class="mt-2 opacity-90">${giftsLine}</div>
    `;
  }
  function pushTokenToGrid(tok){
    const el=document.createElement("div");
    el.className="rounded-xl bg-white/80 border border-white/60 shadow flex items-center justify-center text-xl select-none";
    el.style.boxShadow = tok.rarity.glow;
    el.title = `${tok.emoji} ${tok.rarity.name}`;
    el.textContent = tok.emoji;
    tokenGrid.appendChild(el);
  }

  tokenBtn.addEventListener("click", ()=>{
    const rarity = rollRarity();
    const base = weightedPick(TOKEN_TABLE);
    const mult = rarity.name==="Mythic"?3:(rarity.name==="Rare"?2:1);

    const tok = {
      emoji: base.emoji,
      type: base.type,
      mana: {
        choc: (base.mana.choc||0)*mult,
        heart: (base.mana.heart||0)*mult,
        popcorn: (base.mana.popcorn||0)*mult,
        sparkle: (base.mana.sparkle||0)*mult
      },
      rarity
    };

    state.tokens.push(tok);
    addManaFromToken(tok);

    tokenCount.textContent = String(state.tokens.length);
    pushTokenToGrid(tok);
    renderInventory();

    state.affection = clamp(state.affection + (rarity.name==="Mythic"?4:1.5), 0, 100);
    state.nerves = clamp(state.nerves - 0.6, 0, 100);

    if (state.tokens.length >= 10) addAchievement("Token hoarder");
    if (rarity.name==="Mythic"){ addAchievement("Mythic pull"); unlockLoveLine(); }

    logLoot(`${tok.rarity.name} ${tok.emoji} (+${fmtMana(tok.mana)})`);
    updateHUD();

    try { confetti({ particleCount: 40, spread: 65, origin: { y: 0.75 } }); } catch {}
  });

  function consumeTokens(req){
    const needed = { ...req };
    const remaining=[];
    for(const t of state.tokens){
      if(needed[t.type] > 0) needed[t.type] -= 1;
      else remaining.push(t);
    }
    const ok = Object.values(needed).every(v=>v<=0);
    if(!ok) return false;

    state.tokens = remaining;
    tokenGrid.innerHTML="";
    state.tokens.forEach(pushTokenToGrid);
    tokenCount.textContent = String(state.tokens.length);
    renderInventory();
    return true;
  }

  function totalGifts(){ return Object.values(state.gifts).reduce((a,b)=>a+b,0); }

  craftBtn.addEventListener("click", ()=>{
    const recipes = [
      { name:"Bouquet", key:"bouquet", req:{ rose:2, sparkle:1 } },
      { name:"Chocolate Box", key:"chocoBox", req:{ choc:2, heart:1 } },
      { name:"Candle Kit", key:"candleKit", req:{ candle:1, sparkle:1, heart:1 } },
      { name:"Date Ticket", key:"dateTicket", req:{ popcorn:2, heart:1 } },
    ];

    for(const r of recipes){
      if(consumeTokens(r.req)){
        state.gifts[r.key] += 1;
        giftCount.textContent = String(totalGifts());

        state.affection = clamp(state.affection + 6, 0, 100);
        state.nerves = clamp(state.nerves - 5, 0, 100);
        addAchievement(`Crafted ${r.name}`);
        unlockLoveLine();
        updateHUD();

        logLoot(`Crafted: ${r.name} ğŸ’`);
        battleText.textContent = `You crafted ${r.name} ğŸ’ (BAG updated!)`;

        try { confetti({ particleCount: 120, spread: 90, origin: { y: 0.7 } }); } catch {}
        renderBagMenu();
        return;
      }
    }
    battleText.textContent="Not enough ingredients ğŸ’” (Create more tokens!)";
  });

  // ==================== ROMANCE BATTLE ====================
  function setBars(){
    enemyHPBar.style.width = `${state.enemyHP}%`;
    youHPBar.style.width = `${state.youHP}%`;
    enemyAff.textContent = `${Math.round(state.enemyAffection)}%`;
    enemyAffBar.style.width = `${state.enemyAffection}%`;
    youNerves.textContent = `${Math.round(state.nerves)}%`;
    youNervesBar.style.width = `${state.nerves}%`;
  }

  function setMenu(which){
    menuMain.classList.toggle("hidden", which !== "main");
    menuFight.classList.toggle("hidden", which !== "fight");
    menuBag.classList.toggle("hidden", which !== "bag");
    menuTeam.classList.toggle("hidden", which !== "team");
  }

  function tickStatus(){
    for(const k of Object.keys(state.status)){
      state.status[k] = Math.max(0, state.status[k]-1);
    }
  }

  function enemyTurn(){
    let nervUp = 6;
    let txt = "Valentine tilts their headâ€¦ judging your vibe. ğŸ˜³";

    if (state.status.cozy > 0){ nervUp -= 2; txt = "Valentine smiles softlyâ€¦ cozy aura is working. ğŸ•¯ï¸"; }
    if (state.status.confident > 0){ nervUp -= 2; txt = "Valentine looks impressed. Your confidence is *dangerous*. âœ¨"; }

    state.nerves = clamp(state.nerves + nervUp, 0, 100);
    state.youHP = clamp(state.youHP - Math.max(0, nervUp - 2), 0, 100);
    battleText.textContent = txt;

    if (state.nerves >= 95) battleText.textContent = "You panic a little ğŸ’” (Try Cozy Aura, Handhold, or items!)";

    tickStatus();
    setBars();
    updateHUD();
  }

  function applyMove(move){
    let affGain=0, nervDown=0, heal=0;

    if(move==="Compliment Beam"){
      affGain=14; nervDown=4;
      if(state.status.confident>0) affGain+=6;
      if(state.status.starry>0) affGain+=4;
      battleText.textContent="You fire a Compliment Beam ğŸ’ It lands perfectly.";
    }
    if(move==="Snack Shield"){
      affGain=6; nervDown=10; heal=8;
      if(state.gifts.chocoBox>0){ affGain+=4; heal+=4; }
      battleText.textContent="You deploy Snack Shield ğŸ« Comfort increases dramatically.";
    }
    if(move==="Laugh Attack"){
      affGain=10; nervDown=8;
      if(state.status.cozy>0) affGain+=3;
      battleText.textContent="You use Laugh Attack ğŸ˜‚ The tension melts.";
    }
    if(move==="Cozy Aura"){
      affGain=7; nervDown=12;
      state.status.cozy += 3;
      if(state.gifts.candleKit>0){ state.status.cozy+=2; affGain+=3; }
      battleText.textContent="Cozy Aura activates ğŸ•¯ï¸ Everything feels warm and safe.";
    }

    state.enemyAffection = clamp(state.enemyAffection + affGain, 0, 100);
    state.nerves = clamp(state.nerves - nervDown, 0, 100);
    state.youHP = clamp(state.youHP + heal, 0, 100);

    state.affection = clamp(state.affection + (affGain*0.25), 0, 100);

    if(state.enemyAffection >= 50) addAchievement("Halfway to love");
    if(state.nerves <= 15) addAchievement("Ice-cold rizz");
    if(state.status.cozy >= 4) addAchievement("Cozy build");

    battleStatus.textContent = state.enemyAffection >= 70 ? "Blushing" : "Neutral";
    if(state.enemyAffection >= 100){
      battleStatus.textContent="Smitten";
      battleText.textContent="Valentine is completely smitten ğŸ’˜ The moment feelsâ€¦ inevitable.";
      try { confetti({ particleCount: 160, spread: 90, origin: { y: 0.6 } }); } catch {}
    }

    setBars();
    updateHUD();
  }

  function doProposal(){
    battleText.textContent="You take a breathâ€¦ and choose courage. ğŸ’";
    state.turnLock=true;

    setTimeout(()=>{
      state.enemyAffection = clamp(state.enemyAffection + 30, 0, 100);
      state.nerves = clamp(state.nerves - 18, 0, 100);
      state.affection = clamp(state.affection + 12, 0, 100);

      unlockLoveLine();
      unlockLoveLine();

      battleStatus.textContent="Forever";
      battleText.textContent="Proposal resolves. The room is warm. The world is quiet. ğŸ’–";
      setBars();
      updateHUD();

      try { confetti({ particleCount: 260, spread: 110, origin: { y: 0.65 } }); } catch {}
      state.turnLock=false;
    }, 900);
  }

  function renderBagMenu(){
    menuBag.innerHTML = "";

    const items = [
      {
        label:`ğŸ’ Bouquet (${state.gifts.bouquet})`,
        enabled: state.gifts.bouquet > 0,
        use: ()=>{ state.gifts.bouquet--; state.enemyAffection=clamp(state.enemyAffection+18,0,100); state.nerves=clamp(state.nerves-6,0,100);
          battleText.textContent="You present a bouquet ğŸ’ Itâ€™s devastatingly sweet."; }
      },
      {
        label:`ğŸ« Chocolate Box (${state.gifts.chocoBox})`,
        enabled: state.gifts.chocoBox > 0,
        use: ()=>{ state.gifts.chocoBox--; state.youHP=clamp(state.youHP+16,0,100); state.nerves=clamp(state.nerves-8,0,100);
          battleText.textContent="Chocolate Box ğŸ« Comfort + confidence restored."; }
      },
      {
        label:`ğŸ•¯ï¸ Candle Kit (${state.gifts.candleKit})`,
        enabled: state.gifts.candleKit > 0,
        use: ()=>{ state.gifts.candleKit--; state.status.cozy+=4; state.enemyAffection=clamp(state.enemyAffection+10,0,100);
          battleText.textContent="Candle Kit ğŸ•¯ï¸ Cozy status intensified."; }
      },
      {
        label:`ğŸŸï¸ Date Ticket (${state.gifts.dateTicket})`,
        enabled: state.gifts.dateTicket > 0,
        use: ()=>{ state.gifts.dateTicket--; state.status.confident+=3; state.status.starry+=2; state.enemyAffection=clamp(state.enemyAffection+12,0,100);
          battleText.textContent="Date Ticket ğŸŸï¸ The vibe becomes cinematic."; }
      },
    ];

    items.forEach(it=>{
      const b=document.createElement("button");
      b.className="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/85 border border-white/60 shadow active:scale-95 transition";
      b.style.opacity = it.enabled ? "1" : "0.5";
      b.style.pointerEvents = it.enabled ? "auto" : "none";
      b.textContent = it.label;

      b.addEventListener("click", ()=>{
        if(state.turnLock) return;
        it.use();
        addAchievement("Used an item");
        giftCount.textContent = String(totalGifts());
        renderInventory();
        setBars();
        updateHUD();
        renderBagMenu();
        enemyTurn();
      });

      menuBag.appendChild(b);
    });

    const back=document.createElement("button");
    back.className="sm:col-span-2 rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/85 border border-white/60 shadow active:scale-95 transition";
    back.textContent="BACK";
    back.addEventListener("click", ()=> setMenu("main"));
    menuBag.appendChild(back);
  }

  // Battle menu events
  btnFight.addEventListener("click", ()=> setMenu("fight"));
  btnBag.addEventListener("click", ()=> { renderBagMenu(); setMenu("bag"); });
  btnTeam.addEventListener("click", ()=> setMenu("team"));
  btnRun.addEventListener("click", ()=> { battleText.textContent="You try to runâ€¦ but love has trample. ğŸ’˜"; enemyTurn(); });
  btnBack.addEventListener("click", ()=> setMenu("main"));

  menuFight.querySelectorAll("button[data-move]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(state.turnLock) return;
      state.turnLock=true;
      applyMove(btn.dataset.move);
      setTimeout(()=>{
        enemyTurn();
        state.turnLock=false;
      }, 550);
    });
  });

  btnProposal.addEventListener("click", ()=>{
    if(state.turnLock) return;
    doProposal();
  });

  // Cinematic overlay click already hides it; tiny romance freebies:
  cinematicOverlay.addEventListener("click", ()=>{
    state.affection = clamp(state.affection + 1.2, 0, 100);
    state.nerves = clamp(state.nerves - 0.6, 0, 100);
    updateHUD();
  });

  // Init
  function initBattle(){
    state.enemyHP = 100;
    state.youHP = 100;
    state.enemyAffection = 0;
    battleStatus.textContent = "Neutral";
    battleText.textContent = "A wild Valentine appeared!";
    setBars();
    updateHUD();
    renderInventory();
    renderStack();
    updateSynergy();
    giftCount.textContent = "0";
    tokenCount.textContent = "0";
  }
  initBattle();

  // Close modal on escape (nice touch)
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      if(!dateModal.classList.contains("hidden")) dateModal.classList.add("hidden");
      if(!cinematicOverlay.classList.contains("hidden")) cinematicOverlay.classList.add("hidden");
    }
  });
})();
</script>


        <!-- Pokedex -->
        <section class="glass rounded-3xl p-6">
          <div class="text-2xl font-black text-slate-800/80">5) PokÃ©dex Entry: Boyfriendmon</div>
          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-black text-slate-800/80 text-lg">Boyfriendmon</div>
                <div class="text-sm font-semibold text-slate-700/80 mt-1">Type: <b>Electric / Fairy</b></div>
                <div class="text-sm font-semibold text-slate-700/80">Ability: <b>Makes Me Smile</b></div>
                <div class="text-sm font-semibold text-slate-700/80">Habitat: <b>My heart (permanent residence)</b></div>
              </div>
              <div class="text-4xl">âš¡ğŸ’–</div>
            </div>
            <div class="mt-3 text-sm font-semibold text-slate-800/80">
              PokÃ©dex: â€œKnown to boost happiness instantly. If spotted, expect uncontrollable laughter and sudden date plans.â€
            </div>
          </div>
        </section>

        <!-- Fusion Finale -->
        <section class="glass rounded-3xl p-6">
          <div class="text-2xl font-black text-slate-800/80">6) Fusion Finale: Saga â†’ Capture Screen</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-1">
            Advance the sagaâ€¦ then the â€œcaptureâ€ appears.
          </div>

          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-5">
            <div id="sagaView">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black text-slate-800/80">Saga: <span id="sagaTitle">Love Beyond the Multiverse</span></div>
                <div class="text-xs font-black text-slate-700/70">Chapter <span id="sagaChapter">I</span>/III</div>
              </div>

              <div class="mt-3 text-sm font-semibold text-slate-800/80" id="sagaText">
                I â€” â€œWe met and my life got better.â€
              </div>

              <button id="advanceSaga"
                class="mt-4 rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899);">
                Advance Saga
              </button>
            </div>

            <div id="captureView" class="hidden">
              <div class="font-black text-slate-800/80 text-lg">Throw the Love Ball?</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">Two options. Both are yes-coded.</div>

              <div class="mt-4 flex flex-wrap gap-3">
                <button id="throwLoveBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
                  YES
                </button>
                <button id="throwShinyBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, #22c55e, #60a5fa);">
                  YES (shiny)
                </button>
              </div>

              <div class="mt-3 text-sm font-semibold text-slate-700/80" id="captureMsg">
                (Still locked until the boss is defeated ğŸ˜ˆ)
              </div>
            </div>
          </div>
        </section>

        <!-- Booster pack -->
        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Bonus: Open a Booster Pack</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                It reveals the final question card.
              </div>
            </div>
            <button id="openBooster"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #f59e0b, #ec4899);">
              Open Booster
            </button>
          </div>

          <div id="boosterResult" class="mt-4 hidden rounded-2xl border border-white/60 bg-white/70 p-5">
            <div class="font-black text-slate-800/80 text-xl">âœ¨ You pulled: â€œWill You Be My Valentine?â€</div>
            <div class="text-sm font-semibold text-slate-700/80 mt-2">
              Congratulations. This is the rarest pull. (And also mandatory.) ğŸ’˜
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- DATE MODAL -->
  <div id="dateModal" class="modal-backdrop">
    <div class="glass rounded-3xl w-full max-w-3xl p-6">
      <div class="flex items-center justify-between gap-3">
        <div class="text-2xl font-black text-slate-800/80">Choose a Date (Spell Cards)</div>
        <button id="closeDateModal" class="rounded-full px-4 py-2 font-extrabold bg-white/80 border border-white/60 shadow active:scale-95 transition">
          Close
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5">
        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Cozy Date â€” Sorcery</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: â˜• <span class="mana-pip">1</span> â¤ï¸ <span class="mana-pip">1</span> ğŸ§¸</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            â€œCreate 2 Cuddle tokens. Draw a movie.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #fb7185, #60a5fa);"
            data-spell="Cozy Date" data-cost="2">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Fancy Date â€” Instant</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: ğŸŒ¹ <span class="mana-pip">2</span> â¤ï¸ <span class="mana-pip">1</span> âœ¨</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            â€œGo somewhere cute. Add dessert. Gain +10 happiness.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #ec4899, #f59e0b);"
            data-spell="Fancy Date" data-cost="3">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Chaos Date â€” Enchantment</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: ğŸ® <span class="mana-pip">2</span> â¤ï¸ <span class="mana-pip">2</span> ğŸŸ</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            â€œRoll a d20. Whatever happens, it becomes a core memory.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #6366f1, #22c55e);"
            data-spell="Chaos Date" data-cost="4">
            Cast this
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========== Floating hearts & powerups ==========
  const heartsLayer = document.getElementById("hearts");
  const powerupsLayer = document.getElementById("powerups");

  function spawnHeart() {
    const el = document.createElement("span");
    el.className = "heart";
    el.textContent = Math.random() > 0.25 ? "ğŸ’—" : "ğŸ’–";
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 28;
    const dur  = 5 + Math.random() * 7;
    const drift = (Math.random() * 60 - 30) + "px";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    heartsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 100);
  }

  function spawnPowerup(){
    const el = document.createElement("span");
    el.className = "powerup";
    const items = ["â­","ğŸª™","âœ¨","ğŸ’–","ğŸ®","ğŸ’Œ","ğŸŒ¹"];
    el.textContent = items[Math.floor(Math.random() * items.length)];
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 22;
    const dur  = 6 + Math.random() * 8;
    const drift = (Math.random() * 80 - 40) + "px";
    const rot = (Math.random() * 160 - 80) + "deg";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    el.style.setProperty("--rot", rot);
    powerupsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 200);
  }

  for (let i = 0; i < 14; i++) spawnHeart();
  setInterval(spawnHeart, 220);
  for (let i = 0; i < 10; i++) spawnPowerup();
  setInterval(spawnPowerup, 600);

  // ========== âœ… Pixel clouds ==========
  const pixelCloudsLayer = document.getElementById("pixelClouds");

  const pixelCloudSvg = encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="32" viewBox="0 0 64 32">
      <rect width="64" height="32" fill="none"/>
      <g fill="#ffffff">
        <rect x="10" y="14" width="8" height="6"/>
        <rect x="18" y="12" width="10" height="8"/>
        <rect x="28" y="10" width="12" height="10"/>
        <rect x="40" y="12" width="10" height="8"/>
        <rect x="50" y="14" width="6" height="6"/>
        <rect x="14" y="18" width="40" height="8"/>
      </g>
      <g fill="#e2e8f0" opacity="0.85">
        <rect x="18" y="18" width="10" height="8"/>
        <rect x="32" y="18" width="10" height="8"/>
      </g>
    </svg>
  `);

  function spawnPixelCloud(){
    const el = document.createElement("div");
    el.className = "pixel-cloud";
    const top = (Math.random() * 55) + "vh";
    const dur = (18 + Math.random() * 18) + "s";
    const scale = (0.55 + Math.random() * 0.65).toFixed(2);
    el.style.setProperty("--top", top);
    el.style.setProperty("--s", scale);
    el.style.animationDuration = dur;
    el.style.backgroundImage = `url("data:image/svg+xml,${pixelCloudSvg}")`;
    pixelCloudsLayer.appendChild(el);
    setTimeout(() => el.remove(), parseFloat(dur) * 1000 + 300);
  }

  for (let i=0;i<6;i++) spawnPixelCloud();
  setInterval(spawnPixelCloud, 1700);

  // ========== Mana bar ==========
  const manaBarInner = document.getElementById("manaBarInner");
  const manaPctEl = document.getElementById("manaPct");

  function updateMana(){
    const doc = document.documentElement;
    const scrollTop = doc.scrollTop || document.body.scrollTop;
    const max = (doc.scrollHeight - doc.clientHeight) || 1;
    const pct = Math.max(0, Math.min(100, (scrollTop / max) * 100));
    manaBarInner.style.width = pct.toFixed(1) + "%";
    manaPctEl.textContent = String(Math.round(pct));
  }
  window.addEventListener("scroll", updateMana, { passive: true });
  updateMana();

  // ========== Shiny mode easter egg ==========
  const shinyStar = document.getElementById("shinyStar");
  let shinyClicks = 0;
  shinyStar.addEventListener("click", () => {
    shinyClicks++;
    if (shinyClicks >= 3){
      document.body.classList.toggle("shiny-mode");
      shinyClicks = 0;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.2 } }); } catch {}
    } else {
      shinyStar.animate([{transform:"scale(1)"},{transform:"scale(1.2)"},{transform:"scale(1)"}], {duration:260});
    }
  });

  // ========== GIF loader (generic) ==========
  function setImageTryFor(imgEl, urls) {
    let i = 0;
    const tryNext = () => {
      if (i >= urls.length) { return; }
      const url = urls[i++];
      const probe = new Image();
      probe.onload = () => { imgEl.src = url; };
      probe.onerror = () => tryNext();
      probe.src = url;
    };
    tryNext();
  }

  // ========== Valentine GIF loader ==========
  const valImage = document.getElementById("valImage");
  const hint = document.getElementById("hint");

  const GIFS = {
    start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
    yesMain: ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
    yesFinal: [
      "https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif",
      "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcnd5OW94bW81Zzg5MXpyMHB6eTE0azRiMGU5OHhlYTl4MmNiMHh6biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/TqK5V0YnrWaR2/200.gif"
    ],
    no: ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
  };
  setImageTryFor(valImage, GIFS.start);

  // âœ… Blackhole GIF (shows during phase2 pull) - uses YOUR gif first
  const blackholeGif = document.getElementById("blackholeGif");
  const BLACKHOLE_GIFS = [
    "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjliOThhaGVlNzMyNWFsa2RhZmdidGdxczU0eDF1bTBxMjZpNXRnMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xUA7b2takylWgFwJYQ/giphy.gif"
  ];
  setImageTryFor(blackholeGif, BLACKHOLE_GIFS);

  // ========== âœ… MUSIC (YES + NO + Boss fight) ==========
  function playGlueSong() {
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      if (ctx.state === "suspended") ctx.resume();

      const now = ctx.currentTime;
      const bpm = 132;
      const beat = 60 / bpm;

      const delay = ctx.createDelay(1.0);
      delay.delayTime.value = 0.12;

      const feedback = ctx.createGain();
      feedback.gain.value = 0.25;

      const wet = ctx.createGain();
      wet.gain.value = 0.35;

      const dry = ctx.createGain();
      dry.gain.value = 0.85;

      delay.connect(feedback);
      feedback.connect(delay);
      delay.connect(wet);
      wet.connect(ctx.destination);
      dry.connect(ctx.destination);

      const noteToFreq = (note) => {
        if (note === "REST") return null;
        const m = /^([A-G])(#|b)?(\d)$/.exec(note);
        if (!m) return null;

        const [, letter, accidental, octaveStr] = m;
        const octave = Number(octaveStr);
        const SEMI = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };

        let n = SEMI[letter];
        if (accidental === "#") n += 1;
        if (accidental === "b") n -= 1;

        const midi = (octave + 1) * 12 + n;
        return 440 * Math.pow(2, (midi - 69) / 12);
      };

      function schedule(sequence, {
        type = "triangle",
        volume = 0.12,
        offset = 0,
        detune = 0,
        toDelay = true
      } = {}) {
        let t = now + offset;
        for (const step of sequence) {
          const dur = step.beats * beat;
          const freq = noteToFreq(step.note);
          if (freq) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, t);
            osc.detune.setValueAtTime(detune, t);

            const attack = Math.min(0.012, dur * 0.25);
            const release = Math.min(0.09, dur * 0.45);

            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(volume, t + attack);
            gain.gain.setValueAtTime(volume, t + Math.max(attack, dur - release));
            gain.gain.linearRampToValueAtTime(0, t + dur);

            osc.connect(gain);
            gain.connect(dry);
            if (toDelay) gain.connect(delay);

            osc.start(t);
            osc.stop(t + dur);
          }
          t += dur;
        }
        return t;
      }

      const lead = [
        { note: "C5", beats: 0.5 }, { note: "E5", beats: 0.5 }, { note: "G5", beats: 0.5 }, { note: "C6", beats: 1.5 },
        { note: "B5", beats: 0.5 }, { note: "C6", beats: 2 },
        { note: "G5", beats: 0.5 }, { note: "C6", beats: 2.5 }
      ];
      const harmony = [
        { note: "E4", beats: 0.5 }, { note: "G4", beats: 0.5 }, { note: "C5", beats: 0.5 }, { note: "E5", beats: 1.5 },
        { note: "D5", beats: 0.5 }, { note: "E5", beats: 2 },
        { note: "C5", beats: 0.5 }, { note: "E5", beats: 2.5 }
      ];
      const bass = [
        { note: "C3", beats: 1 }, { note: "REST", beats: 1 },
        { note: "G3", beats: 1 }, { note: "REST", beats: 1 },
        { note: "C3", beats: 2 },
      ];
      const sparkle = [
        { note: "C6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 },
        { note: "B6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "C6", beats: 0.25 },
        { note: "D6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "D7", beats: 0.25 },
        { note: "C7", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "D6", beats: 0.25 },
        { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "E7", beats: 0.25 },
        { note: "D7", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 },
      ];

      const t1 = schedule(lead,    { type: "triangle", volume: 0.14, offset: 0.00, detune: +4 });
      const t2 = schedule(harmony, { type: "sine",     volume: 0.10, offset: 0.02, detune: -3 });
      const t3 = schedule(bass,    { type: "square",   volume: 0.06, offset: 0.00, detune:  0, toDelay: false });
      const t4 = schedule(sparkle, { type: "sine",     volume: 0.07, offset: 0.10, detune: +6 });

      const end = Math.max(t1, t2, t3, t4);
      setTimeout(() => ctx.close().catch(() => {}), Math.ceil((end - now + 0.35) * 1000));
    } catch {}
  }

  // Battle loop music (used for boss fight + NO sting)
  let battleCtx = null;
  let battleMaster = null;
  let battleInterval = null;
  let battleStep = 0;
  let battleIntensity = 1;

  function noiseHit(ctx, time, duration, volume, cutoffHz) {
    const bufferSize = Math.floor(ctx.sampleRate * duration);
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);

    const src = ctx.createBufferSource();
    src.buffer = buffer;

    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.setValueAtTime(cutoffHz, time);

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(volume, time + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);

    src.connect(filter).connect(gain).connect(battleMaster);
    src.start(time);
    src.stop(time + duration);
  }

  function noteToFreqBattle(note) {
    const m = /^([A-G])(#|b)?(\d)$/.exec(note);
    if (!m) return null;
    const [, letter, accidental, octaveStr] = m;
    const octave = Number(octaveStr);
    const SEMI = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
    let n = SEMI[letter];
    if (accidental === "#") n += 1;
    if (accidental === "b") n -= 1;
    const midi = (octave + 1) * 12 + n;
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function startBattleMusic(intensity = 1) {
    if (battleCtx) return;

    battleIntensity = intensity;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    battleCtx = new AudioCtx();
    if (battleCtx.state === "suspended") battleCtx.resume();

    battleMaster = battleCtx.createGain();
    battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
    battleMaster.connect(battleCtx.destination);

    battleStep = 0;

    const tick = () => {
      if (!battleCtx) return;

      const capped = Math.max(1, Math.min(battleIntensity, 6));
      const bpm = 120 + capped * 10;
      const stepDur = 60 / bpm / 2;
      const t = battleCtx.currentTime + 0.02;

      const riff = ["E3","G3","A3","G3","E3","D3","E3","B2"];
      const lead = ["E4","G4","A4","B4","A4","G4","E4","D4"];

      const bassNote = riff[battleStep % riff.length];
      const bassOsc = battleCtx.createOscillator();
      bassOsc.type = "sawtooth";
      bassOsc.frequency.setValueAtTime(noteToFreqBattle(bassNote), t);

      const bassGain = battleCtx.createGain();
      bassGain.gain.setValueAtTime(0, t);
      bassGain.gain.linearRampToValueAtTime(0.12 + capped * 0.01, t + 0.01);
      bassGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur);

      const bassFilter = battleCtx.createBiquadFilter();
      bassFilter.type = "lowpass";
      bassFilter.frequency.setValueAtTime(600 + capped * 180, t);

      bassOsc.connect(bassFilter).connect(bassGain).connect(battleMaster);
      bassOsc.start(t);
      bassOsc.stop(t + stepDur);

      if (battleStep % 2 === 0) {
        const leadNote = lead[(battleStep / 2) % lead.length];
        const leadOsc = battleCtx.createOscillator();
        leadOsc.type = "square";
        leadOsc.frequency.setValueAtTime(noteToFreqBattle(leadNote), t);

        const leadGain = battleCtx.createGain();
        leadGain.gain.setValueAtTime(0, t);
        leadGain.gain.linearRampToValueAtTime(0.07 + capped * 0.008, t + 0.008);
        leadGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur * 0.9);

        leadOsc.connect(leadGain).connect(battleMaster);
        leadOsc.start(t);
        leadOsc.stop(t + stepDur * 0.9);
      }

      const isKick = battleStep % 4 === 0 || battleStep % 4 === 2;
      const isSnare = battleStep % 4 === 1 || battleStep % 4 === 3;

      if (isKick)  noiseHit(battleCtx, t, 0.06, 0.10 + capped * 0.01, 220 + capped * 20);
      if (isSnare) noiseHit(battleCtx, t, 0.05, 0.06 + capped * 0.008, 1200 + capped * 120);
      noiseHit(battleCtx, t, 0.02, 0.03 + capped * 0.004, 6000 + capped * 300);

      battleStep++;
    };

    battleInterval = setInterval(tick, 90);
    tick();
  }

  function updateBattleIntensity(intensity) {
    battleIntensity = intensity;
    if (!battleCtx || !battleMaster) return;
    battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
  }

  function stopBattleMusic() {
    if (battleInterval) clearInterval(battleInterval);
    battleInterval = null;

    if (battleCtx) {
      const ctx = battleCtx;
      battleCtx = null;
      battleMaster = null;
      setTimeout(() => ctx.close().catch(() => {}), 50);
    }
  }

  // ========== Lock YES/NO until boss beaten ==========
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  let yesLocked = true;
  let noLocked = true;

  function lockBtn(btn, label){
    btn.disabled = true;
    btn.style.opacity = "0.55";
    btn.style.cursor = "not-allowed";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }
  function unlockBtn(btn, label){
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }
  function lockYesNo(){
    yesLocked = true; noLocked = true;
    lockBtn(yesBtn, "LOCKED");
    lockBtn(noBtn, "LOCKED");
  }
  function unlockYesNo(){
    yesLocked = false; noLocked = false;
    unlockBtn(yesBtn, "YES");
    unlockBtn(noBtn, "NO");
    hint.textContent = "Unlocked! ğŸ˜³ Now choose wisely...";
  }
  lockYesNo();

  // ========== Begin Event ==========
  const beginEvent = document.getElementById("beginEvent");
  const bossStartBtn = document.getElementById("bossStart");
  beginEvent.addEventListener("click", () => {
    bossStartBtn.scrollIntoView({ behavior: "smooth", block: "center" });
    bossStartBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:520});
  });

  // ========== YES/NO handlers ==========
  let yesFinalTimer = null;

  yesBtn.addEventListener("click", () => {
    if (yesLocked){
      hint.textContent = "YES is locked ğŸ˜ˆ Beat the boss first!";
      yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
      return;
    }

    stopBattleMusic(); // keep it clean for the YES fanfare
    playGlueSong();

    setImageTryFor(valImage, GIFS.yesMain);
    hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! ğŸ’™";
    noBtn.style.display = "none";
    try { confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } }); } catch {}
    if (yesFinalTimer) clearTimeout(yesFinalTimer);
    yesFinalTimer = setTimeout(() => setImageTryFor(valImage, GIFS.yesFinal), 2000);
  });

  noBtn.addEventListener("click", () => {
    if (noLocked){
      hint.textContent = "NO is locked ğŸ˜ˆ Beat the boss first!";
      noBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
      return;
    }

    // keep a little "battle vibe" on NO too
    startBattleMusic(3);
    updateBattleIntensity(3);
    setTimeout(() => { if (!bossGame?.running) stopBattleMusic(); }, 2200);

    setImageTryFor(valImage, GIFS.no);
    hint.textContent = "No (Are you sure about that?) ğŸ˜³";
  });

  // ========== Alt art toggle ==========
  const altArtBtn = document.getElementById("altArtBtn");
  const cardArt = document.getElementById("cardArt");
  let altArt = false;
  altArtBtn.addEventListener("click", () => {
    altArt = !altArt;
    cardArt.textContent = altArt ? "(ALT ART: put another photo here)" : "(Put a cute photo here later)";
    try { confetti({ particleCount: 80, spread: 60, origin: { y: 0.25 } }); } catch {}
  });

  // ========== Date modal + stack ==========
  const dateModal = document.getElementById("dateModal");
  const openDateModal = document.getElementById("openDateModal");
  const closeDateModal = document.getElementById("closeDateModal");
  const chosenDate = document.getElementById("chosenDate");
  const spellStack = document.getElementById("spellStack");
  const manaSpentEl = document.getElementById("manaSpent");
  let manaSpent = 0;

  function pushToStack(name){
    if (spellStack.textContent.includes("empty")) spellStack.innerHTML = "";
    const row = document.createElement("div");
    row.className = "rounded-xl bg-white/75 border border-white/60 px-3 py-2 shadow-sm";
    row.textContent = name + " (on the stack)";
    spellStack.prepend(row);
    row.animate([{transform:"translateY(-6px)", opacity:0},{transform:"translateY(0px)", opacity:1}], {duration:320, easing:"cubic-bezier(.2,.9,.2,1)"});
  }

  openDateModal.addEventListener("click", () => dateModal.classList.add("show"));
  closeDateModal.addEventListener("click", () => dateModal.classList.remove("show"));
  dateModal.addEventListener("click", (e) => { if (e.target === dateModal) dateModal.classList.remove("show"); });

  dateModal.querySelectorAll("button[data-spell]").forEach(btn => {
    btn.addEventListener("click", () => {
      const s = btn.getAttribute("data-spell");
      const cost = Number(btn.getAttribute("data-cost") || "0");
      manaSpent += cost;
      manaSpentEl.textContent = String(manaSpent);

      chosenDate.innerHTML = `Selected spell: <b>${s}</b><div class="mt-2 text-xs font-black text-slate-700/70">Mana spent: <span>${manaSpent}</span></div>`;
      pushToStack(s);

      dateModal.classList.remove("show");
      try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.7 } }); } catch {}
    });
  });

  // ========== Token generator ==========
  const tokenBtn = document.getElementById("tokenBtn");
  const tokenGrid = document.getElementById("tokenGrid");
  const tokenCountEl = document.getElementById("tokenCount");
  const tokenMsg = document.getElementById("tokenMsg");
  let tokens = 0;

  function tokenUnlockMessage(n){
    if (n === 5)  return "Youâ€™ve generated enough love mana.";
    if (n === 10) return "Warning: lethal affection incoming.";
    if (n === 20) return "Ultimate achieved: Ask unlocked. (â€¦if the boss is defeated ğŸ˜ˆ)";
    return null;
  }

  tokenBtn.addEventListener("click", () => {
    tokens++;
    tokenCountEl.textContent = String(tokens);
    const tile = document.createElement("div");
    tile.className = "h-9 w-9 rounded-xl bg-white/75 border border-white/60 flex items-center justify-center shadow-sm";
    tile.textContent = "ğŸ’–";
    tokenGrid.appendChild(tile);
    const msg = tokenUnlockMessage(tokens);
    if (msg){
      tokenMsg.innerHTML = `Tokens: <b>${tokens}</b> â€” <span class="font-black">${msg}</span>`;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } }); } catch {}
    }
  });

  // ========== PokÃ©mon battle logic ==========
  const battleText = document.getElementById("battleText");
  const enemyHPBar = document.getElementById("enemyHPBar");
  const youHPBar = document.getElementById("youHPBar");
  const enemySprite = document.getElementById("enemySprite");

  const battleMenuMain = document.getElementById("battleMenuMain");
  const battleMenuFight = document.getElementById("battleMenuFight");
  const btnFight = document.getElementById("btnFight");
  const btnBag = document.getElementById("btnBag");
  const btnTeam = document.getElementById("btnTeam");
  const btnRun = document.getElementById("btnRun");
  const btnBack = document.getElementById("btnBack");

  const poke = {
    enemyHP: 100,
    youHP: 100,
    stunned: false,
    teamPage: 0,
    inBattle: true
  };

  const moveData = {
    "Compliment Beam": { dmg: 18, text: "You fire a Compliment Beam! â€œYou make everything better.â€ Itâ€™s super effective ğŸ’¥ğŸ’–" },
    "Snack Shield":    { dmg: 6,  heal: 12, text: "Snack Shield! You block negativity with snacks. You feel safer (+HP) ğŸªğŸ›¡ï¸" },
    "Laugh Attack":    { dmg: 14, stun: 0.35, text: "Laugh Attack! He canâ€™t stop smilingâ€¦ thereâ€™s a chance he loses a turn ğŸ˜‚" },
    "Cozy Aura":       { dmg: 10, heal: 6, text: "Cozy Aura surrounds you. Warmth fills the arena (+HP) ğŸ§¸âœ¨" }
  };

  const bagItems = [
    { name: "Love Ball ğŸ’˜", effect: "capture", text: "You toss a Love Ballâ€¦ it wobblesâ€¦ ğŸ‘€" },
    { name: "Date Coupon ğŸ½ï¸", effect: "buff", text: "Date Coupon activated. Future happiness increased." },
    { name: "Chocolate Potion ğŸ«", effect: "heal", amt: 18, text: "Chocolate Potion! Sweet healing (+HP)." },
    { name: "Shiny Charm â­", effect: "shiny", text: "Shiny Charm sparklesâ€¦ the vibes improve âœ¨" }
  ];

  const teamRoster = [
    "Slot 1: Inside joke #1",
    "Slot 2: The photo where you both look cute",
    "Slot 3: The funniest moment ever",
    "Slot 4: The â€œweâ€™re a teamâ€ one",
    "Slot 5: Your shared favorite thing"
  ];

  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  function setHPBars(){
    enemyHPBar.style.width = clamp(poke.enemyHP, 0, 100) + "%";
    youHPBar.style.width   = clamp(poke.youHP, 0, 100) + "%";
  }
  setHPBars();

  function showMainMenu(){
    battleMenuFight.classList.add("hidden");
    battleMenuMain.classList.remove("hidden");
  }
  function showFightMenu(){
    battleMenuMain.classList.add("hidden");
    battleMenuFight.classList.remove("hidden");
  }

  function enemyTurn(){
    if (!poke.inBattle) return;

    if (poke.stunned && Math.random() < 0.6){
      poke.stunned = false;
      battleText.textContent = "Valentine is too flustered to moveâ€¦ ğŸ˜³";
      return;
    }
    poke.stunned = false;

    const attacks = [
      { dmg: 12, text: "Valentine used Fluster Pulse! Your heart races ğŸ’“ (-HP)" },
      { dmg: 10, text: "Valentine used Heart Spark! Itâ€™s adorable but dangerous âœ¨ (-HP)" },
      { dmg: 14, text: "Valentine used Blush Blitz! Critical cuteness ğŸ˜µ (-HP)" }
    ];
    const a = attacks[Math.floor(Math.random() * attacks.length)];
    poke.youHP = clamp(poke.youHP - a.dmg, 0, 100);
    setHPBars();
    battleText.textContent = a.text;

    if (poke.youHP <= 0){
      poke.inBattle = false;
      battleText.textContent = "You faintedâ€¦ but LOVE revives you instantly. (Try again ğŸ˜¤ğŸ’–)";
      poke.youHP = 100;
      poke.enemyHP = 100;
      poke.inBattle = true;
      setHPBars();
      enemySprite.textContent = "ğŸ’˜";
    }
  }

  function winPokemon(){
    poke.inBattle = false;
    enemySprite.textContent = "ğŸ’";
    battleText.textContent = "Valentine was defeatedâ€¦ and wants to join you. Aww. ğŸ’–";
    try { confetti({ particleCount: 140, spread: 85, origin: { y: 0.55 } }); } catch {}
    setTimeout(() => {
      poke.enemyHP = 100;
      poke.youHP = 100;
      poke.inBattle = true;
      enemySprite.textContent = "ğŸ’˜";
      setHPBars();
      battleText.textContent = "A wild Valentine appeared! (Againâ€¦ because it loves you.)";
    }, 1800);
  }

  btnFight.addEventListener("click", () => {
    if (!poke.inBattle) return;
    showFightMenu();
    battleText.textContent = "Choose a move!";
  });

  btnBack.addEventListener("click", () => {
    showMainMenu();
    battleText.textContent = "What will you do?";
  });

  battleMenuFight.querySelectorAll("button[data-move]").forEach(b => {
    b.addEventListener("click", () => {
      if (!poke.inBattle) return;
      const name = b.getAttribute("data-move");
      const m = moveData[name];

      poke.enemyHP = clamp(poke.enemyHP - m.dmg, 0, 100);
      if (m.heal) poke.youHP = clamp(poke.youHP + m.heal, 0, 100);
      if (m.stun && Math.random() < m.stun) poke.stunned = true;

      setHPBars();
      battleText.textContent = m.text;

      if (poke.enemyHP <= 0){
        winPokemon();
        showMainMenu();
        return;
      }

      setTimeout(() => enemyTurn(), 700);
      showMainMenu();
    });
  });

  btnBag.addEventListener("click", () => {
    if (!poke.inBattle) return;
    const it = bagItems[Math.floor(Math.random() * bagItems.length)];
    battleText.textContent = "BAG â†’ " + it.text;

    if (it.effect === "heal"){
      poke.youHP = clamp(poke.youHP + it.amt, 0, 100);
      setHPBars();
    }
    if (it.effect === "capture"){
      const roll = Math.random();
      if (roll > 0.72){
        battleText.textContent = "The Love Ball clicked! Valentine is captured ğŸ’˜ (itâ€™s basically YES.)";
        try { confetti({ particleCount: 110, spread: 75, origin: { y: 0.6 } }); } catch {}
      } else {
        setTimeout(() => enemyTurn(), 650);
      }
    } else {
      setTimeout(() => enemyTurn(), 650);
    }
  });

  btnTeam.addEventListener("click", () => {
    if (!poke.inBattle) return;
    poke.teamPage = (poke.teamPage + 1) % 3;
    if (poke.teamPage === 0){
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(0,2).join(" | ");
    } else if (poke.teamPage === 1){
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(2,4).join(" | ");
    } else {
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(4).join(" | ");
    }
    setTimeout(() => enemyTurn(), 650);
  });

  btnRun.addEventListener("click", () => {
    if (!poke.inBattle) return;
    battleText.textContent = "You canâ€™t run from love.";
    btnRun.animate([{transform:"translateX(0px)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0px)"}], {duration:360});
    setTimeout(() => enemyTurn(), 650);
  });

  // ========== Saga -> Capture ==========
  const sagaChapterEl = document.getElementById("sagaChapter");
  const sagaText = document.getElementById("sagaText");
  const advanceSaga = document.getElementById("advanceSaga");
  const sagaView = document.getElementById("sagaView");
  const captureView = document.getElementById("captureView");
  const throwLoveBall = document.getElementById("throwLoveBall");
  const throwShinyBall = document.getElementById("throwShinyBall");
  const captureMsg = document.getElementById("captureMsg");

  let sagaStep = 1;
  const sagaLines = {
    1: `I â€” â€œWe met and my life got better.â€`,
    2: `II â€” â€œWe became my favorite team.â€`,
    3: `III â€” â€œWill you be my Valentine?â€`
  };
  function toRoman(n){ return n === 1 ? "I" : n === 2 ? "II" : "III"; }

  advanceSaga.addEventListener("click", () => {
    sagaStep = Math.min(3, sagaStep + 1);
    sagaChapterEl.textContent = toRoman(sagaStep);
    sagaText.textContent = sagaLines[sagaStep];
    if (sagaStep === 3){
      sagaView.classList.add("hidden");
      captureView.classList.remove("hidden");
      try { confetti({ particleCount: 140, spread: 90, origin: { y: 0.55 } }); } catch {}
    }
  });

  function captureAttempt(shiny=false){
    if (yesLocked || noLocked){
      captureMsg.textContent = "LOCKED ğŸ˜ˆ Defeat the boss first!";
      return;
    }
    captureMsg.textContent = shiny ? "Shiny captured!! ğŸ’šâœ¨ Valentine accepted!!" : "Captured!! ğŸ’˜ Valentine accepted!!";
    try { confetti({ particleCount: 220, spread: 95, origin: { y: 0.6 } }); } catch {}
    hint.textContent = "Okay now go click YES ğŸ˜¤ğŸ’";
    yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.12)"},{transform:"scale(1)"}], {duration:700, iterations:2});
  }
  throwLoveBall.addEventListener("click", () => captureAttempt(false));
  throwShinyBall.addEventListener("click", () => captureAttempt(true));

  // ========== Booster ==========
  const openBooster = document.getElementById("openBooster");
  const boosterResult = document.getElementById("boosterResult");
  openBooster.addEventListener("click", () => {
    boosterResult.classList.remove("hidden");
    boosterResult.animate([{transform:"scale(0.98)", opacity:0},{transform:"scale(1)", opacity:1}], {duration:420, easing:"cubic-bezier(.2,.9,.2,1)"});
    try { confetti({ particleCount: 160, spread: 85, origin: { y: 0.55 } }); } catch {}
  });

  // ========== Boss arena background image (PUT YOUR FILE NEXT TO THIS HTML) ==========
  // Save your castle image as: boss-bg.png (same folder as this HTML)
  const BOSS_BG_URL = "boss-bg.png";
  const bossBgImg = new Image();
  bossBgImg.src = BOSS_BG_URL;
  let bossBgReady = false;
  bossBgImg.onload = () => (bossBgReady = true);

  function drawCoverImage(ctx, img, w, h) {
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.max(w / iw, h / ih);
    const nw = iw * scale;
    const nh = ih * scale;
    const x = (w - nw) / 2;
    const y = (h - nh) / 2;
    ctx.drawImage(img, x, y, nw, nh);
  }

  // ========== Boss fight + platformer ==========
  const bossCanvas = document.getElementById("bossCanvas");
  const bossOverlay = document.getElementById("bossOverlay");
  const bossMsg = document.getElementById("bossMsg");
  const playerHPBar = document.getElementById("playerHPBar");
  const bossHPBar = document.getElementById("bossHPBar");
  const loveBar = document.getElementById("loveBar");
  const laughFlash = document.getElementById("laughFlash");

  const defaultBossOverlayHTML = bossOverlay.innerHTML;
  const bossCtx2 = bossCanvas.getContext("2d");
  let bossRaf = null;

  function fitCanvasToCSS(canvas, ctx) {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  fitCanvasToCSS(bossCanvas, bossCtx2);

  // Shared keys
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," "].includes(e.key)) {
      keys.add(e.key);
      if (e.key === " ") e.preventDefault();
    }
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key));

  // Boss touch controls
  let bossTouchActive = false, bossTouchX = 0, bossTouchY = 0;
  bossCanvas.addEventListener("pointerdown", (e) => {
    bossTouchActive = true;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
    if (bossGame.running) bossShoot();
  });
  bossCanvas.addEventListener("pointermove", (e) => {
    if (!bossTouchActive) return;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
  });
  window.addEventListener("pointerup", () => (bossTouchActive = false));

  const bossGame = {
    running: false,
    t: 0,
    lastShot: 0,
    phaseTimer: 0,
    pattern: "spray",
    phase2: false,
    blackHole: { active: false, timer: 0, cool: 2.0 },
    bullets: [],
    beams: [],
    particles: [],
    player: { x: 120, y: 260, r: 10, hp: 5, maxHp: 5, inv: 0 },
    boss:   { x: 0, y: 0, r: 28, hp: 100, maxHp: 100, wob: 0 }
  };

  function clamp2(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function dist2(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

  function setBossBars(){
    playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
    bossHPBar.style.width = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
    const lovePct = (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 100;
    loveBar.style.width = lovePct.toFixed(1) + "%";

    // keep battle music intensity synced during boss fight
    if (bossGame.running && battleCtx) {
      const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
      const intensity = 1 + Math.floor((1 - hpPct) * 5);
      updateBattleIntensity(intensity);
    }
  }

  function magalorLaugh() {
    laughFlash.style.opacity = "1";
    try {
      laughFlash.animate(
        [
          { transform: "translateX(-50%) scale(0.85)", opacity: 0 },
          { transform: "translateX(-50%) scale(1.05)", opacity: 1, offset: 0.35 },
          { transform: "translateX(-50%) scale(1.0)", opacity: 1, offset: 0.75 },
          { transform: "translateX(-50%) scale(0.95)", opacity: 0 }
        ],
        { duration: 900, easing: "cubic-bezier(.2,.9,.2,1)" }
      );
    } catch {}
    setTimeout(() => (laughFlash.style.opacity = "0"), 900);
  }

  function resetBossFight(){
    bossGame.running = false;
    bossGame.t = 0;
    bossGame.lastShot = 0;
    bossGame.phaseTimer = 0;
    bossGame.pattern = "spray";
    bossGame.phase2 = false;
    bossGame.blackHole.active = false;
    bossGame.blackHole.timer = 0;
    bossGame.blackHole.cool = 2.0;

    bossGame.bullets.length = 0;
    bossGame.beams.length = 0;
    bossGame.particles.length = 0;

    bossGame.player.x = 120;
    bossGame.player.y = 260;
    bossGame.player.hp = bossGame.player.maxHp = 5;
    bossGame.player.inv = 0;

    bossGame.boss.hp = bossGame.boss.maxHp = 100;
    bossGame.boss.wob = 0;

    blackholeGif.style.opacity = "0";

    setBossBars();
    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = defaultBossOverlayHTML;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Start Boss Fight";
  }

  function spawnBossParticle(x,y,emoji){
    bossGame.particles.push({
      x,y,
      vx:(Math.random()*2-1)*1.2,
      vy:(Math.random()*2-1)*1.2 - 0.8,
      life: 40 + Math.random()*20,
      emoji
    });
  }

  function bossShoot(){
    const now = performance.now();
    if (now - bossGame.lastShot < 120) return;
    bossGame.lastShot = now;

    bossGame.beams.push({
      x: bossGame.player.x,
      y: bossGame.player.y - 12,
      vx: 0,
      vy: -7.6,
      r: 6
    });
    spawnBossParticle(bossGame.player.x, bossGame.player.y-10, "ğŸ’");
  }

  function fireBossBullet(angle, speed, kind="heart"){
    bossGame.bullets.push({
      x: bossGame.boss.x,
      y: bossGame.boss.y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      r: kind === "orb" ? 8 : 7,
      kind
    });
  }

  function chooseBossPattern(){
    const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
    const pool = hpPct > 0.65 ? ["spray","ring"]
                : hpPct > 0.30 ? ["spray","ring","dash"]
                : ["spray","ring","dash","spiral"];
    bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
    bossGame.phaseTimer = 0;
  }

  function roundRectPath(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  function drawHeartShape(ctx, x, y, size){
    ctx.beginPath();
    ctx.moveTo(x, y + size*0.25);
    ctx.bezierCurveTo(x - size, y - size*0.35, x - size*0.6, y - size, x, y - size*0.45);
    ctx.bezierCurveTo(x + size*0.6, y - size, x + size, y - size*0.35, x, y + size*0.25);
    ctx.closePath();
  }

  function drawMagolorLikeBoss(ctx, x, y, scale){
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);

    ctx.globalAlpha = 0.24;
    ctx.beginPath();
    ctx.ellipse(0, 14, 54, 28, 0, 0, Math.PI*2);
    ctx.fillStyle = "#111827";
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.beginPath();
    ctx.moveTo(-52, 10);
    ctx.quadraticCurveTo(0, 64, 52, 10);
    ctx.quadraticCurveTo(0, 36, -52, 10);
    ctx.closePath();
    ctx.fillStyle = "#0b1224";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, -6, 44, 38, 0, 0, Math.PI*2);
    ctx.fillStyle = "#2563eb";
    ctx.fill();

    ctx.beginPath(); ctx.moveTo(-24, -30); ctx.lineTo(-52, -58); ctx.lineTo(-28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();
    ctx.beginPath(); ctx.moveTo(24, -30); ctx.lineTo(52, -58); ctx.lineTo(28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, -6, 30, 24, 0, 0, Math.PI*2);
    ctx.fillStyle = "#0b1020";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(-10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde047";
    ctx.fill();

    ctx.beginPath();
    ctx.roundRect(-46, 4, 92, 24, 12);
    ctx.fillStyle = "#f8fafc";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(-56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde68a";
    ctx.fill();

    ctx.restore();
  }

  function updateBoss(dt){
    bossGame.t += dt;
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    bossGame.boss.wob += dt;
    bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 95;
    bossGame.boss.y = 95 + Math.sin(bossGame.boss.wob * 1.1) * 16;

    let mx = 0, my = 0;
    if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
    if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
    if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
    if (keys.has("ArrowDown") || keys.has("s")) my += 1;

    if (bossTouchActive){
      const dx = bossTouchX - bossGame.player.x;
      const dy = bossTouchY - bossGame.player.y;
      mx = clamp2(dx / 30, -1, 1);
      my = clamp2(dy / 30, -1, 1);
    }

    const speed = 4.25;
    bossGame.player.x = clamp2(bossGame.player.x + mx * speed, 18, w - 18);
    bossGame.player.y = clamp2(bossGame.player.y + my * speed, 120, h - 18);

    if (keys.has(" ")) bossShoot();

    bossGame.phaseTimer += dt;
    const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.7;
    if (bossGame.phaseTimer > 2.2) chooseBossPattern();

    if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5) {
      bossGame.phase2 = true;
      magalorLaugh();
      bossMsg.textContent = "PHASE 2 ğŸ˜³ BLACK HOLE PULL ACTIVATED!";
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ–¤");
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’˜");
    }

    if (bossGame.phase2) {
      bossGame.blackHole.cool -= dt;
      if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0) {
        bossGame.blackHole.active = true;
        bossGame.blackHole.timer = 1.6;
        bossGame.blackHole.cool = 4.2;
        magalorLaugh();
        bossMsg.textContent = "BLACK HOLE PULL ğŸ–¤ğŸ’«";
      }

      if (bossGame.blackHole.active) {
        blackholeGif.style.opacity = "0.95";
        bossGame.blackHole.timer -= dt;
        if (bossGame.blackHole.timer <= 0) {
          bossGame.blackHole.active = false;
          blackholeGif.style.opacity = "0";
          bossMsg.textContent = "Keep going!! Turn chaos into cuddles ğŸ˜¤ğŸ’";
        } else {
          const dx = bossGame.boss.x - bossGame.player.x;
          const dy = bossGame.boss.y - bossGame.player.y;
          const d = Math.sqrt(dx*dx + dy*dy) || 1;
          const pull = 3.3 * (1 - Math.min(d / 520, 1));
          bossGame.player.x += (dx / d) * pull;
          bossGame.player.y += (dy / d) * pull;
          bossGame.player.x = clamp2(bossGame.player.x, 18, w - 18);
          bossGame.player.y = clamp2(bossGame.player.y, 120, h - 18);
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’”");
        }
      } else {
        blackholeGif.style.opacity = "0";
      }
    } else {
      blackholeGif.style.opacity = "0";
    }

    if (bossGame.pattern === "spray"){
      if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
        const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
        const spread = 0.20 + 0.10 * intensity;
        fireBossBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.75*intensity, "heart");
      }
    } else if (bossGame.pattern === "ring"){
      if (bossGame.phaseTimer < dt + 0.02){
        const n = 10 + Math.floor(intensity*4);
        for (let i=0;i<n;i++){
          const a = (Math.PI*2) * (i/n);
          fireBossBullet(a, 2.35 + 0.7*intensity, "orb");
        }
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’—");
      }
    } else if (bossGame.pattern === "dash"){
      if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
        const laneY = 150 + Math.random() * (h - 190);
        bossGame.bullets.push({
          x: -20, y: laneY, vx: 6.2 + 1.25*intensity, vy: 0, r: 9, kind:"dash"
        });
      }
    } else if (bossGame.pattern === "spiral"){
      if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
        const base = bossGame.boss.wob * 2.2;
        fireBossBullet(base, 2.15 + 0.95*intensity, "heart");
      }
    }

    for (const b of bossGame.bullets){ b.x += b.vx; b.y += b.vy; }
    bossGame.bullets = bossGame.bullets.filter(b => b.x > -70 && b.x < w+70 && b.y > -70 && b.y < h+70);

    for (const p of bossGame.beams){ p.x += p.vx; p.y += p.vy; }
    bossGame.beams = bossGame.beams.filter(p => p.y > -50);

    for (const pt of bossGame.particles){
      pt.x += pt.vx; pt.y += pt.vy; pt.vy += 0.03; pt.life -= 1;
    }
    bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

    for (let i = bossGame.beams.length - 1; i >= 0; i--){
      const p = bossGame.beams[i];
      if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
        bossGame.beams.splice(i,1);
        bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "âœ¨");
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’˜");
        setBossBars();
        if (bossGame.boss.hp <= 0) winBossFight();
      }
    }

    if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
    for (let i = bossGame.bullets.length - 1; i >= 0; i--){
      const b = bossGame.bullets[i];
      if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
        bossGame.bullets.splice(i,1);
        if (bossGame.player.inv <= 0){
          bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
          bossGame.player.inv = 0.9;
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’¥");
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’”");
          setBossBars();
          if (bossGame.player.hp <= 0) loseBossFight();
        }
      }
    }
  }

  function drawBoss(){
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    bossCtx2.clearRect(0,0,w,h);

    // âœ… CASTLE BACKGROUND (your screenshot) â€” save it as boss-bg.png next to this HTML
    if (bossBgReady) {
      drawCoverImage(bossCtx2, bossBgImg, w, h);
    } else {
      // fallback while loading
      const g = bossCtx2.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, "rgba(2, 6, 23, 0.75)");
      g.addColorStop(1, "rgba(88, 28, 135, 0.45)");
      bossCtx2.fillStyle = g;
      bossCtx2.fillRect(0, 0, w, h);
    }

    // overlay for readability
    bossCtx2.fillStyle = "rgba(0,0,0,0.18)";
    bossCtx2.fillRect(0,0,w,h);

    // twinkle pixels
    bossCtx2.globalAlpha = 0.35;
    bossCtx2.fillStyle = "#ffffff";
    for (let i = 0; i < 26; i++) {
      const sx = (i * 97) % w;
      const sy = (i * 53) % Math.max(1, Math.floor(h * 0.6));
      bossCtx2.fillRect(sx, sy, 2, 2);
    }
    bossCtx2.globalAlpha = 1;

    // boss
    drawMagolorLikeBoss(bossCtx2, bossGame.boss.x, bossGame.boss.y, 0.75);

    // player
    bossCtx2.save();
    bossCtx2.translate(bossGame.player.x, bossGame.player.y);
    const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
    bossCtx2.globalAlpha = blink;
    bossCtx2.fillStyle = "#ef4444";
    bossCtx2.beginPath();
    bossCtx2.moveTo(0, 9);
    bossCtx2.bezierCurveTo(-16, -4, -10, -20, 0, -10);
    bossCtx2.bezierCurveTo(10, -20, 16, -4, 0, 9);
    bossCtx2.fill();
    bossCtx2.restore();

    // bullets
    for (const b of bossGame.bullets){
      bossCtx2.save();
      bossCtx2.translate(b.x, b.y);
      if (b.kind === "orb"){
        bossCtx2.globalAlpha = 0.92;
        bossCtx2.beginPath(); bossCtx2.arc(0,0,b.r,0,Math.PI*2);
        bossCtx2.fillStyle = "#a78bfa";
        bossCtx2.fill();
      } else if (b.kind === "dash"){
        bossCtx2.globalAlpha = 0.95;
        roundRectPath(bossCtx2, -14, -5, 28, 10, 6);
        bossCtx2.fillStyle = "#fb7185";
        bossCtx2.fill();
      } else {
        bossCtx2.globalAlpha = 0.92;
        drawHeartShape(bossCtx2, 0, 0, b.r);
        bossCtx2.fillStyle = "#f43f5e";
        bossCtx2.fill();
      }
      bossCtx2.restore();
    }
    bossCtx2.globalAlpha = 1;

    // beams
    for (const p of bossGame.beams){
      bossCtx2.save();
      bossCtx2.translate(p.x, p.y);
      bossCtx2.globalAlpha = 0.88;
      roundRectPath(bossCtx2, -3, -12, 6, 24, 6);
      bossCtx2.fillStyle = "#22c55e";
      bossCtx2.fill();
      bossCtx2.restore();
    }

    // particles
    for (const pt of bossGame.particles){
      bossCtx2.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
      bossCtx2.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      bossCtx2.fillText(pt.emoji, pt.x, pt.y);
    }
    bossCtx2.globalAlpha = 1;
  }

  let bossLast = 0;
  function bossLoop(ts){
    if (!bossGame.running) return;
    if (!bossLast) bossLast = ts;
    const dt = Math.min(0.033, (ts - bossLast) / 1000);
    bossLast = ts;

    updateBoss(dt);
    drawBoss();
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function startBossFight(){
    resetBossFight();
    bossGame.running = true;

    // start boss music on user click (allowed)
    startBattleMusic(1);
    updateBattleIntensity(1);

    bossOverlay.style.opacity = "0";
    bossStartBtn.style.opacity = "0";
    bossStartBtn.style.pointerEvents = "none";

    bossMsg.textContent = "MAGALOR is being dramatic ğŸ˜³ Hit him with LOVE BEAMS.";
    document.body.classList.add("boss-mode");

    bossLast = 0;
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function stopBossFight(){
    bossGame.running = false;
    if (bossRaf) cancelAnimationFrame(bossRaf);
    bossRaf = null;
    document.body.classList.remove("boss-mode");
    blackholeGif.style.opacity = "0";
    stopBattleMusic();
  }

  function winBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">BOSS DEFEATED ğŸ’˜</div>
        <div class="text-sm font-semibold mt-2">Unlocked! Now click YES ğŸ˜¤ğŸ’</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Rematch (optional)";

    bossMsg.textContent = "Unlocked! YES + NO are now available.";
    unlockYesNo();

    try { confetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } }); } catch {}
  }

  function loseBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">You got bonked ğŸ’¥</div>
        <div class="text-sm font-semibold mt-2">Try againâ€¦ turn chaos into cuddles ğŸ˜¤</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Try Again";
    bossMsg.textContent = "Tip: Move in circles while shooting!";
  }

  bossStartBtn.addEventListener("click", startBossFight);
  resetBossFight();

// ========== Platformer (Valentine: Celeste C-Side++++ "ALL OF THEM" Dinner Date Edition) ==========
const platCanvas = document.getElementById("platCanvas");
const platCtx = platCanvas.getContext("2d");
const platStartBtn = document.getElementById("platStart");
const platOverlay = document.getElementById("platOverlay");
const platMsg = document.getElementById("platMsg");
const platCountEl = document.getElementById("platCount");

let platRaf = null;
let platLast = 0;

fitCanvasToCSS(platCanvas, platCtx);

const VDAY = {
  pink: "#ff4d8d",
  hotPink: "#ff2d6d",
  blush: "#ffd1dc",
  cream: "#fff5f7",
  lavender: "#d8ccff",
  mint: "#bff7e6",
  cocoa: "#6b3f2a",
  ink: "rgba(15,23,42,0.20)"
};

const SWEETS = ["ğŸ«", "ğŸŒ¹", "ğŸ’–", "ğŸ“", "ğŸ§", "ğŸ¬", "ğŸª"];

// --- â€œRoomsâ€ (camera snap) ---
const ROOM_W = 520;          // world units per room
const ROOM_COUNT = 12;       // longer
const LEVEL_W = ROOM_W * ROOM_COUNT;

const platGame = {
  running: false,

  // Win condition: collect everything (but deaths reset treats PER SEGMENT: B-side remix)
  heartsTarget: 36,
  heartsGot: 0,

  // core world
  camX: 0,
  levelW: LEVEL_W,

  // movement: tight + punishing
  gravity: 0.72,
  maxFall: 16.2,
  accel: 0.70,
  maxRun: 4.95,
  friction: 0.76,

  jumpVel: -9.45,
  wallJumpX: 6.15,
  wallJumpY: -9.10,
  wallSlideMax: 2.65,

  // VERY tight buffers
  coyoteMax: 0.035,
  jumpBufferMax: 0.045,

  // dash (only refilled by crystals)
  dashSpeed: 10.2,
  dashDuration: 0.115,
  dashCooldown: 0.070,

  // feather (free flight)
  featherMaxT: 4.25,
  featherAccel: 0.55,
  featherMaxV: 5.8,
  featherDamp: 0.90,

  // B-side remix: deaths reset treats (PER SEGMENT)
  bSideTreatReset: true,

  player: {
    x: 60, y: 160, w: 18, h: 22,
    vx: 0, vy: 0,
    onGround: false,
    onWall: 0,        // -1 left, +1 right
    facing: 1,

    coyote: 0,
    jumpBuffer: 0,

    dashAvail: 1,
    dashT: 0,
    dashCd: 0,

    featherT: 0
  },

  // â€œsegmentsâ€ divide the level into checkpoint chunks so treat-reset isnâ€™t impossible
  segment: 0,
  segCommitted: [],           // permanent collected per finished segment
  segCurrentCount: 0,

  spawn: { x: 60, y: 160 },
  deaths: 0,

  platforms: [],
  movers: [],                 // moving platforms
  crumble: [],                // crumble state

  hazards: [],                // spike strips
  hazardMovers: [],           // moving kill blocks
  windZones: [],              // wind areas
  noWallZones: [],            // zones where wall jump / slide is disabled

  hearts: [],                 // treats (seg-tagged)
  dashCrystals: [],           // crystals (normal + dashOnly)
  feathers: [],               // feather pickups
  checkpoints: [],

  goal: { x: LEVEL_W - 95, y: 128, w: 28, h: 28 },

  // dinner-date background state
  bg: { lights: [], sparkles: [], skyline: [] },

  prev: { jump: false, dash: false }
};

function rectsOverlap(a, b){
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}
function rand(min, max){ return min + Math.random()*(max-min); }
function sign(n){ return n < 0 ? -1 : (n > 0 ? 1 : 0); }
function clamp01(t){ return Math.max(0, Math.min(1, t)); }

function initDinnerBackground(){
  const w = platCanvas.getBoundingClientRect().width;
  const h = platCanvas.getBoundingClientRect().height;

  platGame.bg.lights = Array.from({ length: 22 }, (_, i) => ({
    t: i / 21,
    phase: rand(0, Math.PI*2),
    a: rand(0.45, 0.98)
  }));

  platGame.bg.sparkles = Array.from({ length: 30 }, () => ({
    x: rand(0, w),
    y: rand(0, h*0.65),
    r: rand(2, 8),
    a: rand(0.05, 0.17),
    phase: rand(0, Math.PI*2)
  }));

  platGame.bg.skyline = Array.from({ length: 36 }, (_, i) => ({
    x: i * 70,
    w: rand(35, 72),
    h: rand(30, 130),
    windows: Math.floor(rand(2, 6))
  }));
}

function drawDinnerBackground(ctx, w, h, cam, t){
  // dusk gradient
  const sky = ctx.createLinearGradient(0,0,0,h);
  sky.addColorStop(0, "rgba(22, 6, 34, 1)");
  sky.addColorStop(0.55, "rgba(88, 18, 70, 1)");
  sky.addColorStop(1, "rgba(255, 77, 141, 0.30)");
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,w,h);

  // bokeh sparkles
  ctx.save();
  ctx.globalCompositeOperation = "lighter";
  for (const s of platGame.bg.sparkles){
    const pulse = 0.5 + 0.5*Math.sin(t*1.6 + s.phase);
    ctx.globalAlpha = s.a * (0.6 + 0.6*pulse);
    ctx.beginPath();
    ctx.ellipse(s.x, s.y, s.r*(0.9+pulse*0.4), s.r*(0.9+pulse*0.4), 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255, 245, 247, 1)";
    ctx.fill();
  }
  ctx.restore();
  ctx.globalAlpha = 1;

  // window frame
  const wx = w*0.12, wy = h*0.08, ww = w*0.76, wh = h*0.58;

  ctx.save();
  ctx.globalAlpha = 0.95;
  ctx.fillStyle = "rgba(10, 8, 18, 0.55)";
  roundRectPath(ctx, wx-10, wy-10, ww+20, wh+20, 22);
  ctx.fill();

  ctx.fillStyle = "rgba(255, 255, 255, 0.06)";
  roundRectPath(ctx, wx, wy, ww, wh, 18);
  ctx.fill();

  ctx.strokeStyle = "rgba(255, 245, 247, 0.18)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(wx + ww*0.5, wy); ctx.lineTo(wx + ww*0.5, wy+wh);
  ctx.moveTo(wx, wy+wh*0.55); ctx.lineTo(wx+ww, wy+wh*0.55);
  ctx.stroke();
  ctx.restore();

  // skyline parallax inside window
  const px = -cam * 0.12;
  const baseY = wy + wh*0.92;

  ctx.save();
  ctx.beginPath();
  roundRectPath(ctx, wx, wy, ww, wh, 18);
  ctx.clip();

  ctx.globalAlpha = 0.35;
  const glow = ctx.createLinearGradient(0, wy+wh*0.3, 0, baseY);
  glow.addColorStop(0, "rgba(255, 77, 141, 0.10)");
  glow.addColorStop(1, "rgba(255, 245, 247, 0.04)");
  ctx.fillStyle = glow;
  ctx.fillRect(wx, wy, ww, wh);

  ctx.globalAlpha = 0.9;
  for (const b of platGame.bg.skyline){
    const bx = wx + ((b.x + px) % (ww + 160)) - 80;
    const by = baseY - b.h;
    ctx.fillStyle = "rgba(12, 10, 22, 0.95)";
    ctx.fillRect(bx, by, b.w, b.h);

    ctx.globalAlpha = 0.12 + 0.10*Math.sin(t*0.8 + (b.x*0.03));
    ctx.fillStyle = "rgba(255, 245, 247, 1)";
    for (let r=0;r<b.windows;r++){
      const wy2 = by + 8 + r*(b.h/(b.windows+1));
      ctx.fillRect(bx + 8, wy2, 6, 4);
      if (b.w > 45) ctx.fillRect(bx + 20, wy2, 6, 4);
      if (b.w > 60) ctx.fillRect(bx + 32, wy2, 6, 4);
    }
    ctx.globalAlpha = 0.9;
  }

  ctx.restore();
  ctx.globalAlpha = 1;

  // string lights across top
  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.strokeStyle = "rgba(255, 245, 247, 0.25)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(w*0.08, h*0.07);
  ctx.quadraticCurveTo(w*0.5, h*0.02, w*0.92, h*0.07);
  ctx.stroke();

  for (const bulb of platGame.bg.lights){
    const x = w*0.08 + bulb.t*(w*0.84);
    const y = h*0.07 + Math.sin(bulb.t*Math.PI)*(-8);
    const tw = 0.45 + 0.55*Math.sin(t*3.2 + bulb.phase);
    ctx.globalAlpha = bulb.a * (0.35 + 0.65*tw);

    ctx.beginPath();
    ctx.ellipse(x, y+10, 4.5, 6, 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255, 245, 247, 1)";
    ctx.fill();

    ctx.globalAlpha *= 0.45;
    ctx.beginPath();
    ctx.ellipse(x, y+10, 10, 14, 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255, 77, 141, 1)";
    ctx.fill();
  }
  ctx.restore();
  ctx.globalAlpha = 1;

  // table (foreground)
  ctx.save();
  ctx.globalAlpha = 0.95;
  const ty = h*0.70;
  ctx.fillStyle = "rgba(15, 10, 24, 0.75)";
  ctx.fillRect(0, ty, w, h-ty);

  const cloth = ctx.createLinearGradient(0, ty, 0, h);
  cloth.addColorStop(0, "rgba(255, 209, 220, 0.25)");
  cloth.addColorStop(1, "rgba(255, 245, 247, 0.10)");
  ctx.fillStyle = cloth;
  ctx.fillRect(0, ty+10, w, h-ty-10);

  // plates
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = "rgba(255, 245, 247, 0.65)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.ellipse(w*0.40, ty+55, 32, 14, 0, 0, Math.PI*2);
  ctx.ellipse(w*0.60, ty+55, 32, 14, 0, 0, Math.PI*2);
  ctx.stroke();

  // candles flicker
  const flick = 0.5 + 0.5*Math.sin(t*8.5);
  function candle(cx, cy){
    ctx.globalAlpha = 0.6;
    ctx.fillStyle = "rgba(255,245,247,0.85)";
    roundRectPath(ctx, cx-6, cy-18, 12, 22, 6);
    ctx.fill();

    ctx.globalAlpha = 0.8;
    ctx.beginPath();
    ctx.ellipse(cx, cy-25, 5, 8 + flick*2, 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255, 190, 90, 1)";
    ctx.fill();

    ctx.globalAlpha = 0.18 + flick*0.10;
    ctx.beginPath();
    ctx.ellipse(cx, cy-25, 18, 26, 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255, 77, 141, 1)";
    ctx.fill();
  }
  candle(w*0.50, ty+42);
  candle(w*0.48, ty+52);

  ctx.globalAlpha = 0.9;
  ctx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
  ctx.fillText("ğŸŒ¹", w*0.52, ty+78);
  ctx.restore();
}

function drawSprinklePlatform(ctx, x, y, w, h, alpha=1){
  ctx.save();
  ctx.globalAlpha = alpha;

  ctx.globalAlpha *= 0.18;
  ctx.fillStyle = "#000";
  roundRectPath(ctx, x+2, y+4, w, h, 14);
  ctx.fill();

  ctx.globalAlpha = alpha;

  const g = ctx.createLinearGradient(x, y, x, y+h);
  g.addColorStop(0, VDAY.cream);
  g.addColorStop(1, VDAY.blush);

  ctx.fillStyle = g;
  ctx.strokeStyle = VDAY.ink;
  ctx.lineWidth = 2;
  roundRectPath(ctx, x, y, w, h, 14);
  ctx.fill();
  ctx.stroke();

  ctx.globalAlpha = alpha*0.7;
  ctx.fillStyle = "#ffffff";
  roundRectPath(ctx, x+8, y+6, Math.max(0, w-16), Math.max(0, h-12), 12);
  ctx.fill();
  ctx.globalAlpha = alpha;

  for (let i = 0; i < Math.floor(w / 22); i++){
    const sx = x + 14 + i*22 + (Math.random()*4);
    const sy = y + 8 + (Math.random()*(h-16));
    ctx.save();
    ctx.translate(sx, sy);
    ctx.rotate((Math.random()*0.8)-0.4);
    ctx.globalAlpha = alpha*0.9;
    ctx.fillStyle = Math.random() < 0.5 ? VDAY.lavender : VDAY.mint;
    ctx.fillRect(-5, -1.5, 10, 3);
    ctx.restore();
  }

  ctx.font = "12px system-ui, Apple Color Emoji, Segoe UI Emoji";
  ctx.globalAlpha = alpha*0.35;
  const count = Math.max(1, Math.floor(w / 90));
  for (let i=0;i<count;i++){
    ctx.fillText("ğŸ’—", x + 18 + i*(w/(count)), y + h - 6);
  }

  ctx.restore();
}

function drawCupidHeart(ctx, cx, cy, size){
  ctx.save();
  ctx.translate(cx, cy);

  ctx.fillStyle = VDAY.hotPink;
  drawHeartShape(ctx, 0, 2, size);
  ctx.fill();

  ctx.globalAlpha = 0.35;
  ctx.fillStyle = "#fff";
  drawHeartShape(ctx, -3, -2, size*0.55);
  ctx.fill();
  ctx.globalAlpha = 1;

  // wings
  ctx.strokeStyle = "rgba(255,255,255,0.9)";
  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  ctx.beginPath();
  ctx.moveTo(-size*0.9, -1);
  ctx.quadraticCurveTo(-size*1.25, -size*0.45, -size*0.75, -size*0.85);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-size*0.75, 2);
  ctx.quadraticCurveTo(-size*1.1, -size*0.2, -size*0.65, -size*0.6);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(size*0.9, -1);
  ctx.quadraticCurveTo(size*1.25, -size*0.45, size*0.75, -size*0.85);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(size*0.75, 2);
  ctx.quadraticCurveTo(size*1.1, -size*0.2, size*0.65, -size*0.6);
  ctx.stroke();

  // cupid arrow
  ctx.strokeStyle = "rgba(255,255,255,0.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(-size*0.1, size*0.95);
  ctx.lineTo(size*0.9, size*0.15);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(size*0.85, size*0.15);
  ctx.lineTo(size*0.65, size*0.1);
  ctx.lineTo(size*0.75, size*0.3);
  ctx.stroke();

  ctx.restore();
}

function drawSpikes(ctx, s){
  ctx.save();
  ctx.globalAlpha = 0.95;
  ctx.fillStyle = "rgba(255, 45, 109, 0.90)";
  ctx.strokeStyle = "rgba(15,23,42,0.18)";
  ctx.lineWidth = 1;

  const count = Math.max(1, Math.floor((s.w || s.h) / 10));
  ctx.beginPath();

  if (s.dir === "up"){
    const y = s.y + s.h;
    for (let i=0;i<count;i++){
      const x0 = s.x + (i*(s.w/count));
      const x1 = s.x + ((i+1)*(s.w/count));
      const xm = (x0+x1)/2;
      ctx.moveTo(x0, y); ctx.lineTo(xm, s.y); ctx.lineTo(x1, y);
    }
  } else if (s.dir === "down"){
    const y = s.y;
    for (let i=0;i<count;i++){
      const x0 = s.x + (i*(s.w/count));
      const x1 = s.x + ((i+1)*(s.w/count));
      const xm = (x0+x1)/2;
      ctx.moveTo(x0, y); ctx.lineTo(xm, s.y + s.h); ctx.lineTo(x1, y);
    }
  } else if (s.dir === "left"){
    const x = s.x + s.w;
    for (let i=0;i<count;i++){
      const y0 = s.y + (i*(s.h/count));
      const y1 = s.y + ((i+1)*(s.h/count));
      const ym = (y0+y1)/2;
      ctx.moveTo(x, y0); ctx.lineTo(s.x, ym); ctx.lineTo(x, y1);
    }
  } else { // right
    const x = s.x;
    for (let i=0;i<count;i++){
      const y0 = s.y + (i*(s.h/count));
      const y1 = s.y + ((i+1)*(s.h/count));
      const ym = (y0+y1)/2;
      ctx.moveTo(x, y0); ctx.lineTo(s.x + s.w, ym); ctx.lineTo(x, y1);
    }
  }

  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

// ---------- Level building helpers ----------
function addPlatform(x,y,w,h, opt={}){
  platGame.platforms.push({ x,y,w,h, ...opt });
}
function addSpikes(x,y,w,h,dir){ platGame.hazards.push({ x,y,w,h,dir }); }
function addHazardMover(x,y,w,h, axis, range, speed){
  platGame.hazardMovers.push({ x,y,w,h, axis, range, speed, t:0 });
}
function addWindZone(x,y,w,h, ax, ay){
  platGame.windZones.push({ x,y,w,h, ax, ay });
}
function addNoWallZone(x,y,w,h){
  platGame.noWallZones.push({ x,y,w,h });
}
function addCrystal(x,y, dashOnly=false){
  platGame.dashCrystals.push({ x,y, used:false, dashOnly });
}
function addFeather(x,y){
  platGame.feathers.push({ x,y, used:false });
}
function addCheckpoint(x,y, segNext){
  platGame.checkpoints.push({ x,y,w:26,h:40, hit:false, segNext });
}
function addTreat(x,y, seg){
  platGame.hearts.push({ x,y, taken:false, seg, emoji: SWEETS[Math.floor(Math.random()*SWEETS.length)] });
}

// ---------- Reset / Build the â€œALL OF THEMâ€ level ----------
function resetPlatformer(){
  platGame.running = false;
  platGame.deaths = 0;

  // segments: 0..3 (each has a checkpoint to commit progress)
  platGame.segment = 0;
  platGame.segCommitted = [0,0,0,0];
  platGame.segCurrentCount = 0;

  platGame.heartsGot = 0;
  platCountEl.textContent = "0";

  platMsg.innerHTML = `
    <b>C-Side++++ Love Run ğŸ’˜ (ALL OF THEM)</b><br>
    Camera snaps by room â€¢ Wind zones â€¢ Dash-only crystals â€¢ Feather flight â€¢ Treat reset on death (per segment).<br>
    <span class="opacity-80">Move: â†â†’/A D â€¢ Jump: â†‘/W/Space â€¢ Dash: Shift/X + direction â€¢ Dash refills only via ğŸ’ (some require dashing).</span>
  `;

  platOverlay.style.opacity = "1";
  platStartBtn.style.opacity = "1";
  platStartBtn.style.pointerEvents = "auto";
  platStartBtn.textContent = "Start C-Side++++ ğŸ’";

  // player
  const p = platGame.player;
  p.x = 60; p.y = 160;
  p.vx = 0; p.vy = 0;
  p.onGround = false;
  p.onWall = 0;
  p.facing = 1;
  p.coyote = 0;
  p.jumpBuffer = 0;
  p.dashAvail = 1;
  p.dashT = 0;
  p.dashCd = 0;
  p.featherT = 0;

  platGame.spawn = { x: 60, y: 160 };
  platGame.camX = 0;

  // clear level arrays
  platGame.platforms = [];
  platGame.movers = [];
  platGame.crumble = [];
  platGame.hazards = [];
  platGame.hazardMovers = [];
  platGame.windZones = [];
  platGame.noWallZones = [];
  platGame.hearts = [];
  platGame.dashCrystals = [];
  platGame.feathers = [];
  platGame.checkpoints = [];

  // --- Build rooms (0..11) ---
  // Each room has its own cruelty theme. Y baseline ~340 ground.
  const GROUND_Y = 350;

  // global ground
  addPlatform(0, GROUND_Y, platGame.levelW, 95, { id:"ground" });

  // Helper offsets
  const R = (i) => i * ROOM_W;

  // ROOM 0: warmup into crumble + pit
  addPlatform(R(0)+0,   310, 240, 22);
  addPlatform(R(0)+270, 270, 60, 16);
  addPlatform(R(0)+350, 235, 58, 16, { crumble:true });
  addPlatform(R(0)+435, 260, 56, 16);
  addSpikes  (R(0)+240, 332, 30, 18, "up");
  addSpikes  (R(0)+330, 332, 20, 18, "up");
  addTreat   (R(0)+120, 265, 0);
  addTreat   (R(0)+295, 235, 0);
  addCrystal (R(0)+460, 210, false); // normal crystal

  // ROOM 1: wall tech + NO-WALL zone strip (forces dash usage)
  addPlatform(R(1)+120, 305, 90, 18);
  addPlatform(R(1)+255, 200, 22, 150); // wall
  addPlatform(R(1)+345, 140, 22, 210); // wall
  addNoWallZone(R(1)+220, 90, 260, 190); // no wall jump/slide in mid-air section
  addSpikes(R(1)+277, 230, 14, 105, "right");
  addSpikes(R(1)+331, 190, 14, 140, "left");
  addTreat(R(1)+150, 260, 0);
  addTreat(R(1)+360, 110, 0);
  addCrystal(R(1)+410, 120, true); // dash-only crystal (must be dashing to collect)

  // ROOM 2: moving platforms + spike sea + wind nudge
  addPlatform(R(2)+60,  300, 85, 16);
  addPlatform(R(2)+190, 235, 70, 14, { moving:true, axis:"x", range: 120, speed: 1.95 });
  addPlatform(R(2)+350, 190, 70, 14, { moving:true, axis:"y", range: 75,  speed: 1.65 });
  addPlatform(R(2)+455, 235, 70, 14, { moving:true, axis:"x", range: 115, speed: 2.15 });
  addSpikes(R(2)+0,  332, 520, 18, "up"); // whole floor deadly here
  addWindZone(R(2)+0, 80, 520, 250, +0.020, -0.006); // gentle up-right push
  addTreat(R(2)+85,  255, 0);
  addTreat(R(2)+420, 150, 0);
  addCrystal(R(2)+250, 170, false);

  // ROOM 3: feather flight corridor (precision through hazards) + checkpoint (commit seg0 -> seg1)
  addPlatform(R(3)+40,  300, 70, 16);
  addPlatform(R(3)+430, 300, 70, 16);
  addSpikes(R(3)+120, 190, 12, 160, "right");
  addSpikes(R(3)+390, 190, 12, 160, "left");
  addSpikes(R(3)+130, 332, 260, 18, "up");
  addWindZone(R(3)+140, 90, 240, 200, 0.0, -0.020); // strong updraft for feather control
  addFeather(R(3)+260, 170);
  addTreat(R(3)+240, 130, 0);
  addCheckpoint(R(3)+470, 255, 1); // when hit, segment advances to 1

  // ROOM 4: segment 1 start â€“ conveyors + crumble staircase
  addPlatform(R(4)+20,  308, 120, 18, { conveyor:+1.05 });
  addPlatform(R(4)+170, 275, 120, 18, { conveyor:-1.05 });
  addPlatform(R(4)+320, 245, 110, 18, { conveyor:+1.15 });
  addSpikes(R(4)+0, 332, 520, 18, "up");
  addPlatform(R(4)+60,  205, 52, 16, { crumble:true });
  addPlatform(R(4)+135, 180, 52, 16, { crumble:true });
  addPlatform(R(4)+210, 155, 52, 16, { crumble:true });
  addPlatform(R(4)+285, 130, 52, 16, { crumble:true });
  addPlatform(R(4)+360, 155, 52, 16, { crumble:true });
  addTreat(R(4)+85,  255, 1);
  addTreat(R(4)+205, 235, 1);
  addTreat(R(4)+300, 210, 1);
  addCrystal(R(4)+400, 120, true); // dash-only crystal at top

  // ROOM 5: moving hazard blocks + micro ledges + wind that lies
  addPlatform(R(5)+60,  260, 54, 16);
  addPlatform(R(5)+140, 220, 54, 16, { crumble:true });
  addPlatform(R(5)+220, 180, 54, 16);
  addPlatform(R(5)+300, 220, 54, 16, { crumble:true });
  addPlatform(R(5)+380, 260, 54, 16);

  addSpikes(R(5)+0, 332, 520, 18, "up");
  addHazardMover(R(5)+165, 290, 34, 34, "y", 110, 2.15);
  addHazardMover(R(5)+265, 295, 34, 34, "y", 95,  2.35);
  addHazardMover(R(5)+365, 292, 34, 34, "y", 120, 2.55);

  addWindZone(R(5)+0, 95, 520, 180, -0.018, 0.0); // push LEFT midair
  addTreat(R(5)+90,  210, 1);
  addTreat(R(5)+250, 150, 1);
  addTreat(R(5)+410, 210, 1);
  addCrystal(R(5)+455, 160, false);

  // ROOM 6: wall gauntlet + no-wall zones forcing dash timing + checkpoint (commit seg1 -> seg2)
  addPlatform(R(6)+40,  308, 120, 18);
  addPlatform(R(6)+220, 150, 22, 200);
  addPlatform(R(6)+320, 110, 22, 240);
  addPlatform(R(6)+420, 150, 22, 200);

  addSpikes(R(6)+242, 180, 14, 150, "right");
  addSpikes(R(6)+306, 140, 14, 190, "left");
  addSpikes(R(6)+442, 180, 14, 150, "right");

  addNoWallZone(R(6)+180, 90, 300, 160); // disables wall jump/slide in this band
  addSpikes(R(6)+180, 332, 340, 18, "up");

  addTreat(R(6)+70,  265, 1);
  addTreat(R(6)+340, 85,  1); // last treat in seg1
  addCheckpoint(R(6)+480, 255, 2);

  // ROOM 7: segment 2 start â€“ feather + wind maze + dash-only crystal gate
  addPlatform(R(7)+40,  300, 70, 16);
  addPlatform(R(7)+420, 300, 70, 16);

  addSpikes(R(7)+110, 190, 12, 160, "right");
  addSpikes(R(7)+398, 190, 12, 160, "left");
  addSpikes(R(7)+122, 332, 276, 18, "up");

  // Wind changes direction mid corridor
  addWindZone(R(7)+140, 90, 240, 80,  +0.020, -0.010);
  addWindZone(R(7)+140, 170,240, 80,  -0.020, -0.010);

  addFeather(R(7)+260, 165);
  addCrystal(R(7)+260, 110, true); // dash-only crystal (forces you to dash while flying)
  addTreat(R(7)+240, 125, 2);
  addTreat(R(7)+280, 125, 2);

  // ROOM 8: ultra tight moving platforms over spikes (classic â€œplease noâ€)
  addSpikes(R(8)+0, 332, 520, 18, "up");
  addPlatform(R(8)+60,  270, 70, 14, { moving:true, axis:"x", range: 160, speed: 2.55 });
  addPlatform(R(8)+220, 210, 70, 14, { moving:true, axis:"y", range: 95,  speed: 2.25 });
  addPlatform(R(8)+380, 160, 70, 14, { moving:true, axis:"x", range: 160, speed: 2.75 });
  addWindZone(R(8)+0, 90, 520, 240, +0.010, 0.0); // slight right push
  addTreat(R(8)+95,  220, 2);
  addTreat(R(8)+405, 115, 2);
  addCrystal(R(8)+260, 160, false);

  // ROOM 9: crumble runway + moving heartbreak blocks + no-wall zone
  addSpikes(R(9)+0, 332, 520, 18, "up");
  for (let i=0;i<6;i++){
    addPlatform(R(9)+60 + i*70, 255 - i*18, 52, 16, { crumble:true });
    addTreat(R(9)+70 + i*70, 220 - i*18, 2);
  }
  addHazardMover(R(9)+280, 285, 34, 34, "y", 140, 2.75);
  addHazardMover(R(9)+360, 285, 34, 34, "y", 120, 2.95);
  addNoWallZone(R(9)+140, 85, 320, 170);
  addCrystal(R(9)+470, 150, true);

  // ROOM 10: final segment checkpoint (commit seg2 -> seg3) + â€œdash or perishâ€ pillar
  addPlatform(R(10)+20, 308, 110, 18);
  addPlatform(R(10)+170, 190, 22, 160);
  addPlatform(R(10)+270, 140, 22, 210);
  addSpikes(R(10)+192, 215, 14, 120, "right");
  addSpikes(R(10)+256, 160, 14, 175, "left");
  addWindZone(R(10)+0, 100, 520, 230, -0.012, 0.0);
  addTreat(R(10)+60, 265, 2);
  addCheckpoint(R(10)+480, 255, 3);

  // ROOM 11: FINAL â€“ brutal micro hops + last feather + last crystal, then goal
  addSpikes(R(11)+0, 332, 520, 18, "up");
  addPlatform(R(11)+60,  260, 54, 16);
  addPlatform(R(11)+145, 220, 54, 16, { crumble:true });
  addPlatform(R(11)+230, 180, 54, 16);
  addPlatform(R(11)+315, 220, 54, 16, { crumble:true });
  addPlatform(R(11)+400, 260, 54, 16);

  addSpikes(R(11)+130, 140, 14, 190, "right");
  addSpikes(R(11)+376, 140, 14, 190, "left");

  addFeather(R(11)+260, 145);
  addCrystal(R(11)+260, 105, true); // dash-only in final
  addTreat(R(11)+95,  210, 3);
  addTreat(R(11)+250, 135, 3);
  addTreat(R(11)+410, 210, 3);

  // goal area platform
  addPlatform(platGame.goal.x - 30, platGame.goal.y + 40, 120, 16);

  // Build movers state
  platGame.movers = platGame.platforms
    .filter(p => p.moving)
    .map(p => ({ ref: p, t: 0, lastX: p.x, lastY: p.y, dx: 0, dy: 0 }));

  // Build crumble state
  platGame.crumble = platGame.platforms
    .filter(p => p.crumble)
    .map(p => ({ ref: p, state: "solid", t: 0, respawnT: 0 }));

  initDinnerBackground();
}

// ---------- Death / Segment rules ----------
function recomputeHeartsGot(){
  const committed = platGame.segCommitted.reduce((a,b)=>a+b,0);
  platGame.heartsGot = committed + platGame.segCurrentCount;
  platCountEl.textContent = String(platGame.heartsGot);
}

function resetCurrentSegmentTreats(){
  // reset only hearts in current segment (B-side remix rule)
  for (const h of platGame.hearts){
    if (h.seg === platGame.segment) h.taken = false;
  }
  platGame.segCurrentCount = 0;
  recomputeHeartsGot();
}

function diePlatformer(){
  const p = platGame.player;
  platGame.deaths += 1;

  // reset dash crystals + feathers on death (Celeste-ish)
  for (const c of platGame.dashCrystals) c.used = false;
  for (const f of platGame.feathers) f.used = false;

  // reset crumble platforms on death
  for (const c of platGame.crumble){
    c.state = "solid";
    c.t = 0;
    c.respawnT = 0;
  }

  // B-side remix: reset treats
  if (platGame.bSideTreatReset) resetCurrentSegmentTreats();

  // respawn
  p.x = platGame.spawn.x;
  p.y = platGame.spawn.y;
  p.vx = 0; p.vy = 0;
  p.onGround = false;
  p.onWall = 0;
  p.coyote = 0;
  p.jumpBuffer = 0;
  p.dashAvail = 1;
  p.dashT = 0;
  p.dashCd = 0;
  p.featherT = 0;

  platMsg.innerHTML = `ğŸ’” Respawn! Deaths: <b>${platGame.deaths}</b> â€¢ Segment: <b>${platGame.segment+1}</b>/${platGame.segCommitted.length}`;
  try { confetti({ particleCount: 20, spread: 70, origin: { y: 0.55 } }); } catch {}
}

// ---------- Moving / Crumble / Hazards ----------
function updateMovingPlatforms(dt){
  for (const m of platGame.movers){
    const p = m.ref;
    m.lastX = p.x; m.lastY = p.y;

    m.t += dt * p.speed;
    if (p.axis === "x"){
      p.x = (p.baseX ?? (p.baseX = p.x)) + Math.sin(m.t * Math.PI * 2) * p.range;
    } else {
      p.y = (p.baseY ?? (p.baseY = p.y)) + Math.sin(m.t * Math.PI * 2) * p.range;
    }

    m.dx = p.x - m.lastX;
    m.dy = p.y - m.lastY;
  }
}

function updateHazardMovers(dt){
  for (const hz of platGame.hazardMovers){
    hz.t += dt * hz.speed;
    const s = Math.sin(hz.t * Math.PI * 2);
    if (hz.axis === "y"){
      hz.y = (hz.baseY ?? (hz.baseY = hz.y)) + s * hz.range;
    } else {
      hz.x = (hz.baseX ?? (hz.baseX = hz.x)) + s * hz.range;
    }
  }
}

function updateCrumble(dt){
  for (const c of platGame.crumble){
    if (c.state === "solid") continue;

    if (c.state === "falling"){
      c.t -= dt;
      if (c.t <= 0){
        c.state = "gone";
        c.respawnT = 1.15; // fast respawn -> still evil
      }
    } else if (c.state === "gone"){
      c.respawnT -= dt;
      if (c.respawnT <= 0){
        c.state = "solid";
        c.t = 0;
      }
    }
  }
}

function isPlatformSolid(plat){
  if (!plat.crumble) return true;
  const c = platGame.crumble.find(x => x.ref === plat);
  return c ? (c.state !== "gone") : true;
}

function inZone(list, p){
  const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
  for (const z of list){
    if (rectsOverlap(pb, z)) return true;
  }
  return false;
}

// ---------- Physics / Collisions ----------
function moveAndCollide(dt){
  const p = platGame.player;
  p.onWall = 0;

  // Horizontal
  p.x += p.vx;

  for (const plat of platGame.platforms){
    if (!isPlatformSolid(plat)) continue;
    const a = { x: p.x, y: p.y, w: p.w, h: p.h };
    const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
    if (!rectsOverlap(a,b)) continue;

    if (p.vx > 0){
      p.x = plat.x - p.w;
      p.vx = 0;
      p.onWall = +1;
    } else if (p.vx < 0){
      p.x = plat.x + plat.w;
      p.vx = 0;
      p.onWall = -1;
    }
  }

  // Vertical
  p.y += p.vy;
  p.onGround = false;
  let landedOn = null;

  for (const plat of platGame.platforms){
    if (!isPlatformSolid(plat)) continue;
    const a = { x: p.x, y: p.y, w: p.w, h: p.h };
    const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
    if (!rectsOverlap(a,b)) continue;

    if (p.vy > 0){
      p.y = plat.y - p.h;
      p.vy = 0;
      p.onGround = true;
      landedOn = plat;

      // carry moving platforms
      if (plat.moving){
        const mover = platGame.movers.find(m => m.ref === plat);
        if (mover){
          p.x += mover.dx;
          p.y += mover.dy;
        }
      }
    } else if (p.vy < 0){
      p.y = plat.y + plat.h;
      p.vy = 0;
    }
  }

  // conveyors
  if (landedOn && landedOn.conveyor){
    p.x += landedOn.conveyor;
  }

  // crumble trigger
  if (landedOn && landedOn.crumble){
    const c = platGame.crumble.find(x => x.ref === landedOn);
    if (c && c.state === "solid"){
      c.state = "falling";
      c.t = 0.20; // VERY fast crumble
    }
  }
}

// ---------- Main Update ----------
function updatePlatformer(dt){
  const w = platCanvas.getBoundingClientRect().width;

  const left  = keys.has("ArrowLeft")  || keys.has("a");
  const right = keys.has("ArrowRight") || keys.has("d");
  const up    = keys.has("ArrowUp")    || keys.has("w");
  const down  = keys.has("ArrowDown")  || keys.has("s");
  const jumpHeld = up || keys.has(" ") || keys.has("Spacebar");
  const dashHeld = keys.has("Shift") || keys.has("x");

  const pressedJump = jumpHeld && !platGame.prev.jump;
  const pressedDash = dashHeld && !platGame.prev.dash;
  platGame.prev.jump = jumpHeld;
  platGame.prev.dash = dashHeld;

  const p = platGame.player;

  if (left) p.facing = -1;
  if (right) p.facing = +1;

  // movers / hazards / crumble
  updateMovingPlatforms(dt);
  updateHazardMovers(dt);
  updateCrumble(dt);

  // buffers
  p.jumpBuffer = Math.max(0, p.jumpBuffer - dt);
  p.coyote = Math.max(0, p.coyote - dt);
  if (pressedJump) p.jumpBuffer = platGame.jumpBufferMax;

  // dash timers
  p.dashCd = Math.max(0, p.dashCd - dt);
  p.dashT  = Math.max(0, p.dashT  - dt);

  // feather timer
  p.featherT = Math.max(0, p.featherT - dt);
  const feathering = p.featherT > 0;

  // coyote
  if (p.onGround) p.coyote = platGame.coyoteMax;

  // apply wind zones (ALWAYS, even during feather/dash)
  for (const wz of platGame.windZones){
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    if (rectsOverlap(pb, wz)){
      // tuned to feel like constant force (dt-compensated)
      p.vx += wz.ax * (dt * 60);
      p.vy += wz.ay * (dt * 60);
    }
  }

  // FEATHER MODE: free flight control
  if (feathering){
    // damp
    p.vx *= platGame.featherDamp;
    p.vy *= platGame.featherDamp;

    // accelerate with arrows
    const fx = (right ? 1 : 0) - (left ? 1 : 0);
    const fy = (down  ? 1 : 0) - (up   ? 1 : 0);

    p.vx += fx * platGame.featherAccel;
    p.vy += fy * platGame.featherAccel;

    p.vx = clamp2(p.vx, -platGame.featherMaxV, platGame.featherMaxV);
    p.vy = clamp2(p.vy, -platGame.featherMaxV, platGame.featherMaxV);
  } else {
    // normal horizontal accel unless dashing
    if (p.dashT <= 0){
      if (left)  p.vx -= platGame.accel;
      if (right) p.vx += platGame.accel;
      if (!left && !right) p.vx *= platGame.friction;
      p.vx = clamp2(p.vx, -platGame.maxRun, platGame.maxRun);
    }

    // gravity unless dashing
    if (p.dashT <= 0){
      p.vy += platGame.gravity;
      p.vy = clamp2(p.vy, -22, platGame.maxFall);
    }
  }

  // movement + collisions
  moveAndCollide(dt);

  // no-wall zone disables wall slide/jump
  const noWallHere = inZone(platGame.noWallZones, p);

  // wall slide
  if (!feathering && !noWallHere && !p.onGround && p.onWall !== 0 && p.dashT <= 0 && p.vy > 0){
    p.vy = Math.min(p.vy, platGame.wallSlideMax);
  }

  // JUMP resolve
  if (p.jumpBuffer > 0){
    if (p.onGround || p.coyote > 0){
      p.vy = platGame.jumpVel;
      p.onGround = false;
      p.coyote = 0;
      p.jumpBuffer = 0;
    } else if (!feathering && !noWallHere && p.onWall !== 0){
      // wall jump away
      p.vy = platGame.wallJumpY;
      p.vx = -p.onWall * platGame.wallJumpX;
      p.jumpBuffer = 0;
    }
  }

  // DASH resolve (8-way)
  if (pressedDash && p.dashAvail > 0 && p.dashCd <= 0 && p.dashT <= 0){
    let dx = (right ? 1 : 0) - (left ? 1 : 0);
    let dy = (down  ? 1 : 0) - (up   ? 1 : 0);

    if (dx === 0 && dy === 0){
      dx = p.facing || 1;
      dy = 0;
    }

    const len = Math.hypot(dx, dy) || 1;
    dx /= len; dy /= len;

    p.vx = dx * platGame.dashSpeed;
    p.vy = dy * platGame.dashSpeed;
    p.dashAvail -= 1;
    p.dashT = platGame.dashDuration;
    p.dashCd = platGame.dashCooldown;
    p.onGround = false;

    try { confetti({ particleCount: 14, spread: 45, origin: { y: 0.6 } }); } catch {}
  }

  // bounds
  p.x = clamp2(p.x, 0, platGame.levelW - p.w);
  if (p.y > 560) diePlatformer();

  // Treat pickups
  for (const h of platGame.hearts){
    if (h.taken) continue;
    const hb = { x: h.x - 9, y: h.y - 12, w: 20, h: 20 };
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    if (rectsOverlap(pb, hb)){
      h.taken = true;
      if (h.seg === platGame.segment){
        platGame.segCurrentCount += 1;
      }
      recomputeHeartsGot();
      try { confetti({ particleCount: 45, spread: 80, origin: { y: 0.7 } }); } catch {}
      platMsg.innerHTML = `Sweet! ğŸ’ ${platGame.heartsGot}/${platGame.heartsTarget} â€¢ Deaths: <b>${platGame.deaths}</b> â€¢ Segment: <b>${platGame.segment+1}</b>`;
    }
  }

  // Crystals (dash refill). Some are DASH-ONLY: only trigger if currently dashing.
  for (const c of platGame.dashCrystals){
    if (c.used) continue;
    const cb = { x: c.x - 10, y: c.y - 10, w: 20, h: 20 };
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    if (!rectsOverlap(pb, cb)) continue;

    if (c.dashOnly && p.dashT <= 0){
      // not dashing: no refill (cruel)
      continue;
    }

    c.used = true;
    p.dashAvail = 1;
    try { confetti({ particleCount: 30, spread: 70, origin: { y: 0.6 } }); } catch {}
    platMsg.innerHTML = `Dash refilled ğŸ’ â€¢ Deaths: <b>${platGame.deaths}</b>`;
  }

  // Feather pickups
  for (const f of platGame.feathers){
    if (f.used) continue;
    const fb = { x: f.x - 10, y: f.y - 10, w: 20, h: 20 };
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    if (rectsOverlap(pb, fb)){
      f.used = true;
      p.featherT = platGame.featherMaxT;
      // feather sections are spicy: donâ€™t give free dash
      try { confetti({ particleCount: 24, spread: 70, origin: { y: 0.6 } }); } catch {}
      platMsg.innerHTML = `Feather flight ğŸª¶ for ${platGame.featherMaxT.toFixed(2)}s â€¢ Donâ€™t touch ğŸ’”`;
    }
  }

  // Checkpoints: commit current segment and advance to next
  for (const cp of platGame.checkpoints){
    const cpb = { x: cp.x, y: cp.y, w: cp.w, h: cp.h };
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    if (cp.hit) continue;

    if (rectsOverlap(pb, cpb)){
      cp.hit = true;

      // Commit segment progress (locks it in)
      platGame.segCommitted[platGame.segment] = platGame.segCurrentCount;

      // Advance segment
      platGame.segment = Math.min(cp.segNext, platGame.segCommitted.length - 1);
      platGame.segCurrentCount = 0;
      recomputeHeartsGot();

      platGame.spawn = { x: cp.x, y: cp.y - 30 };

      try { confetti({ particleCount: 90, spread: 95, origin: { y: 0.6 } }); } catch {}
      platMsg.innerHTML = `Checkpoint ğŸ’Œ Segment advanced! â€¢ Deaths: <b>${platGame.deaths}</b>`;
    }
  }

  // Hazards (static spikes)
  {
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    for (const hz of platGame.hazards){
      if (rectsOverlap(pb, hz)){
        diePlatformer();
        break;
      }
    }
  }

  // Hazards (moving heartbreak blocks)
  {
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    for (const hz of platGame.hazardMovers){
      const hb = { x: hz.x, y: hz.y, w: hz.w, h: hz.h };
      if (rectsOverlap(pb, hb)){
        diePlatformer();
        break;
      }
    }
  }

  // Camera snap to room
  // snap by player center x; keep clamped to world
  const roomIndex = Math.max(0, Math.min(ROOM_COUNT-1, Math.floor((p.x + p.w/2) / ROOM_W)));
  const targetCam = roomIndex * ROOM_W;
  platGame.camX = clamp2(targetCam, 0, platGame.levelW - w);

  // Win condition
  const goal = platGame.goal;
  const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
  const gb = { x: goal.x, y: goal.y, w: goal.w, h: goal.h };
  if (rectsOverlap(pb, gb) && platGame.heartsGot >= platGame.heartsTarget){
    winPlatformer();
  }
}

// ---------- Draw ----------
function drawPlatformer(){
  const w = platCanvas.getBoundingClientRect().width;
  const h = platCanvas.getBoundingClientRect().height;
  platCtx.clearRect(0,0,w,h);

  const t = performance.now()/1000;
  if (!platGame.bg.lights || platGame.bg.lights.length === 0) initDinnerBackground();

  // romantic dinner date background (screen space)
  drawDinnerBackground(platCtx, w, h, platGame.camX, t);

  // world
  const cam = platGame.camX;
  platCtx.save();
  platCtx.translate(-cam, 0);

  // Platforms
  for (const plat of platGame.platforms){
    if (plat.crumble){
      const c = platGame.crumble.find(x => x.ref === plat);
      const alpha =
        !c ? 1 :
        c.state === "solid" ? 1 :
        c.state === "falling" ? (0.55 + 0.45*(c.t/0.20)) :
        0;
      if (alpha > 0.02) drawSprinklePlatform(platCtx, plat.x, plat.y, plat.w, plat.h, alpha);
    } else {
      drawSprinklePlatform(platCtx, plat.x, plat.y, plat.w, plat.h, 1);
    }

    if (plat.conveyor){
      platCtx.save();
      platCtx.globalAlpha = 0.65;
      platCtx.font = "14px system-ui, Apple Color Emoji, Segoe UI Emoji";
      platCtx.fillText(plat.conveyor > 0 ? "â¡ï¸" : "â¬…ï¸", plat.x + plat.w/2 - 7, plat.y + plat.h - 4);
      platCtx.restore();
    }
  }

  // Wind zone hint (subtle)
  for (const wz of platGame.windZones){
    platCtx.save();
    platCtx.globalAlpha = 0.12;
    platCtx.fillStyle = "rgba(255,245,247,1)";
    roundRectPath(platCtx, wz.x, wz.y, wz.w, wz.h, 16);
    platCtx.fill();
    platCtx.restore();
  }

  // No-wall zones hint (subtle)
  for (const nz of platGame.noWallZones){
    platCtx.save();
    platCtx.globalAlpha = 0.10;
    platCtx.fillStyle = "rgba(0,0,0,1)";
    roundRectPath(platCtx, nz.x, nz.y, nz.w, nz.h, 16);
    platCtx.fill();
    platCtx.restore();
  }

  // Spikes
  for (const hz of platGame.hazards) drawSpikes(platCtx, hz);

  // Moving heartbreak blocks
  platCtx.save();
  platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
  for (const hz of platGame.hazardMovers){
    const bob = Math.sin((performance.now()/180) + hz.x*0.01) * 2;
    platCtx.globalAlpha = 0.95;
    platCtx.fillText("ğŸ’”", hz.x + hz.w/2 - 10, hz.y + hz.h/2 + 8 + bob);
  }
  platCtx.restore();

  // Crystals
  platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
  for (const c of platGame.dashCrystals){
    if (c.used) continue;
    const bob = Math.sin((performance.now()/240) + c.x*0.02) * 2;
    platCtx.globalAlpha = c.dashOnly ? 0.85 : 0.98;
    platCtx.fillText(c.dashOnly ? "ğŸ’ " : "ğŸ’", c.x - 10, c.y + 10 + bob);
  }
  platCtx.globalAlpha = 1;

  // Feathers
  platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
  for (const f of platGame.feathers){
    if (f.used) continue;
    const bob = Math.sin((performance.now()/220) + f.x*0.02) * 2;
    platCtx.globalAlpha = 0.95;
    platCtx.fillText("ğŸª¶", f.x - 10, f.y + 10 + bob);
  }
  platCtx.globalAlpha = 1;

  // Checkpoints
  for (const cp of platGame.checkpoints){
    platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
    platCtx.globalAlpha = cp.hit ? 1 : 0.65;
    platCtx.fillText(cp.hit ? "ğŸ’Œ" : "ğŸ“", cp.x - 8, cp.y + 22);
  }
  platCtx.globalAlpha = 1;

  // Treats
  platCtx.font = "20px system-ui, Apple Color Emoji, Segoe UI Emoji";
  for (const hrt of platGame.hearts){
    if (hrt.taken) continue;
    const bob = Math.sin((performance.now()/250) + hrt.x*0.02) * 2;
    platCtx.fillText(hrt.emoji, hrt.x - 9, hrt.y + 6 + bob);
  }

  // Goal
  platCtx.font = "28px system-ui, Apple Color Emoji, Segoe UI Emoji";
  platCtx.fillText("ğŸ’", platGame.goal.x - 6, platGame.goal.y + 26);

  // Player
  const p = platGame.player;
  platCtx.save();
  platCtx.translate(p.x + p.w/2, p.y + p.h/2);
  const floaty = p.onGround ? 0 : Math.sin(performance.now()/120) * 1.5;
  drawCupidHeart(platCtx, 0, 2 + floaty, 13.5);

  // dash aura
  if (p.dashT > 0){
    platCtx.globalAlpha = 0.22;
    platCtx.beginPath();
    platCtx.ellipse(0, 4, 26, 14, 0, 0, Math.PI*2);
    platCtx.fillStyle = "#fff";
    platCtx.fill();
    platCtx.globalAlpha = 1;
  }

  // feather aura
  if (p.featherT > 0){
    platCtx.globalAlpha = 0.20;
    platCtx.beginPath();
    platCtx.ellipse(0, 4, 30, 18, 0, 0, Math.PI*2);
    platCtx.fillStyle = "rgba(255,245,247,1)";
    platCtx.fill();
    platCtx.globalAlpha = 1;
  }

  platCtx.restore();

  platCtx.restore();
}

// ---------- Loop ----------
function platformerLoop(ts){
  if (!platGame.running) return;
  if (!platLast) platLast = ts;

  const dt = Math.min(0.033, (ts - platLast) / 1000);
  platLast = ts;

  // fixed-ish stepping
  const steps = Math.max(1, Math.floor(dt / 0.016));
  const stepDt = dt / steps;
  for (let i=0;i<steps;i++){
    updatePlatformer(stepDt);
  }

  drawPlatformer();
  platRaf = requestAnimationFrame(platformerLoop);
}

function startPlatformer(){
  resetPlatformer();
  platGame.running = true;
  platOverlay.style.opacity = "0";
  platStartBtn.style.opacity = "0";
  platStartBtn.style.pointerEvents = "none";

  platMsg.innerHTML = `ALL OF THEM mode ğŸ’˜ Camera-snap rooms, wind, dash-only crystals, feathers, and treat-reset deaths. Good luck, lover.`;
  platLast = 0;
  platRaf = requestAnimationFrame(platformerLoop);
}

function stopPlatformer(showOverlay = true){
  platGame.running = false;
  if (platRaf) cancelAnimationFrame(platRaf);
  platRaf = null;
  if (showOverlay){
    platOverlay.style.opacity = "1";
    platStartBtn.style.opacity = "1";
    platStartBtn.style.pointerEvents = "auto";
  }
}

function winPlatformer(){
  stopPlatformer(false);
  platOverlay.style.opacity = "1";
  platOverlay.innerHTML = `
    <div class="text-slate-800/90">
      <div class="text-4xl font-extrabold">DATE NIGHT DELIVERED ğŸ’</div>
      <div class="text-sm font-semibold mt-2">C-Side++++ â€œALL OF THEMâ€ cleared. True love. True pain. ğŸ’˜</div>
      <div class="text-xs font-semibold mt-2 opacity-80">Deaths: ${platGame.deaths}</div>
    </div>
  `;
  platStartBtn.style.opacity = "1";
  platStartBtn.style.pointerEvents = "auto";
  platStartBtn.textContent = "Run It Back ğŸ’";
  platMsg.innerHTML = `Perfect delivery ğŸ’–`;

  try { confetti({ particleCount: 320, spread: 110, origin: { y: 0.65 } }); } catch {}
}

platStartBtn.addEventListener("click", startPlatformer);
resetPlatformer();

window.addEventListener("resize", () => {
  fitCanvasToCSS(platCanvas, platCtx);
  initDinnerBackground();
});

</script>
</body>
</html>
