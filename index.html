<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Will you be my Valentine Andrew Getzow?</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* --------- Dreamy background --------- */
    body {
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
        linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
      overflow-x: hidden;
    }
    body.shiny-mode{
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(167, 139, 250, 0.50), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(34, 211, 238, 0.22), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(250, 204, 21, 0.24), transparent 60%),
        linear-gradient(180deg, #f5f3ff 0%, #e0f2fe 50%, #fff7ed 100%);
    }

    /* Boss mode tint */
    body.boss-mode::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
        linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
      opacity: 0.85;
      mix-blend-mode: multiply;
    }

    /* Background layers */
    #bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .blob {
      position: absolute;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      transform: translate3d(0,0,0);
      mix-blend-mode: multiply;
      will-change: transform;
    }
    .blob.a {
      left: -140px;
      top: -160px;
      background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
      animation: floatA 14s ease-in-out infinite;
    }
    .blob.b {
      right: -160px;
      top: -120px;
      background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
      animation: floatB 16s ease-in-out infinite;
    }
    .blob.c {
      left: 10%;
      bottom: -210px;
      background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
      animation: floatC 18s ease-in-out infinite;
    }
    @keyframes floatA { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(80px,60px) scale(1.08);} }
    @keyframes floatB { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(-90px,70px) scale(1.06);} }
    @keyframes floatC { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(120px,-60px) scale(1.1);} }
    body.boss-mode .blob.a{ animation-duration: 9s; }
    body.boss-mode .blob.b{ animation-duration: 10s; }
    body.boss-mode .blob.c{ animation-duration: 11s; }

    .noise {
      position: absolute;
      inset: 0;
      opacity: 0.10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }
    .pixel-grid{
      position:absolute;
      inset:0;
      opacity:.08;
      background-image:
        linear-gradient(to right, rgba(15,23,42,.25) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(15,23,42,.25) 1px, transparent 1px);
      background-size: 26px 26px;
      mix-blend-mode: overlay;
    }

    /* Floating particles */
    #powerups, #hearts{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }
    #powerups{ z-index: 1; }
    .heart, .powerup{
      position: absolute;
      bottom: -40px;
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
      user-select: none;
      opacity: 0;
    }
    .heart{ animation: floatUp linear forwards; }
    .powerup{ animation: puFloat linear forwards; }
    @keyframes floatUp {
      0%   { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
      10%  { opacity: 0.85; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity: 0; }
    }
    @keyframes puFloat{
      0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
      12%  { opacity: .9; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity: 0; }
    }

    /* Big title */
    #bigTitle{
      position: relative;
      z-index: 3;
      text-align: center;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 0.95;
      font-size: clamp(2.0rem, 5vw, 3.8rem);
      color: #ffffff;
      text-shadow: 0 4px 0 rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.22);
      margin-bottom: 0.9rem;
    }
    #bigTitle span{
      display: inline-block;
      padding: 0.18em 0.42em;
      border-radius: 999px;
      background: rgba(244, 63, 94, 0.20);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
    }

    /* card */
    .glass {
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.65);
      box-shadow: 0 22px 70px rgba(0,0,0,0.14);
    }

    /* Mascot bounce */
    .pixel-vibe { text-shadow: 0 2px 0 rgba(0,0,0,0.08); }
    .mascot-bounce { animation: mascotBounce 1.8s ease-in-out infinite; }
    @keyframes mascotBounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

    /* Heart buttons */
    .svg-heart{
      width: 56px;
      height: 50px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      will-change: transform;
    }
    .svg-heart svg{ width: 100%; height: 100%; display: block; }
    .svg-heart.yes path{ fill: #ef4444; }
    .svg-heart.no  path{ fill: #f43f5e; }
    .svg-heart span{
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      transform: translateY(-4px);
      color: white; font-weight: 900; font-size: 11px;
      letter-spacing: .7px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      user-select: none; pointer-events: none;
    }
    .svg-heart:hover{ transform: scale(1.06); filter: drop-shadow(0 12px 18px rgba(0,0,0,.18)); }
    .svg-heart:active{ transform: scale(.96); }

    /* Mana bar */
    #manaWrap{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #manaBarInner{
      width: 0%;
      transition: width 160ms ease;
    }

    /* MTG-ish card frame (inspired, not 1:1) */
    .tcg-card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.65);
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(255,255,255,0.70));
      box-shadow: 0 18px 60px rgba(0,0,0,0.14);
      overflow: hidden;
      position: relative;
    }
    .tcg-frame{
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      background:
        radial-gradient(600px 220px at 20% 10%, rgba(251, 113, 133, 0.22), transparent 60%),
        radial-gradient(600px 220px at 80% 30%, rgba(99, 102, 241, 0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
    }
    .tcg-titlebar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.10);
      font-weight: 900;
    }
    .tcg-rules{
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 12px;
      padding: 12px;
    }

    /* Pokemon-ish encounter box */
    .encounter{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.65);
      background: rgba(255,255,255,0.72);
      box-shadow: 0 18px 60px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .encounter-screen{
      background: linear-gradient(180deg, rgba(34,197,94,0.16), rgba(59,130,246,0.14));
      border-bottom: 1px solid rgba(15,23,42,0.10);
      padding: 16px;
    }
    .text-box{
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      font-weight: 800;
    }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.45);
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal-backdrop.show{ display: flex; }
  </style>
</head>

<body class="min-h-screen">
  <!-- BG -->
  <div id="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
    <div class="blob c"></div>
    <div class="noise"></div>
    <div class="pixel-grid"></div>
  </div>

  <div id="powerups" aria-hidden="true"></div>
  <div id="hearts" aria-hidden="true"></div>

  <!-- Title -->
  <div class="relative z-[3] px-4 pt-6">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-center gap-3 mb-2">
        <h1 id="bigTitle" class="w-full">
          <span>Love Beyond the Multiverse üíò</span>
        </h1>
      </div>

      <!-- Mana / shiny -->
      <div id="manaWrap" class="rounded-2xl glass px-4 py-3 mb-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-extrabold text-slate-800/80">
            Affection Mana: <span id="manaPct">0</span>%
          </div>

          <button id="shinyStar"
            class="text-sm font-black text-slate-700/80 hover:text-slate-900 transition"
            title="psst‚Ä¶ click me 3x">
            ‚≠ê Shiny Chance
          </button>
        </div>
        <div class="mt-2 h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
          <div id="manaBarInner" class="h-full bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
        </div>
      </div>

      <div class="text-center text-white/90 font-extrabold tracking-wide drop-shadow-sm mb-5">
        Two universes. One question.
        <span class="block text-sm font-semibold text-white/80 mt-1">A limited-time crossover has appeared‚Ä¶</span>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="relative z-[3] max-w-7xl mx-auto px-4 pb-10">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5 items-start">

      <!-- LEFT: Valentine card pinned-ish -->
      <aside class="lg:sticky lg:top-24">
        <div class="glass rounded-3xl p-6 text-center">
          <div class="mx-auto mb-3 w-28 mascot-bounce">
            <div class="w-24 h-24 mx-auto">
              <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
                <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
                <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
                <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
                <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
                <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <circle cx="50" cy="55" r="2" fill="#fff"/>
                <circle cx="74" cy="55" r="2" fill="#fff"/>
                <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
                <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                         C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                      fill="#ef4444"/>
                <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                      stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
                <rect x="92" y="70" width="8" height="30" rx="3" fill="#334155"/>
                <rect x="84" y="60" width="26" height="14" rx="6" fill="#475569"/>
                <circle cx="84" cy="67" r="6" fill="#475569"/>
              </svg>
            </div>
            <div class="mt-1 text-center font-extrabold text-sm tracking-wide text-slate-800/80 pixel-vibe">
              2/14/26
            </div>
          </div>

          <div class="font-black text-slate-800/80 mb-3">
            Will you be my Valentine Andrew Getzow?
          </div>

          <img id="valImage" class="w-full h-64 object-cover rounded-xl mb-4"
               style="background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));"
               alt="Valentine gif" />

          <div class="flex gap-6 justify-center mt-2">
            <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>YES</span>
            </button>

            <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>NO</span>
            </button>
          </div>

          <p id="hint" class="text-sm text-gray-600 mt-4 font-semibold">
            Both buttons are locked üòà Beat MAGALOR first.
          </p>
        </div>
      </aside>

      <!-- RIGHT: BIG open space for games + crossover -->
      <main class="space-y-5">

        <!-- EVENT START -->
        <section class="glass rounded-3xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Begin the Event</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                A limited-time crossover has appeared‚Ä¶ defeat MAGALOR to unlock the ultimate question.
              </div>
            </div>
            <button id="beginEvent"
              class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);">
              Begin the Event
            </button>
          </div>
        </section>

        <!-- BOSS FIGHT -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80">üëæ Boss Fight: MAGALOR (Love Edition)</div>
            <div class="text-xs font-black text-slate-700/70">Move: WASD/Arrows ‚Ä¢ Attack: Space / Tap</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">YOU üíñ</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">MAGALOR ‚òÑÔ∏è</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">LOVE METER üíò</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
                </div>
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="bossCanvas" class="w-full block h-[420px]"></canvas>

              <div id="laughFlash"
                  class="absolute top-6 left-1/2 -translate-x-1/2 text-3xl sm:text-5xl font-black tracking-widest text-slate-900 drop-shadow-lg opacity-0 pointer-events-none">
                MAGALOR: HAHAHA!
              </div>

              <div id="bossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="text-slate-800/80">
                  <div class="text-3xl font-extrabold">A wild MAGALOR appeared!</div>
                  <div class="text-sm font-semibold mt-2">Dodge cursed hearts. Shoot love beams.</div>
                </div>
              </div>

              <button id="bossStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
                Start Boss Fight
              </button>
            </div>

            <div id="bossMsg" class="mt-3 text-sm font-semibold text-slate-700/80">
              Beat MAGALOR to unlock YES + NO.
            </div>
          </div>
        </section>

        <!-- PLATFORMER -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80">üïπÔ∏è Platformer: Collect the Hearts</div>
            <div class="text-xs font-black text-slate-700/70">Move: A/D or ‚Üê/‚Üí ‚Ä¢ Jump: W/‚Üë/Space</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3 items-center">
              <div class="sm:col-span-2 text-sm font-semibold text-slate-700/80" id="platMsg">
                Collect <b>7</b> hearts üíñ and touch the <b>love letter</b> üíå.
              </div>
              <div class="text-xs font-black text-slate-700/80 text-right">
                Hearts: <span id="platCount">0</span>/7
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="platCanvas" class="w-full block h-[360px]"></canvas>

              <div id="platOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="text-slate-800/80">
                  <div class="text-3xl font-extrabold">Tiny Love Quest üíå</div>
                  <div class="text-sm font-semibold mt-2">Jump on platforms, grab hearts, reach the letter.</div>
                </div>
              </div>

              <button id="platStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #ec4899, #60a5fa);">
                Start Platformer
              </button>
            </div>
          </div>
        </section>

        <!-- MTG-STYLE: Legendary card -->
        <section class="tcg-card">
          <div class="p-6">
            <div class="flex items-center justify-between gap-3 mb-4">
              <div>
                <div class="text-2xl font-black text-slate-800/80">1) Custom TCG Card: ‚ÄúBe My Valentine‚Äù</div>
                <div class="text-sm font-semibold text-slate-700/80 mt-1">
                  Hover/click to reveal ‚Äúalt art‚Äù üëÄ
                </div>
              </div>
              <button id="altArtBtn"
                class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #6366f1);">
                Reveal Alt Art
              </button>
            </div>

            <div id="tcgCard" class="tcg-frame">
              <div class="tcg-titlebar">
                <div id="cardName">Andrew Getzow, Keeper of My Heart</div>
                <div class="text-xs font-black text-slate-700/70">Cost: üç´‚ù§Ô∏èüçø</div>
              </div>

              <div class="mt-3 grid grid-cols-1 md:grid-cols-[200px_1fr] gap-3">
                <div class="rounded-xl overflow-hidden border border-slate-900/10 bg-white/70">
                  <div id="cardArt" class="h-40 flex items-center justify-center font-black text-slate-700/70">
                    (Put a cute photo here later)
                  </div>
                </div>

                <div class="tcg-rules">
                  <div class="text-xs font-black text-slate-700/70 mb-1">Legendary Creature ‚Äî Human Nerd</div>
                  <div class="text-sm font-semibold text-slate-800/80 leading-relaxed">
                    <div>Whenever you smile, create a <b>Heart token</b>.</div>
                    <div class="mt-1"><b>{T}:</b> Go on a date. If it‚Äôs Valentine‚Äôs Day, you may also get dessert.</div>
                    <div class="mt-1">Partner with <b>You, Hopeless Romantic</b>.</div>
                  </div>
                  <div class="mt-3 text-xs italic font-bold text-slate-700/70">
                    ‚ÄúI‚Äôd tap all my mana for you.‚Äù
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Choose a Date: Modal spell -->
        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">2) Choose a Date (Cast a Spell)</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                Three spell-cards. Pick one.
              </div>
            </div>
            <button id="openDateModal"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #ec4899, #60a5fa);">
              Open Spellbook
            </button>
          </div>

          <div id="chosenDate" class="mt-4 text-sm font-semibold text-slate-700/80">
            Selected spell: <b>None yet</b>
          </div>
        </section>

        <!-- Token generator -->
        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">3) Heart Token Generator</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                Generate love mana. Unlock messages at 5/10/20.
              </div>
            </div>
            <button id="tokenBtn"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
              Create a Heart Token
            </button>
          </div>

          <div class="mt-4 grid grid-cols-6 sm:grid-cols-10 gap-2" id="tokenGrid"></div>
          <div class="mt-4 text-sm font-semibold text-slate-700/80" id="tokenMsg">Tokens: <b id="tokenCount">0</b></div>
        </section>

        <!-- Wild Valentine Appeared -->
        <section class="encounter">
          <div class="p-6">
            <div class="text-2xl font-black text-slate-800/80 mb-3">4) Wild Valentine Appeared!</div>
            <div class="encounter-screen rounded-2xl">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black text-slate-800/80">VALENTINE (???)</div>
                <div class="text-xs font-black text-slate-700/70">HP: ‚ô°‚ô°‚ô°‚ô°‚ô°</div>
              </div>
              <div class="mt-3 text-box" id="battleText">A wild Valentine appeared!</div>
            </div>

            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
              <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
                id="btnFight">FIGHT</button>
              <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
                id="btnBag">BAG</button>
              <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
                id="btnTeam">TEAM</button>
              <button class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/80 border border-white/60 shadow active:scale-95 transition"
                id="btnRun">RUN</button>
            </div>
          </div>
        </section>

        <!-- Pokedex -->
        <section class="glass rounded-3xl p-6">
          <div class="text-2xl font-black text-slate-800/80">5) Pok√©dex Entry: Boyfriendmon</div>
          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-black text-slate-800/80 text-lg">Boyfriendmon</div>
                <div class="text-sm font-semibold text-slate-700/80 mt-1">Type: <b>Electric / Fairy</b></div>
                <div class="text-sm font-semibold text-slate-700/80">Ability: <b>Makes Me Smile</b></div>
                <div class="text-sm font-semibold text-slate-700/80">Habitat: <b>My heart (permanent residence)</b></div>
              </div>
              <div class="text-4xl">‚ö°üíñ</div>
            </div>
            <div class="mt-3 text-sm font-semibold text-slate-800/80">
              Pok√©dex: ‚ÄúKnown to boost happiness instantly. If spotted, expect uncontrollable laughter and sudden date plans.‚Äù
            </div>
          </div>
        </section>

        <!-- Fusion Finale: Saga -> Capture -->
        <section class="glass rounded-3xl p-6">
          <div class="text-2xl font-black text-slate-800/80">6) Fusion Finale: Saga ‚Üí Capture Screen</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-1">
            Advance the saga‚Ä¶ then the ‚Äúcapture‚Äù appears.
          </div>

          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-5">
            <div id="sagaView">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black text-slate-800/80">Saga: <span id="sagaTitle">Love Beyond the Multiverse</span></div>
                <div class="text-xs font-black text-slate-700/70">Chapter <span id="sagaChapter">I</span>/III</div>
              </div>

              <div class="mt-3 text-sm font-semibold text-slate-800/80" id="sagaText">
                I ‚Äî ‚ÄúWe met and my life got better.‚Äù
              </div>

              <button id="advanceSaga"
                class="mt-4 rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899);">
                Advance Saga
              </button>
            </div>

            <div id="captureView" class="hidden">
              <div class="font-black text-slate-800/80 text-lg">Throw the Love Ball?</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">Two options. Both are yes-coded.</div>

              <div class="mt-4 flex flex-wrap gap-3">
                <button id="throwLoveBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
                  YES
                </button>
                <button id="throwShinyBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, #22c55e, #60a5fa);">
                  YES (shiny)
                </button>
              </div>

              <div class="mt-3 text-sm font-semibold text-slate-700/80" id="captureMsg">
                (Still locked until MAGALOR is defeated üòà)
              </div>
            </div>
          </div>
        </section>

        <!-- Booster pack opening -->
        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Bonus: Open a Booster Pack</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                It reveals the final question card.
              </div>
            </div>
            <button id="openBooster"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #f59e0b, #ec4899);">
              Open Booster
            </button>
          </div>

          <div id="boosterResult" class="mt-4 hidden rounded-2xl border border-white/60 bg-white/70 p-5">
            <div class="font-black text-slate-800/80 text-xl">‚ú® You pulled: ‚ÄúWill You Be My Valentine?‚Äù</div>
            <div class="text-sm font-semibold text-slate-700/80 mt-2">
              Congratulations. This is the rarest pull. (And also mandatory.) üíò
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- DATE MODAL -->
  <div id="dateModal" class="modal-backdrop">
    <div class="glass rounded-3xl w-full max-w-3xl p-6">
      <div class="flex items-center justify-between gap-3">
        <div class="text-2xl font-black text-slate-800/80">Choose a Date (Spell Cards)</div>
        <button id="closeDateModal" class="rounded-full px-4 py-2 font-extrabold bg-white/80 border border-white/60 shadow active:scale-95 transition">
          Close
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5">
        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Cozy Date ‚Äî Sorcery</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: ‚òï‚ù§Ô∏èüß∏</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            ‚ÄúCreate 2 Cuddle tokens. Draw a movie.‚Äù
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #fb7185, #60a5fa);"
            data-spell="Cozy Date">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Fancy Date ‚Äî Instant</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: üåπ‚ù§Ô∏è‚ú®</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            ‚ÄúGo somewhere cute. Add dessert. Gain +10 happiness.‚Äù
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #ec4899, #f59e0b);"
            data-spell="Fancy Date">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black text-slate-800/80">Chaos Date ‚Äî Enchantment</div>
          <div class="text-xs font-black text-slate-700/70 mt-1">Cost: üéÆ‚ù§Ô∏èüçü</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-3">
            ‚ÄúRoll a d20. Whatever happens, it becomes a core memory.‚Äù
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #6366f1, #22c55e);"
            data-spell="Chaos Date">
            Cast this
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========== Floating hearts & powerups ==========
  const heartsLayer = document.getElementById("hearts");
  const powerupsLayer = document.getElementById("powerups");

  function spawnHeart() {
    const el = document.createElement("span");
    el.className = "heart";
    el.textContent = Math.random() > 0.25 ? "üíó" : "üíñ";
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 28;
    const dur  = 5 + Math.random() * 7;
    const drift = (Math.random() * 60 - 30) + "px";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    heartsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 100);
  }

  function spawnPowerup(){
    const el = document.createElement("span");
    el.className = "powerup";
    const items = ["‚≠ê","ü™ô","‚ú®","üíñ","üéÆ","üíå","üåπ"];
    el.textContent = items[Math.floor(Math.random() * items.length)];
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 22;
    const dur  = 6 + Math.random() * 8;
    const drift = (Math.random() * 80 - 40) + "px";
    const rot = (Math.random() * 160 - 80) + "deg";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    el.style.setProperty("--rot", rot);
    powerupsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 200);
  }

  for (let i = 0; i < 14; i++) spawnHeart();
  setInterval(spawnHeart, 220);
  for (let i = 0; i < 10; i++) spawnPowerup();
  setInterval(spawnPowerup, 600);

  // ========== Mana bar ==========
  const manaBarInner = document.getElementById("manaBarInner");
  const manaPctEl = document.getElementById("manaPct");

  function updateMana(){
    const doc = document.documentElement;
    const scrollTop = doc.scrollTop || document.body.scrollTop;
    const max = (doc.scrollHeight - doc.clientHeight) || 1;
    const pct = Math.max(0, Math.min(100, (scrollTop / max) * 100));
    manaBarInner.style.width = pct.toFixed(1) + "%";
    manaPctEl.textContent = String(Math.round(pct));
  }
  window.addEventListener("scroll", updateMana, { passive: true });
  updateMana();

  // ========== Shiny mode easter egg ==========
  const shinyStar = document.getElementById("shinyStar");
  let shinyClicks = 0;
  shinyStar.addEventListener("click", () => {
    shinyClicks++;
    if (shinyClicks >= 3){
      document.body.classList.toggle("shiny-mode");
      shinyClicks = 0;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.2 } }); } catch {}
    } else {
      shinyStar.animate([{transform:"scale(1)"},{transform:"scale(1.2)"},{transform:"scale(1)"}], {duration:260});
    }
  });

  // ========== GIF loader ==========
  const valImage = document.getElementById("valImage");
  const hint = document.getElementById("hint");

  function setImageTry(urls, failMessage) {
    let i = 0;
    const tryNext = () => {
      if (i >= urls.length) { hint.textContent = failMessage; return; }
      const url = urls[i++];
      const probe = new Image();
      probe.onload = () => { valImage.src = url; };
      probe.onerror = () => tryNext();
      probe.src = url;
    };
    tryNext();
  }

  const GIFS = {
    start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
    yesMain: ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
    yesFinal: [
      "https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif",
      "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcnd5OW94bW81Zzg5MXpyMHB6eTE0azRiMGU5OHhlYTl4MmNiMHh6biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/TqK5V0YnrWaR2/200.gif"
    ],
    no: ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
  };
  setImageTry(GIFS.start, "Start GIF failed to load.");

  // ========== Lock YES/NO until boss beaten ==========
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");

  let yesLocked = true;
  let noLocked = true;

  function lockBtn(btn, label){
    btn.disabled = true;
    btn.style.opacity = "0.55";
    btn.style.cursor = "not-allowed";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }
  function unlockBtn(btn, label){
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }

  function lockYesNo(){
    yesLocked = true; noLocked = true;
    lockBtn(yesBtn, "LOCKED");
    lockBtn(noBtn, "LOCKED");
  }
  function unlockYesNo(){
    yesLocked = false; noLocked = false;
    unlockBtn(yesBtn, "YES");
    unlockBtn(noBtn, "NO");
    hint.textContent = "Unlocked! üò≥ Now choose wisely...";
  }
  lockYesNo();

  // ========== Begin Event button ==========
  const beginEvent = document.getElementById("beginEvent");
  const bossStartBtn = document.getElementById("bossStart");
  beginEvent.addEventListener("click", () => {
    bossStartBtn.scrollIntoView({ behavior: "smooth", block: "center" });
    bossStartBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:520});
  });

  // ========== YES/NO click handlers ==========
  let yesFinalTimer = null;

  yesBtn.addEventListener("click", () => {
    if (yesLocked){
      hint.textContent = "YES is locked üòà Beat MAGALOR first!";
      yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
      return;
    }
    setImageTry(GIFS.yesMain, "YES GIF failed to load.");
    hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! üíô";
    noBtn.style.display = "none";
    try { confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } }); } catch {}
    if (yesFinalTimer) clearTimeout(yesFinalTimer);
    yesFinalTimer = setTimeout(() => setImageTry(GIFS.yesFinal, "Final Eevee GIF failed to load."), 2000);
  });

  noBtn.addEventListener("click", () => {
    if (noLocked){
      hint.textContent = "NO is locked üòà Beat MAGALOR first!";
      noBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
      return;
    }
    setImageTry(GIFS.no, "NO GIF failed to load.");
    hint.textContent = "No (Are you sure about that?) üò≥";
  });

  // ========== Alt art toggle (placeholder) ==========
  const altArtBtn = document.getElementById("altArtBtn");
  const cardArt = document.getElementById("cardArt");
  let altArt = false;
  altArtBtn.addEventListener("click", () => {
    altArt = !altArt;
    cardArt.textContent = altArt ? "(ALT ART: put another photo here)" : "(Put a cute photo here later)";
    try { confetti({ particleCount: 80, spread: 60, origin: { y: 0.25 } }); } catch {}
  });

  // ========== Date modal ==========
  const dateModal = document.getElementById("dateModal");
  const openDateModal = document.getElementById("openDateModal");
  const closeDateModal = document.getElementById("closeDateModal");
  const chosenDate = document.getElementById("chosenDate");

  openDateModal.addEventListener("click", () => dateModal.classList.add("show"));
  closeDateModal.addEventListener("click", () => dateModal.classList.remove("show"));
  dateModal.addEventListener("click", (e) => {
    if (e.target === dateModal) dateModal.classList.remove("show");
  });

  dateModal.querySelectorAll("button[data-spell]").forEach(btn => {
    btn.addEventListener("click", () => {
      const s = btn.getAttribute("data-spell");
      chosenDate.innerHTML = `Selected spell: <b>${s}</b>`;
      dateModal.classList.remove("show");
      try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.7 } }); } catch {}
    });
  });

  // ========== Token generator ==========
  const tokenBtn = document.getElementById("tokenBtn");
  const tokenGrid = document.getElementById("tokenGrid");
  const tokenCountEl = document.getElementById("tokenCount");
  const tokenMsg = document.getElementById("tokenMsg");
  let tokens = 0;

  function tokenUnlockMessage(n){
    if (n === 5)  return "You‚Äôve generated enough love mana.";
    if (n === 10) return "Warning: lethal affection incoming.";
    if (n === 20) return "Ultimate achieved: Ask unlocked. (‚Ä¶if MAGALOR is defeated üòà)";
    return null;
  }

  tokenBtn.addEventListener("click", () => {
    tokens++;
    tokenCountEl.textContent = String(tokens);
    const tile = document.createElement("div");
    tile.className = "h-9 w-9 rounded-xl bg-white/75 border border-white/60 flex items-center justify-center shadow-sm";
    tile.textContent = "üíñ";
    tokenGrid.appendChild(tile);
    const msg = tokenUnlockMessage(tokens);
    if (msg){
      tokenMsg.innerHTML = `Tokens: <b>${tokens}</b> ‚Äî <span class="font-black">${msg}</span>`;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } }); } catch {}
    }
  });

  // ========== Encounter (FIGHT/BAG/TEAM/RUN) ==========
  const battleText = document.getElementById("battleText");
  const btnFight = document.getElementById("btnFight");
  const btnBag = document.getElementById("btnBag");
  const btnTeam = document.getElementById("btnTeam");
  const btnRun = document.getElementById("btnRun");

  const moves = [
    "Compliment Beam ‚Äî ‚ÄúYou make everything better.‚Äù",
    "Snack Shield ‚Äî ‚ÄúYou always take care of me.‚Äù",
    "Laugh Attack ‚Äî ‚ÄúYou‚Äôre my favorite person to be silly with.‚Äù",
    "Cozy Aura ‚Äî ‚ÄúEverything feels safer with you.‚Äù"
  ];
  const bagItems = [
    "Coupon: One (1) forehead kiss üíã",
    "Coupon: Choose the movie üé¨",
    "Coupon: Dessert add-on üç∞",
    "Item: Love Ball üíò"
  ];
  const teamRoster = [
    "Slot 1: Inside joke #1",
    "Slot 2: A cute photo",
    "Slot 3: Your funniest moment",
    "Slot 4: The ‚Äúwe‚Äôre a team‚Äù one"
  ];

  let moveIndex = 0;
  btnFight.addEventListener("click", () => {
    battleText.textContent = moves[moveIndex % moves.length];
    moveIndex++;
  });
  btnBag.addEventListener("click", () => {
    const item = bagItems[Math.floor(Math.random() * bagItems.length)];
    battleText.textContent = "You opened the bag‚Ä¶ " + item;
  });
  btnTeam.addEventListener("click", () => {
    const t = teamRoster[Math.floor(Math.random() * teamRoster.length)];
    battleText.textContent = "TEAM roster: " + t;
  });
  btnRun.addEventListener("click", () => {
    battleText.textContent = "You can‚Äôt run from love.";
    btnRun.animate([{transform:"translateX(0px)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0px)"}], {duration:360});
  });

  // ========== Saga -> Capture ==========
  const sagaChapterEl = document.getElementById("sagaChapter");
  const sagaText = document.getElementById("sagaText");
  const advanceSaga = document.getElementById("advanceSaga");
  const sagaView = document.getElementById("sagaView");
  const captureView = document.getElementById("captureView");
  const throwLoveBall = document.getElementById("throwLoveBall");
  const throwShinyBall = document.getElementById("throwShinyBall");
  const captureMsg = document.getElementById("captureMsg");

  let sagaStep = 1;
  const sagaLines = {
    1: `I ‚Äî ‚ÄúWe met and my life got better.‚Äù`,
    2: `II ‚Äî ‚ÄúWe became my favorite team.‚Äù`,
    3: `III ‚Äî ‚ÄúWill you be my Valentine?‚Äù`
  };

  function toRoman(n){ return n === 1 ? "I" : n === 2 ? "II" : "III"; }

  advanceSaga.addEventListener("click", () => {
    sagaStep = Math.min(3, sagaStep + 1);
    sagaChapterEl.textContent = toRoman(sagaStep);
    sagaText.textContent = sagaLines[sagaStep];
    if (sagaStep === 3){
      sagaView.classList.add("hidden");
      captureView.classList.remove("hidden");
      try { confetti({ particleCount: 140, spread: 90, origin: { y: 0.55 } }); } catch {}
    }
  });

  function captureAttempt(shiny=false){
    if (yesLocked || noLocked){
      captureMsg.textContent = "LOCKED üòà Defeat MAGALOR first!";
      return;
    }
    captureMsg.textContent = shiny ? "Shiny captured!! üíö‚ú® Valentine accepted!!" : "Captured!! üíò Valentine accepted!!";
    try { confetti({ particleCount: 220, spread: 95, origin: { y: 0.6 } }); } catch {}
    hint.textContent = "Okay now go click YES üò§üíû";
    yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.12)"},{transform:"scale(1)"}], {duration:700, iterations:2});
  }
  throwLoveBall.addEventListener("click", () => captureAttempt(false));
  throwShinyBall.addEventListener("click", () => captureAttempt(true));

  // ========== Booster ==========
  const openBooster = document.getElementById("openBooster");
  const boosterResult = document.getElementById("boosterResult");
  openBooster.addEventListener("click", () => {
    boosterResult.classList.remove("hidden");
    boosterResult.animate([{transform:"scale(0.98)", opacity:0},{transform:"scale(1)", opacity:1}], {duration:420, easing:"cubic-bezier(.2,.9,.2,1)"});
    try { confetti({ particleCount: 160, spread: 85, origin: { y: 0.55 } }); } catch {}
  });

  // ========== Boss fight + platformer code (kept + includes phase 2, laugh flash, black hole pull, etc.) ==========
  // (This is the same logic you already had, just resized to fit the right column.)

  const bossCanvas = document.getElementById("bossCanvas");
  const bossOverlay = document.getElementById("bossOverlay");
  const bossMsg = document.getElementById("bossMsg");
  const playerHPBar = document.getElementById("playerHPBar");
  const bossHPBar = document.getElementById("bossHPBar");
  const loveBar = document.getElementById("loveBar");
  const laughFlash = document.getElementById("laughFlash");

  const defaultBossOverlayHTML = bossOverlay.innerHTML;

  const bossCtx2 = bossCanvas.getContext("2d");
  let bossRaf = null;

  function fitCanvasToCSS(canvas, ctx) {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  fitCanvasToCSS(bossCanvas, bossCtx2);

  // Shared keys
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," "].includes(e.key)) {
      keys.add(e.key);
      if (e.key === " ") e.preventDefault();
    }
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key));

  // Boss touch controls
  let bossTouchActive = false, bossTouchX = 0, bossTouchY = 0;
  bossCanvas.addEventListener("pointerdown", (e) => {
    bossTouchActive = true;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
    if (bossGame.running) bossShoot();
  });
  bossCanvas.addEventListener("pointermove", (e) => {
    if (!bossTouchActive) return;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
  });
  window.addEventListener("pointerup", () => (bossTouchActive = false));

  const bossGame = {
    running: false,
    t: 0,
    lastShot: 0,
    phaseTimer: 0,
    pattern: "spray",
    phase2: false,
    blackHole: { active: false, timer: 0, cool: 2.0 },
    bullets: [],
    beams: [],
    particles: [],
    player: { x: 120, y: 260, r: 10, hp: 5, maxHp: 5, inv: 0 },
    boss:   { x: 0, y: 0, r: 28, hp: 100, maxHp: 100, wob: 0 }
  };

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function dist2(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

  function setBossBars(){
    playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
    bossHPBar.style.width = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
    const lovePct = (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 100;
    loveBar.style.width = lovePct.toFixed(1) + "%";
  }

  function magalorLaugh() {
    laughFlash.style.opacity = "1";
    try {
      laughFlash.animate(
        [
          { transform: "translateX(-50%) scale(0.85)", opacity: 0 },
          { transform: "translateX(-50%) scale(1.05)", opacity: 1, offset: 0.35 },
          { transform: "translateX(-50%) scale(1.0)", opacity: 1, offset: 0.75 },
          { transform: "translateX(-50%) scale(0.95)", opacity: 0 }
        ],
        { duration: 900, easing: "cubic-bezier(.2,.9,.2,1)" }
      );
    } catch {}
    setTimeout(() => (laughFlash.style.opacity = "0"), 900);
  }

  function resetBossFight(){
    bossGame.running = false;
    bossGame.t = 0;
    bossGame.lastShot = 0;
    bossGame.phaseTimer = 0;
    bossGame.pattern = "spray";
    bossGame.phase2 = false;
    bossGame.blackHole.active = false;
    bossGame.blackHole.timer = 0;
    bossGame.blackHole.cool = 2.0;

    bossGame.bullets.length = 0;
    bossGame.beams.length = 0;
    bossGame.particles.length = 0;

    bossGame.player.x = 120;
    bossGame.player.y = 260;
    bossGame.player.hp = bossGame.player.maxHp = 5;
    bossGame.player.inv = 0;

    bossGame.boss.hp = bossGame.boss.maxHp = 100;
    bossGame.boss.wob = 0;

    setBossBars();
    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = defaultBossOverlayHTML;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Start Boss Fight";
  }

  function spawnBossParticle(x,y,emoji){
    bossGame.particles.push({
      x,y,
      vx:(Math.random()*2-1)*1.2,
      vy:(Math.random()*2-1)*1.2 - 0.8,
      life: 40 + Math.random()*20,
      emoji
    });
  }

  function bossShoot(){
    const now = performance.now();
    if (now - bossGame.lastShot < 120) return;
    bossGame.lastShot = now;

    bossGame.beams.push({
      x: bossGame.player.x,
      y: bossGame.player.y - 12,
      vx: 0,
      vy: -7.6,
      r: 6
    });
    spawnBossParticle(bossGame.player.x, bossGame.player.y-10, "üíû");
  }

  function fireBossBullet(angle, speed, kind="heart"){
    bossGame.bullets.push({
      x: bossGame.boss.x,
      y: bossGame.boss.y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      r: kind === "orb" ? 8 : 7,
      kind
    });
  }

  function chooseBossPattern(){
    const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
    const pool = hpPct > 0.65 ? ["spray","ring"]
                : hpPct > 0.30 ? ["spray","ring","dash"]
                : ["spray","ring","dash","spiral"];
    bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
    bossGame.phaseTimer = 0;
  }

  function roundRectPath(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  function drawHeartShape(ctx, x, y, size){
    ctx.beginPath();
    ctx.moveTo(x, y + size*0.25);
    ctx.bezierCurveTo(x - size, y - size*0.35, x - size*0.6, y - size, x, y - size*0.45);
    ctx.bezierCurveTo(x + size*0.6, y - size, x + size, y - size*0.35, x, y + size*0.25);
    ctx.closePath();
  }

  function drawMagolorLikeBoss(ctx, x, y, scale){
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);

    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.ellipse(0, 14, 54, 28, 0, 0, Math.PI*2);
    ctx.fillStyle = "#7c3aed";
    ctx.fill();
    ctx.globalAlpha = 1;

    // cloak
    ctx.beginPath();
    ctx.moveTo(-52, 10);
    ctx.quadraticCurveTo(0, 64, 52, 10);
    ctx.quadraticCurveTo(0, 36, -52, 10);
    ctx.closePath();
    ctx.fillStyle = "#0b1224";
    ctx.fill();

    // hood
    ctx.beginPath();
    ctx.ellipse(0, -6, 44, 38, 0, 0, Math.PI*2);
    ctx.fillStyle = "#2563eb";
    ctx.fill();

    // ear points
    ctx.beginPath(); ctx.moveTo(-24, -30); ctx.lineTo(-52, -58); ctx.lineTo(-28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();
    ctx.beginPath(); ctx.moveTo(24, -30); ctx.lineTo(52, -58); ctx.lineTo(28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();

    // face
    ctx.beginPath();
    ctx.ellipse(0, -6, 30, 24, 0, 0, Math.PI*2);
    ctx.fillStyle = "#0b1020";
    ctx.fill();

    // eyes
    ctx.beginPath();
    ctx.ellipse(-10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde047";
    ctx.fill();

    // scarf
    ctx.beginPath();
    ctx.roundRect(-46, 4, 92, 24, 12);
    ctx.fillStyle = "#f8fafc";
    ctx.fill();

    // hands
    ctx.beginPath();
    ctx.ellipse(-56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde68a";
    ctx.fill();

    ctx.restore();
  }

  function updateBoss(dt){
    bossGame.t += dt;
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    // boss float
    bossGame.boss.wob += dt;
    bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 95;
    bossGame.boss.y = 95 + Math.sin(bossGame.boss.wob * 1.1) * 16;

    // player move
    let mx = 0, my = 0;
    if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
    if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
    if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
    if (keys.has("ArrowDown") || keys.has("s")) my += 1;

    if (bossTouchActive){
      const dx = bossTouchX - bossGame.player.x;
      const dy = bossTouchY - bossGame.player.y;
      mx = clamp(dx / 30, -1, 1);
      my = clamp(dy / 30, -1, 1);
    }

    const speed = 4.25;
    bossGame.player.x = clamp(bossGame.player.x + mx * speed, 18, w - 18);
    bossGame.player.y = clamp(bossGame.player.y + my * speed, 120, h - 18);

    if (keys.has(" ")) bossShoot();

    bossGame.phaseTimer += dt;
    const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.7;
    if (bossGame.phaseTimer > 2.2) chooseBossPattern();

    // Phase 2 at 50% HP
    if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5) {
      bossGame.phase2 = true;
      magalorLaugh();
      bossMsg.textContent = "PHASE 2 üò≥ MAGALOR opened a black hole pull!";
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üñ§");
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíò");
    }

    // Black hole pull mechanic (phase2)
    if (bossGame.phase2) {
      bossGame.blackHole.cool -= dt;
      if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0) {
        bossGame.blackHole.active = true;
        bossGame.blackHole.timer = 1.6;
        bossGame.blackHole.cool = 4.2;
        magalorLaugh();
        bossMsg.textContent = "MAGALOR casts: BLACK HOLE PULL üñ§üí´";
      }

      if (bossGame.blackHole.active) {
        bossGame.blackHole.timer -= dt;
        if (bossGame.blackHole.timer <= 0) {
          bossGame.blackHole.active = false;
          bossMsg.textContent = "Keep going!! Turn him into a Valentine üò§üíû";
        } else {
          const dx = bossGame.boss.x - bossGame.player.x;
          const dy = bossGame.boss.y - bossGame.player.y;
          const d = Math.sqrt(dx*dx + dy*dy) || 1;
          const pull = 3.3 * (1 - Math.min(d / 520, 1));
          bossGame.player.x += (dx / d) * pull;
          bossGame.player.y += (dy / d) * pull;
          bossGame.player.x = clamp(bossGame.player.x, 18, w - 18);
          bossGame.player.y = clamp(bossGame.player.y, 120, h - 18);
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "üíî");
        }
      }
    }

    // patterns
    if (bossGame.pattern === "spray"){
      if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
        const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
        const spread = 0.20 + 0.10 * intensity;
        fireBossBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.75*intensity, "heart");
      }
    } else if (bossGame.pattern === "ring"){
      if (bossGame.phaseTimer < dt + 0.02){
        const n = 10 + Math.floor(intensity*4);
        for (let i=0;i<n;i++){
          const a = (Math.PI*2) * (i/n);
          fireBossBullet(a, 2.35 + 0.7*intensity, "orb");
        }
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíó");
      }
    } else if (bossGame.pattern === "dash"){
      if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
        const laneY = 150 + Math.random() * (h - 190);
        bossGame.bullets.push({
          x: -20, y: laneY, vx: 6.2 + 1.25*intensity, vy: 0, r: 9, kind:"dash"
        });
      }
    } else if (bossGame.pattern === "spiral"){
      if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
        const base = bossGame.boss.wob * 2.2;
        fireBossBullet(base, 2.15 + 0.95*intensity, "heart");
      }
    }

    // update bullets
    for (const b of bossGame.bullets){ b.x += b.vx; b.y += b.vy; }
    bossGame.bullets = bossGame.bullets.filter(b => b.x > -70 && b.x < w+70 && b.y > -70 && b.y < h+70);

    // update beams
    for (const p of bossGame.beams){ p.x += p.vx; p.y += p.vy; }
    bossGame.beams = bossGame.beams.filter(p => p.y > -50);

    // particles
    for (const pt of bossGame.particles){
      pt.x += pt.vx; pt.y += pt.vy; pt.vy += 0.03; pt.life -= 1;
    }
    bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

    // beams -> boss
    for (let i = bossGame.beams.length - 1; i >= 0; i--){
      const p = bossGame.beams[i];
      if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
        bossGame.beams.splice(i,1);
        bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "‚ú®");
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíò");
        setBossBars();
        if (bossGame.boss.hp <= 0) winBossFight();
      }
    }

    // bullets -> player
    if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
    for (let i = bossGame.bullets.length - 1; i >= 0; i--){
      const b = bossGame.bullets[i];
      if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
        bossGame.bullets.splice(i,1);
        if (bossGame.player.inv <= 0){
          bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
          bossGame.player.inv = 0.9;
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "üí•");
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "üíî");
          setBossBars();
          if (bossGame.player.hp <= 0) loseBossFight();
        }
      }
    }
  }

  function drawBoss(){
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    bossCtx2.clearRect(0,0,w,h);

    // arena gradient
    const g = bossCtx2.createLinearGradient(0,0,0,h);
    g.addColorStop(0, "rgba(251, 113, 133, 0.20)");
    g.addColorStop(0.55, "rgba(236, 72, 153, 0.12)");
    g.addColorStop(1, "rgba(96, 165, 250, 0.16)");
    bossCtx2.fillStyle = g;
    bossCtx2.fillRect(0,0,w,h);

    // grid
    bossCtx2.globalAlpha = 0.10;
    bossCtx2.strokeStyle = "#0f172a";
    bossCtx2.lineWidth = 1;
    for (let x=0;x<w;x+=24){ bossCtx2.beginPath(); bossCtx2.moveTo(x,0); bossCtx2.lineTo(x,h); bossCtx2.stroke(); }
    for (let y=0;y<h;y+=24){ bossCtx2.beginPath(); bossCtx2.moveTo(0,y); bossCtx2.lineTo(w,y); bossCtx2.stroke(); }
    bossCtx2.globalAlpha = 1;

    // black hole visual
    if (bossGame.phase2 && bossGame.blackHole.active) {
      bossCtx2.save();
      bossCtx2.translate(bossGame.boss.x, bossGame.boss.y);
      bossCtx2.globalAlpha = 0.22;
      bossCtx2.beginPath();
      bossCtx2.arc(0, 14, 72, 0, Math.PI * 2);
      bossCtx2.fillStyle = "#0b1020";
      bossCtx2.fill();
      bossCtx2.globalAlpha = 0.8;
      bossCtx2.strokeStyle = "#ec4899";
      bossCtx2.lineWidth = 3;
      bossCtx2.beginPath();
      bossCtx2.arc(0, 14, 60, 0, Math.PI * 2);
      bossCtx2.stroke();
      bossCtx2.restore();
      bossCtx2.globalAlpha = 1;
    }

    // boss sprite
    drawMagolorLikeBoss(bossCtx2, bossGame.boss.x, bossGame.boss.y, 0.75);

    // player heart
    bossCtx2.save();
    bossCtx2.translate(bossGame.player.x, bossGame.player.y);
    const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
    bossCtx2.globalAlpha = blink;
    bossCtx2.fillStyle = "#ef4444";
    bossCtx2.beginPath();
    bossCtx2.moveTo(0, 9);
    bossCtx2.bezierCurveTo(-16, -4, -10, -20, 0, -10);
    bossCtx2.bezierCurveTo(10, -20, 16, -4, 0, 9);
    bossCtx2.fill();
    bossCtx2.restore();

    // bullets
    for (const b of bossGame.bullets){
      bossCtx2.save();
      bossCtx2.translate(b.x, b.y);
      if (b.kind === "orb"){
        bossCtx2.globalAlpha = 0.92;
        bossCtx2.beginPath(); bossCtx2.arc(0,0,b.r,0,Math.PI*2);
        bossCtx2.fillStyle = "#a78bfa";
        bossCtx2.fill();
      } else if (b.kind === "dash"){
        bossCtx2.globalAlpha = 0.95;
        roundRectPath(bossCtx2, -14, -5, 28, 10, 6);
        bossCtx2.fillStyle = "#fb7185";
        bossCtx2.fill();
      } else {
        bossCtx2.globalAlpha = 0.92;
        drawHeartShape(bossCtx2, 0, 0, b.r);
        bossCtx2.fillStyle = "#f43f5e";
        bossCtx2.fill();
      }
      bossCtx2.restore();
    }
    bossCtx2.globalAlpha = 1;

    // beams
    for (const p of bossGame.beams){
      bossCtx2.save();
      bossCtx2.translate(p.x, p.y);
      bossCtx2.globalAlpha = 0.85;
      roundRectPath(bossCtx2, -3, -12, 6, 24, 6);
      bossCtx2.fillStyle = "#22c55e";
      bossCtx2.fill();
      bossCtx2.restore();
    }

    // particles
    for (const pt of bossGame.particles){
      bossCtx2.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
      bossCtx2.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      bossCtx2.fillText(pt.emoji, pt.x, pt.y);
    }
    bossCtx2.globalAlpha = 1;
  }

  let bossLast = 0;
  function bossLoop(ts){
    if (!bossGame.running) return;
    if (!bossLast) bossLast = ts;
    const dt = Math.min(0.033, (ts - bossLast) / 1000);
    bossLast = ts;

    updateBoss(dt);
    drawBoss();
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function startBossFight(){
    resetBossFight();
    bossGame.running = true;

    bossOverlay.style.opacity = "0";
    bossStartBtn.style.opacity = "0";
    bossStartBtn.style.pointerEvents = "none";

    bossMsg.textContent = "MAGALOR is being dramatic üò≥ Hit him with LOVE BEAMS.";
    document.body.classList.add("boss-mode");

    bossLast = 0;
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function stopBossFight(){
    bossGame.running = false;
    if (bossRaf) cancelAnimationFrame(bossRaf);
    bossRaf = null;
    document.body.classList.remove("boss-mode");
  }

  function winBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-slate-800/80">
        <div class="text-4xl font-extrabold">MAGALOR DEFEATED üíò</div>
        <div class="text-sm font-semibold mt-2">Unlocked! Now click YES üò§üíû</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Rematch (optional)";

    bossMsg.textContent = "Unlocked! YES + NO are now available.";
    unlockYesNo();

    try { confetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } }); } catch {}
  }

  function loseBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-slate-800/80">
        <div class="text-4xl font-extrabold">You got bonked üí•</div>
        <div class="text-sm font-semibold mt-2">Try again‚Ä¶ turn chaos into cuddles üò§</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Try Again";
    bossMsg.textContent = "Tip: Move in circles while shooting!";
  }

  bossStartBtn.addEventListener("click", startBossFight);
  resetBossFight();

  // ========== Platformer ==========
  const platCanvas = document.getElementById("platCanvas");
  const platCtx = platCanvas.getContext("2d");
  const platStartBtn = document.getElementById("platStart");
  const platOverlay = document.getElementById("platOverlay");
  const platMsg = document.getElementById("platMsg");
  const platCountEl = document.getElementById("platCount");

  let platRaf = null;
  let platLast = 0;

  fitCanvasToCSS(platCanvas, platCtx);

  const platGame = {
    running: false,
    heartsTarget: 7,
    heartsGot: 0,
    camX: 0,
    levelW: 1500,
    gravity: 0.55,
    player: { x: 60, y: 160, w: 18, h: 22, vx: 0, vy: 0, onGround: false },
    platforms: [],
    hearts: [],
    goal: { x: 1420, y: 140, w: 24, h: 24 }
  };

  function resetPlatformer(){
    platGame.running = false;
    platGame.heartsGot = 0;
    platCountEl.textContent = "0";
    platMsg.innerHTML = `Collect <b>${platGame.heartsTarget}</b> hearts üíñ and touch the <b>love letter</b> üíå.`;
    platOverlay.style.opacity = "1";
    platStartBtn.style.opacity = "1";
    platStartBtn.style.pointerEvents = "auto";
    platStartBtn.textContent = "Start Platformer";

    platGame.player.x = 60; platGame.player.y = 160;
    platGame.player.vx = 0; platGame.player.vy = 0; platGame.player.onGround = false;
    platGame.camX = 0;

    platGame.platforms = [
      { x: 0,   y: 250, w: 420, h: 22 },
      { x: 460, y: 220, w: 170, h: 18 },
      { x: 680, y: 190, w: 160, h: 18 },
      { x: 890, y: 235, w: 190, h: 18 },
      { x: 1120,y: 190, w: 200, h: 18 },
      { x: 1360,y: 245, w: 160, h: 18 },
      { x: 0,   y: 300, w: 1500, h: 70 },
    ];

    platGame.hearts = [
      { x: 140, y: 205, taken: false },
      { x: 320, y: 195, taken: false },
      { x: 520, y: 175, taken: false },
      { x: 730, y: 145, taken: false },
      { x: 940, y: 185, taken: false },
      { x: 1180,y: 145, taken: false },
      { x: 1370,y: 190, taken: false },
    ];
  }

  function rectsOverlap(a, b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function updatePlatformer(){
    const w = platCanvas.getBoundingClientRect().width;
    const left = keys.has("ArrowLeft") || keys.has("a");
    const right = keys.has("ArrowRight") || keys.has("d");
    const jump = keys.has("ArrowUp") || keys.has("w") || keys.has(" ");

    const p = platGame.player;
    const accel = 0.55;
    const maxV = 4.2;
    const friction = 0.82;

    if (left) p.vx -= accel;
    if (right) p.vx += accel;
    if (!left && !right) p.vx *= friction;
    p.vx = clamp(p.vx, -maxV, maxV);

    if (jump && p.onGround){
      p.vy = -9.3;
      p.onGround = false;
    }

    p.vy += platGame.gravity;
    p.vy = clamp(p.vy, -20, 12);

    p.x += p.vx;
    p.y += p.vy;

    p.x = clamp(p.x, 0, platGame.levelW - p.w);
    if (p.y > 440) { p.y = 120; p.vy = 0; }

    p.onGround = false;
    for (const plat of platGame.platforms){
      const a = { x: p.x, y: p.y, w: p.w, h: p.h };
      const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
      if (rectsOverlap(a,b)){
        if (p.vy > 0 && (p.y + p.h - p.vy) <= plat.y + 2){
          p.y = plat.y - p.h;
          p.vy = 0;
          p.onGround = true;
        } else if (p.vy < 0 && (p.y - p.vy) >= plat.y + plat.h - 2){
          p.y = plat.y + plat.h;
          p.vy = 0;
        }
      }
    }

    for (const heart of platGame.hearts){
      if (heart.taken) continue;
      const hb = { x: heart.x - 8, y: heart.y - 8, w: 16, h: 16 };
      const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
      if (rectsOverlap(pb, hb)){
        heart.taken = true;
        platGame.heartsGot += 1;
        platCountEl.textContent = String(platGame.heartsGot);
        try { confetti({ particleCount: 60, spread: 55, origin: { y: 0.7 } }); } catch {}
        platMsg.innerHTML = `Aww üíñ ${platGame.heartsGot}/${platGame.heartsTarget} collected!`;
      }
    }

    platGame.camX = clamp(p.x - w*0.35, 0, platGame.levelW - w);

    const goal = platGame.goal;
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    const gb = { x: goal.x, y: goal.y, w: goal.w, h: goal.h };
    if (rectsOverlap(pb, gb) && platGame.heartsGot >= platGame.heartsTarget){
      winPlatformer();
    }
  }

  function drawPlatformer(){
    const w = platCanvas.getBoundingClientRect().width;
    const h = platCanvas.getBoundingClientRect().height;
    platCtx.clearRect(0,0,w,h);

    const g = platCtx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, "rgba(255, 192, 203, 0.20)");
    g.addColorStop(1, "rgba(173, 216, 230, 0.22)");
    platCtx.fillStyle = g;
    platCtx.fillRect(0,0,w,h);

    const cam = platGame.camX;
    platCtx.save();
    platCtx.translate(-cam, 0);

    for (const plat of platGame.platforms){
      platCtx.globalAlpha = 0.95;
      platCtx.fillStyle = "#ffffff";
      platCtx.strokeStyle = "rgba(15, 23, 42, 0.15)";
      platCtx.lineWidth = 2;
      roundRectPath(platCtx, plat.x, plat.y, plat.w, plat.h, 12);
      platCtx.fill();
      platCtx.stroke();
      platCtx.globalAlpha = 1;
    }

    for (const heart of platGame.hearts){
      if (heart.taken) continue;
      platCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      platCtx.fillText("üíñ", heart.x - 8, heart.y + 6);
    }

    platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
    platCtx.fillText("üíå", platGame.goal.x - 4, platGame.goal.y + 20);

    const p = platGame.player;
    platCtx.save();
    platCtx.translate(p.x + p.w/2, p.y + p.h/2);
    platCtx.fillStyle = "#ef4444";
    drawHeartShape(platCtx, 0, 2, 14);
    platCtx.fill();
    platCtx.restore();

    platCtx.restore();
  }

  function platformerLoop(ts){
    if (!platGame.running) return;
    if (!platLast) platLast = ts;
    const dt = Math.min(0.033, (ts - platLast) / 1000);
    platLast = ts;

    for (let i=0;i<Math.max(1, Math.floor(dt/0.016)); i++){
      updatePlatformer();
    }
    drawPlatformer();
    platRaf = requestAnimationFrame(platformerLoop);
  }

  function startPlatformer(){
    resetPlatformer();
    platGame.running = true;
    platOverlay.style.opacity = "0";
    platStartBtn.style.opacity = "0";
    platStartBtn.style.pointerEvents = "none";
    platMsg.innerHTML = `Go go go üíû Collect ${platGame.heartsTarget} hearts!`;
    platLast = 0;
    platRaf = requestAnimationFrame(platformerLoop);
  }

  function stopPlatformer(showOverlay = true){
    platGame.running = false;
    if (platRaf) cancelAnimationFrame(platRaf);
    platRaf = null;
    if (showOverlay){
      platOverlay.style.opacity = "1";
      platStartBtn.style.opacity = "1";
      platStartBtn.style.pointerEvents = "auto";
    }
  }

  function winPlatformer(){
    stopPlatformer(false);
    platOverlay.style.opacity = "1";
    platOverlay.innerHTML = `
      <div class="text-slate-800/80">
        <div class="text-4xl font-extrabold">LOVE QUEST COMPLETE üíå</div>
        <div class="text-sm font-semibold mt-2">Okay‚Ä¶ that was adorable.</div>
      </div>
    `;
    platStartBtn.style.opacity = "1";
    platStartBtn.style.pointerEvents = "auto";
    platStartBtn.textContent = "Play Again";
    platMsg.innerHTML = `Awwww üíñ You did it!`;
    try { confetti({ particleCount: 180, spread: 90, origin: { y: 0.65 } }); } catch {}
  }

  platStartBtn.addEventListener("click", startPlatformer);
  resetPlatformer();

  // Resize canvases properly on resize
  window.addEventListener("resize", () => {
    fitCanvasToCSS(bossCanvas, bossCtx2);
    fitCanvasToCSS(platCanvas, platCtx);
  });

</script>
</body>
</html>

