<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Will you be my Valentine Andrew Getzow?</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* =========================================================
      NEW: Day/Night + prettier global palette using CSS vars
    ========================================================= */
    :root{
      --bg-a: rgba(255, 182, 193, 0.55);
      --bg-b: rgba(255, 105, 180, 0.28);
      --bg-c: rgba(147, 197, 253, 0.35);
      --bg-l1: #fff1f2;
      --bg-l2: #ffe4e6;
      --bg-l3: #fdf2f8;
      --bg-l4: #eff6ff;

      --glass: rgba(255, 255, 255, 0.78);
      --glass2: rgba(255, 255, 255, 0.70);
      --ink: rgba(15, 23, 42, 0.85);
      --muted: rgba(15, 23, 42, 0.65);

      --frame: rgba(255,255,255,0.65);
      --shadow: rgba(0,0,0,0.14);
      --accent1: #fb7185;
      --accent2: #ec4899;
      --accent3: #6366f1;

      --sectionRibbon: rgba(251, 113, 133, 0.22);
      --sectionRibbon2: rgba(99, 102, 241, 0.18);
    }

    body.night-mode{
      --bg-a: rgba(147, 51, 234, 0.35);
      --bg-b: rgba(59, 130, 246, 0.22);
      --bg-c: rgba(244, 63, 94, 0.20);
      --bg-l1: #0b1020;
      --bg-l2: #0f172a;
      --bg-l3: #111827;
      --bg-l4: #0b1020;

      --glass: rgba(15, 23, 42, 0.62);
      --glass2: rgba(15, 23, 42, 0.55);
      --ink: rgba(248, 250, 252, 0.92);
      --muted: rgba(226, 232, 240, 0.75);

      --frame: rgba(255,255,255,0.16);
      --shadow: rgba(0,0,0,0.28);

      --sectionRibbon: rgba(236, 72, 153, 0.18);
      --sectionRibbon2: rgba(59, 130, 246, 0.16);
    }

    body{
      background:
        radial-gradient(900px 520px at 20% 15%, var(--bg-a), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, var(--bg-b), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, var(--bg-c), transparent 60%),
        linear-gradient(180deg, var(--bg-l1) 0%, var(--bg-l2) 40%, var(--bg-l3) 70%, var(--bg-l4) 100%);
      overflow-x:hidden;
      color: var(--ink);
    }

    /* keep your shiny-mode, now it stacks with day/night */
    body.shiny-mode{
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(167, 139, 250, 0.50), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(34, 211, 238, 0.22), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(250, 204, 21, 0.24), transparent 60%),
        linear-gradient(180deg, #f5f3ff 0%, #e0f2fe 50%, #fff7ed 100%);
    }

    /* Boss mode tint */
    body.boss-mode::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
        linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
      opacity: 0.85;
      mix-blend-mode: multiply;
    }

    /* =========================================================
      NEW: Extra â€œprettyâ€ layout styling (frames + ribbons)
    ========================================================= */
    .quest-shell{
      position: relative;
      border-radius: 28px;
      border: 1px solid var(--frame);
      background: var(--glass2);
      box-shadow: 0 22px 70px var(--shadow);
      overflow:hidden;
    }
    .quest-shell::before{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(800px 240px at 20% 0%, var(--sectionRibbon), transparent 60%),
        radial-gradient(800px 240px at 80% 30%, var(--sectionRibbon2), transparent 60%);
      opacity: 0.95;
      mix-blend-mode: overlay;
    }
    .quest-shell > *{ position: relative; z-index: 1; }

    .pretty-divider{
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(251,113,133,.0), rgba(251,113,133,.65), rgba(99,102,241,.55), rgba(251,113,133,.0));
      opacity: .85;
    }

    /* BG layers */
    #bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .blob {
      position: absolute;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      transform: translate3d(0,0,0);
      mix-blend-mode: multiply;
      will-change: transform;
    }
    .blob.a { left:-140px; top:-160px;
      background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
      animation: floatA 14s ease-in-out infinite;
    }
    .blob.b { right:-160px; top:-120px;
      background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
      animation: floatB 16s ease-in-out infinite;
    }
    .blob.c { left:10%; bottom:-210px;
      background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
      animation: floatC 18s ease-in-out infinite;
    }
    @keyframes floatA { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(80px,60px) scale(1.08);} }
    @keyframes floatB { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(-90px,70px) scale(1.06);} }
    @keyframes floatC { 0%,100% { transform: translate(0,0) scale(1);} 50%{ transform: translate(120px,-60px) scale(1.1);} }
    body.boss-mode .blob.a{ animation-duration: 9s; }
    body.boss-mode .blob.b{ animation-duration: 10s; }
    body.boss-mode .blob.c{ animation-duration: 11s; }

    .noise {
      position: absolute;
      inset: 0;
      opacity: 0.10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }

    /* your black hole GIF grid */
    .pixel-grid{
      position:absolute;
      inset:0;
      opacity:.22;
      background-image: url("https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjliOThhaGVlNzMyNWFsa2RhZmdidGdxczU0eDF1bTBxMjZpNXRnMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xUA7b2takylWgFwJYQ/giphy.gif");
      background-size: cover;
      background-position: center;
      mix-blend-mode: overlay;
      filter: saturate(0.95) contrast(1.05);
    }

    /* Floating particles */
    #powerups, #hearts, #petals{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }
    #powerups{ z-index: 1; }
    .heart, .powerup, .petal{
      position: absolute;
      bottom: -40px;
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
      user-select: none;
      opacity: 0;
    }
    .heart{ animation: floatUp linear forwards; }
    .powerup{ animation: puFloat linear forwards; }
    .petal{ animation: petalFloat linear forwards; }

    @keyframes floatUp {
      0%   { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
      10%  { opacity: 0.85; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity: 0; }
    }
    @keyframes puFloat{
      0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
      12%  { opacity: .9; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity: 0; }
    }
    @keyframes petalFloat{
      0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
      10%  { opacity: .9; }
      100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15) rotate(var(--rot)); opacity: 0; }
    }

    /* Pixel clouds */
    #pixelClouds{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }
    .pixel-cloud{
      position: absolute;
      left: -260px;
      top: var(--top);
      width: 240px;
      height: 120px;
      opacity: 0.30;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.08));
      image-rendering: pixelated;
      background-repeat: no-repeat;
      background-size: 100% 100%;
      animation: cloudDrift linear forwards;
      transform: translateZ(0);
    }
    body.boss-mode .pixel-cloud{ opacity: 0.18; }
    @keyframes cloudDrift{
      from { transform: translateX(0) scale(var(--s)); }
      to   { transform: translateX(calc(100vw + 520px)) scale(var(--s)); }
    }

    /* Big title */
    #bigTitle{
      position: relative;
      z-index: 3;
      text-align: center;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 0.95;
      font-size: clamp(2.0rem, 5vw, 3.8rem);
      color: #ffffff;
      text-shadow: 0 4px 0 rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.22);
      margin-bottom: 0.9rem;
      user-select: none;
    }
    #bigTitle span{
      display: inline-block;
      padding: 0.18em 0.42em;
      border-radius: 999px;
      background: rgba(244, 63, 94, 0.20);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
    }

    /* card */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid var(--frame);
      box-shadow: 0 22px 70px var(--shadow);
    }

    .pixel-vibe { text-shadow: 0 2px 0 rgba(0,0,0,0.08); }
    .mascot-bounce { animation: mascotBounce 1.8s ease-in-out infinite; }
    @keyframes mascotBounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

    /* Heart buttons */
    .svg-heart{
      width: 56px;
      height: 50px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      will-change: transform;
    }
    .svg-heart svg{ width: 100%; height: 100%; display: block; }
    .svg-heart.yes path{ fill: #ef4444; }
    .svg-heart.no  path{ fill: #f43f5e; }

    /* âœ… NEW: NO button is bigger + slightly â€œmenacingâ€ */
    .svg-heart.no{
      width: 78px;
      height: 70px;
      transform-origin: center;
      animation: noBreath 1.6s ease-in-out infinite;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.22));
    }
    @keyframes noBreath{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.06); }
    }

    .svg-heart span{
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      transform: translateY(-4px);
      color: white; font-weight: 900; font-size: 11px;
      letter-spacing: .7px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      user-select: none; pointer-events: none;
    }
    .svg-heart:hover{ transform: scale(1.06); filter: drop-shadow(0 12px 18px rgba(0,0,0,.18)); }
    .svg-heart:active{ transform: scale(.96); }

    /* Mana bar */
    #manaWrap{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #manaBarInner{
      width: 0%;
      transition: width 160ms ease;
    }

    /* Quest Map header (NEW) */
    #questMap{
      position: sticky;
      top: 0;
      z-index: 55;
      margin-bottom: 10px;
    }
    .quest-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--frame);
      background: rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.92);
      box-shadow: 0 18px 45px rgba(0,0,0,0.14);
      font-weight: 900;
      user-select:none;
    }
    body.night-mode .quest-chip{
      background: rgba(15,23,42,0.25);
      color: rgba(248,250,252,0.92);
    }

    /* MTG-ish card frame (unchanged) */
    .tcg-card{
      border-radius: 18px;
      border: 1px solid var(--frame);
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(255,255,255,0.70));
      box-shadow: 0 18px 60px rgba(0,0,0,0.14);
      overflow: hidden;
      position: relative;
    }
    body.night-mode .tcg-card{
      background: linear-gradient(180deg, rgba(15,23,42,0.70), rgba(15,23,42,0.55));
      box-shadow: 0 18px 60px rgba(0,0,0,0.30);
    }
    .tcg-frame{
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      background:
        radial-gradient(600px 220px at 20% 10%, rgba(251, 113, 133, 0.22), transparent 60%),
        radial-gradient(600px 220px at 80% 30%, rgba(99, 102, 241, 0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
    }
    body.night-mode .tcg-frame{
      border-color: rgba(248,250,252,0.14);
      background:
        radial-gradient(600px 220px at 20% 10%, rgba(236, 72, 153, 0.16), transparent 60%),
        radial-gradient(600px 220px at 80% 30%, rgba(59, 130, 246, 0.14), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,0.60), rgba(15,23,42,0.45));
    }

    .tcg-titlebar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.10);
      font-weight: 900;
    }
    body.night-mode .tcg-titlebar{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.10);
    }
    .tcg-subbar{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(15,23,42,0.10);
    }
    body.night-mode .tcg-subbar{
      background: rgba(255,255,255,0.07);
      border-color: rgba(255,255,255,0.10);
    }
    .tcg-rules{
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 12px;
      padding: 12px;
    }
    body.night-mode .tcg-rules{
      background: rgba(255,255,255,0.07);
      border-color: rgba(255,255,255,0.10);
    }
    .mana-pip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15,23,42,0.08);
      border: 1px solid rgba(15,23,42,0.12);
      font-weight: 900;
      font-size: 12px;
      margin-left: 6px;
    }
    body.night-mode .mana-pip{
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.12);
      color: rgba(248,250,252,0.9);
    }

    /* Encounter */
    .encounter{
      border-radius: 18px;
      border: 1px solid var(--frame);
      background: var(--glass2);
      box-shadow: 0 18px 60px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .encounter-screen{
      background: linear-gradient(180deg, rgba(34,197,94,0.16), rgba(59,130,246,0.14));
      border-bottom: 1px solid rgba(15,23,42,0.10);
      padding: 16px;
      position: relative;
      overflow:hidden;
    }
    body.night-mode .encounter-screen{
      background: linear-gradient(180deg, rgba(59,130,246,0.12), rgba(236,72,153,0.10));
      border-bottom-color: rgba(255,255,255,0.10);
    }
    .text-box{
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      padding: 12px;
      font-weight: 800;
      min-height: 58px;
    }
    body.night-mode .text-box{
      background: rgba(15,23,42,0.60);
      border-color: rgba(255,255,255,0.14);
      color: rgba(248,250,252,0.92);
    }
    .hpbar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(255,255,255,0.65);
      overflow:hidden;
    }
    body.night-mode .hpbar{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.12);
    }
    .hpbar > div{
      height: 100%;
      width: 100%;
      transition: width 220ms ease;
      background: linear-gradient(90deg, rgba(34,197,94,0.9), rgba(250,204,21,0.9), rgba(239,68,68,0.9));
    }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.55);
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal-backdrop.show{ display: flex; }

    /* Boss blackhole gif overlay */
    #blackholeGif{
      position: absolute;
      left: 50%;
      top: 44%;
      transform: translate(-50%, -50%);
      width: 170px;
      height: 170px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,0.22));
      mix-blend-mode: screen;
    }

    /* =========================================================
      NEW: NO Boss Fight modal styling
    ========================================================= */
    #noBossCard{
      width: min(1100px, 96vw);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.22);
      background: linear-gradient(180deg, rgba(15,23,42,0.78), rgba(15,23,42,0.62));
      box-shadow: 0 26px 80px rgba(0,0,0,0.40);
      overflow:hidden;
      position: relative;
    }
    #noBossCard::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(900px 420px at 25% 0%, rgba(244,63,94,0.25), transparent 65%),
        radial-gradient(900px 420px at 80% 25%, rgba(99,102,241,0.18), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      opacity: 0.95;
      pointer-events:none;
    }
    #noBossCard > *{ position: relative; z-index: 1; }
    #noBossCanvas{
      width: 100%;
      display:block;
      height: 520px;
      background: rgba(255,255,255,0.06);
    }
    @media (max-width: 640px){
      #noBossCanvas{ height: 460px; }
    }

    /* =========================================================
      NEW: Retro mode (Konami egg)
    ========================================================= */
    body.retro-mode .pixel-grid{
      opacity: .35;
      filter: saturate(1.1) contrast(1.25) hue-rotate(12deg);
    }
    body.retro-mode *{
      text-shadow: 0 0 0 rgba(0,0,0,0);
    }
    body.retro-mode #bigTitle span{
      box-shadow: 0 0 0 2px rgba(255,255,255,0.25) inset, 0 14px 40px rgba(0,0,0,0.25);
    }

    /* Mirror mode (egg) */
    body.mirror-mode{
      filter: hue-rotate(150deg) saturate(1.2) contrast(1.08);
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- BG -->
  <div id="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
    <div class="blob c"></div>
    <div class="noise"></div>
    <div class="pixel-grid"></div>
  </div>

  <div id="powerups" aria-hidden="true"></div>
  <div id="pixelClouds" aria-hidden="true"></div>
  <div id="hearts" aria-hidden="true"></div>
  <div id="petals" aria-hidden="true"></div>

  <!-- Title -->
  <div class="relative z-[3] px-4 pt-6">
    <div class="max-w-7xl mx-auto">

      <!-- NEW: Quest Map header -->
      <div id="questMap" class="flex flex-wrap justify-center gap-2 mb-4">
        <div class="quest-chip">ğŸ—ºï¸ QUEST MAP</div>
        <div class="quest-chip">ğŸ’˜ Boss</div>
        <div class="quest-chip">ğŸ•¹ï¸ Platformer</div>
        <div class="quest-chip">ğŸƒ TCG</div>
        <div class="quest-chip">âœ¨ Spells</div>
        <div class="quest-chip">ğŸ«¶ PokÃ©mon</div>
      </div>

      <h1 id="bigTitle" class="w-full">
        <span>Love Beyond the Multiverse ğŸ’˜</span>
      </h1>

      <!-- Mana / shiny / day-night -->
      <div id="manaWrap" class="rounded-2xl glass px-4 py-3 mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm font-extrabold" style="color: var(--muted);">
            Affection Mana: <span id="manaPct">0</span>%
            <span class="ml-2 text-xs font-black opacity-70" id="modeLabel"></span>
          </div>

          <div class="flex items-center gap-2">
            <button id="dayNightBtn"
              class="rounded-full px-4 py-2 font-black border border-white/60 bg-white/70 shadow active:scale-95 transition"
              title="Day/Night">
              ğŸŒ/ğŸŒ™
            </button>

            <button id="shinyStar"
              class="text-sm font-black transition"
              style="color: var(--muted);"
              title="psstâ€¦ click me 3x">
              â­ Shiny Chance
            </button>
          </div>
        </div>
        <div class="mt-2 h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
          <div id="manaBarInner" class="h-full bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
        </div>
      </div>

      <div class="text-center text-white/90 font-extrabold tracking-wide drop-shadow-sm mb-5">
        Two universes. One question.
        <span class="block text-sm font-semibold text-white/80 mt-1">A limited-time crossover has appearedâ€¦</span>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="relative z-[3] max-w-7xl mx-auto px-4 pb-10">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5 items-start">

      <!-- LEFT: Valentine card -->
      <aside class="lg:sticky lg:top-24">
        <div class="quest-shell p-6 text-center">
          <div class="mx-auto mb-3 w-28 mascot-bounce">
            <div class="w-24 h-24 mx-auto">
              <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
                <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
                <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
                <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
                <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
                <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <circle cx="50" cy="55" r="2" fill="#fff"/>
                <circle cx="74" cy="55" r="2" fill="#fff"/>
                <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
                <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                         C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                      fill="#ef4444"/>
                <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                      stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
                <rect x="92" y="70" width="8" height="30" rx="3" fill="#334155"/>
                <rect x="84" y="60" width="26" height="14" rx="6" fill="#475569"/>
                <circle cx="84" cy="67" r="6" fill="#475569"/>
              </svg>
            </div>

            <!-- Easter egg target: clicking this date multiple times does something -->
            <div id="dateStamp" class="mt-1 text-center font-extrabold text-sm tracking-wide opacity-80 pixel-vibe" style="color: var(--muted); cursor:pointer;">
              2/14/26
            </div>
          </div>

          <div class="font-black mb-3" style="color: var(--muted);">
            Will you be my Valentine Andrew Getzow?
          </div>

          <img id="valImage" class="w-full h-64 object-cover rounded-xl mb-4"
               style="background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));"
               alt="Valentine gif" />

          <div class="pretty-divider my-4"></div>

          <div class="flex gap-6 justify-center mt-2">
            <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>YES</span>
            </button>

            <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
              <svg viewBox="0 0 32 29" aria-hidden="true">
                <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
                  c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
              </svg>
              <span>NO</span>
            </button>
          </div>

          <p id="hint" class="text-sm mt-4 font-semibold opacity-80" style="color: var(--muted);">
            Both buttons are locked ğŸ˜ˆ Beat the boss first.
          </p>

          <p class="text-xs font-black opacity-60 mt-2" style="color: var(--muted);">
            (Psst: there are 7 easter eggsâ€¦ one is Konami code.)
          </p>
        </div>
      </aside>

      <!-- RIGHT: content -->
      <main class="space-y-5">

        <!-- EVENT START -->
        <section class="quest-shell p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-2xl font-black opacity-90">Begin the Event</div>
              <div class="text-sm font-semibold opacity-80 mt-1">
                A limited-time crossover has appearedâ€¦ defeat the boss to unlock the ultimate question.
              </div>
            </div>
            <button id="beginEvent"
              class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, var(--accent1), var(--accent2), var(--accent3));">
              Begin the Event
            </button>
          </div>
        </section>

        <!-- BOSS FIGHT (your existing boss fight kept) -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black opacity-90">ğŸ‘¾ Boss Fight (Love Edition)</div>
            <div class="text-xs font-black opacity-70">Move: WASD/Arrows â€¢ Attack: Space / Tap</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-xs font-black opacity-80 mb-1">YOU ğŸ’–</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black opacity-80 mb-1">BOSS â˜„ï¸</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black opacity-80 mb-1">LOVE METER ğŸ’˜</div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
                </div>
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="bossCanvas" class="w-full block h-[420px]"></canvas>

              <img id="blackholeGif" alt="Black hole gif" />

              <div id="laughFlash"
                  class="absolute top-6 left-1/2 -translate-x-1/2 text-3xl sm:text-5xl font-black tracking-widest text-white drop-shadow-lg opacity-0 pointer-events-none">
                MAGALOR LAUGH
              </div>

              <div id="bossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="opacity-90">
                  <div class="text-3xl font-extrabold">A wild boss appeared!</div>
                  <div class="text-sm font-semibold mt-2">Dodge cursed hearts. Shoot love beams.</div>
                </div>
              </div>

              <button id="bossStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, var(--accent3), var(--accent2), var(--accent1));">
                Start Boss Fight
              </button>
            </div>

            <div id="bossMsg" class="mt-3 text-sm font-semibold opacity-80">
              Beat the boss to unlock YES + NO.
            </div>
          </div>
        </section>

        <!-- PLATFORMER (kept) -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black opacity-90">ğŸ•¹ï¸ Platformer: Collect the Hearts</div>
            <div class="text-xs font-black opacity-70">Move: A/D or â†/â†’ â€¢ Jump: W/â†‘/Space</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3 items-center">
              <div class="sm:col-span-2 text-sm font-semibold opacity-80" id="platMsg">
                Collect <b>7</b> hearts ğŸ’– and touch the <b>love letter</b> ğŸ’Œ.
              </div>
              <div class="text-xs font-black opacity-80 text-right">
                Hearts: <span id="platCount">0</span>/7
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="platCanvas" class="w-full block h-[360px]"></canvas>

              <div id="platOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="opacity-90">
                  <div class="text-3xl font-extrabold">Tiny Love Quest ğŸ’Œ</div>
                  <div class="text-sm font-semibold mt-2">Jump on platforms, grab hearts, reach the letter.</div>
                </div>
              </div>

              <button id="platStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, var(--accent1), var(--accent2), #60a5fa);">
                Start Platformer
              </button>
            </div>
          </div>
        </section>

        <!-- MTG-STYLE (kept) -->
        <section class="tcg-card">
          <div class="p-6">
            <div class="flex items-center justify-between gap-3 mb-4">
              <div>
                <div class="text-2xl font-black opacity-90">1) Custom TCG Card: â€œBe My Valentineâ€</div>
                <div class="text-sm font-semibold opacity-80 mt-1">
                  Hover/click to reveal â€œalt artâ€ ğŸ‘€
                </div>
              </div>
              <button id="altArtBtn"
                class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
                style="background: linear-gradient(135deg, var(--accent1), var(--accent3));">
                Reveal Alt Art
              </button>
            </div>

            <div id="tcgCard" class="tcg-frame">
              <div class="tcg-titlebar">
                <div id="cardName">Andrew Getzow, Keeper of My Heart</div>
                <div class="text-xs font-black opacity-70">
                  Cost:
                  <span class="mana-pip">ğŸ«</span>
                  <span class="mana-pip">â¤ï¸</span>
                  <span class="mana-pip">ğŸ¿</span>
                </div>
              </div>

              <div class="tcg-subbar">
                <div class="text-xs font-black opacity-70">Legendary Creature â€” Human Nerd</div>
                <div class="text-xs font-black opacity-70">
                  P/T: <span class="mana-pip">7</span>/<span class="mana-pip">14</span>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-1 md:grid-cols-[220px_1fr] gap-3">
                <div class="rounded-xl overflow-hidden border border-slate-900/10 bg-white/70">
                  <div id="cardArt" class="h-44 flex items-center justify-center font-black opacity-70">
                    (Put a cute photo here later)
                  </div>
                </div>

                <div class="tcg-rules">
                  <div class="text-sm font-semibold opacity-90 leading-relaxed">
                    <div><b>Whenever you smile</b>, create a <b>Heart token</b>.</div>
                    <div class="mt-1"><b>{T}:</b> Go on a date. If itâ€™s Valentineâ€™s Day, you may also get dessert.</div>
                    <div class="mt-1"><b>Partner</b> with <b>You, Hopeless Romantic</b>.</div>
                    <div class="mt-2 text-xs font-black opacity-70">
                      Reminder text: Heart tokens have â€œ{1}: Make me blush. Scry 1.â€
                    </div>
                  </div>
                  <div class="mt-3 text-xs italic font-bold opacity-70">
                    â€œIâ€™d tap all my mana for you.â€
                  </div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="rounded-xl bg-white/70 border border-white/60 p-3">
                  <div class="text-xs font-black opacity-70">Flavor</div>
                  <div class="text-sm font-semibold opacity-90 mt-1">â€œTurn 1: I fell. Turn 2: I stayed.â€</div>
                </div>
                <div class="rounded-xl bg-white/70 border border-white/60 p-3">
                  <div class="text-xs font-black opacity-70">Synergy</div>
                  <div class="text-sm font-semibold opacity-90 mt-1">If love is a stack, my feelings have split second.</div>
                </div>
                <div class="rounded-xl bg-white/70 border border-white/60 p-3">
                  <div class="text-xs font-black opacity-70">Inside Joke Slot</div>
                  <div class="text-sm font-semibold opacity-90 mt-1">â€œOur first date was basically a turn 1 love play.â€</div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- Choose a Date (kept) -->
        <section class="quest-shell p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black opacity-90">2) Choose a Date (Cast a Spell)</div>
              <div class="text-sm font-semibold opacity-80 mt-1">
                Pick a spell â€” it goes on <b>the stack</b> âœ¨
              </div>
            </div>
            <button id="openDateModal"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, var(--accent2), #60a5fa);">
              Open Spellbook
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div id="chosenDate" class="text-sm font-semibold rounded-2xl bg-white/70 border border-white/60 p-4 opacity-90">
              Selected spell: <b>None yet</b>
              <div class="mt-2 text-xs font-black opacity-70">Mana spent: <span id="manaSpent">0</span></div>
            </div>

            <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
              <div class="text-xs font-black opacity-70 mb-2">THE STACK</div>
              <div id="spellStack" class="space-y-2 text-sm font-semibold opacity-90">
                <div class="opacity-70">â€” empty â€”</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Token generator (kept) -->
        <section class="quest-shell p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black opacity-90">3) Heart Token Generator</div>
              <div class="text-sm font-semibold opacity-80 mt-1">
                Generate love mana. Unlock messages at 5/10/20.
              </div>
            </div>
            <button id="tokenBtn"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, var(--accent1), #f59e0b);">
              Create a Heart Token
            </button>
          </div>

          <div class="mt-4 grid grid-cols-6 sm:grid-cols-10 gap-2" id="tokenGrid"></div>
          <div class="mt-4 text-sm font-semibold opacity-80" id="tokenMsg">Tokens: <b id="tokenCount">0</b></div>
        </section>

        <!-- PokÃ©mon battle (kept) -->
        <section class="encounter">
          <div class="p-6">
            <div class="text-2xl font-black opacity-90 mb-3">4) Wild Valentine Appeared!</div>

            <div class="encounter-screen rounded-2xl">
              <div class="grid grid-cols-2 gap-3 items-start">
                <div class="rounded-2xl bg-white/70 border border-white/60 p-3">
                  <div class="flex items-center justify-between gap-2">
                    <div class="font-black opacity-90">Valentine (???)
                      <span class="text-xs font-black opacity-70 ml-2">Lv. 14</span>
                    </div>
                    <div class="text-xs font-black opacity-70">Type: ğŸ’–/âœ¨</div>
                  </div>
                  <div class="mt-2 hpbar"><div id="enemyHPBar"></div></div>
                  <div class="mt-2 text-4xl text-center select-none" id="enemySprite">ğŸ’˜</div>
                </div>

                <div class="rounded-2xl bg-white/70 border border-white/60 p-3">
                  <div class="flex items-center justify-between gap-2">
                    <div class="font-black opacity-90">You
                      <span class="text-xs font-black opacity-70 ml-2">Trainer</span>
                    </div>
                    <div class="text-xs font-black opacity-70">Ability: ğŸ’¬ Charm</div>
                  </div>
                  <div class="mt-2 hpbar"><div id="youHPBar"></div></div>
                  <div class="mt-2 text-4xl text-center select-none">ğŸ«¶</div>
                </div>
              </div>

              <div class="mt-3 text-box" id="battleText">A wild Valentine appeared!</div>
            </div>

            <div class="mt-4">
              <div id="battleMenuMain" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button class="rounded-xl px-4 py-3 font-black bg-white/80 border border-white/60 shadow active:scale-95 transition opacity-90"
                  id="btnFight">FIGHT</button>
                <button class="rounded-xl px-4 py-3 font-black bg-white/80 border border-white/60 shadow active:scale-95 transition opacity-90"
                  id="btnBag">BAG</button>
                <button class="rounded-xl px-4 py-3 font-black bg-white/80 border border-white/60 shadow active:scale-95 transition opacity-90"
                  id="btnTeam">TEAM</button>
                <button class="rounded-xl px-4 py-3 font-black bg-white/80 border border-white/60 shadow active:scale-95 transition opacity-90"
                  id="btnRun">RUN</button>
              </div>

              <div id="battleMenuFight" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
                  style="background: linear-gradient(135deg, var(--accent1), var(--accent2));" data-move="Compliment Beam">Compliment Beam</button>
                <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
                  style="background: linear-gradient(135deg, #60a5fa, #22c55e);" data-move="Snack Shield">Snack Shield</button>
                <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
                  style="background: linear-gradient(135deg, #f59e0b, var(--accent1));" data-move="Laugh Attack">Laugh Attack</button>
                <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
                  style="background: linear-gradient(135deg, var(--accent3), var(--accent2));" data-move="Cozy Aura">Cozy Aura</button>

                <button class="sm:col-span-2 rounded-xl px-4 py-3 font-black bg-white/85 border border-white/60 shadow active:scale-95 transition opacity-90"
                  id="btnBack">BACK</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Pokedex (kept) -->
        <section class="quest-shell p-6">
          <div class="text-2xl font-black opacity-90">5) PokÃ©dex Entry: Boyfriendmon</div>
          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-black opacity-90 text-lg">Boyfriendmon</div>
                <div class="text-sm font-semibold opacity-80 mt-1">Type: <b>Electric / Fairy</b></div>
                <div class="text-sm font-semibold opacity-80">Ability: <b>Makes Me Smile</b></div>
                <div class="text-sm font-semibold opacity-80">Habitat: <b>My heart (permanent residence)</b></div>
              </div>
              <div class="text-4xl">âš¡ğŸ’–</div>
            </div>
            <div class="mt-3 text-sm font-semibold opacity-90">
              PokÃ©dex: â€œKnown to boost happiness instantly. If spotted, expect uncontrollable laughter and sudden date plans.â€
            </div>
          </div>
        </section>

        <!-- Fusion Finale (kept) -->
        <section class="quest-shell p-6">
          <div class="text-2xl font-black opacity-90">6) Fusion Finale: Saga â†’ Capture Screen</div>
          <div class="text-sm font-semibold opacity-80 mt-1">
            Advance the sagaâ€¦ then the â€œcaptureâ€ appears.
          </div>

          <div class="mt-4 rounded-2xl border border-white/60 bg-white/70 p-5">
            <div id="sagaView">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black opacity-90">Saga: <span id="sagaTitle">Love Beyond the Multiverse</span></div>
                <div class="text-xs font-black opacity-70">Chapter <span id="sagaChapter">I</span>/III</div>
              </div>

              <div class="mt-3 text-sm font-semibold opacity-90" id="sagaText">
                I â€” â€œWe met and my life got better.â€
              </div>

              <button id="advanceSaga"
                class="mt-4 rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, var(--accent3), var(--accent2));">
                Advance Saga
              </button>
            </div>

            <div id="captureView" class="hidden">
              <div class="font-black opacity-90 text-lg">Throw the Love Ball?</div>
              <div class="text-sm font-semibold opacity-80 mt-1">Two options. Both are yes-coded.</div>

              <div class="mt-4 flex flex-wrap gap-3">
                <button id="throwLoveBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, var(--accent1), #f59e0b);">
                  YES
                </button>
                <button id="throwShinyBall"
                  class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                  style="background: linear-gradient(135deg, #22c55e, #60a5fa);">
                  YES (shiny)
                </button>
              </div>

              <div class="mt-3 text-sm font-semibold opacity-80" id="captureMsg">
                (Still locked until the boss is defeated ğŸ˜ˆ)
              </div>
            </div>
          </div>
        </section>

        <!-- Booster pack (kept) -->
        <section class="quest-shell p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-2xl font-black opacity-90">Bonus: Open a Booster Pack</div>
              <div class="text-sm font-semibold opacity-80 mt-1">
                It reveals the final question card.
              </div>
            </div>
            <button id="openBooster"
              class="rounded-full px-5 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #f59e0b, var(--accent2));">
              Open Booster
            </button>
          </div>

          <div id="boosterResult" class="mt-4 hidden rounded-2xl border border-white/60 bg-white/70 p-5">
            <div class="font-black opacity-90 text-xl">âœ¨ You pulled: â€œWill You Be My Valentine?â€</div>
            <div class="text-sm font-semibold opacity-80 mt-2">
              Congratulations. This is the rarest pull. (And also mandatory.) ğŸ’˜
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- DATE MODAL (kept) -->
  <div id="dateModal" class="modal-backdrop">
    <div class="glass rounded-3xl w-full max-w-3xl p-6">
      <div class="flex items-center justify-between gap-3">
        <div class="text-2xl font-black opacity-90">Choose a Date (Spell Cards)</div>
        <button id="closeDateModal" class="rounded-full px-4 py-2 font-extrabold bg-white/80 border border-white/60 shadow active:scale-95 transition">
          Close
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5">
        <div class="tcg-card p-4">
          <div class="font-black opacity-90">Cozy Date â€” Sorcery</div>
          <div class="text-xs font-black opacity-70 mt-1">Cost: â˜• <span class="mana-pip">1</span> â¤ï¸ <span class="mana-pip">1</span> ğŸ§¸</div>
          <div class="text-sm font-semibold opacity-80 mt-3">
            â€œCreate 2 Cuddle tokens. Draw a movie.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, var(--accent1), #60a5fa);"
            data-spell="Cozy Date" data-cost="2">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black opacity-90">Fancy Date â€” Instant</div>
          <div class="text-xs font-black opacity-70 mt-1">Cost: ğŸŒ¹ <span class="mana-pip">2</span> â¤ï¸ <span class="mana-pip">1</span> âœ¨</div>
          <div class="text-sm font-semibold opacity-80 mt-3">
            â€œGo somewhere cute. Add dessert. Gain +10 happiness.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, var(--accent2), #f59e0b);"
            data-spell="Fancy Date" data-cost="3">
            Cast this
          </button>
        </div>

        <div class="tcg-card p-4">
          <div class="font-black opacity-90">Chaos Date â€” Enchantment</div>
          <div class="text-xs font-black opacity-70 mt-1">Cost: ğŸ® <span class="mana-pip">2</span> â¤ï¸ <span class="mana-pip">2</span> ğŸŸ</div>
          <div class="text-sm font-semibold opacity-80 mt-3">
            â€œRoll a d20. Whatever happens, it becomes a core memory.â€
          </div>
          <button class="mt-4 w-full rounded-full px-4 py-3 font-extrabold text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, var(--accent3), #22c55e);"
            data-spell="Chaos Date" data-cost="4">
            Cast this
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… NEW: NO BOSS FIGHT MODAL -->
  <div id="noBossModal" class="modal-backdrop">
    <div id="noBossCard">
      <div class="px-6 py-4 flex items-center justify-between border-b border-white/10">
        <div class="text-white font-black text-lg">ğŸ–¤ NO BOSS FIGHT â€” â€œThe Heart That Refusesâ€</div>
        <div class="text-white/70 text-xs font-black">Move: WASD/Arrows â€¢ Shoot: Space/Tap</div>
      </div>

      <div class="px-6 py-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
          <div>
            <div class="text-xs font-black text-white/80 mb-1">YOU ğŸ’</div>
            <div class="h-3 rounded-full bg-white/10 border border-white/10 overflow-hidden">
              <div id="noPlayerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
            </div>
          </div>
          <div>
            <div class="text-xs font-black text-white/80 mb-1">NO HEART ğŸ–¤</div>
            <div class="h-3 rounded-full bg-white/10 border border-white/10 overflow-hidden">
              <div id="noBossHPBar" class="h-full w-full bg-gradient-to-r from-fuchsia-500 to-indigo-500"></div>
            </div>
          </div>
          <div>
            <div class="text-xs font-black text-white/80 mb-1">TIP</div>
            <div class="text-xs font-semibold text-white/70">Circle strafe + spam Space ğŸ˜¤</div>
          </div>
        </div>

        <div class="relative rounded-2xl overflow-hidden border border-white/10">
          <canvas id="noBossCanvas"></canvas>

          <div id="noBossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
            <div class="text-white drop-shadow-lg">
              <div class="text-4xl font-extrabold">YOU PRESSED â€œNOâ€ ğŸ˜³</div>
              <div class="text-sm font-semibold mt-2">The NO heart escapedâ€¦ and itâ€™s MAD.</div>
            </div>
          </div>

          <button id="noBossStart"
            class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
            style="background: linear-gradient(135deg, #111827, #7c3aed, #ec4899);">
            Start NO Boss Fight
          </button>
        </div>

        <div class="mt-3 text-sm font-semibold text-white/75" id="noBossMsg">
          Beat the NO heart to â€œclear the doubtâ€ (thenâ€¦ go click YES).
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // Floating hearts & powerups (kept) + NEW petals layer
  // =========================================================
  const heartsLayer = document.getElementById("hearts");
  const powerupsLayer = document.getElementById("powerups");
  const petalsLayer = document.getElementById("petals");

  function spawnHeart() {
    const el = document.createElement("span");
    el.className = "heart";
    el.textContent = Math.random() > 0.25 ? "ğŸ’—" : "ğŸ’–";
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 28;
    const dur  = 5 + Math.random() * 7;
    const drift = (Math.random() * 60 - 30) + "px";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    heartsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 100);
  }

  function spawnPowerup(){
    const el = document.createElement("span");
    el.className = "powerup";
    const items = ["â­","ğŸª™","âœ¨","ğŸ’–","ğŸ®","ğŸ’Œ","ğŸŒ¹"];
    el.textContent = items[Math.floor(Math.random() * items.length)];
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 22;
    const dur  = 6 + Math.random() * 8;
    const drift = (Math.random() * 80 - 40) + "px";
    const rot = (Math.random() * 160 - 80) + "deg";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    el.style.setProperty("--rot", rot);
    powerupsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 200);
  }

  let petalsOn = false;
  let petalsTimer = null;
  function spawnPetal(){
    const el = document.createElement("span");
    el.className = "petal";
    const items = ["ğŸŒ¸","ğŸŒ·","ğŸŒ¹"];
    el.textContent = items[Math.floor(Math.random() * items.length)];
    const left = Math.random() * 100;
    const size = 14 + Math.random() * 20;
    const dur  = 6 + Math.random() * 8;
    const drift = (Math.random() * 80 - 40) + "px";
    const rot = (Math.random() * 360 - 180) + "deg";
    el.style.left = left + "vw";
    el.style.fontSize = size + "px";
    el.style.animationDuration = dur + "s";
    el.style.setProperty("--drift", drift);
    el.style.setProperty("--rot", rot);
    petalsLayer.appendChild(el);
    setTimeout(() => el.remove(), dur * 1000 + 250);
  }
  function setPetalsMode(on){
    petalsOn = on;
    if (petalsTimer) clearInterval(petalsTimer);
    petalsTimer = null;
    if (on){
      for (let i=0;i<10;i++) spawnPetal();
      petalsTimer = setInterval(spawnPetal, 420);
    }
  }

  for (let i = 0; i < 14; i++) spawnHeart();
  setInterval(spawnHeart, 220);
  for (let i = 0; i < 10; i++) spawnPowerup();
  setInterval(spawnPowerup, 600);

  // =========================================================
  // Pixel clouds (kept)
  // =========================================================
  const pixelCloudsLayer = document.getElementById("pixelClouds");

  const pixelCloudSvg = encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="32" viewBox="0 0 64 32">
      <rect width="64" height="32" fill="none"/>
      <g fill="#ffffff">
        <rect x="10" y="14" width="8" height="6"/>
        <rect x="18" y="12" width="10" height="8"/>
        <rect x="28" y="10" width="12" height="10"/>
        <rect x="40" y="12" width="10" height="8"/>
        <rect x="50" y="14" width="6" height="6"/>
        <rect x="14" y="18" width="40" height="8"/>
      </g>
      <g fill="#e2e8f0" opacity="0.85">
        <rect x="18" y="18" width="10" height="8"/>
        <rect x="32" y="18" width="10" height="8"/>
      </g>
    </svg>
  `);

  function spawnPixelCloud(){
    const el = document.createElement("div");
    el.className = "pixel-cloud";
    const top = (Math.random() * 55) + "vh";
    const dur = (18 + Math.random() * 18) + "s";
    const scale = (0.55 + Math.random() * 0.65).toFixed(2);
    el.style.setProperty("--top", top);
    el.style.setProperty("--s", scale);
    el.style.animationDuration = dur;
    el.style.backgroundImage = `url("data:image/svg+xml,${pixelCloudSvg}")`;
    pixelCloudsLayer.appendChild(el);
    setTimeout(() => el.remove(), parseFloat(dur) * 1000 + 300);
  }

  for (let i=0;i<6;i++) spawnPixelCloud();
  setInterval(spawnPixelCloud, 1700);

  // =========================================================
  // Mana bar (kept)
  // =========================================================
  const manaBarInner = document.getElementById("manaBarInner");
  const manaPctEl = document.getElementById("manaPct");

  function updateMana(){
    const doc = document.documentElement;
    const scrollTop = doc.scrollTop || document.body.scrollTop;
    const max = (doc.scrollHeight - doc.clientHeight) || 1;
    const pct = Math.max(0, Math.min(100, (scrollTop / max) * 100));
    manaBarInner.style.width = pct.toFixed(1) + "%";
    manaPctEl.textContent = String(Math.round(pct));
  }
  window.addEventListener("scroll", updateMana, { passive: true });
  updateMana();

  // =========================================================
  // NEW: Day/Night mode toggle + auto-set + persistence
  // =========================================================
  const dayNightBtn = document.getElementById("dayNightBtn");
  const modeLabel = document.getElementById("modeLabel");

  function setMode(night){
    document.body.classList.toggle("night-mode", !!night);
    localStorage.setItem("val_mode", night ? "night" : "day");
    modeLabel.textContent = night ? "ğŸŒ™ Night Mode" : "ğŸŒ Day Mode";
  }

  (function initMode(){
    const saved = localStorage.getItem("val_mode");
    if (saved === "night") return setMode(true);
    if (saved === "day") return setMode(false);

    // auto: night if 7pm-6am
    const h = new Date().getHours();
    const autoNight = (h >= 19 || h < 6);
    setMode(autoNight);
  })();

  dayNightBtn.addEventListener("click", () => {
    setMode(!document.body.classList.contains("night-mode"));
    try { confetti({ particleCount: 80, spread: 70, origin: { y: 0.15 } }); } catch {}
  });

  // =========================================================
  // Shiny mode easter egg (kept)
  // =========================================================
  const shinyStar = document.getElementById("shinyStar");
  let shinyClicks = 0;
  shinyStar.addEventListener("click", () => {
    shinyClicks++;
    if (shinyClicks >= 3){
      document.body.classList.toggle("shiny-mode");
      shinyClicks = 0;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.2 } }); } catch {}
    } else {
      shinyStar.animate([{transform:"scale(1)"},{transform:"scale(1.2)"},{transform:"scale(1)"}], {duration:260});
    }
  });

  // =========================================================
  // GIF loader (kept)
  // =========================================================
  function setImageTryFor(imgEl, urls) {
    let i = 0;
    const tryNext = () => {
      if (i >= urls.length) { return; }
      const url = urls[i++];
      const probe = new Image();
      probe.onload = () => { imgEl.src = url; };
      probe.onerror = () => tryNext();
      probe.src = url;
    };
    tryNext();
  }

  // =========================================================
  // Valentine GIF loader (kept)
  // =========================================================
  const valImage = document.getElementById("valImage");
  const hint = document.getElementById("hint");

  const GIFS = {
    start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
    yesMain: ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
    yesFinal: [
      "https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif",
      "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcnd5OW94bW81Zzg5MXpyMHB6eTE0azRiMGU5OHhlYTl4MmNiMHh6biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/TqK5V0YnrWaR2/200.gif"
    ],
    no: ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
  };
  setImageTryFor(valImage, GIFS.start);

  // Blackhole GIF
  const blackholeGif = document.getElementById("blackholeGif");
  const BLACKHOLE_GIFS = [
    "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjliOThhaGVlNzMyNWFsa2RhZmdidGdxczU0eDF1bTBxMjZpNXRnMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xUA7b2takylWgFwJYQ/giphy.gif"
  ];
  setImageTryFor(blackholeGif, BLACKHOLE_GIFS);

  // =========================================================
  // MUSIC (kept)
  // =========================================================
  function playGlueSong() {
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      if (ctx.state === "suspended") ctx.resume();

      const now = ctx.currentTime;
      const bpm = 132;
      const beat = 60 / bpm;

      const delay = ctx.createDelay(1.0);
      delay.delayTime.value = 0.12;

      const feedback = ctx.createGain();
      feedback.gain.value = 0.25;

      const wet = ctx.createGain();
      wet.gain.value = 0.35;

      const dry = ctx.createGain();
      dry.gain.value = 0.85;

      delay.connect(feedback);
      feedback.connect(delay);
      delay.connect(wet);
      wet.connect(ctx.destination);
      dry.connect(ctx.destination);

      const noteToFreq = (note) => {
        if (note === "REST") return null;
        const m = /^([A-G])(#|b)?(\d)$/.exec(note);
        if (!m) return null;

        const [, letter, accidental, octaveStr] = m;
        const octave = Number(octaveStr);
        const SEMI = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };

        let n = SEMI[letter];
        if (accidental === "#") n += 1;
        if (accidental === "b") n -= 1;

        const midi = (octave + 1) * 12 + n;
        return 440 * Math.pow(2, (midi - 69) / 12);
      };

      function schedule(sequence, {
        type = "triangle",
        volume = 0.12,
        offset = 0,
        detune = 0,
        toDelay = true
      } = {}) {
        let t = now + offset;
        for (const step of sequence) {
          const dur = step.beats * beat;
          const freq = noteToFreq(step.note);
          if (freq) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, t);
            osc.detune.setValueAtTime(detune, t);

            const attack = Math.min(0.012, dur * 0.25);
            const release = Math.min(0.09, dur * 0.45);

            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(volume, t + attack);
            gain.gain.setValueAtTime(volume, t + Math.max(attack, dur - release));
            gain.gain.linearRampToValueAtTime(0, t + dur);

            osc.connect(gain);
            gain.connect(dry);
            if (toDelay) gain.connect(delay);

            osc.start(t);
            osc.stop(t + dur);
          }
          t += dur;
        }
        return t;
      }

      const lead = [
        { note: "C5", beats: 0.5 }, { note: "E5", beats: 0.5 }, { note: "G5", beats: 0.5 }, { note: "C6", beats: 1.5 },
        { note: "B5", beats: 0.5 }, { note: "C6", beats: 2 },
        { note: "G5", beats: 0.5 }, { note: "C6", beats: 2.5 }
      ];
      const harmony = [
        { note: "E4", beats: 0.5 }, { note: "G4", beats: 0.5 }, { note: "C5", beats: 0.5 }, { note: "E5", beats: 1.5 },
        { note: "D5", beats: 0.5 }, { note: "E5", beats: 2 },
        { note: "C5", beats: 0.5 }, { note: "E5", beats: 2.5 }
      ];
      const bass = [
        { note: "C3", beats: 1 }, { note: "REST", beats: 1 },
        { note: "G3", beats: 1 }, { note: "REST", beats: 1 },
        { note: "C3", beats: 2 },
      ];
      const sparkle = [
        { note: "C6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 },
        { note: "B6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 }, { note: "C6", beats: 0.25 },
        { note: "D6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "D7", beats: 0.25 },
        { note: "C7", beats: 0.25 }, { note: "A6", beats: 0.25 }, { note: "F6", beats: 0.25 }, { note: "D6", beats: 0.25 },
        { note: "E6", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "E7", beats: 0.25 },
        { note: "D7", beats: 0.25 }, { note: "C7", beats: 0.25 }, { note: "G6", beats: 0.25 }, { note: "E6", beats: 0.25 },
      ];

      const t1 = schedule(lead,    { type: "triangle", volume: 0.14, offset: 0.00, detune: +4 });
      const t2 = schedule(harmony, { type: "sine",     volume: 0.10, offset: 0.02, detune: -3 });
      const t3 = schedule(bass,    { type: "square",   volume: 0.06, offset: 0.00, detune:  0, toDelay: false });
      const t4 = schedule(sparkle, { type: "sine",     volume: 0.07, offset: 0.10, detune: +6 });

      const end = Math.max(t1, t2, t3, t4);
      setTimeout(() => ctx.close().catch(() => {}), Math.ceil((end - now + 0.35) * 1000));
    } catch {}
  }

  // battle loop music (kept)
  let battleCtx = null;
  let battleMaster = null;
  let battleInterval = null;
  let battleStep = 0;
  let battleIntensity = 1;

  function noiseHit(ctx, time, duration, volume, cutoffHz) {
    const bufferSize = Math.floor(ctx.sampleRate * duration);
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);

    const src = ctx.createBufferSource();
    src.buffer = buffer;

    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.setValueAtTime(cutoffHz, time);

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(volume, time + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);

    src.connect(filter).connect(gain).connect(battleMaster);
    src.start(time);
    src.stop(time + duration);
  }

  function noteToFreqBattle(note) {
    const m = /^([A-G])(#|b)?(\d)$/.exec(note);
    if (!m) return null;
    const [, letter, accidental, octaveStr] = m;
    const octave = Number(octaveStr);
    const SEMI = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
    let n = SEMI[letter];
    if (accidental === "#") n += 1;
    if (accidental === "b") n -= 1;
    const midi = (octave + 1) * 12 + n;
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function startBattleMusic(intensity = 1) {
    if (battleCtx) return;

    battleIntensity = intensity;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    battleCtx = new AudioCtx();
    if (battleCtx.state === "suspended") battleCtx.resume();

    battleMaster = battleCtx.createGain();
    battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
    battleMaster.connect(battleCtx.destination);

    battleStep = 0;

    const tick = () => {
      if (!battleCtx) return;

      const capped = Math.max(1, Math.min(battleIntensity, 6));
      const bpm = 120 + capped * 10;
      const stepDur = 60 / bpm / 2;
      const t = battleCtx.currentTime + 0.02;

      const riff = ["E3","G3","A3","G3","E3","D3","E3","B2"];
      const lead = ["E4","G4","A4","B4","A4","G4","E4","D4"];

      const bassNote = riff[battleStep % riff.length];
      const bassOsc = battleCtx.createOscillator();
      bassOsc.type = "sawtooth";
      bassOsc.frequency.setValueAtTime(noteToFreqBattle(bassNote), t);

      const bassGain = battleCtx.createGain();
      bassGain.gain.setValueAtTime(0, t);
      bassGain.gain.linearRampToValueAtTime(0.12 + capped * 0.01, t + 0.01);
      bassGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur);

      const bassFilter = battleCtx.createBiquadFilter();
      bassFilter.type = "lowpass";
      bassFilter.frequency.setValueAtTime(600 + capped * 180, t);

      bassOsc.connect(bassFilter).connect(bassGain).connect(battleMaster);
      bassOsc.start(t);
      bassOsc.stop(t + stepDur);

      if (battleStep % 2 === 0) {
        const leadNote = lead[(battleStep / 2) % lead.length];
        const leadOsc = battleCtx.createOscillator();
        leadOsc.type = "square";
        leadOsc.frequency.setValueAtTime(noteToFreqBattle(leadNote), t);

        const leadGain = battleCtx.createGain();
        leadGain.gain.setValueAtTime(0, t);
        leadGain.gain.linearRampToValueAtTime(0.07 + capped * 0.008, t + 0.008);
        leadGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur * 0.9);

        leadOsc.connect(leadGain).connect(battleMaster);
        leadOsc.start(t);
        leadOsc.stop(t + stepDur * 0.9);
      }

      const isKick = battleStep % 4 === 0 || battleStep % 4 === 2;
      const isSnare = battleStep % 4 === 1 || battleStep % 4 === 3;

      if (isKick)  noiseHit(battleCtx, t, 0.06, 0.10 + capped * 0.01, 220 + capped * 20);
      if (isSnare) noiseHit(battleCtx, t, 0.05, 0.06 + capped * 0.008, 1200 + capped * 120);
      noiseHit(battleCtx, t, 0.02, 0.03 + capped * 0.004, 6000 + capped * 300);

      battleStep++;
    };

    battleInterval = setInterval(tick, 90);
    tick();
  }

  function updateBattleIntensity(intensity) {
    battleIntensity = intensity;
    if (!battleCtx || !battleMaster) return;
    battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
  }

  function stopBattleMusic() {
    if (battleInterval) clearInterval(battleInterval);
    battleInterval = null;

    if (battleCtx) {
      const ctx = battleCtx;
      battleCtx = null;
      battleMaster = null;
      setTimeout(() => ctx.close().catch(() => {}), 50);
    }
  }

  // =========================================================
  // Lock YES/NO until boss beaten (kept)
  // =========================================================
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  let yesLocked = true;
  let noLocked = true;

  function lockBtn(btn, label){
    btn.disabled = true;
    btn.style.opacity = "0.55";
    btn.style.cursor = "not-allowed";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }
  function unlockBtn(btn, label){
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    const span = btn.querySelector("span");
    if (span) span.textContent = label;
  }
  function lockYesNo(){
    yesLocked = true; noLocked = true;
    lockBtn(yesBtn, "LOCKED");
    lockBtn(noBtn, "LOCKED");
  }
  function unlockYesNo(){
    yesLocked = false; noLocked = false;
    unlockBtn(yesBtn, "YES");
    unlockBtn(noBtn, "NO");
    hint.textContent = "Unlocked! ğŸ˜³ Now choose wisely...";
  }
  lockYesNo();

  // =========================================================
  // Begin Event scroll (kept)
  // =========================================================
  const beginEvent = document.getElementById("beginEvent");
  const bossStartBtn = document.getElementById("bossStart");
  beginEvent.addEventListener("click", () => {
    bossStartBtn.scrollIntoView({ behavior: "smooth", block: "center" });
    bossStartBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:520});
  });

  // =========================================================
  // YES handler (kept)
  // =========================================================
  let yesFinalTimer = null;
  yesBtn.addEventListener("click", () => {
    if (yesLocked){
      hint.textContent = "YES is locked ğŸ˜ˆ Beat the boss first!";
      yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
      return;
    }

    stopBattleMusic();
    playGlueSong();
    setImageTryFor(valImage, GIFS.yesMain);
    hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! ğŸ’™";
    noBtn.style.display = "none";
    try { confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } }); } catch {}
    if (yesFinalTimer) clearTimeout(yesFinalTimer);
    yesFinalTimer = setTimeout(() => setImageTryFor(valImage, GIFS.yesFinal), 2000);
  });

  // =========================================================
  // âœ… NEW: NO handler becomes ENTIRE boss fight
  // =========================================================
  const noBossModal = document.getElementById("noBossModal");
  const noBossStart = document.getElementById("noBossStart");
  const noBossOverlay = document.getElementById("noBossOverlay");
  const noBossMsg = document.getElementById("noBossMsg");
  const noBossCanvas = document.getElementById("noBossCanvas");
  const noCtx = noBossCanvas.getContext("2d");

  const noPlayerHPBar = document.getElementById("noPlayerHPBar");
  const noBossHPBar = document.getElementById("noBossHPBar");

  function fitCanvasToCSS(canvas, ctx) {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // Shared keys (kept)
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," "].includes(e.key)) {
      keys.add(e.key);
      if (e.key === " ") e.preventDefault();
    }
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key));

  // NO boss touch controls
  let noTouchActive=false, noTouchX=0, noTouchY=0;
  noBossCanvas.addEventListener("pointerdown", (e) => {
    noTouchActive = true;
    const r = noBossCanvas.getBoundingClientRect();
    noTouchX = e.clientX - r.left;
    noTouchY = e.clientY - r.top;
    if (noGame.running) noShoot();
  });
  noBossCanvas.addEventListener("pointermove", (e) => {
    if (!noTouchActive) return;
    const r = noBossCanvas.getBoundingClientRect();
    noTouchX = e.clientX - r.left;
    noTouchY = e.clientY - r.top;
  });
  window.addEventListener("pointerup", () => (noTouchActive = false));

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function dist2(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

  const noGame = {
    running:false,
    t:0,
    lastShot:0,
    bullets:[],      // boss bullets
    beams:[],        // player shots
    particles:[],
    player:{ x:120, y:320, r:10, hp:6, maxHp:6, inv:0 },
    boss:{ x:520, y:120, r:24, hp:120, maxHp:120, vx:3.4, vy:2.7, rage:1 }
  };

  function setNoBars(){
    noPlayerHPBar.style.width = (noGame.player.hp/noGame.player.maxHp*100) + "%";
    noBossHPBar.style.width = (noGame.boss.hp/noGame.boss.maxHp*100) + "%";
  }

  function resetNoFight(){
    noGame.running = false;
    noGame.t = 0;
    noGame.lastShot = 0;
    noGame.bullets.length = 0;
    noGame.beams.length = 0;
    noGame.particles.length = 0;

    noGame.player.x = 160; noGame.player.y = 360;
    noGame.player.hp = noGame.player.maxHp = 6;
    noGame.player.inv = 0;

    noGame.boss.x = 620; noGame.boss.y = 140;
    noGame.boss.hp = noGame.boss.maxHp = 120;
    noGame.boss.vx = 3.4; noGame.boss.vy = 2.7;
    noGame.boss.rage = 1;

    setNoBars();
    noBossOverlay.style.opacity = "1";
    noBossStart.style.opacity = "1";
    noBossStart.style.pointerEvents = "auto";
    noBossStart.textContent = "Start NO Boss Fight";
    noBossMsg.textContent = "Beat the NO heart to â€œclear the doubtâ€ (thenâ€¦ go click YES).";
  }

  function spawnNoParticle(x,y,emoji){
    noGame.particles.push({
      x,y,
      vx:(Math.random()*2-1)*1.3,
      vy:(Math.random()*2-1)*1.3 - 0.8,
      life: 40 + Math.random()*20,
      emoji
    });
  }

  function noShoot(){
    const now = performance.now();
    if (now - noGame.lastShot < 120) return;
    noGame.lastShot = now;
    noGame.beams.push({ x:noGame.player.x, y:noGame.player.y-12, vx:0, vy:-7.8, r:6 });
    spawnNoParticle(noGame.player.x, noGame.player.y-10, "ğŸ’");
  }

  function fireNoBullet(angle, speed, kind="no"){
    noGame.bullets.push({
      x:noGame.boss.x,
      y:noGame.boss.y,
      vx:Math.cos(angle)*speed,
      vy:Math.sin(angle)*speed,
      r: kind === "orb" ? 9 : 7,
      kind
    });
  }

  function drawHeartShape(ctx, x, y, size){
    ctx.beginPath();
    ctx.moveTo(x, y + size*0.25);
    ctx.bezierCurveTo(x - size, y - size*0.35, x - size*0.6, y - size, x, y - size*0.45);
    ctx.bezierCurveTo(x + size*0.6, y - size, x + size, y - size*0.35, x, y + size*0.25);
    ctx.closePath();
  }
  function roundRectPath(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  function updateNo(dt){
    noGame.t += dt;

    const w = noBossCanvas.getBoundingClientRect().width;
    const h = noBossCanvas.getBoundingClientRect().height;

    // player move
    let mx=0,my=0;
    if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
    if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
    if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
    if (keys.has("ArrowDown") || keys.has("s")) my += 1;

    if (noTouchActive){
      const dx = noTouchX - noGame.player.x;
      const dy = noTouchY - noGame.player.y;
      mx = clamp(dx/30, -1, 1);
      my = clamp(dy/30, -1, 1);
    }

    const speed = 4.4;
    noGame.player.x = clamp(noGame.player.x + mx*speed, 18, w-18);
    noGame.player.y = clamp(noGame.player.y + my*speed, 80, h-18);

    if (keys.has(" ")) noShoot();

    // boss â€œruns aroundâ€ + gets angrier as HP drops
    const hpPct = noGame.boss.hp / noGame.boss.maxHp;
    noGame.boss.rage = 1 + Math.floor((1 - hpPct) * 4);

    noGame.boss.x += noGame.boss.vx * (1 + noGame.boss.rage*0.08);
    noGame.boss.y += noGame.boss.vy * (1 + noGame.boss.rage*0.08);

    if (noGame.boss.x < 24 || noGame.boss.x > w-24) noGame.boss.vx *= -1;
    if (noGame.boss.y < 24 || noGame.boss.y > h*0.55) noGame.boss.vy *= -1;

    // boss shoots at you
    const shootRate = 0.18 + noGame.boss.rage*0.05; // probability per tick window
    if (Math.random() < shootRate * dt * 8.0){
      const ang = Math.atan2(noGame.player.y - noGame.boss.y, noGame.player.x - noGame.boss.x);
      const spread = 0.22 + noGame.boss.rage*0.06;
      const speedB = 2.8 + noGame.boss.rage*0.55;
      fireNoBullet(ang + (Math.random()*2-1)*spread, speedB, "no");
      if (noGame.boss.rage >= 4 && Math.random() < 0.25){
        // occasional ring burst
        const n = 8 + Math.floor(Math.random()*6);
        for (let i=0;i<n;i++){
          fireNoBullet((Math.PI*2)*(i/n), 2.0 + noGame.boss.rage*0.25, "orb");
        }
        spawnNoParticle(noGame.boss.x, noGame.boss.y, "ğŸ–¤");
      }
    }

    // move bullets
    for (const b of noGame.bullets){ b.x += b.vx; b.y += b.vy; }
    noGame.bullets = noGame.bullets.filter(b => b.x>-70 && b.x<w+70 && b.y>-70 && b.y<h+70);

    // move beams
    for (const p of noGame.beams){ p.x += p.vx; p.y += p.vy; }
    noGame.beams = noGame.beams.filter(p => p.y>-50);

    // particles
    for (const pt of noGame.particles){
      pt.x += pt.vx; pt.y += pt.vy; pt.vy += 0.03; pt.life -= 1;
    }
    noGame.particles = noGame.particles.filter(pt => pt.life > 0);

    // beam hits boss
    for (let i=noGame.beams.length-1;i>=0;i--){
      const p = noGame.beams[i];
      if (dist2(p.x,p.y, noGame.boss.x,noGame.boss.y) < (p.r+noGame.boss.r)**2){
        noGame.beams.splice(i,1);
        noGame.boss.hp = Math.max(0, noGame.boss.hp - 3);
        spawnNoParticle(noGame.boss.x, noGame.boss.y, "âœ¨");
        spawnNoParticle(noGame.boss.x, noGame.boss.y, "ğŸ’˜");
        setNoBars();
        if (noGame.boss.hp <= 0) winNoFight();
      }
    }

    // bullets hit player
    if (noGame.player.inv > 0) noGame.player.inv -= dt;
    for (let i=noGame.bullets.length-1;i>=0;i--){
      const b = noGame.bullets[i];
      if (dist2(b.x,b.y, noGame.player.x,noGame.player.y) < (b.r+noGame.player.r)**2){
        noGame.bullets.splice(i,1);
        if (noGame.player.inv <= 0){
          noGame.player.hp = Math.max(0, noGame.player.hp - 1);
          noGame.player.inv = 0.9;
          spawnNoParticle(noGame.player.x, noGame.player.y, "ğŸ’¥");
          spawnNoParticle(noGame.player.x, noGame.player.y, "ğŸ’”");
          setNoBars();
          if (noGame.player.hp <= 0) loseNoFight();
        }
      }
    }
  }

  function drawNo(){
    const w = noBossCanvas.getBoundingClientRect().width;
    const h = noBossCanvas.getBoundingClientRect().height;

    noCtx.clearRect(0,0,w,h);

    // background
    const g = noCtx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, "rgba(15,23,42,0.35)");
    g.addColorStop(1, "rgba(15,23,42,0.72)");
    noCtx.fillStyle = g;
    noCtx.fillRect(0,0,w,h);

    // faint stars
    noCtx.globalAlpha = 0.35;
    noCtx.fillStyle = "#ffffff";
    for (let i=0;i<40;i++){
      const sx = (i*97 + Math.floor(noGame.t*80)) % w;
      const sy = (i*53) % Math.max(1, Math.floor(h*0.8));
      noCtx.fillRect(sx, sy, 2, 2);
    }
    noCtx.globalAlpha = 1;

    // boss: big heart with "NO"
    noCtx.save();
    noCtx.translate(noGame.boss.x, noGame.boss.y);
    noCtx.globalAlpha = 0.96;
    drawHeartShape(noCtx, 0, 0, 22 + noGame.boss.rage*2.5);
    noCtx.fillStyle = "rgba(17,24,39,0.95)";
    noCtx.fill();
    noCtx.lineWidth = 2;
    noCtx.strokeStyle = "rgba(236,72,153,0.45)";
    noCtx.stroke();
    noCtx.font = "900 14px system-ui";
    noCtx.fillStyle = "rgba(248,250,252,0.95)";
    noCtx.textAlign = "center";
    noCtx.fillText("NO", 0, 6);
    noCtx.restore();

    // player heart
    noCtx.save();
    noCtx.translate(noGame.player.x, noGame.player.y);
    const blink = noGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
    noCtx.globalAlpha = blink;
    drawHeartShape(noCtx, 0, 2, 14);
    noCtx.fillStyle = "rgba(239,68,68,0.95)";
    noCtx.fill();
    noCtx.restore();

    // bullets
    for (const b of noGame.bullets){
      noCtx.save();
      noCtx.translate(b.x,b.y);
      if (b.kind === "orb"){
        noCtx.globalAlpha = 0.90;
        noCtx.beginPath(); noCtx.arc(0,0,b.r,0,Math.PI*2);
        noCtx.fillStyle = "rgba(124,58,237,0.95)";
        noCtx.fill();
      } else {
        noCtx.globalAlpha = 0.92;
        drawHeartShape(noCtx, 0, 0, b.r);
        noCtx.fillStyle = "rgba(244,63,94,0.90)";
        noCtx.fill();
      }
      noCtx.restore();
    }

    // beams
    for (const p of noGame.beams){
      noCtx.save();
      noCtx.translate(p.x,p.y);
      noCtx.globalAlpha = 0.90;
      roundRectPath(noCtx, -3, -12, 6, 24, 6);
      noCtx.fillStyle = "rgba(34,197,94,0.95)";
      noCtx.fill();
      noCtx.restore();
    }

    // particles
    for (const pt of noGame.particles){
      noCtx.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
      noCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      noCtx.fillText(pt.emoji, pt.x, pt.y);
    }
    noCtx.globalAlpha = 1;
  }

  let noRaf=null, noLast=0;
  function noLoop(ts){
    if (!noGame.running) return;
    if (!noLast) noLast = ts;
    const dt = Math.min(0.033, (ts-noLast)/1000);
    noLast = ts;

    updateNo(dt);
    drawNo();
    noRaf = requestAnimationFrame(noLoop);
  }

  function startNoFight(){
    fitCanvasToCSS(noBossCanvas, noCtx);
    resetNoFight();

    noGame.running = true;
    noBossOverlay.style.opacity = "0";
    noBossStart.style.opacity = "0";
    noBossStart.style.pointerEvents = "none";

    startBattleMusic(3);
    updateBattleIntensity(3);

    noBossMsg.textContent = "Itâ€™s running. Itâ€™s fighting. Itâ€™s chaos. (Shoot it.)";
    try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.4 } }); } catch {}

    noLast = 0;
    noRaf = requestAnimationFrame(noLoop);
  }

  function stopNoFight(){
    noGame.running = false;
    if (noRaf) cancelAnimationFrame(noRaf);
    noRaf = null;
    stopBattleMusic();
  }

  function winNoFight(){
    stopNoFight();
    noBossOverlay.style.opacity = "1";
    noBossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">NO DEFEATED ğŸ’˜</div>
        <div class="text-sm font-semibold mt-2">Okayâ€¦ now go click YES ğŸ˜¤ğŸ’</div>
      </div>
    `;
    noBossStart.style.opacity = "1";
    noBossStart.style.pointerEvents = "auto";
    noBossStart.textContent = "Rematch (optional)";
    noBossMsg.textContent = "Doubt cleared. Your destiny is YES.";
    try { confetti({ particleCount: 220, spread: 90, origin: { y: 0.6 } }); } catch {}

    // close after a beat
    setTimeout(() => {
      noBossModal.classList.remove("show");
      hint.textContent = "NO tried to fight youâ€¦ and lost. Click YES ğŸ˜¤ğŸ’";
      yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.12)"},{transform:"scale(1)"}], {duration:700, iterations:2});
    }, 1200);
  }

  function loseNoFight(){
    stopNoFight();
    noBossOverlay.style.opacity = "1";
    noBossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">YOU GOT BONKED ğŸ’¥</div>
        <div class="text-sm font-semibold mt-2">Try again. (It canâ€™t win forever.)</div>
      </div>
    `;
    noBossStart.style.opacity = "1";
    noBossStart.style.pointerEvents = "auto";
    noBossStart.textContent = "Try Again";
    noBossMsg.textContent = "Tip: Keep moving + shoot constantly.";
  }

  noBossStart.addEventListener("click", startNoFight);
  resetNoFight();

  noBtn.addEventListener("click", () => {
    if (noLocked){
      hint.textContent = "NO is locked ğŸ˜ˆ Beat the boss first!";
      noBtn.animate([{transform:"scale(1)"},{transform:"scale(1.10)"},{transform:"scale(1)"}], {duration:340});
      return;
    }

    // show â€œNO bossâ€ instead of just a gif
    setImageTryFor(valImage, GIFS.no);
    hint.textContent = "You pressed NOâ€¦ and it escaped. ğŸ˜³";
    noBossModal.classList.add("show");
    noBossOverlay.style.opacity = "1";
    noBossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">NO RUNS AWAY ğŸ–¤</div>
        <div class="text-sm font-semibold mt-2">Catch it in the arena.</div>
      </div>
    `;
    noBossStart.textContent = "Start NO Boss Fight";
  });

  // prevent click outside closing the NO boss (itâ€™s a â€œfightâ€)
  noBossModal.addEventListener("click", (e) => {
    if (e.target === noBossModal && !noGame.running){
      // allow closing only when not running
      noBossModal.classList.remove("show");
    }
  });

  // =========================================================
  // Alt art toggle (kept)
  // =========================================================
  const altArtBtn = document.getElementById("altArtBtn");
  const cardArt = document.getElementById("cardArt");
  let altArt = false;
  altArtBtn.addEventListener("click", () => {
    altArt = !altArt;
    cardArt.textContent = altArt ? "(ALT ART: put another photo here)" : "(Put a cute photo here later)";
    try { confetti({ particleCount: 80, spread: 60, origin: { y: 0.25 } }); } catch {}
  });

  // =========================================================
  // Date modal + stack (kept)
  // =========================================================
  const dateModal = document.getElementById("dateModal");
  const openDateModal = document.getElementById("openDateModal");
  const closeDateModal = document.getElementById("closeDateModal");
  const chosenDate = document.getElementById("chosenDate");
  const spellStack = document.getElementById("spellStack");
  const manaSpentEl = document.getElementById("manaSpent");
  let manaSpent = 0;

  function pushToStack(name){
    if (spellStack.textContent.includes("empty")) spellStack.innerHTML = "";
    const row = document.createElement("div");
    row.className = "rounded-xl bg-white/75 border border-white/60 px-3 py-2 shadow-sm";
    row.textContent = name + " (on the stack)";
    spellStack.prepend(row);
    row.animate([{transform:"translateY(-6px)", opacity:0},{transform:"translateY(0px)", opacity:1}], {duration:320, easing:"cubic-bezier(.2,.9,.2,1)"});
  }

  openDateModal.addEventListener("click", () => dateModal.classList.add("show"));
  closeDateModal.addEventListener("click", () => dateModal.classList.remove("show"));
  dateModal.addEventListener("click", (e) => { if (e.target === dateModal) dateModal.classList.remove("show"); });

  dateModal.querySelectorAll("button[data-spell]").forEach(btn => {
    btn.addEventListener("click", () => {
      const s = btn.getAttribute("data-spell");
      const cost = Number(btn.getAttribute("data-cost") || "0");
      manaSpent += cost;
      manaSpentEl.textContent = String(manaSpent);

      chosenDate.innerHTML = `Selected spell: <b>${s}</b><div class="mt-2 text-xs font-black opacity-70">Mana spent: <span>${manaSpent}</span></div>`;
      pushToStack(s);

      dateModal.classList.remove("show");
      try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.7 } }); } catch {}
    });
  });

  // =========================================================
  // Token generator (kept)
  // =========================================================
  const tokenBtn = document.getElementById("tokenBtn");
  const tokenGrid = document.getElementById("tokenGrid");
  const tokenCountEl = document.getElementById("tokenCount");
  const tokenMsg = document.getElementById("tokenMsg");
  let tokens = 0;

  function tokenUnlockMessage(n){
    if (n === 5)  return "Youâ€™ve generated enough love mana.";
    if (n === 10) return "Warning: lethal affection incoming.";
    if (n === 20) return "Ultimate achieved: Ask unlocked. (â€¦if the boss is defeated ğŸ˜ˆ)";
    return null;
  }

  tokenBtn.addEventListener("click", () => {
    tokens++;
    tokenCountEl.textContent = String(tokens);
    const tile = document.createElement("div");
    tile.className = "h-9 w-9 rounded-xl bg-white/75 border border-white/60 flex items-center justify-center shadow-sm";
    tile.textContent = "ğŸ’–";
    tokenGrid.appendChild(tile);
    const msg = tokenUnlockMessage(tokens);
    if (msg){
      tokenMsg.innerHTML = `Tokens: <b>${tokens}</b> â€” <span class="font-black">${msg}</span>`;
      try { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } }); } catch {}
    }
  });

  // =========================================================
  // PokÃ©mon battle logic (kept)
  // =========================================================
  const battleText = document.getElementById("battleText");
  const enemyHPBar = document.getElementById("enemyHPBar");
  const youHPBar = document.getElementById("youHPBar");
  const enemySprite = document.getElementById("enemySprite");

  const battleMenuMain = document.getElementById("battleMenuMain");
  const battleMenuFight = document.getElementById("battleMenuFight");
  const btnFight = document.getElementById("btnFight");
  const btnBag = document.getElementById("btnBag");
  const btnTeam = document.getElementById("btnTeam");
  const btnRun = document.getElementById("btnRun");
  const btnBack = document.getElementById("btnBack");

  const poke = {
    enemyHP: 100,
    youHP: 100,
    stunned: false,
    teamPage: 0,
    inBattle: true
  };

  const moveData = {
    "Compliment Beam": { dmg: 18, text: "You fire a Compliment Beam! â€œYou make everything better.â€ Itâ€™s super effective ğŸ’¥ğŸ’–" },
    "Snack Shield":    { dmg: 6,  heal: 12, text: "Snack Shield! You block negativity with snacks. You feel safer (+HP) ğŸªğŸ›¡ï¸" },
    "Laugh Attack":    { dmg: 14, stun: 0.35, text: "Laugh Attack! He canâ€™t stop smilingâ€¦ thereâ€™s a chance he loses a turn ğŸ˜‚" },
    "Cozy Aura":       { dmg: 10, heal: 6, text: "Cozy Aura surrounds you. Warmth fills the arena (+HP) ğŸ§¸âœ¨" }
  };

  const bagItems = [
    { name: "Love Ball ğŸ’˜", effect: "capture", text: "You toss a Love Ballâ€¦ it wobblesâ€¦ ğŸ‘€" },
    { name: "Date Coupon ğŸ½ï¸", effect: "buff", text: "Date Coupon activated. Future happiness increased." },
    { name: "Chocolate Potion ğŸ«", effect: "heal", amt: 18, text: "Chocolate Potion! Sweet healing (+HP)." },
    { name: "Shiny Charm â­", effect: "shiny", text: "Shiny Charm sparklesâ€¦ the vibes improve âœ¨" }
  ];

  const teamRoster = [
    "Slot 1: Inside joke #1",
    "Slot 2: The photo where you both look cute",
    "Slot 3: The funniest moment ever",
    "Slot 4: The â€œweâ€™re a teamâ€ one",
    "Slot 5: Your shared favorite thing"
  ];

  function clampHP(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function setHPBars(){
    enemyHPBar.style.width = clampHP(poke.enemyHP, 0, 100) + "%";
    youHPBar.style.width   = clampHP(poke.youHP, 0, 100) + "%";
  }
  setHPBars();

  function showMainMenu(){
    battleMenuFight.classList.add("hidden");
    battleMenuMain.classList.remove("hidden");
  }
  function showFightMenu(){
    battleMenuMain.classList.add("hidden");
    battleMenuFight.classList.remove("hidden");
  }

  function enemyTurn(){
    if (!poke.inBattle) return;

    if (poke.stunned && Math.random() < 0.6){
      poke.stunned = false;
      battleText.textContent = "Valentine is too flustered to moveâ€¦ ğŸ˜³";
      return;
    }
    poke.stunned = false;

    const attacks = [
      { dmg: 12, text: "Valentine used Fluster Pulse! Your heart races ğŸ’“ (-HP)" },
      { dmg: 10, text: "Valentine used Heart Spark! Itâ€™s adorable but dangerous âœ¨ (-HP)" },
      { dmg: 14, text: "Valentine used Blush Blitz! Critical cuteness ğŸ˜µ (-HP)" }
    ];
    const a = attacks[Math.floor(Math.random() * attacks.length)];
    poke.youHP = clampHP(poke.youHP - a.dmg, 0, 100);
    setHPBars();
    battleText.textContent = a.text;

    if (poke.youHP <= 0){
      poke.inBattle = false;
      battleText.textContent = "You faintedâ€¦ but LOVE revives you instantly. (Try again ğŸ˜¤ğŸ’–)";
      poke.youHP = 100;
      poke.enemyHP = 100;
      poke.inBattle = true;
      setHPBars();
      enemySprite.textContent = "ğŸ’˜";
    }
  }

  function winPokemon(){
    poke.inBattle = false;
    enemySprite.textContent = "ğŸ’";
    battleText.textContent = "Valentine was defeatedâ€¦ and wants to join you. Aww. ğŸ’–";
    try { confetti({ particleCount: 140, spread: 85, origin: { y: 0.55 } }); } catch {}
    setTimeout(() => {
      poke.enemyHP = 100;
      poke.youHP = 100;
      poke.inBattle = true;
      enemySprite.textContent = "ğŸ’˜";
      setHPBars();
      battleText.textContent = "A wild Valentine appeared! (Againâ€¦ because it loves you.)";
    }, 1800);
  }

  btnFight.addEventListener("click", () => {
    if (!poke.inBattle) return;
    showFightMenu();
    battleText.textContent = "Choose a move!";
  });

  btnBack.addEventListener("click", () => {
    showMainMenu();
    battleText.textContent = "What will you do?";
  });

  battleMenuFight.querySelectorAll("button[data-move]").forEach(b => {
    b.addEventListener("click", () => {
      if (!poke.inBattle) return;
      const name = b.getAttribute("data-move");
      const m = moveData[name];

      poke.enemyHP = clampHP(poke.enemyHP - m.dmg, 0, 100);
      if (m.heal) poke.youHP = clampHP(poke.youHP + m.heal, 0, 100);
      if (m.stun && Math.random() < m.stun) poke.stunned = true;

      setHPBars();
      battleText.textContent = m.text;

      if (poke.enemyHP <= 0){
        winPokemon();
        showMainMenu();
        return;
      }

      setTimeout(() => enemyTurn(), 700);
      showMainMenu();
    });
  });

  btnBag.addEventListener("click", () => {
    if (!poke.inBattle) return;
    const it = bagItems[Math.floor(Math.random() * bagItems.length)];
    battleText.textContent = "BAG â†’ " + it.text;

    if (it.effect === "heal"){
      poke.youHP = clampHP(poke.youHP + it.amt, 0, 100);
      setHPBars();
    }
    if (it.effect === "capture"){
      const roll = Math.random();
      if (roll > 0.72){
        battleText.textContent = "The Love Ball clicked! Valentine is captured ğŸ’˜ (itâ€™s basically YES.)";
        try { confetti({ particleCount: 110, spread: 75, origin: { y: 0.6 } }); } catch {}
      } else {
        setTimeout(() => enemyTurn(), 650);
      }
    } else {
      setTimeout(() => enemyTurn(), 650);
    }
  });

  btnTeam.addEventListener("click", () => {
    if (!poke.inBattle) return;
    poke.teamPage = (poke.teamPage + 1) % 3;
    if (poke.teamPage === 0){
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(0,2).join(" | ");
    } else if (poke.teamPage === 1){
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(2,4).join(" | ");
    } else {
      battleText.textContent = "TEAM â†’ " + teamRoster.slice(4).join(" | ");
    }
    setTimeout(() => enemyTurn(), 650);
  });

  btnRun.addEventListener("click", () => {
    if (!poke.inBattle) return;
    battleText.textContent = "You canâ€™t run from love.";
    btnRun.animate([{transform:"translateX(0px)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0px)"}], {duration:360});
    setTimeout(() => enemyTurn(), 650);
  });

  // =========================================================
  // Saga -> Capture (kept)
  // =========================================================
  const sagaChapterEl = document.getElementById("sagaChapter");
  const sagaText = document.getElementById("sagaText");
  const advanceSaga = document.getElementById("advanceSaga");
  const sagaView = document.getElementById("sagaView");
  const captureView = document.getElementById("captureView");
  const throwLoveBall = document.getElementById("throwLoveBall");
  const throwShinyBall = document.getElementById("throwShinyBall");
  const captureMsg = document.getElementById("captureMsg");

  let sagaStep = 1;
  const sagaLines = {
    1: `I â€” â€œWe met and my life got better.â€`,
    2: `II â€” â€œWe became my favorite team.â€`,
    3: `III â€” â€œWill you be my Valentine?â€`
  };
  function toRoman(n){ return n === 1 ? "I" : n === 2 ? "II" : "III"; }

  advanceSaga.addEventListener("click", () => {
    sagaStep = Math.min(3, sagaStep + 1);
    sagaChapterEl.textContent = toRoman(sagaStep);
    sagaText.textContent = sagaLines[sagaStep];
    if (sagaStep === 3){
      sagaView.classList.add("hidden");
      captureView.classList.remove("hidden");
      try { confetti({ particleCount: 140, spread: 90, origin: { y: 0.55 } }); } catch {}
    }
  });

  function captureAttempt(shiny=false){
    if (yesLocked || noLocked){
      captureMsg.textContent = "LOCKED ğŸ˜ˆ Defeat the boss first!";
      return;
    }
    captureMsg.textContent = shiny ? "Shiny captured!! ğŸ’šâœ¨ Valentine accepted!!" : "Captured!! ğŸ’˜ Valentine accepted!!";
    try { confetti({ particleCount: 220, spread: 95, origin: { y: 0.6 } }); } catch {}
    hint.textContent = "Okay now go click YES ğŸ˜¤ğŸ’";
    yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.12)"},{transform:"scale(1)"}], {duration:700, iterations:2});
  }
  throwLoveBall.addEventListener("click", () => captureAttempt(false));
  throwShinyBall.addEventListener("click", () => captureAttempt(true));

  // =========================================================
  // Booster (kept)
  // =========================================================
  const openBooster = document.getElementById("openBooster");
  const boosterResult = document.getElementById("boosterResult");
  openBooster.addEventListener("click", () => {
    boosterResult.classList.remove("hidden");
    boosterResult.animate([{transform:"scale(0.98)", opacity:0},{transform:"scale(1)", opacity:1}], {duration:420, easing:"cubic-bezier(.2,.9,.2,1)"});
    try { confetti({ particleCount: 160, spread: 85, origin: { y: 0.55 } }); } catch {}
  });

  // =========================================================
  // Boss arena background (kept)
  // =========================================================
  const BOSS_BG_URL = "boss-bg.png";
  const bossBgImg = new Image();
  bossBgImg.src = BOSS_BG_URL;
  let bossBgReady = false;
  bossBgImg.onload = () => (bossBgReady = true);

  function drawCoverImage(ctx, img, w, h) {
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.max(w / iw, h / ih);
    const nw = iw * scale;
    const nh = ih * scale;
    const x = (w - nw) / 2;
    const y = (h - nh) / 2;
    ctx.drawImage(img, x, y, nw, nh);
  }

  // =========================================================
  // Boss fight (your existing boss fight logic kept EXACTLY)
  // =========================================================
  const bossCanvas = document.getElementById("bossCanvas");
  const bossOverlay = document.getElementById("bossOverlay");
  const bossMsg = document.getElementById("bossMsg");
  const playerHPBar = document.getElementById("playerHPBar");
  const bossHPBar = document.getElementById("bossHPBar");
  const loveBar = document.getElementById("loveBar");
  const laughFlash = document.getElementById("laughFlash");

  const defaultBossOverlayHTML = bossOverlay.innerHTML;
  const bossCtx2 = bossCanvas.getContext("2d");
  let bossRaf = null;

  fitCanvasToCSS(bossCanvas, bossCtx2);

  const bossGame = {
    running: false,
    t: 0,
    lastShot: 0,
    phaseTimer: 0,
    pattern: "spray",
    phase2: false,
    blackHole: { active: false, timer: 0, cool: 2.0 },
    bullets: [],
    beams: [],
    particles: [],
    player: { x: 120, y: 260, r: 10, hp: 5, maxHp: 5, inv: 0 },
    boss:   { x: 0, y: 0, r: 28, hp: 100, maxHp: 100, wob: 0 }
  };

  function clamp2(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function distBoss(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

  function setBossBars(){
    playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
    bossHPBar.style.width = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
    const lovePct = (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 100;
    loveBar.style.width = lovePct.toFixed(1) + "%";

    if (bossGame.running && battleCtx) {
      const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
      const intensity = 1 + Math.floor((1 - hpPct) * 5);
      updateBattleIntensity(intensity);
    }
  }

  function magalorLaugh() {
    laughFlash.style.opacity = "1";
    try {
      laughFlash.animate(
        [
          { transform: "translateX(-50%) scale(0.85)", opacity: 0 },
          { transform: "translateX(-50%) scale(1.05)", opacity: 1, offset: 0.35 },
          { transform: "translateX(-50%) scale(1.0)", opacity: 1, offset: 0.75 },
          { transform: "translateX(-50%) scale(0.95)", opacity: 0 }
        ],
        { duration: 900, easing: "cubic-bezier(.2,.9,.2,1)" }
      );
    } catch {}
    setTimeout(() => (laughFlash.style.opacity = "0"), 900);
  }

  function resetBossFight(){
    bossGame.running = false;
    bossGame.t = 0;
    bossGame.lastShot = 0;
    bossGame.phaseTimer = 0;
    bossGame.pattern = "spray";
    bossGame.phase2 = false;
    bossGame.blackHole.active = false;
    bossGame.blackHole.timer = 0;
    bossGame.blackHole.cool = 2.0;

    bossGame.bullets.length = 0;
    bossGame.beams.length = 0;
    bossGame.particles.length = 0;

    bossGame.player.x = 120;
    bossGame.player.y = 260;
    bossGame.player.hp = bossGame.player.maxHp = 5;
    bossGame.player.inv = 0;

    bossGame.boss.hp = bossGame.boss.maxHp = 100;
    bossGame.boss.wob = 0;

    blackholeGif.style.opacity = "0";

    setBossBars();
    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = defaultBossOverlayHTML;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Start Boss Fight";
  }

  function spawnBossParticle(x,y,emoji){
    bossGame.particles.push({
      x,y,
      vx:(Math.random()*2-1)*1.2,
      vy:(Math.random()*2-1)*1.2 - 0.8,
      life: 40 + Math.random()*20,
      emoji
    });
  }

  function bossShoot(){
    const now = performance.now();
    if (now - bossGame.lastShot < 120) return;
    bossGame.lastShot = now;

    bossGame.beams.push({
      x: bossGame.player.x,
      y: bossGame.player.y - 12,
      vx: 0,
      vy: -7.6,
      r: 6
    });
    spawnBossParticle(bossGame.player.x, bossGame.player.y-10, "ğŸ’");
  }

  function fireBossBullet(angle, speed, kind="heart"){
    bossGame.bullets.push({
      x: bossGame.boss.x,
      y: bossGame.boss.y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      r: kind === "orb" ? 8 : 7,
      kind
    });
  }

  function chooseBossPattern(){
    const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
    const pool = hpPct > 0.65 ? ["spray","ring"]
                : hpPct > 0.30 ? ["spray","ring","dash"]
                : ["spray","ring","dash","spiral"];
    bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
    bossGame.phaseTimer = 0;
  }

  function drawMagolorLikeBoss(ctx, x, y, scale){
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);

    ctx.globalAlpha = 0.24;
    ctx.beginPath();
    ctx.ellipse(0, 14, 54, 28, 0, 0, Math.PI*2);
    ctx.fillStyle = "#111827";
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.beginPath();
    ctx.moveTo(-52, 10);
    ctx.quadraticCurveTo(0, 64, 52, 10);
    ctx.quadraticCurveTo(0, 36, -52, 10);
    ctx.closePath();
    ctx.fillStyle = "#0b1224";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, -6, 44, 38, 0, 0, Math.PI*2);
    ctx.fillStyle = "#2563eb";
    ctx.fill();

    ctx.beginPath(); ctx.moveTo(-24, -30); ctx.lineTo(-52, -58); ctx.lineTo(-28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();
    ctx.beginPath(); ctx.moveTo(24, -30); ctx.lineTo(52, -58); ctx.lineTo(28, -60); ctx.closePath();
    ctx.fillStyle = "#3b82f6"; ctx.fill();

    ctx.beginPath();
    ctx.ellipse(0, -6, 30, 24, 0, 0, Math.PI*2);
    ctx.fillStyle = "#0b1020";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(-10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 10, -10, 5, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde047";
    ctx.fill();

    ctx.beginPath();
    ctx.roundRect(-46, 4, 92, 24, 12);
    ctx.fillStyle = "#f8fafc";
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(-56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.ellipse( 56, 10, 14, 12, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fde68a";
    ctx.fill();

    ctx.restore();
  }

  function updateBoss(dt){
    bossGame.t += dt;
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    bossGame.boss.wob += dt;
    bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 95;
    bossGame.boss.y = 95 + Math.sin(bossGame.boss.wob * 1.1) * 16;

    let mx = 0, my = 0;
    if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
    if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
    if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
    if (keys.has("ArrowDown") || keys.has("s")) my += 1;

    // boss touch
    if (bossTouchActive){
      const dx = bossTouchX - bossGame.player.x;
      const dy = bossTouchY - bossGame.player.y;
      mx = clamp2(dx / 30, -1, 1);
      my = clamp2(dy / 30, -1, 1);
    }

    const speed = 4.25;
    bossGame.player.x = clamp2(bossGame.player.x + mx * speed, 18, w - 18);
    bossGame.player.y = clamp2(bossGame.player.y + my * speed, 120, h - 18);

    if (keys.has(" ")) bossShoot();

    bossGame.phaseTimer += dt;
    const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.7;
    if (bossGame.phaseTimer > 2.2) chooseBossPattern();

    if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5) {
      bossGame.phase2 = true;
      magalorLaugh();
      bossMsg.textContent = "PHASE 2 ğŸ˜³ BLACK HOLE PULL ACTIVATED!";
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ–¤");
      spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’˜");
    }

    if (bossGame.phase2) {
      bossGame.blackHole.cool -= dt;
      if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0) {
        bossGame.blackHole.active = true;
        bossGame.blackHole.timer = 1.6;
        bossGame.blackHole.cool = 4.2;
        magalorLaugh();
        bossMsg.textContent = "BLACK HOLE PULL ğŸ–¤ğŸ’«";
      }

      if (bossGame.blackHole.active) {
        blackholeGif.style.opacity = "0.95";
        bossGame.blackHole.timer -= dt;
        if (bossGame.blackHole.timer <= 0) {
          bossGame.blackHole.active = false;
          blackholeGif.style.opacity = "0";
          bossMsg.textContent = "Keep going!! Turn chaos into cuddles ğŸ˜¤ğŸ’";
        } else {
          const dx = bossGame.boss.x - bossGame.player.x;
          const dy = bossGame.boss.y - bossGame.player.y;
          const d = Math.sqrt(dx*dx + dy*dy) || 1;
          const pull = 3.3 * (1 - Math.min(d / 520, 1));
          bossGame.player.x += (dx / d) * pull;
          bossGame.player.y += (dy / d) * pull;
          bossGame.player.x = clamp2(bossGame.player.x, 18, w - 18);
          bossGame.player.y = clamp2(bossGame.player.y, 120, h - 18);
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’”");
        }
      } else {
        blackholeGif.style.opacity = "0";
      }
    } else {
      blackholeGif.style.opacity = "0";
    }

    if (bossGame.pattern === "spray"){
      if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
        const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
        const spread = 0.20 + 0.10 * intensity;
        fireBossBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.75*intensity, "heart");
      }
    } else if (bossGame.pattern === "ring"){
      if (bossGame.phaseTimer < dt + 0.02){
        const n = 10 + Math.floor(intensity*4);
        for (let i=0;i<n;i++){
          const a = (Math.PI*2) * (i/n);
          fireBossBullet(a, 2.35 + 0.7*intensity, "orb");
        }
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’—");
      }
    } else if (bossGame.pattern === "dash"){
      if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
        const laneY = 150 + Math.random() * (h - 190);
        bossGame.bullets.push({
          x: -20, y: laneY, vx: 6.2 + 1.25*intensity, vy: 0, r: 9, kind:"dash"
        });
      }
    } else if (bossGame.pattern === "spiral"){
      if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
        const base = bossGame.boss.wob * 2.2;
        fireBossBullet(base, 2.15 + 0.95*intensity, "heart");
      }
    }

    for (const b of bossGame.bullets){ b.x += b.vx; b.y += b.vy; }
    bossGame.bullets = bossGame.bullets.filter(b => b.x > -70 && b.x < w+70 && b.y > -70 && b.y < h+70);

    for (const p of bossGame.beams){ p.x += p.vx; p.y += p.vy; }
    bossGame.beams = bossGame.beams.filter(p => p.y > -50);

    for (const pt of bossGame.particles){
      pt.x += pt.vx; pt.y += pt.vy; pt.vy += 0.03; pt.life -= 1;
    }
    bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

    for (let i = bossGame.beams.length - 1; i >= 0; i--){
      const p = bossGame.beams[i];
      if (distBoss(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
        bossGame.beams.splice(i,1);
        bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "âœ¨");
        spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "ğŸ’˜");
        setBossBars();
        if (bossGame.boss.hp <= 0) winBossFight();
      }
    }

    if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
    for (let i = bossGame.bullets.length - 1; i >= 0; i--){
      const b = bossGame.bullets[i];
      if (distBoss(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
        bossGame.bullets.splice(i,1);
        if (bossGame.player.inv <= 0){
          bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
          bossGame.player.inv = 0.9;
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’¥");
          spawnBossParticle(bossGame.player.x, bossGame.player.y, "ğŸ’”");
          setBossBars();
          if (bossGame.player.hp <= 0) loseBossFight();
        }
      }
    }
  }

  function drawBoss(){
    const w = bossCanvas.getBoundingClientRect().width;
    const h = bossCanvas.getBoundingClientRect().height;

    bossCtx2.clearRect(0,0,w,h);

    if (bossBgReady) {
      drawCoverImage(bossCtx2, bossBgImg, w, h);
    } else {
      const g = bossCtx2.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, "rgba(2, 6, 23, 0.75)");
      g.addColorStop(1, "rgba(88, 28, 135, 0.45)");
      bossCtx2.fillStyle = g;
      bossCtx2.fillRect(0, 0, w, h);
    }

    bossCtx2.fillStyle = "rgba(0,0,0,0.18)";
    bossCtx2.fillRect(0,0,w,h);

    bossCtx2.globalAlpha = 0.35;
    bossCtx2.fillStyle = "#ffffff";
    for (let i = 0; i < 26; i++) {
      const sx = (i * 97) % w;
      const sy = (i * 53) % Math.max(1, Math.floor(h * 0.6));
      bossCtx2.fillRect(sx, sy, 2, 2);
    }
    bossCtx2.globalAlpha = 1;

    drawMagolorLikeBoss(bossCtx2, bossGame.boss.x, bossGame.boss.y, 0.75);

    bossCtx2.save();
    bossCtx2.translate(bossGame.player.x, bossGame.player.y);
    const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
    bossCtx2.globalAlpha = blink;
    bossCtx2.fillStyle = "#ef4444";
    bossCtx2.beginPath();
    bossCtx2.moveTo(0, 9);
    bossCtx2.bezierCurveTo(-16, -4, -10, -20, 0, -10);
    bossCtx2.bezierCurveTo(10, -20, 16, -4, 0, 9);
    bossCtx2.fill();
    bossCtx2.restore();

    for (const b of bossGame.bullets){
      bossCtx2.save();
      bossCtx2.translate(b.x, b.y);
      if (b.kind === "orb"){
        bossCtx2.globalAlpha = 0.92;
        bossCtx2.beginPath(); bossCtx2.arc(0,0,b.r,0,Math.PI*2);
        bossCtx2.fillStyle = "#a78bfa";
        bossCtx2.fill();
      } else if (b.kind === "dash"){
        bossCtx2.globalAlpha = 0.95;
        roundRectPath(bossCtx2, -14, -5, 28, 10, 6);
        bossCtx2.fillStyle = "#fb7185";
        bossCtx2.fill();
      } else {
        bossCtx2.globalAlpha = 0.92;
        drawHeartShape(bossCtx2, 0, 0, b.r);
        bossCtx2.fillStyle = "#f43f5e";
        bossCtx2.fill();
      }
      bossCtx2.restore();
    }
    bossCtx2.globalAlpha = 1;

    for (const p of bossGame.beams){
      bossCtx2.save();
      bossCtx2.translate(p.x, p.y);
      bossCtx2.globalAlpha = 0.88;
      roundRectPath(bossCtx2, -3, -12, 6, 24, 6);
      bossCtx2.fillStyle = "#22c55e";
      bossCtx2.fill();
      bossCtx2.restore();
    }

    for (const pt of bossGame.particles){
      bossCtx2.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
      bossCtx2.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      bossCtx2.fillText(pt.emoji, pt.x, pt.y);
    }
    bossCtx2.globalAlpha = 1;
  }

  let bossLast = 0;

  // boss touch controls (kept)
  let bossTouchActive = false, bossTouchX = 0, bossTouchY = 0;
  bossCanvas.addEventListener("pointerdown", (e) => {
    bossTouchActive = true;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
    if (bossGame.running) bossShoot();
  });
  bossCanvas.addEventListener("pointermove", (e) => {
    if (!bossTouchActive) return;
    const r = bossCanvas.getBoundingClientRect();
    bossTouchX = e.clientX - r.left;
    bossTouchY = e.clientY - r.top;
  });
  window.addEventListener("pointerup", () => (bossTouchActive = false));

  function bossLoop(ts){
    if (!bossGame.running) return;
    if (!bossLast) bossLast = ts;
    const dt = Math.min(0.033, (ts - bossLast) / 1000);
    bossLast = ts;

    updateBoss(dt);
    drawBoss();
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function startBossFight(){
    resetBossFight();
    bossGame.running = true;

    startBattleMusic(1);
    updateBattleIntensity(1);

    bossOverlay.style.opacity = "0";
    bossStartBtn.style.opacity = "0";
    bossStartBtn.style.pointerEvents = "none";

    bossMsg.textContent = "MAGALOR is being dramatic ğŸ˜³ Hit him with LOVE BEAMS.";
    document.body.classList.add("boss-mode");

    bossLast = 0;
    bossRaf = requestAnimationFrame(bossLoop);
  }

  function stopBossFight(){
    bossGame.running = false;
    if (bossRaf) cancelAnimationFrame(bossRaf);
    bossRaf = null;
    document.body.classList.remove("boss-mode");
    blackholeGif.style.opacity = "0";
    stopBattleMusic();
  }

  function winBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">BOSS DEFEATED ğŸ’˜</div>
        <div class="text-sm font-semibold mt-2">Unlocked! Now click YES ğŸ˜¤ğŸ’</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Rematch (optional)";

    bossMsg.textContent = "Unlocked! YES + NO are now available.";
    unlockYesNo();

    try { confetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } }); } catch {}
  }

  function loseBossFight(){
    stopBossFight();

    bossOverlay.style.opacity = "1";
    bossOverlay.innerHTML = `
      <div class="text-white drop-shadow-lg">
        <div class="text-4xl font-extrabold">You got bonked ğŸ’¥</div>
        <div class="text-sm font-semibold mt-2">Try againâ€¦ turn chaos into cuddles ğŸ˜¤</div>
      </div>
    `;

    bossStartBtn.style.opacity = "1";
    bossStartBtn.style.pointerEvents = "auto";
    bossStartBtn.textContent = "Try Again";
    bossMsg.textContent = "Tip: Move in circles while shooting!";
  }

  bossStartBtn.addEventListener("click", startBossFight);
  resetBossFight();

  // =========================================================
  // Platformer (kept)
  // =========================================================
  const platCanvas = document.getElementById("platCanvas");
  const platCtx = platCanvas.getContext("2d");
  const platStartBtn = document.getElementById("platStart");
  const platOverlay = document.getElementById("platOverlay");
  const platMsg = document.getElementById("platMsg");
  const platCountEl = document.getElementById("platCount");

  let platRaf = null;
  let platLast = 0;

  fitCanvasToCSS(platCanvas, platCtx);

  const platGame = {
    running: false,
    heartsTarget: 7,
    heartsGot: 0,
    camX: 0,
    levelW: 1500,
    gravity: 0.55,
    player: { x: 60, y: 160, w: 18, h: 22, vx: 0, vy: 0, onGround: false },
    platforms: [],
    hearts: [],
    goal: { x: 1420, y: 140, w: 24, h: 24 }
  };

  function rectsOverlap(a, b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function resetPlatformer(){
    platGame.running = false;
    platGame.heartsGot = 0;
    platCountEl.textContent = "0";
    platMsg.innerHTML = `Collect <b>${platGame.heartsTarget}</b> hearts ğŸ’– and touch the <b>love letter</b> ğŸ’Œ.`;
    platOverlay.style.opacity = "1";
    platStartBtn.style.opacity = "1";
    platStartBtn.style.pointerEvents = "auto";
    platStartBtn.textContent = "Start Platformer";

    platGame.player.x = 60; platGame.player.y = 160;
    platGame.player.vx = 0; platGame.player.vy = 0; platGame.player.onGround = false;
    platGame.camX = 0;

    platGame.platforms = [
      { x: 0,   y: 250, w: 420, h: 22 },
      { x: 460, y: 220, w: 170, h: 18 },
      { x: 680, y: 190, w: 160, h: 18 },
      { x: 890, y: 235, w: 190, h: 18 },
      { x: 1120,y: 190, w: 200, h: 18 },
      { x: 1360,y: 245, w: 160, h: 18 },
      { x: 0,   y: 300, w: 1500, h: 70 },
    ];

    platGame.hearts = [
      { x: 140, y: 205, taken: false },
      { x: 320, y: 195, taken: false },
      { x: 520, y: 175, taken: false },
      { x: 730, y: 145, taken: false },
      { x: 940, y: 185, taken: false },
      { x: 1180,y: 145, taken: false },
      { x: 1370,y: 190, taken: false },
    ];
  }

  function updatePlatformer(){
    const w = platCanvas.getBoundingClientRect().width;
    const left = keys.has("ArrowLeft") || keys.has("a");
    const right = keys.has("ArrowRight") || keys.has("d");
    const jump = keys.has("ArrowUp") || keys.has("w") || keys.has(" ");

    const p = platGame.player;
    const accel = 0.55;
    const maxV = 4.2;
    const friction = 0.82;

    if (left) p.vx -= accel;
    if (right) p.vx += accel;
    if (!left && !right) p.vx *= friction;
    p.vx = clamp2(p.vx, -maxV, maxV);

    if (jump && p.onGround){
      p.vy = -9.3;
      p.onGround = false;
    }

    p.vy += platGame.gravity;
    p.vy = clamp2(p.vy, -20, 12);

    p.x += p.vx;
    p.y += p.vy;

    p.x = clamp2(p.x, 0, platGame.levelW - p.w);
    if (p.y > 440) { p.y = 120; p.vy = 0; }

    p.onGround = false;
    for (const plat of platGame.platforms){
      const a = { x: p.x, y: p.y, w: p.w, h: p.h };
      const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
      if (rectsOverlap(a,b)){
        if (p.vy > 0 && (p.y + p.h - p.vy) <= plat.y + 2){
          p.y = plat.y - p.h;
          p.vy = 0;
          p.onGround = true;
        } else if (p.vy < 0 && (p.y - p.vy) >= plat.y + plat.h - 2){
          p.y = plat.y + plat.h;
          p.vy = 0;
        }
      }
    }

    for (const heart of platGame.hearts){
      if (heart.taken) continue;
      const hb = { x: heart.x - 8, y: heart.y - 8, w: 16, h: 16 };
      const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
      if (rectsOverlap(pb, hb)){
        heart.taken = true;
        platGame.heartsGot += 1;
        platCountEl.textContent = String(platGame.heartsGot);
        try { confetti({ particleCount: 60, spread: 55, origin: { y: 0.7 } }); } catch {}
        platMsg.innerHTML = `Aww ğŸ’– ${platGame.heartsGot}/${platGame.heartsTarget} collected!`;
      }
    }

    platGame.camX = clamp2(p.x - w*0.35, 0, platGame.levelW - w);

    const goal = platGame.goal;
    const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
    const gb = { x: goal.x, y: goal.y, w: goal.w, h: goal.h };
    if (rectsOverlap(pb, gb) && platGame.heartsGot >= platGame.heartsTarget){
      winPlatformer();
    }
  }

  function drawPlatformer(){
    const w = platCanvas.getBoundingClientRect().width;
    const h = platCanvas.getBoundingClientRect().height;
    platCtx.clearRect(0,0,w,h);

    // slightly prettier depending on mode
    const g = platCtx.createLinearGradient(0,0,0,h);
    if (document.body.classList.contains("night-mode")){
      g.addColorStop(0, "rgba(59,130,246,0.18)");
      g.addColorStop(1, "rgba(236,72,153,0.14)");
    } else {
      g.addColorStop(0, "rgba(255, 192, 203, 0.20)");
      g.addColorStop(1, "rgba(173, 216, 230, 0.22)");
    }
    platCtx.fillStyle = g;
    platCtx.fillRect(0,0,w,h);

    const cam = platGame.camX;
    platCtx.save();
    platCtx.translate(-cam, 0);

    for (const plat of platGame.platforms){
      platCtx.globalAlpha = 0.95;
      platCtx.fillStyle = "rgba(255,255,255,0.90)";
      platCtx.strokeStyle = "rgba(15, 23, 42, 0.15)";
      platCtx.lineWidth = 2;
      roundRectPath(platCtx, plat.x, plat.y, plat.w, plat.h, 12);
      platCtx.fill();
      platCtx.stroke();
      platCtx.globalAlpha = 1;

      // tiny sparkles on platforms (prettier)
      if (Math.random() < 0.03){
        platCtx.globalAlpha = 0.55;
        platCtx.fillText("âœ¨", plat.x + 10 + Math.random()*20, plat.y - 6);
        platCtx.globalAlpha = 1;
      }
    }

    for (const heart of platGame.hearts){
      if (heart.taken) continue;
      platCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
      platCtx.fillText("ğŸ’–", heart.x - 8, heart.y + 6);
    }

    platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
    platCtx.fillText("ğŸ’Œ", platGame.goal.x - 4, platGame.goal.y + 20);

    const p = platGame.player;
    platCtx.save();
    platCtx.translate(p.x + p.w/2, p.y + p.h/2);
    platCtx.fillStyle = "#ef4444";
    drawHeartShape(platCtx, 0, 2, 14);
    platCtx.fill();
    platCtx.restore();

    platCtx.restore();
  }

  function platformerLoop(ts){
    if (!platGame.running) return;
    if (!platLast) platLast = ts;
    const dt = Math.min(0.033, (ts - platLast) / 1000);
    platLast = ts;

    for (let i=0;i<Math.max(1, Math.floor(dt/0.016)); i++){
      updatePlatformer();
    }
    drawPlatformer();
    platRaf = requestAnimationFrame(platformerLoop);
  }

  function startPlatformer(){
    resetPlatformer();
    platGame.running = true;
    platOverlay.style.opacity = "0";
    platStartBtn.style.opacity = "0";
    platStartBtn.style.pointerEvents = "none";
    platMsg.innerHTML = `Go go go ğŸ’ Collect ${platGame.heartsTarget} hearts!`;
    platLast = 0;
    platRaf = requestAnimationFrame(platformerLoop);
  }

  function stopPlatformer(showOverlay = true){
    platGame.running = false;
    if (platRaf) cancelAnimationFrame(platRaf);
    platRaf = null;
    if (showOverlay){
      platOverlay.style.opacity = "1";
      platStartBtn.style.opacity = "1";
      platStartBtn.style.pointerEvents = "auto";
    }
  }

  function winPlatformer(){
    stopPlatformer(false);
    platOverlay.style.opacity = "1";
    platOverlay.innerHTML = `
      <div class="opacity-90">
        <div class="text-4xl font-extrabold">LOVE QUEST COMPLETE ğŸ’Œ</div>
        <div class="text-sm font-semibold mt-2">Okayâ€¦ that was adorable.</div>
      </div>
    `;
    platStartBtn.style.opacity = "1";
    platStartBtn.style.pointerEvents = "auto";
    platStartBtn.textContent = "Play Again";
    platMsg.innerHTML = `Awwww ğŸ’– You did it!`;
    try { confetti({ particleCount: 180, spread: 90, origin: { y: 0.65 } }); } catch {}
  }

  platStartBtn.addEventListener("click", startPlatformer);
  resetPlatformer();

  window.addEventListener("resize", () => {
    fitCanvasToCSS(bossCanvas, bossCtx2);
    fitCanvasToCSS(platCanvas, platCtx);
    fitCanvasToCSS(noBossCanvas, noCtx);
  });

  // =========================================================
  // =========================================================
  // âœ… 7 EASTER EGGS (ONE = KONAMI)
  // =========================================================
  // =========================================================

  // (1) KONAMI CODE â†’ toggles retro-mode + confetti + petals
  const KONAMI = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
  let konamiIdx = 0;

  window.addEventListener("keydown", (e) => {
    const key = e.key;
    const expected = KONAMI[konamiIdx];
    if (key === expected){
      konamiIdx++;
      if (konamiIdx >= KONAMI.length){
        konamiIdx = 0;
        document.body.classList.toggle("retro-mode");
        setPetalsMode(true);
        try { confetti({ particleCount: 260, spread: 95, origin: { y: 0.35 } }); } catch {}
        hint.textContent = "KONAMI CODE FOUND ğŸ•¹ï¸ğŸ’˜ Retro Love Mode activated!";
        startBattleMusic(2);
        setTimeout(() => stopBattleMusic(), 1200);
      }
    } else {
      konamiIdx = (key === KONAMI[0]) ? 1 : 0;
    }
  });

  // (2) Double-click the title â†’ mirror-mode
  const bigTitle = document.getElementById("bigTitle");
  bigTitle.addEventListener("dblclick", () => {
    document.body.classList.toggle("mirror-mode");
    try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.2 } }); } catch {}
    hint.textContent = document.body.classList.contains("mirror-mode")
      ? "Mirror Mode ğŸ’« (everything feelsâ€¦ alternate-universe-y)"
      : "Mirror Mode off ğŸ’—";
  });

  // (3) Click the date stamp 7 times â†’ secret petals mode toggle
  const dateStamp = document.getElementById("dateStamp");
  let dateClicks = 0;
  dateStamp.addEventListener("click", () => {
    dateClicks++;
    dateStamp.animate([{transform:"scale(1)"},{transform:"scale(1.15)"},{transform:"scale(1)"}], {duration:240});
    if (dateClicks >= 7){
      dateClicks = 0;
      setPetalsMode(!petalsOn);
      try { confetti({ particleCount: 120, spread: 85, origin: { y: 0.2 } }); } catch {}
      hint.textContent = petalsOn ? "Petal rain ON ğŸŒ¸" : "Petal rain OFF";
    }
  });

  // (4) Type LOVE quickly â†’ heart superburst
  let typed = "";
  let typedTimer = null;
  window.addEventListener("keydown", (e) => {
    if (e.key.length === 1){
      typed += e.key.toLowerCase();
      if (typedTimer) clearTimeout(typedTimer);
      typedTimer = setTimeout(() => typed = "", 650);
      if (typed.endsWith("love")){
        typed = "";
        try { confetti({ particleCount: 220, spread: 100, origin: { y: 0.5 } }); } catch {}
        hint.textContent = "LOVE typed ğŸ’– Superburst!";
      }
    }
  });

  // (5) Hold YES for 1.2s â†’ â€œYes Magnetâ€ pulses + confetti
  let yesHoldTimer = null;
  yesBtn.addEventListener("pointerdown", () => {
    yesHoldTimer = setTimeout(() => {
      yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.16)"},{transform:"scale(1)"}], {duration:620, iterations:2});
      try { confetti({ particleCount: 140, spread: 90, origin: { y: 0.65 } }); } catch {}
      hint.textContent = "YES MAGNET ACTIVATED ğŸ§²ğŸ’˜ (youâ€™re getting warmer...)";
    }, 1200);
  });
  window.addEventListener("pointerup", () => { if (yesHoldTimer) clearTimeout(yesHoldTimer); yesHoldTimer = null; });

  // (6) Click mana percent 10 times â†’ instantly show 100% + sparkle
  let manaClicks = 0;
  manaPctEl.style.cursor = "pointer";
  manaPctEl.addEventListener("click", () => {
    manaClicks++;
    if (manaClicks >= 10){
      manaClicks = 0;
      manaBarInner.style.width = "100%";
      manaPctEl.textContent = "100";
      try { confetti({ particleCount: 160, spread: 100, origin: { y: 0.1 } }); } catch {}
      hint.textContent = "Affection Mana MAXED âœ¨";
    }
  });

  // (7) Secret: scroll to bottom once â†’ â€œPortalâ€ message + music blip
  let bottomEggDone = false;
  window.addEventListener("scroll", () => {
    if (bottomEggDone) return;
    const doc = document.documentElement;
    const nearBottom = (doc.scrollTop + doc.clientHeight) >= (doc.scrollHeight - 12);
    if (nearBottom){
      bottomEggDone = true;
      hint.textContent = "You reached the end of the quest map ğŸ—ºï¸ğŸ’˜ Portal unlocked!";
      try { confetti({ particleCount: 140, spread: 85, origin: { y: 0.95 } }); } catch {}
      playGlueSong();
    }
  }, { passive:true });

</script>
</body>
</html>
