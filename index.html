<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Will you be my Valentine Andrew Getzow?</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --fg: rgba(255,255,255,0.96);
      --shadow: rgba(0,0,0,0.18);
      --pill: rgba(244,63,94,0.20);
      --card: rgba(255,255,255,0.80);
      --cardBorder: rgba(255,255,255,0.70);
      --muted: rgba(15,23,42,0.78);
      --hud: rgba(255,255,255,0.55);
    }

    body{
      min-height: 100vh;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
        linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
      overflow-x: hidden;
    }
    body.sunset{
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(255, 170, 120, 0.55), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.25), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.25), transparent 60%),
        linear-gradient(180deg, #fff7ed 0%, #ffedd5 35%, #ffe4e6 70%, #eff6ff 100%);
    }
    body.night{
      --fg: rgba(255,255,255,0.92);
      --shadow: rgba(0,0,0,0.55);
      --pill: rgba(59,130,246,0.18);
      --card: rgba(255,255,255,0.12);
      --cardBorder: rgba(255,255,255,0.18);
      --muted: rgba(255,255,255,0.86);
      --hud: rgba(255,255,255,0.12);
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(59, 130, 246, 0.25), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(168, 85, 247, 0.18), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(244, 63, 94, 0.15), transparent 60%),
        linear-gradient(180deg, #0b1220 0%, #0f172a 50%, #111827 100%);
    }

    body.boss-mode::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
        linear-gradient(180deg, rgba(15,23,42,0.28), rgba(0,0,0,0.12));
      opacity: 0.85;
      mix-blend-mode: multiply;
    }

    #stage{
      transform: translate3d(var(--px, 0px), var(--py, 0px), 0);
      transition: transform 80ms linear;
    }

    #bg{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow:hidden;
    }
    .blob{
      position:absolute;
      width: 520px;
      height: 520px;
      border-radius: 999px;
      filter: blur(55px);
      opacity: 0.55;
      mix-blend-mode: multiply;
      will-change: transform;
    }
    .blob.a{
      left:-140px; top:-160px;
      background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
      animation: floatA 14s ease-in-out infinite;
    }
    .blob.b{
      right:-160px; top:-120px;
      background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
      animation: floatB 16s ease-in-out infinite;
    }
    .blob.c{
      left:10%; bottom:-210px;
      background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
      animation: floatC 18s ease-in-out infinite;
    }
    @keyframes floatA{ 0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(80px,60px) scale(1.08)}}
    @keyframes floatB{ 0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(-90px,70px) scale(1.06)}}
    @keyframes floatC{ 0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(120px,-60px) scale(1.1)}}

    .noise{
      position:absolute; inset:0;
      opacity: .10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='https://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }
    .pixel-grid{
      position:absolute; inset:0;
      opacity:.08;
      background-image:
        linear-gradient(to right, rgba(15,23,42,.25) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(15,23,42,.25) 1px, transparent 1px);
      background-size: 26px 26px;
      mix-blend-mode: overlay;
    }
    body.night .pixel-grid{
      opacity:.12;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.10) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.10) 1px, transparent 1px);
    }

    /* Celeste-ish clouds */
    #celesteClouds{
      position: fixed; inset:0;
      pointer-events:none;
      z-index: 2;
      overflow:hidden;
    }
    .ccloud{
      position:absolute;
      top: var(--top);
      left: -35%;
      width: var(--w);
      height: calc(var(--w) * 0.22);
      border-radius: 999px;
      background:
        radial-gradient(circle at 22% 35%, rgba(255,255,255,0.90), rgba(255,255,255,0.45) 55%, rgba(255,255,255,0.18) 70%, transparent 78%);
      filter: drop-shadow(0 14px 22px rgba(0,0,0,0.10));
      opacity: var(--op);
      animation: cdrift var(--dur) linear infinite;
    }
    .ccloud::before,.ccloud::after{ content:""; position:absolute; background: inherit; border-radius:999px; }
    .ccloud::before{ width:48%; height:170%; left:10%; top:-70%; }
    .ccloud::after{ width:55%; height:190%; left:38%; top:-90%; }
    .ccloud .streak{
      position:absolute;
      right:12%; top:45%;
      width:22%; height:6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      opacity:.7;
    }
    @keyframes cdrift{ from{transform:translateX(0)} to{transform:translateX(180vw)} }
    body.night .ccloud{ opacity: calc(var(--op) * 0.45); }

    /* particles */
    #petals, #powerups, #hearts{
      position: fixed; inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    #petals{ z-index:3; }
    #powerups{ z-index:3; }
    #hearts{ z-index:4; }

    .heart{
      position:absolute;
      bottom:-40px;
      animation: floatUp linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
      user-select:none;
    }
    @keyframes floatUp{
      0%{ transform:translateY(0) translateX(0) scale(1); opacity:0; }
      10%{ opacity:0.85; }
      100%{ transform:translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity:0; }
    }
    .powerup{
      position:absolute;
      bottom:-40px;
      opacity:0;
      animation: puFloat linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.12));
      user-select:none;
    }
    @keyframes puFloat{
      0%{ transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity:0; }
      12%{ opacity:.95; }
      100%{ transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity:0; }
    }
    .petal{
      position:absolute;
      top:-40px;
      opacity:0;
      animation: fallDown linear forwards;
      user-select:none;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.10));
    }
    @keyframes fallDown{
      0%{ transform:translateY(0) translateX(0) rotate(0deg); opacity:0; }
      10%{ opacity:.85; }
      100%{ transform:translateY(120vh) translateX(var(--drift)) rotate(var(--rot)); opacity:0; }
    }

    /* Title */
    #bigTitle{
      position: relative;
      z-index: 6;
      text-align:center;
      font-weight: 1000;
      letter-spacing: -0.02em;
      line-height: 0.95;
      font-size: clamp(2.2rem, 6vw, 4.6rem);
      color: var(--fg);
      text-shadow: 0 4px 0 var(--shadow), 0 12px 34px rgba(0,0,0,0.22);
      margin-bottom: 1.15rem;
      user-select:none;
    }
    #titlePill{
      position: relative;
      display:inline-block;
      padding: 0.18em 4.4em 0.18em 0.42em;
      border-radius: 999px;
      background: var(--pill);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
      overflow:hidden;
    }
    #letsGo{
      position:absolute;
      right:22px;
      top:50%;
      transform: translateY(-50%) rotate(-12deg) scale(0.7);
      font-weight:1000;
      font-size: clamp(1.15rem, 3vw, 2.1rem);
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(0,0,0,0.95);
      text-shadow: 0 10px 18px rgba(0,0,0,0.12);
      opacity: 0;
      pointer-events:none;
      white-space: nowrap;
      z-index: 9;
    }
    #letsGo.show{
      opacity: 1;
      animation: letsGoPop 650ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes letsGoPop{
      0%{ transform: translateY(-50%) rotate(-12deg) scale(0.55); opacity:0; }
      60%{ transform: translateY(-50%) rotate(-12deg) scale(1.05); opacity:1; }
      100%{ transform: translateY(-50%) rotate(-12deg) scale(0.92); opacity:1; }
    }

    /* card */
    .card{
      position: relative;
      z-index: 7;
      background: var(--card);
      backdrop-filter: blur(14px);
      border: 1px solid var(--cardBorder);
      box-shadow: 0 22px 70px rgba(0,0,0,0.14);
    }
    .pixelFrame{ position: relative; }
    .pixelFrame::before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: 30px;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,0.75) 0 8px, rgba(255,255,255,0.35) 8px 16px),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.75) 0 8px, rgba(255,255,255,0.35) 8px 16px);
      opacity: .22;
      pointer-events:none;
    }
    .pixelFrame::after{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius: 28px;
      border: 2px solid rgba(255,255,255,0.55);
      pointer-events:none;
      box-shadow: 0 20px 70px rgba(0,0,0,0.12);
    }
    body.night .pixelFrame::before{ opacity:.14; }
    body.night .pixelFrame::after{ border-color: rgba(255,255,255,0.18); }

    /* Media container ‚Äî VIDEO FIRST to reduce pixelly look */
    .mediaBox{
      width: 100%;
      height: 16rem; /* matches h-64 */
      border-radius: 0.75rem;
      overflow: hidden;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));
      position: relative;
    }
    #valVideo, #valImage{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      image-rendering: auto;
    }
    #valImage{ display:none; } /* we default to video; gif fallback shows this */

    /* heart buttons */
    .svg-heart{
      width: 56px;
      height: 50px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease;
      will-change: transform;
      user-select:none;
    }
    .svg-heart svg{ width:100%; height:100%; display:block; }
    .svg-heart.yes path{ fill:#ef4444; }
    .svg-heart.no path{ fill:#f43f5e; }
    .svg-heart span{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: translateY(-4px);
      color:#fff;
      font-weight:1000;
      font-size:11px;
      letter-spacing:.9px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .svg-heart:hover{ transform: scale(1.06); filter: drop-shadow(0 12px 18px rgba(0,0,0,.18)); }
    .svg-heart:active{ transform: scale(.96); }

    /* controls */
    #controls{
      position: fixed;
      right: 14px;
      top: 14px;
      z-index: 60;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pillBtn{
      border: 0;
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.60);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 42px rgba(0,0,0,0.14);
      font-weight: 1000;
      letter-spacing: .02em;
      user-select:none;
      white-space: nowrap;
    }
    body.night .pillBtn{
      background: rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.18);
    }

    /* audio controls */
    #audioRow{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 42px rgba(0,0,0,0.14);
    }
    body.night #audioRow{
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
    }
    #vol{ width: 110px; accent-color: #ef4444; }
    body.night #vol{ accent-color: #93c5fd; }

    /* toasts */
    #toasts{
      position: fixed;
      left: 14px;
      top: 14px;
      z-index: 80;
      display:flex;
      flex-direction: column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.72);
      box-shadow: 0 18px 52px rgba(0,0,0,0.16);
      font-weight: 900;
      letter-spacing: .02em;
      color: rgba(15,23,42,0.92);
      opacity: 0;
      transform: translateY(-10px);
      animation: toastInOut 3200ms ease-in-out forwards;
    }
    body.night .toast{
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.92);
    }
    @keyframes toastInOut{
      0%{ opacity:0; transform: translateY(-10px); }
      15%{ opacity:1; transform: translateY(0px); }
      85%{ opacity:1; transform: translateY(0px); }
      100%{ opacity:0; transform: translateY(-10px); }
    }

    /* warp overlay */
    #warp{
      position: fixed;
      inset: 0;
      z-index: 500;
      pointer-events: none;
      opacity: 0;
    }
    #warp.show{
      opacity: 1;
      animation: warp 620ms ease-in-out forwards;
    }
    #warp::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,0.55), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(59,130,246,0.25), transparent 65%),
        conic-gradient(from 90deg, rgba(244,63,94,0.18), rgba(59,130,246,0.18), rgba(244,63,94,0.18));
      transform: scale(0.7);
    }
    @keyframes warp{
      0%{ opacity:0; }
      10%{ opacity:1; }
      55%{ opacity:1; }
      100%{ opacity:0; }
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 200;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal.show{ display:flex; }
    .modal::before{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(2,6,23,0.38);
      backdrop-filter: blur(6px);
    }
    .modalCard{
      position: relative;
      z-index: 1;
      width: min(980px, 100%);
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(255,255,255,0.72);
      border-radius: 22px;
      box-shadow: 0 30px 120px rgba(0,0,0,0.28);
      overflow:hidden;
    }
    body.night .modalCard{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.18);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      font-weight: 1000;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .modalBody{ padding: 14px; color: var(--muted); }
    .xBtn{
      border:0;
      cursor:pointer;
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.55);
      font-weight: 1000;
    }
    body.night .xBtn{
      background: rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.18);
    }

    .gameText{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: 0.02em;
    }

    .shake{ animation: shake 250ms ease-in-out; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      20%{ transform: translateX(-8px); }
      40%{ transform: translateX(8px); }
      60%{ transform: translateX(-6px); }
      80%{ transform: translateX(6px); }
      100%{ transform: translateX(0); }
    }
    .freeze{ animation: freezeFlash 90ms ease-in-out; }
    @keyframes freezeFlash{
      0%{ filter: brightness(1); }
      50%{ filter: brightness(1.18); }
      100%{ filter: brightness(1); }
    }

    /* Battle */
    #battleCanvas{
      width:100%;
      height:360px;
      display:block;
      background:
        radial-gradient(700px 320px at 30% 25%, rgba(244,63,94,0.16), transparent 60%),
        radial-gradient(700px 320px at 80% 60%, rgba(59,130,246,0.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.28), rgba(255,255,255,0.10));
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.55);
      overflow:hidden;
    }
    body.night #battleCanvas{
      background:
        radial-gradient(700px 320px at 30% 25%, rgba(59,130,246,0.18), transparent 60%),
        radial-gradient(700px 320px at 80% 60%, rgba(244,63,94,0.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border-color: rgba(255,255,255,0.18);
    }
    .menuBtn{
      border: 1px solid rgba(255,255,255,0.55);
      background: rgba(255,255,255,0.45);
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 1000;
      cursor: pointer;
      user-select:none;
    }
    body.night .menuBtn{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.92);
    }
    .barOuter{
      height: 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.10);
      overflow:hidden;
    }
    body.night .barOuter{ background: rgba(255,255,255,0.12); }
    .barInner{
      height:100%;
      border-radius: 999px;
      transition: width 120ms ease;
      background: linear-gradient(90deg, rgba(244,63,94,0.85), rgba(59,130,246,0.65));
    }

    /* Platformer canvas */
    #platformCanvas{
      width:100%;
      height:520px;
      display:block;
      background: linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.08));
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.55);
    }
    body.night #platformCanvas{
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border-color: rgba(255,255,255,0.18);
    }

    /* Dedede sticker */
    #dededeCorner{
      position: fixed;
      left: 14px;
      bottom: 14px;
      z-index: 55;
      display:flex;
      align-items:flex-end;
      gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,0.60);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.70);
      box-shadow: 0 18px 52px rgba(0,0,0,0.16);
      user-select:none;
    }
    body.night #dededeCorner{
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.92);
    }
    #dededeImg{
      width: 70px;
      height: 70px;
      object-fit: contain;
      display:block;
    }
    #dededeFallback{
      display:none;
      font-size: 46px;
      line-height: 1;
    }
    #dededeDate{
      font-weight: 1000;
      letter-spacing: .06em;
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>

<body class="flex flex-col items-center justify-center p-6">
  <div id="warp" aria-hidden="true"></div>
  <div id="toasts" aria-live="polite"></div>

  <!-- Dedede sticker (add dedede.png in your repo root) -->
  <div id="dededeCorner" class="gameText" title="Put dedede.png in your repo to show Dedede here">
    <img id="dededeImg" src="dedede.png" alt="King Dedede" />
    <div id="dededeFallback">üëëüêß</div>
    <div id="dededeDate">2/14/26</div>
  </div>

  <div id="controls" class="gameText">
    <button id="toggleCycle" class="pillBtn" type="button">‚è≥ Cycle</button>
    <button id="openPlatformer" class="pillBtn" type="button">üßó Platformer</button>
    <button id="openBattle" class="pillBtn" type="button">‚öîÔ∏è Battle</button>
    <button id="screenshotBtn" class="pillBtn" type="button">üì∏ Screenshot</button>

    <div id="audioRow">
      <button id="muteBtn" class="pillBtn" style="padding:8px 10px;" type="button">üîä</button>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.45" />
      <span id="audioStatus" class="text-xs font-extrabold opacity-80">click anywhere to start</span>
    </div>
  </div>

  <div id="stage">
    <div id="bg" aria-hidden="true">
      <div class="blob a"></div>
      <div class="blob b"></div>
      <div class="blob c"></div>
      <div class="noise"></div>
      <div class="pixel-grid"></div>
    </div>

    <div id="celesteClouds" aria-hidden="true">
      <div class="ccloud" style="--top: 10%; --w: 420px; --dur: 78s; --op: 0.55;"><div class="streak"></div></div>
      <div class="ccloud" style="--top: 18%; --w: 520px; --dur: 96s; --op: 0.35;"><div class="streak"></div></div>
      <div class="ccloud" style="--top: 28%; --w: 360px; --dur: 68s; --op: 0.42;"><div class="streak"></div></div>
      <div class="ccloud" style="--top: 34%; --w: 620px; --dur: 118s; --op: 0.28;"><div class="streak"></div></div>
    </div>

    <div id="petals" aria-hidden="true"></div>
    <div id="powerups" aria-hidden="true"></div>
    <div id="hearts" aria-hidden="true"></div>

    <h1 id="bigTitle" class="w-full px-4">
      <span id="titlePill">
        Will you be my Valentine Andrew Getzow? Pretty Pleases? üíò
        <span id="letsGo">LETS GOOOO</span>
      </span>
    </h1>

    <div id="mainCard" class="card pixelFrame rounded-3xl p-7 max-w-md w-full text-center gameText">
      <div class="text-xs font-extrabold uppercase tracking-widest mb-2" style="color: var(--muted);">
        Coins: <span id="coinCount">0</span> ¬∑ Love Combo: <span id="loveCount">x0</span>
      </div>

      <!-- Video first (cleaner), GIF fallback -->
      <div class="mediaBox">
        <video id="valVideo" autoplay loop muted playsinline></video>
        <img id="valImage" alt="Valentine gif" />
      </div>

      <div class="rounded-2xl p-4 text-left mb-4"
           style="background: rgba(255,255,255,0.55); border: 1px solid rgba(255,255,255,0.65);">
        <div class="font-extrabold tracking-wide text-sm uppercase" style="color: var(--muted);">Quest Log</div>
        <div class="mt-2 text-sm" style="color: var(--muted);">
          <div>üéØ Objective: <span class="font-semibold">Get Andrew to say YES</span></div>
          <div class="mt-1">üíñ Meter: <span id="meterPct" class="font-extrabold">0%</span></div>
          <div class="mt-1">‚öîÔ∏è Boss: <span id="bossStatus" class="font-extrabold">Dormant</span></div>
        </div>

        <div class="mt-3">
          <div class="barOuter"><div id="meterBar" class="barInner" style="width:0%;"></div></div>
          <div class="mt-2 flex gap-2 justify-between">
            <button id="mashLove" class="pillBtn" type="button" style="padding:10px 12px;">üïπÔ∏è Mash LOVE</button>
            <button id="startMusicBtn" class="pillBtn" type="button" style="padding:10px 12px;">üéµ Start Music</button>
          </div>
        </div>
      </div>

      <div class="flex gap-6 justify-center mt-1">
        <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>YES</span>
        </button>

        <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>NO</span>
        </button>
      </div>

      <p id="hint" class="text-sm mt-4" style="color: var(--muted);">
        Tip: NO triggers a bullet-hell battle now. Beat it by FIGHTing or SPAREing.
      </p>
    </div>
  </div>

  <!-- PLATFORMER MODAL -->
  <div id="platformerModal" class="modal" role="dialog" aria-modal="true" aria-label="Platformer">
    <div class="modalCard">
      <div class="modalHeader gameText">
        <div>Platformer (Celeste + Silksong vibes)</div>
        <button class="xBtn gameText" id="closePlatformer" type="button">‚úï</button>
      </div>
      <div class="modalBody gameText">
        <div class="flex flex-wrap gap-2 items-center justify-between mb-3">
          <div class="font-extrabold uppercase text-xs tracking-wider">
            ‚Üê ‚Üí move ¬∑ Space jump ¬∑ Shift dash ¬∑ Z attack ¬∑ X silk ¬∑ R restart
          </div>
          <div class="font-extrabold uppercase text-xs tracking-wider">
            Deaths: <span id="deathCount">0</span> ¬∑ üçì carried: <span id="berryCarry">0</span> ¬∑ Silk: <span id="silkPct">0%</span>
          </div>
        </div>
        <canvas id="platformCanvas" width="960" height="520"></canvas>
      </div>
    </div>
  </div>

  <!-- BATTLE MODAL -->
  <div id="battleModal" class="modal" role="dialog" aria-modal="true" aria-label="Battle">
    <div class="modalCard">
      <div class="modalHeader gameText">
        <div>Battle (Undertale + Deltarune vibes)</div>
        <button class="xBtn gameText" id="closeBattle" type="button">‚úï</button>
      </div>
      <div class="modalBody gameText">
        <div class="grid gap-3">
          <div class="grid sm:grid-cols-3 gap-3">
            <div class="rounded-2xl p-3" style="background: rgba(255,255,255,0.45); border: 1px solid rgba(255,255,255,0.55);">
              <div class="font-extrabold uppercase text-xs tracking-wider">You</div>
              <div class="mt-2 text-sm">HP: <span id="bHp">20</span>/<span id="bHpMax">20</span></div>
              <div class="mt-2 barOuter"><div id="bHpBar" class="barInner" style="width:100%;"></div></div>
              <div class="mt-3 text-sm">TP: <span id="bTp">0</span>%</div>
              <div class="mt-2 barOuter"><div id="bTpBar" class="barInner" style="width:0%; background: linear-gradient(90deg, rgba(59,130,246,0.85), rgba(168,85,247,0.65));"></div></div>
            </div>

            <div class="rounded-2xl p-3" style="background: rgba(255,255,255,0.45); border: 1px solid rgba(255,255,255,0.55);">
              <div class="font-extrabold uppercase text-xs tracking-wider">Enemy</div>
              <div class="mt-2 text-sm">NO Courage: <span id="bBossHp">100</span>%</div>
              <div class="mt-2 barOuter"><div id="bBossHpBar" class="barInner" style="width:100%; background: linear-gradient(90deg, rgba(239,68,68,0.95), rgba(244,63,94,0.75));"></div></div>
              <div class="mt-3 text-sm">MERCY: <span id="bMercy">0</span>%</div>
              <div class="mt-2 barOuter"><div id="bMercyBar" class="barInner" style="width:0%; background: linear-gradient(90deg, rgba(34,197,94,0.85), rgba(59,130,246,0.55));"></div></div>
            </div>

            <div class="rounded-2xl p-3" style="background: rgba(255,255,255,0.45); border: 1px solid rgba(255,255,255,0.55);">
              <div class="font-extrabold uppercase text-xs tracking-wider">Info</div>
              <div id="bText" class="mt-2 text-sm leading-snug">
                Use arrow keys to move your SOUL. Dodge bullets to gain TP. ACT increases MERCY. MERCY at 100% lets you SPARE.
              </div>
              <div class="mt-2 text-xs opacity-80">Phase 2 music = faster + extra layers.</div>
            </div>
          </div>

          <canvas id="battleCanvas" width="960" height="360"></canvas>

          <div class="grid grid-cols-4 gap-2">
            <button id="btnFight" class="menuBtn" type="button">FIGHT</button>
            <button id="btnAct" class="menuBtn" type="button">ACT</button>
            <button id="btnItem" class="menuBtn" type="button">ITEM</button>
            <button id="btnMercy" class="menuBtn" type="button">MERCY</button>
          </div>

          <div class="text-sm opacity-80">
            Battle controls: Arrow keys move. (Staying alive builds TP faster.)
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Dedede fallback if file missing ===== */
const dededeImg = document.getElementById("dededeImg");
const dededeFallback = document.getElementById("dededeFallback");
dededeImg.addEventListener("error", ()=>{
  dededeImg.style.display = "none";
  dededeFallback.style.display = "block";
});

/* ===== Small helpers ===== */
const warp = document.getElementById("warp");
const showWarp = () => { warp.classList.remove("show"); void warp.offsetWidth; warp.classList.add("show"); };

const toasts = document.getElementById("toasts");
function showToast(text){
  const el = document.createElement("div");
  el.className = "toast gameText";
  el.textContent = text;
  toasts.appendChild(el);
  setTimeout(()=>el.remove(), 3400);
}
function freezeFlash(el){ el.classList.remove("freeze"); void el.offsetWidth; el.classList.add("freeze"); }
function shake(el){ el.classList.remove("shake"); void el.offsetWidth; el.classList.add("shake"); }

/* ===== Parallax ===== */
const stage = document.getElementById("stage");
window.addEventListener("mousemove", (e)=>{
  const x = (e.clientX / window.innerWidth) - 0.5;
  const y = (e.clientY / window.innerHeight) - 0.5;
  stage.style.setProperty("--px", (x * 18) + "px");
  stage.style.setProperty("--py", (y * 18) + "px");
});

/* ===== Cycle backgrounds ===== */
const toggleCycle = document.getElementById("toggleCycle");
const cycleList = ["day","sunset","night"];
let cycleIdx = 0;
function applyCycle(name){
  document.body.classList.remove("sunset","night");
  if (name === "sunset") document.body.classList.add("sunset");
  if (name === "night") document.body.classList.add("night");
}
function nextCycle(){
  cycleIdx = (cycleIdx + 1) % cycleList.length;
  applyCycle(cycleList[cycleIdx]);
  showToast("Cycle: " + cycleList[cycleIdx].toUpperCase());
}
toggleCycle.addEventListener("click", ()=>{ showWarp(); nextCycle(); });
setInterval(()=>{ nextCycle(); }, 30000);

/* ===== Background particles ===== */
const heartsLayer = document.getElementById("hearts");
const powerupsLayer = document.getElementById("powerups");
const petalsLayer = document.getElementById("petals");

function spawnHeart(){
  const el = document.createElement("span");
  el.className = "heart";
  el.textContent = Math.random() > 0.25 ? "üíó" : "üíñ";
  const left = Math.random()*100;
  const size = 12 + Math.random()*22;
  const dur = 5 + Math.random()*7;
  const drift = (Math.random()*60-30) + "px";
  el.style.left = left + "vw";
  el.style.fontSize = size + "px";
  el.style.opacity = (0.30 + Math.random()*0.50).toFixed(2);
  el.style.animationDuration = dur + "s";
  el.style.setProperty("--drift", drift);
  heartsLayer.appendChild(el);
  setTimeout(()=>el.remove(), dur*1000+100);
}
for(let i=0;i<14;i++) spawnHeart();
setInterval(spawnHeart, 250);

function spawnPowerup(){
  const el = document.createElement("span");
  el.className = "powerup";
  const items = ["‚≠ê","ü™ô","‚ú®","üíñ","üéÆ","üçÑ","üíé","‚ù§Ô∏è","üü¢","üî∫","üü®","üí†"];
  el.textContent = items[Math.floor(Math.random()*items.length)];
  const left = Math.random()*100;
  const size = 12 + Math.random()*18;
  const dur = 6 + Math.random()*8;
  const drift = (Math.random()*80-40) + "px";
  const rot = (Math.random()*160-80) + "deg";
  el.style.left = left + "vw";
  el.style.fontSize = size + "px";
  el.style.animationDuration = dur + "s";
  el.style.setProperty("--drift", drift);
  el.style.setProperty("--rot", rot);
  powerupsLayer.appendChild(el);
  setTimeout(()=>el.remove(), dur*1000+200);
}
for(let i=0;i<10;i++) spawnPowerup();
setInterval(spawnPowerup, 650);

function spawnPetal(){
  const el = document.createElement("span");
  el.className = "petal";
  const items = ["üå∏","üéà","üéÄ","üå∑"];
  el.textContent = items[Math.floor(Math.random()*items.length)];
  const left = Math.random()*100;
  const size = 12 + Math.random()*16;
  const dur = 6 + Math.random()*8;
  const drift = (Math.random()*120-60) + "px";
  const rot = (Math.random()*220-110) + "deg";
  el.style.left = left + "vw";
  el.style.fontSize = size + "px";
  el.style.opacity = (0.22 + Math.random()*0.55).toFixed(2);
  el.style.animationDuration = dur + "s";
  el.style.setProperty("--drift", drift);
  el.style.setProperty("--rot", rot);
  petalsLayer.appendChild(el);
  setTimeout(()=>el.remove(), dur*1000+200);
}
for(let i=0;i<6;i++) spawnPetal();
setInterval(spawnPetal, 950);

/* ===== Media loader (VIDEO first, GIF fallback) ===== */
const valVideo = document.getElementById("valVideo");
const valImage = document.getElementById("valImage");
const hint = document.getElementById("hint");

function showVideo(url){
  valVideo.style.display = "block";
  valImage.style.display = "none";
  valVideo.src = url;
  valVideo.play().catch(()=>{});
}
function showImage(url){
  valImage.style.display = "block";
  valVideo.style.display = "none";
  valImage.src = url;
}
function setMediaTry(sources, failMessage){
  let i = 0;
  const tryNext = () => {
    if (i >= sources.length){
      hint.textContent = failMessage;
      return;
    }
    const s = sources[i++];

    if (s.kind === "video"){
      const probe = document.createElement("video");
      probe.muted = true;
      probe.playsInline = true;
      probe.src = s.url;
      const ok = () => { showVideo(s.url); hint.textContent = ""; cleanup(); };
      const bad = () => { cleanup(); tryNext(); };
      const cleanup = () => {
        probe.removeEventListener("canplaythrough", ok);
        probe.removeEventListener("error", bad);
      };
      probe.addEventListener("canplaythrough", ok, { once:true });
      probe.addEventListener("error", bad, { once:true });
      probe.load();
      return;
    }

    // image
    const img = new Image();
    img.onload = () => { showImage(s.url); hint.textContent = ""; };
    img.onerror = () => tryNext();
    img.src = s.url;
  };
  tryNext();
}

/* Tenor ‚Äúm/‚Äù URLs often look better as MP4 than GIF.
   We try mp4 first, then gif fallback. */
const GIFS = {
  start: [
    {kind:"video", url:"https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.mp4"},
    {kind:"img",   url:"https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"},
  ],
  yesMain: [
    {kind:"video", url:"https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.mp4"},
    {kind:"img",   url:"https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"},
  ],
  yesFinal: [
    {kind:"video", url:"https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.mp4"},
    {kind:"img",   url:"https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"},
  ],
  no: [
    /* This one is a giphy gif; you can replace with an mp4 if you want */
    {kind:"img", url:"https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"}
  ]
};

setMediaTry(GIFS.start, "Start media failed to load.");

/* ===== HUD state ===== */
const coinCountEl = document.getElementById("coinCount");
const loveCountEl = document.getElementById("loveCount");
const meterBar = document.getElementById("meterBar");
const meterPct = document.getElementById("meterPct");
const bossStatus = document.getElementById("bossStatus");

let state = { coins: 0, combo: 0, meter: 0 };
function syncHUD(){
  coinCountEl.textContent = String(state.coins);
  loveCountEl.textContent = "x" + state.combo;
  meterPct.textContent = Math.round(state.meter) + "%";
  meterBar.style.width = state.meter + "%";
}
syncHUD();
function addMeter(v){
  state.meter = Math.max(0, Math.min(100, state.meter + v));
  syncHUD();
}

/* ===== Mash LOVE ===== */
document.getElementById("mashLove").addEventListener("click", ()=>{
  addMeter(8);
  state.combo += 1;
  syncHUD();
  if (state.meter >= 100){
    showToast("LOVE OVERDRIVE üí•");
    state.coins += 5;
    state.meter = 60;
    syncHUD();
    confetti({ particleCount: 160, spread: 80, origin: { y: 0.6 } });
  }
});

/* ===== Buttons ===== */
const yesBtn = document.getElementById("yesBtn");
const noBtn  = document.getElementById("noBtn");
const letsGo = document.getElementById("letsGo");
const mainCard = document.getElementById("mainCard");
let yesFinalTimer = null;

yesBtn.addEventListener("click", ()=>{
  ensureMusicStarted();
  letsGo.classList.add("show");
  confetti({ particleCount: 260, spread: 90, origin: { y: 0.6 } });
  setMediaTry(GIFS.yesMain, "YES media failed to load.");

  hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! üíô";

  if (yesFinalTimer) clearTimeout(yesFinalTimer);
  yesFinalTimer = setTimeout(()=>setMediaTry(GIFS.yesFinal, "Final media failed."), 1800);

  if (battle.running){
    battleWin("YES ending cutscene activated üíò");
  }
});

/* NO button: comically bigger + runs away + starts battle */
let noScale = 1;
function ensureNoFixed(){
  if (noBtn.dataset.fixed === "1") return;
  noBtn.dataset.fixed = "1";
  const r = noBtn.getBoundingClientRect();
  noBtn.style.position = "fixed";
  noBtn.style.left = r.left + "px";
  noBtn.style.top  = r.top + "px";
  noBtn.style.zIndex = "999";
}
function clampNoOnScreen(){
  const scale = Math.min(noScale, 4.2);
  const w = 56 * scale;
  const h = 50 * scale;
  const pad = 14;
  let left = parseFloat(noBtn.style.left || "0");
  let top  = parseFloat(noBtn.style.top  || "0");
  left = Math.max(pad, Math.min(window.innerWidth - w - pad, left));
  top  = Math.max(pad, Math.min(window.innerHeight - h - pad, top));
  noBtn.style.left = left + "px";
  noBtn.style.top  = top + "px";
}
function applyNoScale(){
  noBtn.style.transform = `scale(${Math.min(noScale, 4.2)})`;
  clampNoOnScreen();
}
function runAwayNo(){
  ensureNoFixed();
  const scale = Math.min(noScale, 4.2);
  const w = 56 * scale;
  const h = 50 * scale;
  const pad = 14;
  const left = pad + Math.random() * Math.max(1, (window.innerWidth - w - pad*2));
  const top  = pad + Math.random() * Math.max(1, (window.innerHeight - h - pad*2));
  noBtn.style.transition = "left 140ms ease, top 140ms ease, transform 120ms ease";
  noBtn.style.left = left + "px";
  noBtn.style.top  = top + "px";
  applyNoScale();
}
window.addEventListener("resize", clampNoOnScreen);

noBtn.addEventListener("click", ()=>{
  ensureMusicStarted();
  setMediaTry(GIFS.no, "NO media failed to load.");
  bossStatus.textContent = "Engaged";

  noScale *= 1.22;
  ensureNoFixed();
  applyNoScale();
  runAwayNo();

  openBattle();
});

/* ===== Modals ===== */
function openModal(m){ m.classList.add("show"); }
function closeModal(m){ m.classList.remove("show"); }
function closeOnBackdrop(m, onClose){
  m.addEventListener("click",(e)=>{
    if (e.target === m){ closeModal(m); onClose?.(); }
  });
}

const platformerModal = document.getElementById("platformerModal");
document.getElementById("openPlatformer").addEventListener("click", ()=>{ ensureMusicStarted(); showWarp(); openModal(platformerModal); startPlatformer(); });
document.getElementById("closePlatformer").addEventListener("click", ()=>{ closeModal(platformerModal); stopPlatformer(); });
closeOnBackdrop(platformerModal, stopPlatformer);

const battleModal = document.getElementById("battleModal");
document.getElementById("openBattle").addEventListener("click", ()=>{ ensureMusicStarted(); showWarp(); openModal(battleModal); battleStart(); });
document.getElementById("closeBattle").addEventListener("click", ()=>{ closeModal(battleModal); battleStop(); });
closeOnBackdrop(battleModal, battleStop);

function openBattle(){
  showWarp();
  openModal(battleModal);
  battleStart();
}

/* Screenshot */
document.getElementById("screenshotBtn").addEventListener("click", async ()=>{
  ensureMusicStarted();
  try{
    showToast("Taking screenshot‚Ä¶");
    const canvas = await html2canvas(document.body, { scale: 2 });
    const a = document.createElement("a");
    a.download = "valentine.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
    showToast("Saved screenshot ‚úÖ");
  }catch{
    showToast("Screenshot failed üò≠");
  }
});

/* ===== ESC closes ===== */
window.addEventListener("keydown",(e)=>{
  if (e.key !== "Escape") return;
  [platformerModal, battleModal].forEach(m=>m.classList.remove("show"));
  stopPlatformer();
  battleStop();
});

/* ===== MUSIC (Phase 2 = more intense) ===== */
const muteBtn = document.getElementById("muteBtn");
const volEl = document.getElementById("vol");
const audioStatus = document.getElementById("audioStatus");
const startMusicBtn = document.getElementById("startMusicBtn");

let audio = {
  ctx: null,
  master: null,
  started: false,
  muted: false,
  volume: 0.45,
  ambient: {},
  battle: {},
  mode: "ambient",
  battleIntensity: 1, // 1 or 2
};

function mtof(m){ return 440 * Math.pow(2, (m-69)/12); }

function createNoise(ctx, type="highpass", freq=700){
  const bufferSize = 2 * ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) output[i] = (Math.random()*2-1) * 0.35;

  const src = ctx.createBufferSource();
  src.buffer = noiseBuffer;
  src.loop = true;

  const filter = ctx.createBiquadFilter();
  filter.type = type;
  filter.frequency.value = freq;

  const gain = ctx.createGain();
  gain.gain.value = 0.0;

  src.connect(filter).connect(gain);
  return { src, gain };
}

function setupAmbient(){
  const ctx = audio.ctx;
  const layer = audio.ambient;

  layer.gain = ctx.createGain();
  layer.gain.gain.value = 1.0;
  layer.gain.connect(audio.master);

  layer.osc1 = ctx.createOscillator();
  layer.osc1.type = "square";
  layer.g1 = ctx.createGain(); layer.g1.gain.value = 0.0;
  layer.osc1.connect(layer.g1).connect(layer.gain);

  layer.osc2 = ctx.createOscillator();
  layer.osc2.type = "triangle";
  layer.g2 = ctx.createGain(); layer.g2.gain.value = 0.0;
  layer.osc2.connect(layer.g2).connect(layer.gain);

  layer.bass = ctx.createOscillator();
  layer.bass.type = "sawtooth";
  layer.gb = ctx.createGain(); layer.gb.gain.value = 0.0;
  const lp = ctx.createBiquadFilter(); lp.type = "lowpass"; lp.frequency.value = 240;
  layer.bass.connect(lp).connect(layer.gb).connect(layer.gain);

  layer.noise = createNoise(ctx, "highpass", 700);
  layer.noise.gain.connect(layer.gain);

  layer.osc1.start(); layer.osc2.start(); layer.bass.start(); layer.noise.src.start();

  layer.step = 0;
  layer.bpm = 118;

  const root = 60;
  const leadSteps = [0,2,5,7,5,2,0,2, 0,2,3,5,7,5,3,2];
  const harmSteps = [0,0,2,2,5,5,2,2, 0,0,2,2,5,5,3,3];
  const bassSteps = [0,0,5,5, 3,3,7,7, 0,0,5,5, 3,3,2,2];

  layer.tick = (stepDur)=>{
    const now = ctx.currentTime;
    const i = layer.step % 16;

    const leadMidi = root + leadSteps[i];
    const harmMidi = root - 12 + harmSteps[i];
    const bassMidi = root - 24 + bassSteps[i];

    layer.osc1.frequency.setValueAtTime(mtof(leadMidi), now);
    layer.osc2.frequency.setValueAtTime(mtof(harmMidi), now);
    layer.bass.frequency.setValueAtTime(mtof(bassMidi), now);

    // lead
    layer.g1.gain.cancelScheduledValues(now);
    layer.g1.gain.setValueAtTime(0, now);
    layer.g1.gain.linearRampToValueAtTime(0.11, now + 0.01);
    layer.g1.gain.linearRampToValueAtTime(0, now + stepDur * 0.88);

    // harm
    layer.g2.gain.cancelScheduledValues(now);
    layer.g2.gain.setValueAtTime(0, now);
    layer.g2.gain.linearRampToValueAtTime(0.06, now + 0.02);
    layer.g2.gain.linearRampToValueAtTime(0, now + stepDur * 0.92);

    // bass
    const bassHit = (i % 2 === 0);
    layer.gb.gain.cancelScheduledValues(now);
    layer.gb.gain.setValueAtTime(0, now);
    layer.gb.gain.linearRampToValueAtTime(bassHit ? 0.10 : 0.04, now + 0.01);
    layer.gb.gain.linearRampToValueAtTime(0, now + stepDur * 0.95);

    // noise kick/snare
    const kick = (i % 4 === 0);
    const snare = (i % 4 === 2);
    const n = layer.noise.gain.gain;
    n.cancelScheduledValues(now);
    n.setValueAtTime(0, now);
    if (kick){
      n.linearRampToValueAtTime(0.06, now + 0.01);
      n.linearRampToValueAtTime(0, now + 0.08);
    } else if (snare){
      n.linearRampToValueAtTime(0.08, now + 0.01);
      n.linearRampToValueAtTime(0, now + 0.12);
    }

    layer.step++;
  };

  layer.setBpm = (bpm)=>{
    layer.bpm = bpm;
    if (layer.timer) clearInterval(layer.timer);
    const stepDur = 60 / bpm / 2;
    layer.timer = setInterval(()=>layer.tick(stepDur), stepDur*1000);
  };

  layer.setBpm(layer.bpm);
}

function setupBattle(){
  const ctx = audio.ctx;
  const layer = audio.battle;

  layer.gain = ctx.createGain();
  layer.gain.gain.value = 0.0; // start muted (we crossfade)
  layer.gain.connect(audio.master);

  // main voices
  layer.osc1 = ctx.createOscillator();
  layer.osc1.type = "square";
  layer.g1 = ctx.createGain(); layer.g1.gain.value = 0.0;
  layer.osc1.connect(layer.g1).connect(layer.gain);

  layer.osc2 = ctx.createOscillator();
  layer.osc2.type = "triangle";
  layer.g2 = ctx.createGain(); layer.g2.gain.value = 0.0;
  layer.osc2.connect(layer.g2).connect(layer.gain);

  layer.bass = ctx.createOscillator();
  layer.bass.type = "sawtooth";
  layer.gb = ctx.createGain(); layer.gb.gain.value = 0.0;
  const lp = ctx.createBiquadFilter(); lp.type = "lowpass"; lp.frequency.value = 220;
  layer.bass.connect(lp).connect(layer.gb).connect(layer.gain);

  // drums (noise)
  layer.noise = createNoise(ctx, "highpass", 700);
  layer.noise.gain.connect(layer.gain);

  // EXTRA LAYERS for phase 2
  layer.arp = ctx.createOscillator();
  layer.arp.type = "square";
  layer.garp = ctx.createGain(); layer.garp.gain.value = 0.0; // off until phase 2
  layer.arp.connect(layer.garp).connect(layer.gain);

  layer.hats = createNoise(ctx, "highpass", 4500);
  layer.hats.gain.connect(layer.gain);

  layer.osc1.start(); layer.osc2.start(); layer.bass.start();
  layer.noise.src.start(); layer.arp.start(); layer.hats.src.start();

  layer.step = 0;
  layer.bpm = 156; // phase 1
  const root = 57;

  const leadSteps = [0,3,5,7,8,7,5,3, 0,3,5,10,8,7,5,3];
  const harmSteps = [0,0,3,3,5,5,3,3, 0,0,3,3,7,7,5,5];
  const bassSteps = [0,0,0,0, 5,5,5,5, 3,3,3,3, 7,7,7,7];

  // arpeggio (only audible in phase 2)
  const arpSteps = [0,7,10,7, 0,7,12,10, 0,7,10,15, 12,10,7,0];

  layer.tick = (stepDur)=>{
    const now = ctx.currentTime;
    const i = layer.step % 16;

    // main notes
    layer.osc1.frequency.setValueAtTime(mtof(root + leadSteps[i]), now);
    layer.osc2.frequency.setValueAtTime(mtof(root - 12 + harmSteps[i]), now);
    layer.bass.frequency.setValueAtTime(mtof(root - 24 + bassSteps[i]), now);

    // lead envelope
    layer.g1.gain.cancelScheduledValues(now);
    layer.g1.gain.setValueAtTime(0, now);
    layer.g1.gain.linearRampToValueAtTime(0.12, now + 0.01);
    layer.g1.gain.linearRampToValueAtTime(0, now + stepDur * 0.86);

    // harmony
    layer.g2.gain.cancelScheduledValues(now);
    layer.g2.gain.setValueAtTime(0, now);
    layer.g2.gain.linearRampToValueAtTime(0.07, now + 0.02);
    layer.g2.gain.linearRampToValueAtTime(0, now + stepDur * 0.90);

    // bass
    const bassHit = (i % 2 === 0);
    layer.gb.gain.cancelScheduledValues(now);
    layer.gb.gain.setValueAtTime(0, now);
    layer.gb.gain.linearRampToValueAtTime(bassHit ? 0.12 : 0.06, now + 0.01);
    layer.gb.gain.linearRampToValueAtTime(0, now + stepDur * 0.95);

    // kick/snare
    const kick = (i % 4 === 0);
    const snare = (i % 4 === 2);
    const n = layer.noise.gain.gain;
    n.cancelScheduledValues(now);
    n.setValueAtTime(0, now);
    if (kick){
      n.linearRampToValueAtTime(0.08, now + 0.01);
      n.linearRampToValueAtTime(0, now + 0.08);
    } else if (snare){
      n.linearRampToValueAtTime(0.10, now + 0.01);
      n.linearRampToValueAtTime(0, now + 0.12);
    }

    // PHASE 2 extras (arp + hats)
    if (audio.battleIntensity >= 2){
      // arp note
      layer.arp.frequency.setValueAtTime(mtof(root + 12 + arpSteps[i]), now);
      layer.garp.gain.cancelScheduledValues(now);
      layer.garp.gain.setValueAtTime(0, now);
      layer.garp.gain.linearRampToValueAtTime(0.07, now + 0.006);
      layer.garp.gain.linearRampToValueAtTime(0, now + stepDur * 0.55);

      // hats on every 8th
      const hh = layer.hats.gain.gain;
      hh.cancelScheduledValues(now);
      hh.setValueAtTime(0, now);
      hh.linearRampToValueAtTime(0.06, now + 0.005);
      hh.linearRampToValueAtTime(0, now + 0.05);
    } else {
      // keep arp/hats quiet
      layer.garp.gain.setValueAtTime(0, now);
      layer.hats.gain.gain.setValueAtTime(0, now);
    }

    layer.step++;
  };

  layer.setBpm = (bpm)=>{
    layer.bpm = bpm;
    if (layer.timer) clearInterval(layer.timer);
    const stepDur = 60 / bpm / 2;
    layer.timer = setInterval(()=>layer.tick(stepDur), stepDur*1000);
  };

  layer.setBpm(layer.bpm);
}

function ensureMusicStarted(){
  if (audio.started) return;
  try{
    audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
    audio.master = audio.ctx.createGain();
    audio.master.gain.value = audio.volume;
    audio.master.connect(audio.ctx.destination);

    setupAmbient();
    setupBattle();

    audio.started = true;
    audioStatus.textContent = "playing";
    showToast("Music started ‚úÖ");
  } catch{
    audioStatus.textContent = "audio blocked";
    showToast("Audio couldn't start in this browser.");
  }
}
async function resumeAudio(){
  if (!audio.ctx) return;
  try{ await audio.ctx.resume(); } catch {}
}

function setMusicMode(mode){
  if (!audio.started) return;
  audio.mode = mode;
  const a = audio.ambient.gain.gain;
  const b = audio.battle.gain.gain;
  const now = audio.ctx.currentTime;
  a.cancelScheduledValues(now);
  b.cancelScheduledValues(now);
  if (mode === "battle"){
    a.setValueAtTime(a.value, now);
    a.linearRampToValueAtTime(0.0, now + 0.25);
    b.setValueAtTime(b.value, now);
    b.linearRampToValueAtTime(1.0, now + 0.25);
  } else {
    b.setValueAtTime(b.value, now);
    b.linearRampToValueAtTime(0.0, now + 0.25);
    a.setValueAtTime(a.value, now);
    a.linearRampToValueAtTime(1.0, now + 0.25);
  }
}

function setBattleIntensity(level){
  if (!audio.started) return;
  const target = level >= 2 ? 2 : 1;
  if (audio.battleIntensity === target) return;
  audio.battleIntensity = target;

  // speed up + extra layers kick in
  if (target === 2){
    audio.battle.setBpm(176);
    showToast("üî• Phase 2 music!");
  } else {
    audio.battle.setBpm(156);
  }
}

volEl.addEventListener("input", ()=>{
  audio.volume = parseFloat(volEl.value);
  if (audio.master) audio.master.gain.value = audio.muted ? 0 : audio.volume;
});
muteBtn.addEventListener("click", ()=>{
  audio.muted = !audio.muted;
  muteBtn.textContent = audio.muted ? "üîá" : "üîä";
  if (audio.master) audio.master.gain.value = audio.muted ? 0 : audio.volume;
});
startMusicBtn.addEventListener("click", async ()=>{
  ensureMusicStarted();
  await resumeAudio();
});
window.addEventListener("pointerdown", async ()=>{
  ensureMusicStarted();
  await resumeAudio();
  audioStatus.textContent = audio.started ? "playing" : "click anywhere to start";
}, { once: true });

/* ===== Battle (Phase 2 triggers intensity) ===== */
const battle = {
  running: false,
  raf: null,
  x: 480, y: 180, r: 8,
  hpMax: 20, hp: 20,
  tp: 0,
  bossHp: 100,
  mercy: 0,
  phase: 1,
  bullets: [],
  keys: {},
  invuln: 0,
  lastSpawn: 0,
  spawnRate: 420,
  text: "..."
};

const bHp = document.getElementById("bHp");
const bHpMax = document.getElementById("bHpMax");
const bHpBar = document.getElementById("bHpBar");
const bTp = document.getElementById("bTp");
const bTpBar = document.getElementById("bTpBar");
const bBossHp = document.getElementById("bBossHp");
const bBossHpBar = document.getElementById("bBossHpBar");
const bMercy = document.getElementById("bMercy");
const bMercyBar = document.getElementById("bMercyBar");
const bText = document.getElementById("bText");

const battleCanvas = document.getElementById("battleCanvas");
const bctx = battleCanvas.getContext("2d");

function battleSync(){
  bHp.textContent = String(battle.hp);
  bHpMax.textContent = String(battle.hpMax);
  bHpBar.style.width = (battle.hp / battle.hpMax * 100) + "%";
  bTp.textContent = String(Math.round(battle.tp));
  bTpBar.style.width = Math.max(0, Math.min(100, battle.tp)) + "%";
  bBossHp.textContent = String(Math.round(battle.bossHp));
  bBossHpBar.style.width = Math.max(0, battle.bossHp) + "%";
  bMercy.textContent = String(Math.round(battle.mercy));
  bMercyBar.style.width = Math.max(0, Math.min(100, battle.mercy)) + "%";
  bText.textContent = battle.text;
}

function battleReset(){
  battle.x = 480; battle.y = 180;
  battle.hpMax = 20; battle.hp = 20;
  battle.tp = 0;
  battle.bossHp = 100;
  battle.mercy = 0;
  battle.phase = 1;
  setBattleIntensity(1);
  battle.bullets = [];
  battle.invuln = 0;
  battle.lastSpawn = performance.now();
  battle.spawnRate = 420;
  battle.text = "A wild NO appears‚Ä¶";
  battleSync();
}

function battleStart(){
  ensureMusicStarted();
  resumeAudio();
  setMusicMode("battle");
  document.body.classList.add("boss-mode");

  if (battle.running) return;
  battle.running = true;
  bossStatus.textContent = "Battle";
  battleReset();
  battle.raf = requestAnimationFrame(battleLoop);
  showToast("Battle started ‚öîÔ∏è");
}

function battleStop(){
  if (!battle.running) return;
  battle.running = false;
  if (battle.raf) cancelAnimationFrame(battle.raf);
  battle.raf = null;
  document.body.classList.remove("boss-mode");
  setMusicMode("ambient");
  bossStatus.textContent = "Dormant";
  setBattleIntensity(1);
}

function battleWin(msg){
  battle.text = msg || "You win!";
  battleSync();
  confetti({ particleCount: 220, spread: 95, origin: { y: 0.55 } });
  showToast("Victory! üèÜ");
  battleStop();
  closeModal(battleModal);
}

function battleLose(){
  battle.text = "You got hit‚Ä¶ try again!";
  battleSync();
  shake(mainCard);
  showToast("Defeated üò≠");
  battleStop();
  closeModal(battleModal);
}

function spawnBulletPattern(now){
  const prevPhase = battle.phase;
  battle.phase = (battle.bossHp <= 50) ? 2 : 1;

  if (battle.phase !== prevPhase){
    battle.text = "Phase " + battle.phase + "!";
    battle.spawnRate = battle.phase === 2 ? 300 : 420;
    showToast("Phase " + battle.phase + "!!");
    freezeFlash(mainCard);

    // üî• PHASE 2 = more intense music
    setBattleIntensity(battle.phase);
  }

  const w = battleCanvas.width, h = battleCanvas.height;
  const count = battle.phase === 2 ? 6 : 4;

  for (let i=0;i<count;i++){
    const side = Math.floor(Math.random()*4);
    let x,y,vx,vy;
    const speed = (battle.phase === 2 ? 2.6 : 2.0) + Math.random()*0.6;

    if (side === 0){ x = -10; y = Math.random()*h; vx = speed; vy = (Math.random()*2-1)*1.1; }
    if (side === 1){ x = w+10; y = Math.random()*h; vx = -speed; vy = (Math.random()*2-1)*1.1; }
    if (side === 2){ x = Math.random()*w; y = -10; vx = (Math.random()*2-1)*1.1; vy = speed; }
    if (side === 3){ x = Math.random()*w; y = h+10; vx = (Math.random()*2-1)*1.1; vy = -speed; }

    if (Math.random() < (battle.phase === 2 ? 0.45 : 0.25)){
      const dx = battle.x - x;
      const dy = battle.y - y;
      const mag = Math.hypot(dx,dy) || 1;
      vx = (dx/mag) * speed;
      vy = (dy/mag) * speed;
    }

    battle.bullets.push({x,y,vx,vy,r: 6 + Math.random()*4});
  }

  if (Math.random() < 0.18){
    const cx = w*(0.25 + Math.random()*0.5);
    const cy = h*(0.25 + Math.random()*0.5);
    const rings = battle.phase === 2 ? 10 : 8;
    for (let k=0;k<rings;k++){
      const ang = (Math.PI*2) * (k/rings);
      battle.bullets.push({x:cx,y:cy,vx:Math.cos(ang)*2.2,vy:Math.sin(ang)*2.2,r:5});
    }
  }
}

function battleLoop(now){
  if (!battle.running) return;

  const w = battleCanvas.width, h = battleCanvas.height;

  // input
  const speed = 2.7;
  let ax = 0, ay = 0;
  if (battle.keys["ArrowLeft"]) ax -= 1;
  if (battle.keys["ArrowRight"]) ax += 1;
  if (battle.keys["ArrowUp"]) ay -= 1;
  if (battle.keys["ArrowDown"]) ay += 1;

  const norm = Math.hypot(ax,ay) || 1;
  ax = (ax/norm) * speed;
  ay = (ay/norm) * speed;

  battle.x += ax;
  battle.y += ay;

  battle.x = Math.max(battle.r+8, Math.min(w - battle.r-8, battle.x));
  battle.y = Math.max(battle.r+8, Math.min(h - battle.r-8, battle.y));

  if (now - battle.lastSpawn > battle.spawnRate){
    spawnBulletPattern(now);
    battle.lastSpawn = now;
  }

  for (const b of battle.bullets){
    b.x += b.vx;
    b.y += b.vy;
  }
  battle.bullets = battle.bullets.filter(b => b.x > -60 && b.x < w+60 && b.y > -60 && b.y < h+60);

  if (battle.invuln > 0) battle.invuln--;
  let hit = false;
  if (battle.invuln <= 0){
    for (const b of battle.bullets){
      const dx = b.x - battle.x;
      const dy = b.y - battle.y;
      const rr = (b.r + battle.r);
      if (dx*dx + dy*dy < rr*rr){ hit = true; break; }
    }
  }

  battle.tp = Math.min(100, battle.tp + 0.12);

  if (hit){
    battle.hp -= 2;
    battle.invuln = 24;
    shake(mainCard);
    freezeFlash(mainCard);
    battle.text = "Ouch!";
    if (battle.hp <= 0){
      battle.hp = 0;
      battleSync();
      return battleLose();
    }
  }

  // draw
  bctx.clearRect(0,0,w,h);

  bctx.save();
  bctx.globalAlpha = 0.85;
  bctx.strokeStyle = document.body.classList.contains("night") ? "rgba(255,255,255,0.30)" : "rgba(15,23,42,0.18)";
  bctx.lineWidth = 6;
  bctx.strokeRect(10,10,w-20,h-20);
  bctx.restore();

  for (const b of battle.bullets){
    bctx.save();
    bctx.globalAlpha = 0.95;
    bctx.fillStyle = document.body.classList.contains("night") ? "rgba(255,255,255,0.62)" : "rgba(15,23,42,0.55)";
    bctx.beginPath();
    bctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    bctx.fill();
    bctx.restore();
  }

  const pulse = (battle.invuln > 0 && Math.floor(battle.invuln/4)%2===0) ? 0.35 : 1.0;
  bctx.save();
  bctx.globalAlpha = pulse;
  bctx.fillStyle = "rgba(239,68,68,0.92)";
  const x = battle.x, y = battle.y;
  bctx.beginPath();
  bctx.moveTo(x, y + 6);
  bctx.bezierCurveTo(x - 10, y - 4, x - 6, y - 16, x, y - 8);
  bctx.bezierCurveTo(x + 6, y - 16, x + 10, y - 4, x, y + 6);
  bctx.fill();
  bctx.restore();

  battleSync();
  battle.raf = requestAnimationFrame(battleLoop);
}

window.addEventListener("keydown",(e)=>{ battle.keys[e.key] = true; });
window.addEventListener("keyup",(e)=>{ battle.keys[e.key] = false; });

document.getElementById("btnFight").addEventListener("click", ()=>{
  ensureMusicStarted(); resumeAudio();
  if (!battle.running) return;

  const spend = Math.min(60, battle.tp);
  const dmg = 7 + Math.floor(spend/20);
  battle.tp -= spend;

  battle.bossHp -= dmg;
  battle.text = `You FIGHT! (-${dmg} courage)`;
  freezeFlash(mainCard);
  confetti({ particleCount: 40, spread: 80, origin: { y: 0.65 } });

  if (battle.bossHp <= 0){
    battle.bossHp = 0;
    battleWin("NO has been defeated‚Ä¶ now press YES üòå");
    noBtn.style.display = "none";
    hint.textContent = "NO is gone. Now press YES like a champion üèÜ";
    state.coins += 20;
    syncHUD();
    return;
  }

  battleSync();
});

document.getElementById("btnAct").addEventListener("click", ()=>{
  ensureMusicStarted(); resumeAudio();
  if (!battle.running) return;

  const acts = [
    {t:"Compliment", m:18},
    {t:"Offer Snacks", m:22},
    {t:"Sing Badly", m:16},
    {t:"Confess", m:26},
    {t:"Tell Joke", m:14},
  ];
  const pick = acts[Math.floor(Math.random()*acts.length)];
  battle.mercy = Math.min(100, battle.mercy + pick.m);
  battle.text = `ACT: ${pick.t} (+${pick.m}% MERCY)`;
  showToast("ACT used ‚ú®");
  battleSync();
});

document.getElementById("btnItem").addEventListener("click", ()=>{
  ensureMusicStarted(); resumeAudio();
  if (!battle.running) return;

  const canHeal = battle.hp < battle.hpMax;
  if (canHeal){
    battle.hp = Math.min(battle.hpMax, battle.hp + 6);
    battle.text = "ITEM: Heart Candy (HP +6)";
  } else {
    battle.tp = Math.min(100, battle.tp + 30);
    battle.text = "ITEM: Spark Soda (TP +30)";
  }
  battleSync();
});

document.getElementById("btnMercy").addEventListener("click", ()=>{
  ensureMusicStarted(); resumeAudio();
  if (!battle.running) return;

  if (battle.mercy >= 100){
    battleWin("You SPARE the NO. Peace achieved ‚ú®");
    noBtn.style.display = "none";
    hint.textContent = "You spared NO. Now press YES üòå";
    state.coins += 15;
    syncHUD();
  } else {
    battle.text = `MERCY is only ${Math.round(battle.mercy)}%. Use ACT more!`;
    battleSync();
  }
});

/* ===== Platformer (kept minimal; same as before) ===== */
const platCanvas = document.getElementById("platformCanvas");
const pctx = platCanvas.getContext("2d");
const deathCountEl = document.getElementById("deathCount");
const berryCarryEl = document.getElementById("berryCarry");
const silkPctEl = document.getElementById("silkPct");

let plat = { running:false, raf:null, keys:{}, deaths:0, berryCarry:0, silk:0 };

function startPlatformer(){
  if (plat.running) return;
  plat.running = true;
  plat.deaths = 0;
  plat.berryCarry = 0;
  plat.silk = 0;
  deathCountEl.textContent = "0";
  berryCarryEl.textContent = "0";
  silkPctEl.textContent = "0%";
  drawPlat();
}
function stopPlatformer(){
  plat.running = false;
  if (plat.raf) cancelAnimationFrame(plat.raf);
  plat.raf = null;
}
function drawPlat(){
  const w = platCanvas.width, h = platCanvas.height;
  pctx.clearRect(0,0,w,h);
  pctx.fillStyle = "rgba(255,255,255,0.14)";
  pctx.fillRect(0,0,w,h);
  pctx.font = "28px ui-monospace, monospace";
  pctx.fillText("Celeste-ish room here (kept from your last version)", 70, 120);
}

/* ===== Music UI ===== */
syncHUD();
startMusicBtn.addEventListener("click", ()=>{
  ensureMusicStarted();
  resumeAudio();
  audioStatus.textContent = "playing";
});
</script>
</body>
</html>
