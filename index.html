<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine‚Äôs Day 2026 ‚Äî Sarah Stets</title>

  <!-- Tailwind + Confetti -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* =========================================================
       0) Base + Background
    ========================================================= */
    :root{
      --glass: rgba(255,255,255,0.78);
      --glass-border: rgba(255,255,255,0.60);
      --shadow: 0 22px 70px rgba(0,0,0,0.14);
    }

    body{
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
        linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
    }

    body.shiny-mode{
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(167, 139, 250, 0.50), transparent 60%),
        radial-gradient(900px 520px at 80% 25%, rgba(34, 211, 238, 0.22), transparent 60%),
        radial-gradient(900px 520px at 55% 85%, rgba(250, 204, 21, 0.24), transparent 60%),
        linear-gradient(180deg, #f5f3ff 0%, #e0f2fe 50%, #fff7ed 100%);
    }

    /* Boss tint */
    body.boss-mode::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
        linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
      opacity:0.85;
      mix-blend-mode:multiply;
    }

    /* Background layers */
    #bg{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      overflow:hidden;
    }
    .blob{
      position:absolute;
      width:520px;
      height:520px;
      border-radius:999px;
      filter: blur(55px);
      opacity:0.55;
      mix-blend-mode:multiply;
      will-change:transform;
      transform: translate3d(0,0,0);
    }
    .blob.a{
      left:-140px;
      top:-160px;
      background: radial-gradient(circle at 30% 30%, rgba(244,63,94,0.55), rgba(255,182,193,0.25) 55%, transparent 70%);
      animation: floatA 14s ease-in-out infinite;
    }
    .blob.b{
      right:-160px;
      top:-120px;
      background: radial-gradient(circle at 30% 30%, rgba(236,72,153,0.45), rgba(147,197,253,0.22) 55%, transparent 70%);
      animation: floatB 16s ease-in-out infinite;
    }
    .blob.c{
      left:10%;
      bottom:-210px;
      background: radial-gradient(circle at 30% 30%, rgba(147,197,253,0.45), rgba(244,63,94,0.18) 55%, transparent 70%);
      animation: floatC 18s ease-in-out infinite;
    }
    @keyframes floatA { 0%,100% { transform: translate(0,0) scale(1);} 50% { transform: translate(80px,60px) scale(1.08);} }
    @keyframes floatB { 0%,100% { transform: translate(0,0) scale(1);} 50% { transform: translate(-90px,70px) scale(1.06);} }
    @keyframes floatC { 0%,100% { transform: translate(0,0) scale(1);} 50% { transform: translate(120px,-60px) scale(1.1);} }

    body.boss-mode .blob.a{ animation-duration: 9s; }
    body.boss-mode .blob.b{ animation-duration: 10s; }
    body.boss-mode .blob.c{ animation-duration: 11s; }

    .noise{
      position:absolute;
      inset:0;
      opacity:0.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size:180px 180px;
    }
    .pixel-grid{
      position:absolute;
      inset:0;
      opacity:.14;
      mix-blend-mode:overlay;
      filter:saturate(.95) contrast(1.05);
      background-image:
        linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px);
      background-size: 42px 42px;
    }

    /* =========================================================
       0.5) Floating emoji layers (hearts / powerups / pixel clouds)
    ========================================================= */
    #hearts, #powerups, #pixelClouds{
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    #hearts{ z-index: 7; }
    #powerups{ z-index: 6; }
    #pixelClouds{ z-index: 5; }

    .heart, .powerup{
      position:absolute;
      bottom:-12vh;
      will-change: transform, opacity;
      animation-name: floatUp;
      animation-timing-function: linear;
      animation-iteration-count: 1;
      transform: translate3d(calc(var(--drift, 0px)), 0, 0);
      filter:
        drop-shadow(0 10px 22px rgba(0,0,0,.18))
        drop-shadow(0 0 22px rgba(255, 140, 210, .18));
    }
    .powerup{
      filter:
        drop-shadow(0 10px 22px rgba(0,0,0,.14))
        drop-shadow(0 0 18px rgba(120, 200, 255, .16));
    }
    @keyframes floatUp{
      from{ transform: translate3d(calc(var(--drift, 0px)), 0, 0) rotate(0deg); opacity: 0; }
      10%{ opacity: 1; }
      to{ transform: translate3d(calc(var(--drift, 0px)), -120vh, 0) rotate(var(--rot, 0deg)); opacity: 0; }
    }

    .pixel-cloud{
      position:absolute;
      left:-30vw;
      top: var(--top, 20vh);
      width: 180px;
      height: 90px;
      opacity: .60;
      transform: scale(var(--s, 1));
      background-repeat:no-repeat;
      background-size: contain;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.12));
      animation: cloudDrift linear 1 forwards;
    }
    @keyframes cloudDrift{
      from{ transform: translate3d(-30vw, 0, 0) scale(var(--s, 1)); opacity: 0; }
      8%{ opacity: .65; }
      to{ transform: translate3d(160vw, 0, 0) scale(var(--s, 1)); opacity: 0; }
    }

    /* =========================================================
       1) SPACE SCENE (Galaxy clouds + stars + planets + Kirby)
       Fixes:
       - actually renders (HTML added)
       - correct z-index layering
       - nebula clouds visible (screen blend) and animated
       - Kirby placed behind floating hearts but above nebula
    ========================================================= */
    #spaceScene{
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      overflow: hidden;
      background:
        radial-gradient(1200px 800px at 30% 35%, rgba(120, 80, 255, .18), transparent 60%),
        radial-gradient(900px 700px at 70% 70%, rgba(255, 90, 190, .14), transparent 58%),
        radial-gradient(1100px 900px at 60% 20%, rgba(40, 210, 255, .10), transparent 55%),
        radial-gradient(1400px 1000px at 40% 90%, rgba(30, 20, 60, 1), rgba(5, 5, 18, 1) 60%);
      filter: saturate(1.10) contrast(1.06);
      transform: translateZ(0);
    }

    #spaceScene .stars{
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.85) 50%, transparent 52%),
        radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,.75) 50%, transparent 52%),
        radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,.8) 50%, transparent 52%),
        radial-gradient(1px 1px at 85% 75%, rgba(255,255,255,.7) 50%, transparent 52%),
        radial-gradient(1px 1px at 55% 80%, rgba(255,255,255,.65) 50%, transparent 52%),
        radial-gradient(1px 1px at 15% 85%, rgba(255,255,255,.8) 50%, transparent 52%),
        radial-gradient(1px 1px at 92% 22%, rgba(255,255,255,.75) 50%, transparent 52%);
      background-size: 240px 240px;
      opacity:.60;
      filter: blur(.2px) drop-shadow(0 0 8px rgba(120,200,255,.10));
      animation: starDrift 80s linear infinite;
    }
    @keyframes starDrift{
      from{ transform: translate3d(0,0,0) scale(1.05); }
      to{ transform: translate3d(-6%, 4%, 0) scale(1.05); }
    }
    
.moon{
  position:absolute;
  width: 46vmin;
  height: 46vmin;
  left: 6vmin;
  top: 8vmin;
  border-radius: 50%;
  z-index: 2;
  opacity: .98;
  transform: translate3d(0,0,0);
  animation: floatParallax 10s ease-in-out infinite;
  overflow: hidden; /* so texture stays perfectly circular */

  /* Base lighting (keeps it ‚Äú3D‚Äù) */
  background:
    radial-gradient(circle at 30% 25%,
      rgba(255,255,255,0.95) 0%,
      rgba(240,240,255,0.65) 22%,
      rgba(255,255,255,0.08) 45%,
      transparent 60%
    ),
    radial-gradient(circle at 70% 75%,
      rgba(0,0,0,0.0) 35%,
      rgba(0,0,0,0.25) 70%,
      rgba(0,0,0,0.55) 100%
    );

  box-shadow:
    inset 10px 12px 26px rgba(255,255,255,0.12),
    inset -28px -32px 70px rgba(0,0,0,0.45);

  filter:
    drop-shadow(0 28px 60px rgba(0,0,0,.34))
    drop-shadow(0 0 90px rgba(160, 120, 255, .28));
}

/* ‚úÖ CRATER DETAIL LAYER (this is where the vivid craters come from) */
.moon::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;

  background-image: url("moon-texture.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  /* Make craters POP */
  filter:
    saturate(1.35)
    contrast(1.35)
    brightness(1.05)
    sharpen(0); /* harmless placeholder; ignored by browsers */

  /* Blend with lighting nicely */
  mix-blend-mode: overlay;
  opacity: 0.92;
}

/* ‚úÖ Extra punch: crater ‚Äúmicro-contrast‚Äù + rim glow */
.moon::after{
  content:"";
  position:absolute;
  inset:-2%;
  border-radius:50%;
  pointer-events:none;

  background:
    /* crisp rim glow */
    radial-gradient(circle at 30% 25%,
      rgba(255,255,255,0.65),
      rgba(255,255,255,0.12) 45%,
      transparent 70%
    ),
    /* subtle crater depth boost */
    radial-gradient(circle at 55% 55%,
      rgba(0,0,0,0.10),
      transparent 55%
    );

  mix-blend-mode: screen;
  opacity: 0.65;

  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,0.10),
    inset 0 0 40px rgba(255,255,255,0.06);
}


    /* ‚Äúnebula sheen‚Äù around edges */
    radial-gradient(circle at 65% 35%,
      rgba(34,211,238,0.10),
      transparent 55%
    ),
    radial-gradient(circle at 40% 80%,
      rgba(167,139,250,0.14),
      transparent 58%
    ),

    /* micro-texture (SVG noise) */
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");

  background-size: auto, auto, auto, 220px 220px;
  background-position: center, center, center, center;
  mix-blend-mode: overlay;
  opacity: 0.45;

  /* glossy edge */
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,0.10),
    inset 0 0 40px rgba(255,255,255,0.06);
}

/* Subtle terminator line + extra depth */
.moon::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;

  background:
    radial-gradient(circle at 75% 70%,
      rgba(0,0,0,0.0) 35%,
      rgba(0,0,0,0.25) 65%,
      rgba(0,0,0,0.45) 100%
    );

  mix-blend-mode: multiply;
  opacity: 0.55;
}


    .planet{
      position:absolute;
      border-radius: 50%;
      transform: translate3d(0,0,0);
      filter: drop-shadow(0 20px 36px rgba(0,0,0,.28)) drop-shadow(0 0 40px rgba(120,180,255,.14));
      opacity:.95;
      z-index: 2;
      animation: floatParallax 12s ease-in-out infinite;
    }
    .planet-star{
      width: 22vmin;
      height: 22vmin;
      left: 48vmin;
      top: 30vmin;
      background:
        radial-gradient(circle at 35% 30%, rgba(140,100,255,.95), rgba(80,40,160,.85) 55%, rgba(30, 20, 60,.95) 100%),
        radial-gradient(circle at 55% 65%, rgba(255,255,255,.20), transparent 55%),
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.22), transparent 55%);
      box-shadow: inset -18px -24px 40px rgba(0,0,0,.35);
      animation-duration: 14s;
    }
    .planet-star::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 50%;
      background:
        radial-gradient(10px 10px at 25% 35%, rgba(255,255,255,.95) 45%, transparent 55%),
        radial-gradient(12px 12px at 55% 55%, rgba(255,255,255,.92) 45%, transparent 55%),
        radial-gradient(9px 9px at 72% 38%, rgba(255,255,255,.88) 45%, transparent 55%),
        radial-gradient(11px 11px at 40% 75%, rgba(255,255,255,.90) 45%, transparent 55%);
      opacity:.8;
      mix-blend-mode: screen;
      filter: blur(.2px);
    }
    .planet-star::before{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius:50%;
      background: radial-gradient(circle, rgba(255,255,255,.22), transparent 60%);
      filter: blur(1.2px);
      opacity:.8;
    }

    .planet-ring{
      width: 16vmin;
      height: 16vmin;
      right: 10vmin;
      top: 12vmin;
      background:
        radial-gradient(circle at 30% 25%, rgba(120,220,255,.95), rgba(60,120,200,.82) 55%, rgba(25, 35, 70,.95) 100%);
      box-shadow: inset -12px -18px 30px rgba(0,0,0,.35);
      animation-duration: 12s;
    }
    .planet-ring::after{
      content:"";
      position:absolute;
      left: -25%;
      top: 40%;
      width: 150%;
      height: 45%;
      border-radius: 50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,.24), rgba(255,255,255,.10) 55%, transparent 72%),
        radial-gradient(closest-side, rgba(120,180,255,.22), transparent 70%);
      transform: rotate(-18deg);
      filter: blur(.3px);
      opacity:.9;
    }

    @keyframes floatParallax{
      0%,100%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(0,-8px,0); }
    }

    /* Nebula clouds container */
    #nebula{
      position:absolute;
      inset:-10%;
      z-index: 1;
      pointer-events:none;
      opacity: 0.95;
    }
    .nebula-cloud{
      position:absolute;
      width: clamp(360px, 55vmin, 900px);
      height: clamp(240px, 40vmin, 650px);
      border-radius: 45%;
      opacity: .62;
      transform: translate3d(0,0,0) scale(var(--s,1));
      will-change: transform, opacity;
      mix-blend-mode: screen;
      filter: blur(18px) saturate(1.25) contrast(1.15);
      background:
        radial-gradient(closest-side at 30% 35%, rgba(150,110,255,.55), transparent 65%),
        radial-gradient(closest-side at 55% 55%, rgba(255,120,200,.35), transparent 68%),
        radial-gradient(closest-side at 70% 35%, rgba(80,220,255,.25), transparent 70%),
        radial-gradient(closest-side at 40% 75%, rgba(50, 40, 120,.35), transparent 72%);
      animation: nebulaDrift var(--dur, 18s) ease-in-out infinite alternate;
    }
    .nebula-cloud::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius: inherit;
      background: radial-gradient(closest-side, rgba(0,0,0,.18), transparent 70%);
      opacity:.55;
      mix-blend-mode: multiply;
      filter: blur(22px);
    }
    @keyframes nebulaDrift{
      from { transform: translate3d(-8%, 0, 0) scale(var(--s,1)); }
      to   { transform: translate3d(8%, -4%, 0) scale(var(--s,1)); }
    }

    /* Kirby floating (behind hearts/powerups/clouds, above nebula/space) */
    #kirby{
      position:absolute;
      width: clamp(76px, 12vmin, 160px);
      left: 46%;
      top: 62%;
      transform: translate3d(-50%,-50%,0);
      z-index: 4;
      opacity: .97;
      filter:
        drop-shadow(0 18px 30px rgba(0,0,0,.25))
        drop-shadow(0 0 34px rgba(255,150,210,.18));
      animation: kirbyFloat 9s ease-in-out infinite;
    }
    @keyframes kirbyFloat{
      0%,100%{ transform: translate3d(-50%,-50%,0) rotate(-2deg); }
      50%{ transform: translate3d(-48%,-56%,0) rotate(2deg); }
    }

    /* =========================================================
       2) Glass + Title + Mana
    ========================================================= */
    .glass{
      background: var(--glass);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }

    #bigTitle{
      text-align:center;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 0.95;
      font-size: clamp(2.0rem, 5vw, 3.8rem);
      color:#fff;
      text-shadow: 0 4px 0 rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.22);
      margin-bottom: 0.9rem;
      position:relative;
      z-index:3;
    }
    #bigTitle span{
      display:inline-block;
      padding: .18em .42em;
      border-radius:999px;
      background: rgba(244,63,94,0.20);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.35);
    }

    #manaWrap{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #manaBarInner{
      width:0%;
      transition: width 160ms ease;
    }

    /* =========================================================
       3) Buttons (Heart SVG buttons)
    ========================================================= */
    .svg-heart{
      width: 62px;
      height: 56px;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      position: relative;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      will-change: transform;
    }
    .svg-heart svg{ width:100%; height:100%; display:block; }
    .svg-heart.yes path{ fill: #ef4444; }
    .svg-heart.no  path{ fill: #f43f5e; }
    .svg-heart span{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: translateY(-3px);
      color:#fff;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: .7px;
      text-shadow: 0 1px 2px rgba(0,0,0,.25);
      user-select:none;
      pointer-events:none;
    }
    .svg-heart:hover{ transform: scale(1.06); filter: drop-shadow(0 12px 18px rgba(0,0,0,.18)); }
    .svg-heart:active{ transform: scale(.96); }

    #heartButtons{
      position: relative;
      height: 118px;
      border-radius: 22px;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(255,255,255,.62);
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 24px;
    }
    .svg-heart.no.runaway{
      position:absolute;
      left:0; top:0;
      z-index: 20;
      --nx: 0px;
      --ny: 0px;
      --nscale: 1;
      transform: translate(var(--nx), var(--ny)) scale(var(--nscale));
      transition: transform 120ms ease, filter 120ms ease, opacity 120ms ease;
    }
    .svg-heart.no.runaway.is-running{ transition: transform 60ms linear; }

    .mascot-bounce{ animation: mascotBounce 1.8s ease-in-out infinite; }
    @keyframes mascotBounce { 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(-6px);} }

    #blackholeGif{
      position:absolute;
      left:50%;
      top:44%;
      transform: translate(-50%, -50%);
      width:170px;
      height:170px;
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,0.22));
      mix-blend-mode: screen;
    }

    /* Simple modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 60;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .modal.hidden{ display:none; }
    .modal .backdrop{
      position:absolute;
      inset:0;
      background: rgba(2,6,23,0.50);
      backdrop-filter: blur(6px);
    }
    .modal .panel{
      position:relative;
      width: min(980px, calc(100vw - 24px));
      max-height: min(82vh, 760px);
      overflow:auto;
      border-radius: 28px;
      padding: 18px;
      background: rgba(255,255,255,0.86);
      border: 1px solid rgba(255,255,255,0.62);
      box-shadow: 0 40px 90px rgba(2,6,23,0.25);
    }

    .hidden{ display:none !important; }

    /* Platformer crisp pixels + stable layout */
    #platCanvas { image-rendering: pixelated; touch-action: none; }

    /* Platformer overlay */
    .plat-wrap{
      position: relative;
      border-radius: 22px;
      overflow: hidden;
    }
    #platOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(255,255,255,0.62);
      backdrop-filter: blur(10px);
      transition: opacity 220ms ease;
      pointer-events: none;
    }
    #platStart{
      position:absolute;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: auto;
      transition: opacity 220ms ease;
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Background blobs + texture -->
  <div id="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
    <div class="blob c"></div>
    <div class="noise"></div>
    <div class="pixel-grid"></div>
  </div>

  <!-- SPACE SCENE (Galaxy Clouds / Planets / Kirby) -->
  <div id="spaceScene" aria-hidden="true">
    <div class="stars"></div>

    <div id="nebula">
      <div class="nebula-cloud" style="left:-6%; top:4%; --s:1.05; --dur:20s;"></div>
      <div class="nebula-cloud" style="left:38%; top:8%; --s:0.90; --dur:24s; opacity:.58;"></div>
      <div class="nebula-cloud" style="left:10%; top:52%; --s:1.12; --dur:22s; opacity:.60;"></div>
      <div class="nebula-cloud" style="left:58%; top:54%; --s:0.98; --dur:26s; opacity:.56;"></div>
    </div>

    <div class="moon"></div>
    <div class="planet planet-star"></div>
    <div class="planet planet-ring"></div>

    <!-- King D (simple SVG) -->
    <svg id="kirby" viewBox="0 0 200 200" aria-hidden="true">
      <!-- body -->
      <defs>
        <radialGradient id="kBody" cx="35%" cy="30%" r="70%">
          <stop offset="0" stop-color="#ffd1dc"/>
          <stop offset="0.55" stop-color="#ff94b8"/>
          <stop offset="1" stop-color="#ff5fa0"/>
        </radialGradient>
        <radialGradient id="kCheek" cx="50%" cy="50%" r="60%">
          <stop offset="0" stop-color="#ff6aa8" stop-opacity="0.9"/>
          <stop offset="1" stop-color="#ff6aa8" stop-opacity="0"/>
        </radialGradient>
      </defs>

      <ellipse cx="100" cy="105" rx="72" ry="62" fill="url(#kBody)"/>
      <!-- arms -->
      <ellipse cx="45" cy="112" rx="26" ry="22" fill="#ff82b1" opacity="0.95"/>
      <ellipse cx="155" cy="112" rx="26" ry="22" fill="#ff82b1" opacity="0.95"/>
      <!-- feet -->
      <ellipse cx="70" cy="160" rx="34" ry="24" fill="#ff2d6d" opacity="0.95"/>
      <ellipse cx="130" cy="160" rx="34" ry="24" fill="#ff2d6d" opacity="0.95"/>
      <!-- eyes -->
      <ellipse cx="82" cy="92" rx="10" ry="20" fill="#111827"/>
      <ellipse cx="118" cy="92" rx="10" ry="20" fill="#111827"/>
      <ellipse cx="79" cy="86" rx="3" ry="6" fill="#fff"/>
      <ellipse cx="115" cy="86" rx="3" ry="6" fill="#fff"/>
      <!-- mouth -->
      <path d="M100 110 C92 110 92 124 100 124 C108 124 108 110 100 110 Z" fill="#7c2d12" opacity="0.85"/>
      <!-- cheeks -->
      <ellipse cx="62" cy="112" rx="20" ry="14" fill="url(#kCheek)"/>
      <ellipse cx="138" cy="112" rx="20" ry="14" fill="url(#kCheek)"/>
      <!-- tiny star sparkle -->
      <path d="M165 50 l6 12 13 2 -10 9 2 13 -11-6 -11 6 2-13 -10-9 13-2z"
            fill="#fff" opacity="0.35"/>
    </svg>
  </div>

  <!-- Floating emoji layers -->
  <div id="powerups" aria-hidden="true"></div>
  <div id="pixelClouds" aria-hidden="true"></div>
  <div id="hearts" aria-hidden="true"></div>
 
  <!-- Title + Mana -->
  <header class="relative z-[3] px-4 pt-6">
    <div class="max-w-7xl mx-auto">
      <h1 id="bigTitle"><span>Love Beyond the Multiverse üíò</span></h1>

      <div id="manaWrap" class="glass rounded-2xl px-4 py-3 mb-4">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-extrabold text-slate-800/80">
            Affection Mana: <span id="manaPct">0</span>%
          </div>
          <div class="flex items-center gap-3">
            <button id="musicBtn" class="text-sm font-black text-slate-700/80 hover:text-slate-900 transition">
              üéµ Music: Off
            </button>
            <button id="shinyStar" class="text-sm font-black text-slate-700/80 hover:text-slate-900 transition" title="psst‚Ä¶ click me 3x">
              ‚≠ê Shiny Chance
            </button>
          </div>
        </div>
        <div class="mt-2 h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
          <div id="manaBarInner" class="h-full bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
        </div>
      </div>

      <div class="text-center text-white/90 font-extrabold tracking-wide drop-shadow-sm mb-5">
        Two universes. One question.
        <span class="block text-sm font-semibold text-white/80 mt-1">Defeat the boss to unlock YES + NO.</span>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <div class="relative z-[3] max-w-7xl mx-auto px-4 pb-12">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5 items-start">

      <!-- LEFT: Valentine card -->
      <aside class="lg:sticky lg:top-24">
        <div class="glass rounded-3xl p-6 text-center">
          <div class="mx-auto mb-3 w-28 mascot-bounce">
            <div class="w-24 h-24 mx-auto">
              <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
                <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
                <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
                <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
                <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
                <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
                <circle cx="50" cy="55" r="2" fill="#fff"/>
                <circle cx="74" cy="55" r="2" fill="#fff"/>
                <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
                <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                         C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                      fill="#ef4444"/>
                <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                      stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
              </svg>
            </div>
            <div class="mt-1 text-center font-extrabold text-sm tracking-wide text-slate-800/80">
              2/14/26
            </div>
          </div>

          <div class="font-black text-slate-800/80 mb-3">
            Will you be my Valentine, Andrew Getzow?
          </div>

          <img id="valImage"
               class="w-full h-64 object-cover rounded-xl mb-4"
               style="background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));"
               alt="Valentine gif" />

          <!-- Runaway arena -->
          <div id="heartButtons" class="mx-auto">
            <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
              <svg viewBox="0 0 64 58" aria-hidden="true">
                <path d="M32 54s-20-11.6-27-24C-1.2 18.4 6.2 6 18.3 6c6.1 0 10.2 3.1 13.7 7.4C35.5 9.1 39.6 6 45.7 6 57.8 6 65.2 18.4 59 30c-7 12.4-27 24-27 24z"/>
              </svg>
              <span>YES</span>
            </button>

            <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
              <svg viewBox="0 0 64 58" aria-hidden="true">
                <path d="M32 54s-20-11.6-27-24C-1.2 18.4 6.2 6 18.3 6c6.1 0 10.2 3.1 13.7 7.4C35.5 9.1 39.6 6 45.7 6 57.8 6 65.2 18.4 59 30c-7 12.4-27 24-27 24z"/>
              </svg>
              <span>NO</span>
            </button>
          </div>

          <p id="hint" class="text-sm text-gray-700 mt-4 font-semibold">
            Both buttons are locked üòà Beat the boss first.
          </p>

          <div class="mt-3 text-xs font-black text-slate-700/70">
            Status: <span id="statusLine" class="font-extrabold">Undecided</span>
          </div>
        </div>
      </aside>

      <!-- RIGHT: content -->
      <main class="space-y-5">

        <!-- Begin -->
        <section class="glass rounded-3xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Begin the Event</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
               The Boss guards the sacrid answers! 
              </div>
            </div>
            <button id="beginEvent"
              class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);">
              Begin
            </button>
          </div>
        </section>

        <!-- Boss Fight -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80"> Boss Fight (Love Edition)</div>
            <div class="text-xs font-black text-slate-700/70">Move: WASD/Arrows ‚Ä¢ Attack: Space / Tap</div>
          </div>

          <div class="px-6 py-5">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">YOU </div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">BOSS </div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
                </div>
              </div>
              <div>
                <div class="text-xs font-black text-slate-700/80 mb-1">LOVE METER </div>
                <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                  <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
                </div>
              </div>
            </div>

            <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
              <canvas id="bossCanvas" class="w-full block h-[420px]"></canvas>
              <img id="blackholeGif" alt="Black hole gif" />

              <div id="bossOverlay" class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
                <div class="text-slate-800/80">
                  <div class="text-3xl font-extrabold">A wild boss (NOT COPYWRITE) appeared!</div>
                  <div class="text-sm font-semibold mt-2">Dodge cursed hearts. Shoot love beams.</div>
                </div>
              </div>

              <button id="bossStart"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
                Start Boss Fight
              </button>
            </div>

            <div id="bossMsg" class="mt-3 text-sm font-semibold text-slate-700/80">
              Beat the boss to unlock 
            </div>
          </div>
        </section>

        <!-- PLATFORMER -->
        <section class="glass rounded-3xl overflow-hidden">
          <div class="flex items-center justify-between px-6 py-4 border-b border-white/50">
            <div class="font-black text-slate-800/80"> Platformer (C-Side++++)</div>
            <div class="text-xs font-black text-slate-700/70">Treats: <span id="platCount">0</span>/36</div>
          </div>
          <div class="px-6 py-5">
            <div class="text-sm font-semibold text-slate-700/80 mb-3" id="platMsg">
              Collect ALL the sweets üíò
            </div>

            <div class="plat-wrap border border-white/60 bg-white/55">
              <canvas id="platCanvas" class="w-full block h-[420px]"></canvas>

              <div id="platOverlay">
                <div class="text-slate-800/90">
                  <div class="text-3xl font-extrabold">Platformer</div>
                  <div class="text-sm font-semibold mt-2">Move: ‚Üê‚Üí/A D ‚Ä¢ Jump: ‚Üë/W/Space ‚Ä¢ Dash: Shift/X + direction</div>
                  <div class="text-xs font-semibold mt-2 opacity-80">Dash refills only via üíé (some require dashing). Death resets treats (per segment).</div>
                </div>
              </div>

              <button id="platStart"
                class="rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);">
                Start C-Side++++ 
              </button>
            </div>
          </div>
        </section>

        <!-- TCG + HUD + Spellbook + Tokens + Battle -->
        <section class="glass rounded-3xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
            <div>
              <div class="text-2xl font-black text-slate-800/80">Romance Arcade System</div>
              <div class="text-sm font-semibold text-slate-700/80 mt-1">
                Tokens ‚Üí mana ‚Üí cast spells ‚Üí buffs ‚Üí unlock love lines!
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="altArtBtn"
                class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
                style="background: linear-gradient(135deg, #fb7185, #6366f1);">
                Reveal Alt Art
              </button>
              <button id="openDateModal"
                class="rounded-full px-4 py-2 font-extrabold text-white shadow active:scale-95 transition"
                style="background: linear-gradient(135deg, #ec4899, #60a5fa);">
                Open Spellbook
              </button>
            </div>
          </div>

          <!-- Cinematic -->
          <div id="cinematicOverlay" class="modal hidden" aria-hidden="true">
            <div class="backdrop"></div>
            <div class="panel text-center">
              <div class="text-xl font-black text-slate-900/80">‚ú® ALT ART UNLOCKED ‚ú®</div>
              <div id="cinematicLine" class="mt-3 font-extrabold text-slate-800/80">
                ‚ÄúI would choose you in every draft.‚Äù
              </div>
              <div class="mt-3 text-xs font-black text-slate-700/70">Click anywhere to continue</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-[1.2fr_0.8fr] gap-4">

            <!-- Card -->
            <div class="rounded-3xl bg-white/60 border border-white/60 p-4">
              <div id="tcgCard" class="rounded-3xl bg-white/70 border border-white/60 p-4"
                   style="transform-style:preserve-3d; cursor:pointer;">
                <div class="flex items-center justify-between gap-3">
                  <div class="font-black text-slate-800/80">
                    Andrew Getzow, Keeper of My Heart
                    <span class="ml-2 text-xs font-black text-slate-700/70">VAL-014</span>
                  </div>
                  <div class="text-xs font-black text-slate-700/70">
                    Cost: üç´ ‚ù§Ô∏è üçø ‚ú®
                  </div>
                </div>

                <div class="mt-3 rounded-2xl overflow-hidden border border-slate-900/10 bg-white/70 relative">
                  <div id="cardArt" class="h-44 flex items-center justify-center font-black text-slate-700/70"
                       style="background:
                         radial-gradient(600px 120px at 30% 30%, rgba(255,77,141,0.20), transparent 55%),
                         radial-gradient(600px 120px at 80% 60%, rgba(99,102,241,0.14), transparent 55%),
                         rgba(255,255,255,0.62);">
                    (Put a cute photo here later)
                  </div>
                  <div class="absolute left-3 bottom-3 px-3 py-1 rounded-full bg-white/80 border border-slate-900/10 text-xs font-black text-slate-700/70">
                    <span id="artCaption">‚ÄúDinner Date Foil‚Äù</span>
                  </div>
                </div>

                <div class="mt-3 rounded-2xl bg-white/70 border border-white/60 p-4">
                  <div class="text-sm font-semibold text-slate-800/80 leading-relaxed">
                    <div><b>Whenever you smile</b>, create a <b>Heart token</b>.</div>
                    <div class="mt-1"><b>{T}:</b> Go on a date. If it‚Äôs Valentine‚Äôs Day, you may also get dessert.</div>
                    <div class="mt-1"><b>Partner</b> with <b>You, Hopeless Romantic</b>.</div>
                  </div>
                  <div class="mt-3 text-xs italic font-black text-slate-700/70">
                    <span id="flavorQuote">‚ÄúI‚Äôd tap all my mana for you.‚Äù</span>
                  </div>
                  <div class="mt-3 text-sm font-extrabold text-slate-800/80">
                    Love Letter: <span id="loveLetterLine">‚ÄúIf love were a format, I‚Äôd still pick you first.‚Äù</span>
                  </div>
                  <div class="mt-2 text-xs font-black text-slate-700/70" id="loveLineUnlocks">0/8 unlocked üíå</div>
                </div>
              </div>
            </div>

            <!-- HUD -->
            <div class="rounded-3xl bg-white/60 border border-white/60 p-5">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xl font-black text-slate-800/80">Romance HUD</div>
                  <div class="text-sm font-semibold text-slate-700/80 mt-1">Play the system for buffs + unlocks.</div>
                </div>
                <div class="text-xs font-black text-slate-700/70">
                  Phase: <span id="romancePhase" class="px-2 py-1 rounded-full bg-white/80 border border-white/60">I</span>
                </div>
              </div>

              <div class="mt-4 space-y-3">
                <div>
                  <div class="flex items-center justify-between text-xs font-black text-slate-700/70">
                    <span>Affection</span><span id="affectionText">0%</span>
                  </div>
                  <div class="h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
                    <div id="affectionFill" class="h-full bg-gradient-to-r from-pink-500 to-fuchsia-500" style="width:0%"></div>
                  </div>
                </div>

                <div>
                  <div class="flex items-center justify-between text-xs font-black text-slate-700/70">
                    <span>Nerves</span><span id="nervesText">25%</span>
                  </div>
                  <div class="h-3 rounded-full bg-white/70 border border-white/60 overflow-hidden">
                    <div id="nervesFill" class="h-full bg-gradient-to-r from-indigo-500 to-sky-400" style="width:25%"></div>
                  </div>
                </div>

                <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
                  <div class="text-xs font-black text-slate-700/70">Mana Pool</div>
                  <div id="manaPoolMini" class="mt-1 text-sm font-extrabold text-slate-800/80">üç´0 ‚ù§Ô∏è0 üçø0 ‚ú®0</div>
                </div>

                <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
                  <div class="text-xs font-black text-slate-700/70">Achievements</div>
                  <div id="achievementsMini" class="mt-1 text-sm font-extrabold text-slate-800/80">‚Äî none yet ‚Äî</div>
                </div>

                <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
                  <div class="text-xs font-black text-slate-700/70">Battle Status</div>
                  <div class="mt-1 text-sm font-extrabold text-slate-800/80">
                    <span id="battleStatus">Neutral</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Spellbook + Stack summary -->
          <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
              <div class="text-sm font-semibold text-slate-700/80" id="chosenDate">
                Selected spell: <b>None yet</b>
              </div>
              <div class="mt-2 text-xs font-black text-slate-700/70">
                Mana pool: <span id="manaSpent">üç´0 ‚ù§Ô∏è0 üçø0 ‚ú®0</span>
              </div>
              <div class="mt-2 text-xs font-black text-slate-700/70">
                Combo bonus: <span id="comboBonus">None</span>
              </div>
            </div>

            <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
              <div class="flex items-center justify-between">
                <div class="text-xs font-black text-slate-700/70">THE STACK</div>
                <button id="resolveStack"
                  class="rounded-full px-3 py-2 text-xs font-black text-white shadow active:scale-95 transition"
                  style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
                  Resolve ‚ú®
                </button>
              </div>
              <div id="spellStack" class="mt-2 space-y-2 text-sm font-semibold text-slate-800/80">
                <div class="opacity-70">‚Äî empty ‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Tokens + crafting -->
          <div class="mt-5 grid grid-cols-1 lg:grid-cols-[1fr_0.9fr] gap-3">
            <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-lg font-black text-slate-800/80">Heart Token Atelier</div>
                  <div class="text-sm font-semibold text-slate-700/80 mt-1">
                    Generate tokens ‚Üí gain mana ‚Üí craft gifts.
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="craftBtn"
                    class="rounded-full px-4 py-2 font-extrabold text-white shadow-lg active:scale-95 transition"
                    style="background: linear-gradient(135deg, #6366f1, #ec4899);">
                    Craft Gift
                  </button>
                  <button id="tokenBtn"
                    class="rounded-full px-4 py-2 font-extrabold text-white shadow-lg active:scale-95 transition"
                    style="background: linear-gradient(135deg, #fb7185, #f59e0b);">
                    Create Token
                  </button>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-8 sm:grid-cols-12 gap-2" id="tokenGrid"></div>

              <div class="mt-3 text-sm font-semibold text-slate-700/80" id="tokenMsg">
                Tokens: <b id="tokenCount">0</b> ‚Ä¢ Crafted gifts: <b id="giftCount">0</b>
              </div>
              <div class="mt-2 text-xs font-black text-slate-700/70" id="tokenLootLog">
                Loot log: ‚Äî ‚Äî
              </div>
            </div>

            <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
              <div class="text-xs font-black text-slate-700/70 mb-2">CRAFTING RECIPES</div>
              <div class="text-sm font-semibold text-slate-800/80">
                <div><b>üíê Bouquet</b> = üåπ + üåπ + ‚ú®</div>
                <div class="mt-1"><b>üç´ Chocolate Box</b> = üç´ + üç´ + ‚ù§Ô∏è</div>
                <div class="mt-1"><b>üïØÔ∏è Candle Kit</b> = üïØÔ∏è + ‚ú® + ‚ù§Ô∏è</div>
                <div class="mt-1"><b>üéüÔ∏è Date Ticket</b> = üçø + üçø + ‚ù§Ô∏è</div>
              </div>

              <div class="mt-4">
                <div class="text-xs font-black text-slate-700/70 mb-2">INVENTORY</div>
                <div id="inventoryPanel" class="text-sm font-semibold text-slate-800/80 opacity-90">
                  ‚Äî empty ‚Äî
                </div>
              </div>
            </div>
          </div>

        <!-- ‚ÄúWild Valentine‚Äù battle (REPLACE your whole block with this) -->
<div class="mt-5 rounded-3xl bg-white/60 border border-white/60 p-5 battle-arena">
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-xl font-black text-slate-800/80">Wild Valentine Encounter</div>
      <div id="battleText" class="text-sm font-semibold text-slate-700/80 mt-1">
        A wild Valentine appeared!
      </div>
    </div>
    <div class="text-xs font-black text-slate-700/70">
      Enemy Affection: <span id="enemyAff">0%</span>
    </div>
  </div>

  <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
    <!-- ENEMY -->
    <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
      <div class="text-xs font-black text-slate-700/70">Enemy HP</div>
      <div class="mt-2 h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
        <div id="enemyHPBar" class="h-full bg-gradient-to-r from-indigo-500 to-fuchsia-500" style="width:100%"></div>
      </div>

      <!-- ‚úÖ Enemy sprite GIF -->
      <div class="mt-3 flex justify-center">
        <img
          id="enemySprite"
          src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOTM1NmR2dzBnM2hjN2hyMGc0OTg3Y3JqMGViaW5ocmEzNG4wOGFibSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/I2uqvnLH9pfHVdbgWH/giphy.gif"
          alt="Valentine sprite"
          class="battle-sprite"
          draggable="false"
        />
      </div>
    </div>

    <!-- YOU -->
    <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
      <div class="text-xs font-black text-slate-700/70">You HP</div>
      <div class="mt-2 h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
        <div id="youHPBar" class="h-full bg-gradient-to-r from-rose-500 to-pink-500" style="width:100%"></div>
      </div>

      <div class="mt-3 text-xs font-black text-slate-700/70 flex items-center justify-between">
        <span>Nerves</span><span id="youNerves">25%</span>
      </div>
      <div class="mt-2 h-2 rounded-full bg-white/80 border border-white/60 overflow-hidden">
        <div id="youNervesBar" class="h-full bg-gradient-to-r from-sky-500 to-indigo-400" style="width:25%"></div>
      </div>

      <!-- ‚úÖ User sprite GIF -->
      <div class="mt-3 flex justify-center">
        <img
          id="youSprite"
          src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExamkzNmF6dDhtd2c3d2RpMDRyaXo4enByNWFocHdyZzRkcDdsdXN2ZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3xgR6JaucMaXe/giphy.gif"
          alt="You sprite"
          class="battle-sprite"
          draggable="false"
        />
      </div>
    </div>
  </div>

  <!-- Buttons + RUN -->
  <div class="mt-4 grid grid-cols-2 sm:grid-cols-5 gap-3">
    <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #fb7185, #ec4899);" data-move="Compliment Beam">Compliment</button>
    <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #60a5fa, #22c55e);" data-move="Snack Shield">Snack</button>
    <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #f59e0b, #fb7185);" data-move="Laugh Attack">Laugh</button>
    <button class="rounded-xl px-4 py-3 font-black text-white shadow active:scale-95 transition"
            style="background: linear-gradient(135deg, #6366f1, #ec4899);" data-move="Cozy Aura">Cozy</button>

    <button id="btnRun"
      class="rounded-xl px-4 py-3 font-black text-slate-800/80 bg-white/85 border border-white/60 shadow active:scale-95 transition">
      RUN
    </button>
  </div>

  <!-- FX layer -->
  <div id="battleFx" class="battle-fx" aria-hidden="true"></div>

  <!-- ‚úÖ Quick Time Event: Dodge -->
  <div id="qte" class="qte hidden" aria-hidden="true">
    <div class="qte-inner">
      <div class="qte-title">DODGE!</div>
      <div class="qte-sub">Tap fast ‚Äî you can‚Äôt let the üíò hit you</div>

      <button id="qteBtn" class="qte-btn" type="button">DODGE</button>

      <div class="qte-bar" aria-hidden="true">
        <div id="qteFill" class="qte-fill"></div>
      </div>

      <div class="qte-hint">Tip: tap or press <b>Space</b></div>
    </div>
  </div>
</div>

<style>
  /* === Battle visuals / better graphics === */
  .battle-arena{ position: relative; overflow: hidden; transform: translateZ(0); }
  .battle-arena::before{
    content:"";
    position:absolute;
    inset:-40%;
    background:
      radial-gradient(800px 520px at 25% 30%, rgba(167,139,250,0.30), transparent 60%),
      radial-gradient(900px 560px at 75% 40%, rgba(34,211,238,0.22), transparent 62%),
      radial-gradient(850px 650px at 55% 85%, rgba(244,63,94,0.18), transparent 65%),
      radial-gradient(600px 500px at 60% 55%, rgba(255,255,255,0.10), transparent 60%);
    filter: blur(18px) saturate(1.2);
    opacity: 0.85;
    animation: arenaDrift 14s ease-in-out infinite;
    z-index: 0;
  }
  .battle-arena::after{
    content:"";
    position:absolute;
    inset:0;
    background-image:
      radial-gradient(circle, rgba(255,255,255,0.55) 0 1px, transparent 2px),
      radial-gradient(circle, rgba(255,255,255,0.25) 0 1px, transparent 2px);
    background-size: 120px 120px, 70px 70px;
    background-position: 0 0, 20px 40px;
    opacity: 0.25;
    mix-blend-mode: screen;
    z-index: 0;
  }
  @keyframes arenaDrift{
    0%,100%{ transform: translate3d(0,0,0) scale(1); }
    50%{ transform: translate3d(-14px, 10px, 0) scale(1.04); }
  }
  .battle-arena > *{ position: relative; z-index: 1; }

  .battle-sprite{
    width: 160px;
    height: 160px;
    object-fit: contain;
    image-rendering: auto;
    filter: drop-shadow(0 14px 26px rgba(0,0,0,0.18));
    animation: spriteFloat 2.2s ease-in-out infinite;
    user-select: none;
    pointer-events: none;
  }
  #enemySprite{ filter: drop-shadow(0 14px 26px rgba(0,0,0,0.18)) drop-shadow(0 0 40px rgba(167,139,250,0.25)); }
  #youSprite{   filter: drop-shadow(0 14px 26px rgba(0,0,0,0.18)) drop-shadow(0 0 40px rgba(244,63,94,0.18)); }

  @keyframes spriteFloat{
    0%,100%{ transform: translateY(0); }
    50%{ transform: translateY(-6px); }
  }

  /* FX layer */
  .battle-fx{
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index: 20;
    overflow:hidden;
  }

  /* Hit shake */
  @keyframes hitShake{
    0%{ transform: translateX(0); }
    20%{ transform: translateX(-6px); }
    40%{ transform: translateX(6px); }
    60%{ transform: translateX(-4px); }
    80%{ transform: translateX(4px); }
    100%{ transform: translateX(0); }
  }
  .hit-shake{ animation: hitShake 320ms ease; }

  /* Floating text */
  .float-text{
    position:absolute;
    font-weight: 900;
    font-size: 16px;
    letter-spacing: 0.4px;
    opacity: 0;
    transform: translateY(0);
    filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
    animation: floatUpText 900ms ease forwards;
  }
  @keyframes floatUpText{
    0%{ opacity: 0; transform: translateY(6px) scale(0.96); }
    15%{ opacity: 1; }
    100%{ opacity: 0; transform: translateY(-34px) scale(1.04); }
  }

  /* Sparkles */
  .spark{
    position:absolute;
    opacity: 0;
    font-size: 18px;
    animation: sparkPop 700ms ease forwards;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,0.14));
  }
  @keyframes sparkPop{
    0%{ opacity: 0; transform: translate(0,0) scale(0.8); }
    18%{ opacity: 1; }
    100%{ opacity: 0; transform: translate(var(--dx), var(--dy)) scale(1.2); }
  }

  /* === QTE Overlay === */
  .qte{
    position:absolute;
    inset:0;
    z-index: 30;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(15,23,42,0.45);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .qte.hidden{ display:none; }

  .qte-inner{
    width: min(520px, 92%);
    border-radius: 22px;
    padding: 16px 16px 14px;
    background: rgba(255,255,255,0.78);
    border: 1px solid rgba(255,255,255,0.65);
    box-shadow: 0 22px 70px rgba(0,0,0,0.18);
    text-align:center;
  }
  .qte-title{
    font-weight: 900;
    letter-spacing: -0.02em;
    font-size: 30px;
    color: rgba(15,23,42,0.85);
  }
  .qte-sub{
    margin-top: 4px;
    font-weight: 800;
    font-size: 13px;
    color: rgba(15,23,42,0.65);
  }
  .qte-btn{
    margin-top: 12px;
    width: 100%;
    border-radius: 16px;
    padding: 14px 14px;
    font-weight: 900;
    color: white;
    background: linear-gradient(135deg, #fb7185, #ec4899, #6366f1);
    box-shadow: 0 14px 30px rgba(0,0,0,0.18);
    transform: translateZ(0);
  }
  .qte-btn:active{ transform: scale(0.98); }

  .qte-bar{
    margin-top: 12px;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.75);
    border: 1px solid rgba(15,23,42,0.12);
    overflow:hidden;
  }
  .qte-fill{
    height: 100%;
    width: 100%;
    transform-origin: left;
    background: linear-gradient(90deg, rgba(34,211,238,0.95), rgba(167,139,250,0.95), rgba(244,63,94,0.95));
  }
  .qte-hint{
    margin-top: 8px;
    font-size: 12px;
    font-weight: 800;
    color: rgba(15,23,42,0.55);
  }
</style>

<script>
  // ====== Battle logic with QTE Dodge + RUN message ======
  const enemyHPBar = document.getElementById("enemyHPBar");
  const youHPBar = document.getElementById("youHPBar");
  const enemyAff = document.getElementById("enemyAff");
  const youNerves = document.getElementById("youNerves");
  const youNervesBar = document.getElementById("youNervesBar");
  const battleText = document.getElementById("battleText");

  const battleCard = document.querySelector(".battle-arena");
  const battleFx = document.getElementById("battleFx");
  const enemySprite = document.getElementById("enemySprite");
  const youSprite = document.getElementById("youSprite");

  const btnRun = document.getElementById("btnRun");

  const qte = document.getElementById("qte");
  const qteBtn = document.getElementById("qteBtn");
  const qteFill = document.getElementById("qteFill");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  const state = {
    enemyHP: 100,
    youHP: 100,
    enemyAff: 0,
    nerves: 25,
    shield: 0,       // reduces next incoming dmg
    stunned: false,  // enemy can skip turn
    inTurn: false
  };

  const moves = {
    "Compliment Beam": { dmg: 18, aff: 14, text: "Compliment Beam! ‚ÄúYou look SO cute.‚Äù üí•üíñ" },
    "Snack Shield":    { dmg: 6,  heal: 12, aff: 6,  shield: 1, text: "Snack Shield! You feel safer (+HP) üç™üõ°Ô∏è" },
    "Laugh Attack":    { dmg: 12, aff: 10, stun: 0.35, text: "Laugh Attack! He can‚Äôt stop smiling üòÇ" },
    "Cozy Aura":       { dmg: 10, heal: 8,  aff: 8,  text: "Cozy Aura! Warm vibes (+HP) üß∏‚ú®" }
  };

  function setBars(){
    enemyHPBar.style.width = clamp(state.enemyHP,0,100) + "%";
    youHPBar.style.width   = clamp(state.youHP,0,100) + "%";
    enemyAff.textContent = clamp(state.enemyAff,0,100).toFixed(0) + "%";
    youNerves.textContent = clamp(state.nerves,0,100).toFixed(0) + "%";
    youNervesBar.style.width = clamp(state.nerves,0,100) + "%";
  }
  setBars();

  function shake(el){
    if (!el) return;
    el.classList.remove("hit-shake");
    void el.offsetWidth;
    el.classList.add("hit-shake");
  }

  function centerOf(el){
    const r = el.getBoundingClientRect();
    const cr = battleCard.getBoundingClientRect();
    return { x: (r.left + r.width/2) - cr.left, y: (r.top + r.height/2) - cr.top };
  }

  function sparkBurst(x, y, count=10){
    const chars = ["‚ú®","üí´","‚≠ê","üåü","üíñ"];
    for (let i=0;i<count;i++){
      const s = document.createElement("div");
      s.className = "spark";
      s.textContent = chars[Math.floor(Math.random()*chars.length)];
      s.style.left = x + "px";
      s.style.top = y + "px";
      s.style.setProperty("--dx", (Math.random()*120-60) + "px");
      s.style.setProperty("--dy", (Math.random()*120-60) + "px");
      battleFx.appendChild(s);
      setTimeout(()=>s.remove(), 750);
    }
  }

  function floatText(x, y, text, color){
    const t = document.createElement("div");
    t.className = "float-text";
    t.textContent = text;
    t.style.left = x + "px";
    t.style.top = y + "px";
    t.style.color = color || "rgba(15,23,42,0.85)";
    battleFx.appendChild(t);
    setTimeout(()=>t.remove(), 950);
  }

  function runDodgeQTE(ms=650){
    return new Promise((resolve)=>{
      let done=false;
      const start = performance.now();

      qte.classList.remove("hidden");
      qte.setAttribute("aria-hidden","false");

      const finish = (ok)=>{
        if(done) return;
        done=true;
        qte.classList.add("hidden");
        qte.setAttribute("aria-hidden","true");
        window.removeEventListener("keydown", onKey);
        qteBtn.removeEventListener("click", onClick);
        resolve(ok);
      };

      const onClick = ()=>finish(true);
      const onKey = (e)=>{
        if(e.key===" " || e.code==="Space"){
          e.preventDefault();
          finish(true);
        }
      };

      qteBtn.addEventListener("click", onClick, { once:true });
      window.addEventListener("keydown", onKey);

      const tick = (now)=>{
        if(done) return;
        const t = (now-start)/ms;
        const left = Math.max(0, 1 - t);
        qteFill.style.transform = `scaleX(${left})`;
        if(t>=1) finish(false);
        else requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    });
  }

  async function enemyAttack(){
    const base = 12 + Math.floor(Math.random()*4); // 12-15
    battleText.textContent = "Valentine attacks! QUICK ‚Äî DODGE!";

    const dodged = await runDodgeQTE(650);
    const pos = centerOf(youSprite);

    let dmg = base;
    if(state.shield > 0){
      dmg = Math.max(1, Math.floor(dmg * 0.5));
      state.shield = 0;
    }

    if(dodged){
      const reduced = Math.max(1, Math.floor(dmg * 0.5));
      state.youHP = clamp(state.youHP - reduced, 0, 100);
      state.nerves = clamp(state.nerves - 6, 0, 100);
      battleText.textContent = "Nice! You dodged ‚Äî love still grazes you üíû";
      floatText(pos.x, pos.y, `-${reduced}`, "rgba(34,197,94,0.95)");
      sparkBurst(pos.x, pos.y, 10);
      shake(youSprite);
    }else{
      state.youHP = clamp(state.youHP - dmg, 0, 100);
      state.nerves = clamp(state.nerves + 10, 0, 100);
      battleText.textContent = "Oof üí• You got hit!";
      floatText(pos.x, pos.y, `-${dmg}`, "rgba(244,63,94,0.95)");
      sparkBurst(pos.x, pos.y, 12);
      shake(youSprite);
      shake(battleCard);
    }

    setBars();

    if(state.youHP <= 0){
      battleText.textContent = "You fainted‚Ä¶ but LOVE revives you instantly. (Try again üò§üíñ)";
      state.youHP = 100;
      state.enemyHP = 100;
      state.enemyAff = 0;
      state.nerves = 25;
      setBars();
    }
  }

  function win(){
    battleText.textContent = "Valentine surrendered‚Ä¶ it‚Äôs basically YES. üíòüíñ";
    const epos = centerOf(enemySprite);
    sparkBurst(epos.x, epos.y, 14);
    shake(enemySprite);
    // reset after a moment
    setTimeout(()=>{
      state.enemyHP = 100;
      state.youHP = 100;
      state.enemyAff = 0;
      state.nerves = 25;
      setBars();
      battleText.textContent = "A wild Valentine appeared! (Again‚Ä¶ because it loves you.)";
    }, 1600);
  }

  async function playerMove(name){
    if(state.inTurn) return;
    state.inTurn = true;

    const m = moves[name];
    const epos = centerOf(enemySprite);

    state.enemyHP = clamp(state.enemyHP - m.dmg, 0, 100);
    state.enemyAff = clamp(state.enemyAff + (m.aff || 0), 0, 100);

    if(m.heal) state.youHP = clamp(state.youHP + m.heal, 0, 100);
    if(m.shield) state.shield = 1;
    if(m.stun && Math.random() < m.stun) state.stunned = true;

    battleText.textContent = m.text;
    floatText(epos.x, epos.y, `-${m.dmg}`, "rgba(99,102,241,0.95)");
    sparkBurst(epos.x, epos.y, 10);
    shake(enemySprite);

    setBars();

    if(state.enemyHP <= 0 || state.enemyAff >= 100){
      win();
      state.inTurn = false;
      return;
    }

    // enemy turn (unless stunned)
    setTimeout(async ()=>{
      if(state.stunned){
        state.stunned = false;
        battleText.textContent = "Valentine is too flustered to move‚Ä¶ üò≥";
        state.inTurn = false;
        return;
      }
      await enemyAttack();
      state.inTurn = false;
    }, 700);
  }

  // move buttons
  document.querySelectorAll("button[data-move]").forEach(btn=>{
    btn.addEventListener("click", ()=> playerMove(btn.getAttribute("data-move")));
  });

  // RUN button
  btnRun.addEventListener("click", ()=>{
    battleText.textContent = "You can‚Äôt run from love.";
    btnRun.animate(
      [
        { transform:"translateX(0px)" },
        { transform:"translateX(-6px)" },
        { transform:"translateX(6px)" },
        { transform:"translateX(-4px)" },
        { transform:"translateX(4px)" },
        { transform:"translateX(0px)" }
      ],
      { duration: 360 }
    );
  });
</script>


  <!-- Spellbook Modal -->
  <div id="dateModal" class="modal hidden" aria-hidden="true">
    <div class="backdrop" data-close="1"></div>
    <div class="panel">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-black text-slate-800/80">Spellbook of Dates</div>
          <div class="text-sm font-semibold text-slate-700/80 mt-1">
            Add spells to the stack ‚Üí resolve for buffs ‚ú®
          </div>
        </div>
        <button id="closeDateModal"
          class="rounded-full px-3 py-2 font-black bg-white/80 border border-white/60 active:scale-95 transition">
          Close
        </button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-[1fr_0.9fr] gap-3">
        <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70 mb-3">SPELL LIST</div>
          <div id="spellList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>

        <div class="rounded-2xl bg-white/70 border border-white/60 p-4">
          <div class="text-xs font-black text-slate-700/70 mb-2">CURRENT SYNERGY</div>
          <div id="synergyPanel" class="text-sm font-semibold text-slate-800/80">
            Add spells to see combo effects.
          </div>

          <div class="mt-4 text-xs font-black text-slate-700/70 mb-2">STACK CONTROLS</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="stackUndo" class="rounded-xl px-3 py-2 font-black bg-white/85 border border-white/60 active:scale-95 transition">Undo</button>
            <button id="stackClear" class="rounded-xl px-3 py-2 font-black bg-white/85 border border-white/60 active:scale-95 transition">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       MAIN GAME SCRIPT
  ========================================================== -->
  <script>
  (() => {
    "use strict";

    /* =========================================================
       Helpers
    ========================================================= */
    const $ = (id) => document.getElementById(id);
    const clamp = (n,a,b) => Math.max(a, Math.min(b,n));

    function safeConfetti(opts){
      try { confetti(opts); } catch {}
    }

    function setImageTryFor(imgEl, urls) {
      let i = 0;
      const tryNext = () => {
        if (i >= urls.length) return;
        const url = urls[i++];
        const probe = new Image();
        probe.onload = () => { imgEl.src = url; };
        probe.onerror = tryNext;
        probe.src = url;
      };
      tryNext();
    }

    /* =========================================================
       Floating hearts / powerups / pixel clouds
    ========================================================= */
    const heartsLayer = $("hearts");
    const powerupsLayer = $("powerups");
    const pixelCloudsLayer = $("pixelClouds");

    function spawnHeart(){
      const el = document.createElement("span");
      el.className = "heart";
      el.textContent = Math.random() > 0.25 ? "üíó" : "üíñ";
      const left = Math.random() * 100;
      const size = 14 + Math.random() * 28;
      const dur  = 5 + Math.random() * 7;
      const drift = (Math.random() * 60 - 30) + "px";
      el.style.left = left + "vw";
      el.style.fontSize = size + "px";
      el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
      el.style.animationDuration = dur + "s";
      el.style.setProperty("--drift", drift);
      el.style.setProperty("--rot", (Math.random()*140 - 70) + "deg");
      heartsLayer.appendChild(el);
      setTimeout(() => el.remove(), dur * 1000 + 200);
    }

    function spawnPowerup(){
      const el = document.createElement("span");
      el.className = "powerup";
      const items = ["‚≠ê","ü™ô","‚ú®","üíñ","üéÆ","üíå","üåπ"];
      el.textContent = items[Math.floor(Math.random() * items.length)];
      const left = Math.random() * 100;
      const size = 14 + Math.random() * 22;
      const dur  = 6 + Math.random() * 8;
      const drift = (Math.random() * 80 - 40) + "px";
      const rot = (Math.random() * 160 - 80) + "deg";
      el.style.left = left + "vw";
      el.style.fontSize = size + "px";
      el.style.opacity = (0.25 + Math.random() * 0.45).toFixed(2);
      el.style.animationDuration = dur + "s";
      el.style.setProperty("--drift", drift);
      el.style.setProperty("--rot", rot);
      powerupsLayer.appendChild(el);
      setTimeout(() => el.remove(), dur * 1000 + 250);
    }

    const pixelCloudSvg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="32" viewBox="0 0 64 32">
        <rect width="64" height="32" fill="none"/>
        <g fill="#ffffff">
          <rect x="10" y="14" width="8" height="6"/>
          <rect x="18" y="12" width="10" height="8"/>
          <rect x="28" y="10" width="12" height="10"/>
          <rect x="40" y="12" width="10" height="8"/>
          <rect x="50" y="14" width="6" height="6"/>
          <rect x="14" y="18" width="40" height="8"/>
        </g>
        <g fill="#e2e8f0" opacity="0.85">
          <rect x="18" y="18" width="10" height="8"/>
          <rect x="32" y="18" width="10" height="8"/>
        </g>
      </svg>
    `);

    function spawnPixelCloud(){
      const el = document.createElement("div");
      el.className = "pixel-cloud";
      const top = (Math.random() * 55) + "vh";
      const dur = (18 + Math.random() * 18) + "s";
      const scale = (0.55 + Math.random() * 0.65).toFixed(2);
      el.style.setProperty("--top", top);
      el.style.setProperty("--s", scale);
      el.style.animationDuration = dur;
      el.style.backgroundImage = `url("data:image/svg+xml,${pixelCloudSvg}")`;
      pixelCloudsLayer.appendChild(el);
      setTimeout(() => el.remove(), parseFloat(dur) * 1000 + 400);
    }

    for (let i = 0; i < 12; i++) spawnHeart();
    for (let i = 0; i < 8; i++) spawnPowerup();
    for (let i = 0; i < 6; i++) spawnPixelCloud();
    setInterval(spawnHeart, 220);
    setInterval(spawnPowerup, 650);
    setInterval(spawnPixelCloud, 1700);

    /* =========================================================
       Mana bar (scroll progress) + shiny mode
    ========================================================= */
    const manaBarInner = $("manaBarInner");
    const manaPctEl = $("manaPct");
    function updateMana(){
      const doc = document.documentElement;
      const scrollTop = doc.scrollTop || document.body.scrollTop;
      const max = (doc.scrollHeight - doc.clientHeight) || 1;
      const pct = clamp((scrollTop / max) * 100, 0, 100);
      manaBarInner.style.width = pct.toFixed(1) + "%";
      manaPctEl.textContent = String(Math.round(pct));
    }
    window.addEventListener("scroll", updateMana, { passive:true });
    updateMana();

    const shinyStar = $("shinyStar");
    let shinyClicks = 0;
    shinyStar.addEventListener("click", () => {
      shinyClicks++;
      if (shinyClicks >= 3){
        document.body.classList.toggle("shiny-mode");
        shinyClicks = 0;
        safeConfetti({ particleCount: 120, spread: 80, origin: { y: 0.2 } });
      } else {
        shinyStar.animate([{transform:"scale(1)"},{transform:"scale(1.2)"},{transform:"scale(1)"}], {duration:260});
      }
    });

    /* =========================================================
       Simple music toggle (low volume oscillator)
    ========================================================= */
    const musicBtn = $("musicBtn");
    let audioCtx = null;
    let musicOsc = null;
    let musicOn = false;

    function startMusic(){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 220;
        gain.gain.value = 0.02;
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();
        musicOsc = { osc, gain };

        let step = 0;
        const chord = [220, 277.18, 329.63, 392.00];
        const timer = setInterval(() => {
          if (!musicOn || !musicOsc){ clearInterval(timer); return; }
          step = (step + 1) % chord.length;
          musicOsc.osc.frequency.setTargetAtTime(chord[step], audioCtx.currentTime, 0.08);
        }, 900);
      } catch {}
    }

    function stopMusic(){
      try{
        if (!musicOsc || !audioCtx) return;
        musicOsc.gain.gain.setTargetAtTime(0.0001, audioCtx.currentTime, 0.05);
        setTimeout(() => {
          try { musicOsc.osc.stop(); } catch {}
          musicOsc = null;
        }, 120);
      } catch {}
    }

    musicBtn.addEventListener("click", () => {
      musicOn = !musicOn;
      musicBtn.textContent = `üéµ Music: ${musicOn ? "On" : "Off"}`;
      if (musicOn) startMusic();
      else stopMusic();
    });

    /* =========================================================
       Valentine GIF (clean loader)
    ========================================================= */
    const valImage = $("valImage");
    const GIFS = {
      start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
      yes:   ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
      no:    ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
    };
    setImageTryFor(valImage, GIFS.start);

    /* =========================================================
       YES/NO locking + runaway NO (AFTER boss victory)
    ========================================================= */
    const yesBtn = $("yesBtn");
    const noBtn  = $("noBtn");
    const hint   = $("hint");
    const statusLine = $("statusLine");
    const arena = $("heartButtons");

    let unlocked = false;

    function lockButton(btn, label){
      btn.disabled = true;
      btn.style.opacity = "0.55";
      btn.style.cursor = "not-allowed";
      const span = btn.querySelector("span");
      if (span) span.textContent = label;
    }
    function unlockButton(btn, label){
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
      const span = btn.querySelector("span");
      if (span) span.textContent = label;
    }
    function lockYesNo(){
      unlocked = false;
      lockButton(yesBtn, "LOCKED");
      lockButton(noBtn, "LOCKED");
      hint.textContent = "Both buttons are locked üòà Beat the boss first.";
      statusLine.textContent = "Undecided";
    }
    function unlockYesNo(){
      unlocked = true;
      unlockButton(yesBtn, "YES");
      unlockButton(noBtn, "NO");
      hint.textContent = "Unlocked! üò≥ Now choose wisely...";
      statusLine.textContent = "Unlocked";
      enableRunawayNo();
      safeConfetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } });
    }
    lockYesNo();

    yesBtn.addEventListener("click", () => {
      if (!unlocked){
        hint.textContent = "YES is locked üòà Beat the boss first!";
        yesBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
        return;
      }
      statusLine.textContent = "YES üíñ";
      hint.textContent = "You are now my Valentine FOREVER‚Ä¶ (for 2026 üòá)";
      setImageTryFor(valImage, GIFS.yes);
      safeConfetti({ particleCount: 260, spread: 95, origin: { y: 0.6 } });
    });

    noBtn.addEventListener("click", () => {
      if (!unlocked){
        hint.textContent = "NO is locked üòà Beat the boss first!";
        noBtn.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:320});
        return;
      }
      statusLine.textContent = "NO?! üò≥";
      hint.textContent = "No (Are you sure about that?)";
      setImageTryFor(valImage, GIFS.no);
    });

    function enableRunawayNo(){
      if (noBtn.classList.contains("runaway")) return;

      noBtn.classList.add("runaway");
      const arenaRect0 = arena.getBoundingClientRect();
      const noRect0 = noBtn.getBoundingClientRect();
      let nx = (noRect0.left - arenaRect0.left);
      let ny = (noRect0.top  - arenaRect0.top);
      let scale = 1;
      let moveCount = 0;

      noBtn.style.left = "0px";
      noBtn.style.top  = "0px";
      setTransform();

      function setTransform(){
        noBtn.style.setProperty("--nx", `${nx}px`);
        noBtn.style.setProperty("--ny", `${ny}px`);
        noBtn.style.setProperty("--nscale", `${scale}`);
      }

      function flee(extraBoost=0){
        const arenaRect = arena.getBoundingClientRect();
        const btnRect = noBtn.getBoundingClientRect();
        const bw = btnRect.width;
        const bh = btnRect.height;

        const maxX = Math.max(0, arenaRect.width - bw);
        const maxY = Math.max(0, arenaRect.height - bh);

        const dx = (Math.random()*2 - 1);
        const dy = (Math.random()*2 - 1);
        const step = 120 + extraBoost + Math.min(260, moveCount * 12);

        nx = clamp(nx + dx * step, 0, maxX);
        ny = clamp(ny + dy * step, 0, maxY);

        moveCount++;
        noBtn.classList.add("is-running");
        setTransform();
        setTimeout(() => noBtn.classList.remove("is-running"), 120);
      }

      noBtn.addEventListener("mouseenter", () => unlocked && flee(90));
      noBtn.addEventListener("touchstart", (e) => {
        if (!unlocked) return;
        e.preventDefault();
        flee(140);
      }, { passive:false });

      noBtn.addEventListener("click", (e) => {
        if (!unlocked) return;
        e.preventDefault();
        e.stopPropagation();
        statusLine.textContent = "NO?! üò≥ (it panicked)";
        scale = clamp(scale * 1.18, 1, 2.6);
        setTransform();
        flee(260);
      });

      window.addEventListener("resize", () => {
        const arenaRect = arena.getBoundingClientRect();
        const btnRect = noBtn.getBoundingClientRect();
        nx = clamp(nx, 0, Math.max(0, arenaRect.width - btnRect.width));
        ny = clamp(ny, 0, Math.max(0, arenaRect.height - btnRect.height));
        setTransform();
      });
    }

    /* =========================================================
       Boss fight (self-contained)
    ========================================================= */
    const beginEvent = $("beginEvent");
    const bossCanvas = $("bossCanvas");
    const bossCtx = bossCanvas.getContext("2d");
    const bossOverlay = $("bossOverlay");
    const bossStart = $("bossStart");
    const bossMsg = $("bossMsg");
    const playerHPBar = $("playerHPBar");
    const bossHPBar = $("bossHPBar");
    const loveBar = $("loveBar");
    const blackholeGif = $("blackholeGif");

    beginEvent.addEventListener("click", () => {
      bossStart.scrollIntoView({ behavior: "smooth", block: "center" });
      bossStart.animate([{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}], {duration:520});
    });

    setImageTryFor(blackholeGif, [
      "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjliOThhaGVlNzMyNWFsa2RhZmdidGdxczU0eDF1bTBxMjZpNXRnMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xUA7b2takylWgFwJYQ/giphy.gif"
    ]);

    // Global keys for boss fight
    const keys = new Set();
    window.addEventListener("keydown", (e) => {
      if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," ", "Shift", "x"].includes(e.key)){
        keys.add(e.key);
        if (e.key === " ") e.preventDefault();
      }
    }, { passive:false });
    window.addEventListener("keyup", (e) => keys.delete(e.key));

    function fitCanvasToCSS(canvas, ctx){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.floor(rect.width  * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    fitCanvasToCSS(bossCanvas, bossCtx);
    window.addEventListener("resize", () => fitCanvasToCSS(bossCanvas, bossCtx));

    const bossGame = {
      running:false,
      raf:null,
      lastTs:0,
      t:0,
      lastShot:0,
      phase2:false,
      blackHole: { active:false, timer:0, cool:2.0 },
      bullets:[],
      beams:[],
      particles:[],
      player:{ x:120, y:260, r:10, hp:5, maxHp:5, inv:0 },
      boss:{ x:0, y:0, r:28, hp:100, maxHp:100, wob:0 },
      pattern:"spray",
      phaseTimer:0
    };

    function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

    function setBossBars(){
      playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
      bossHPBar.style.width   = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
      const lovePct = (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 100;
      loveBar.style.width = lovePct.toFixed(1) + "%";
    }

    function spawnParticle(x,y,emoji){
      bossGame.particles.push({
        x,y,
        vx:(Math.random()*2-1)*1.2,
        vy:(Math.random()*2-1)*1.2 - 0.8,
        life: 40 + Math.random()*20,
        emoji
      });
    }

    function drawHeart(ctx, x, y, size, color){
      ctx.save();
      ctx.translate(x,y);
      ctx.beginPath();
      ctx.moveTo(0, size*0.25);
      ctx.bezierCurveTo(-size, -size*0.35, -size*0.6, -size, 0, -size*0.45);
      ctx.bezierCurveTo(size*0.6, -size, size, -size*0.35, 0, size*0.25);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
      ctx.restore();
    }

    function rr(ctx, x, y, w, h, r){
      if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(x,y,w,h,r); return; }
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y,   x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x,   y+h, r);
      ctx.arcTo(x,   y+h, x,   y,   r);
      ctx.arcTo(x,   y,   x+w, y,   r);
      ctx.closePath();
    }

    function drawBossSprite(ctx, x, y){
      ctx.save();
      ctx.translate(x,y);

      ctx.globalAlpha = 0.24;
      ctx.beginPath();
      ctx.ellipse(0, 14, 54, 28, 0, 0, Math.PI*2);
      ctx.fillStyle = "#111827";
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.beginPath();
      ctx.moveTo(-52, 10);
      ctx.quadraticCurveTo(0, 64, 52, 10);
      ctx.quadraticCurveTo(0, 36, -52, 10);
      ctx.closePath();
      ctx.fillStyle = "#0b1224";
      ctx.fill();

      ctx.beginPath();
      ctx.ellipse(0, -6, 44, 38, 0, 0, Math.PI*2);
      ctx.fillStyle = "#2563eb";
      ctx.fill();

      ctx.beginPath();
      ctx.ellipse(0, -6, 30, 24, 0, 0, Math.PI*2);
      ctx.fillStyle = "#0b1020";
      ctx.fill();

      ctx.beginPath();
      ctx.ellipse(-10, -10, 5, 12, 0, 0, Math.PI*2);
      ctx.ellipse( 10, -10, 5, 12, 0, 0, Math.PI*2);
      ctx.fillStyle = "#fde047";
      ctx.fill();

      ctx.beginPath();
      rr(ctx, -46, 4, 92, 24, 12);
      ctx.fillStyle = "#f8fafc";
      ctx.fill();

      ctx.restore();
    }

    function fireBullet(angle, speed, kind="heart"){
      bossGame.bullets.push({
        x: bossGame.boss.x,
        y: bossGame.boss.y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        r: kind === "orb" ? 8 : 7,
        kind
      });
    }

    function shoot(){
      const now = performance.now();
      if (now - bossGame.lastShot < 120) return;
      bossGame.lastShot = now;

      bossGame.beams.push({
        x: bossGame.player.x,
        y: bossGame.player.y - 12,
        vx: 0,
        vy: -7.6,
        r: 6
      });
      spawnParticle(bossGame.player.x, bossGame.player.y-10, "üíû");
    }

    function choosePattern(){
      const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
      const pool = hpPct > 0.65 ? ["spray","ring"]
                 : hpPct > 0.30 ? ["spray","ring","dash"]
                 : ["spray","ring","dash","spiral"];
      bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
      bossGame.phaseTimer = 0;
    }

    function resetBossFight(){
      bossGame.running = false;
      bossGame.lastTs = 0;
      bossGame.t = 0;
      bossGame.lastShot = 0;
      bossGame.phase2 = false;
      bossGame.blackHole.active = false;
      bossGame.blackHole.timer = 0;
      bossGame.blackHole.cool = 2.0;
      bossGame.bullets.length = 0;
      bossGame.beams.length = 0;
      bossGame.particles.length = 0;

      bossGame.player.x = 120;
      bossGame.player.y = 260;
      bossGame.player.hp = bossGame.player.maxHp = 5;
      bossGame.player.inv = 0;

      bossGame.boss.hp = bossGame.boss.maxHp = 100;
      bossGame.boss.wob = 0;

      bossGame.pattern = "spray";
      bossGame.phaseTimer = 0;

      blackholeGif.style.opacity = "0";
      setBossBars();
      bossOverlay.style.opacity = "1";
      bossOverlay.innerHTML = `
        <div class="text-slate-800/80">
          <div class="text-3xl font-extrabold">A wild boss appeared!</div>
          <div class="text-sm font-semibold mt-2">Dodge cursed hearts. Shoot love beams.</div>
        </div>
      `;
      bossStart.style.opacity = "1";
      bossStart.style.pointerEvents = "auto";
      bossStart.textContent = "Start Boss Fight";
      bossMsg.textContent = "Beat the boss to unlock YES + NO.";
    }

    function stopBossFight(){
      bossGame.running = false;
      if (bossGame.raf) cancelAnimationFrame(bossGame.raf);
      bossGame.raf = null;
      document.body.classList.remove("boss-mode");
      blackholeGif.style.opacity = "0";
    }

    function winBossFight(){
      stopBossFight();
      bossOverlay.style.opacity = "1";
      bossOverlay.innerHTML = `
        <div class="text-white drop-shadow-lg">
          <div class="text-4xl font-extrabold">BOSS DEFEATED üíò</div>
          <div class="text-sm font-semibold mt-2">Unlocked! Now click YES üò§üíû</div>
        </div>
      `;
      bossStart.style.opacity = "1";
      bossStart.style.pointerEvents = "auto";
      bossStart.textContent = "Rematch (optional)";
      bossMsg.textContent = "Unlocked! YES + NO are now available.";
      unlockYesNo();
    }

    function loseBossFight(){
      stopBossFight();
      bossOverlay.style.opacity = "1";
      bossOverlay.innerHTML = `
        <div class="text-white drop-shadow-lg">
          <div class="text-4xl font-extrabold">You got bonked üí•</div>
          <div class="text-sm font-semibold mt-2">Try again‚Ä¶ turn chaos into cuddles üò§</div>
        </div>
      `;
      bossStart.style.opacity = "1";
      bossStart.style.pointerEvents = "auto";
      bossStart.textContent = "Try Again";
      bossMsg.textContent = "Tip: Move in circles while shooting!";
    }

    function updateBoss(dt){
      bossGame.t += dt;

      const w = bossCanvas.getBoundingClientRect().width;
      const h = bossCanvas.getBoundingClientRect().height;

      bossGame.boss.wob += dt;
      bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 95;
      bossGame.boss.y = 95 + Math.sin(bossGame.boss.wob * 1.1) * 16;

      let mx = 0, my = 0;
      if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
      if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
      if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
      if (keys.has("ArrowDown") || keys.has("s")) my += 1;

      const speed = 4.25;
      bossGame.player.x = clamp(bossGame.player.x + mx * speed, 18, w - 18);
      bossGame.player.y = clamp(bossGame.player.y + my * speed, 120, h - 18);

      if (keys.has(" ")) shoot();

      bossGame.phaseTimer += dt;
      const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.7;
      if (bossGame.phaseTimer > 2.2) choosePattern();

      if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5){
        bossGame.phase2 = true;
        bossMsg.textContent = "PHASE 2 üò≥ BLACK HOLE PULL ACTIVATED!";
        spawnParticle(bossGame.boss.x, bossGame.boss.y, "üñ§");
      }

      if (bossGame.phase2){
        bossGame.blackHole.cool -= dt;
        if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0){
          bossGame.blackHole.active = true;
          bossGame.blackHole.timer = 1.6;
          bossGame.blackHole.cool = 4.2;
          bossMsg.textContent = "BLACK HOLE PULL üñ§üí´";
        }
        if (bossGame.blackHole.active){
          blackholeGif.style.opacity = "0.95";
          bossGame.blackHole.timer -= dt;
          if (bossGame.blackHole.timer <= 0){
            bossGame.blackHole.active = false;
            blackholeGif.style.opacity = "0";
            bossMsg.textContent = "Keep going!! Turn chaos into cuddles üò§üíû";
          } else {
            const dx = bossGame.boss.x - bossGame.player.x;
            const dy = bossGame.boss.y - bossGame.player.y;
            const d = Math.sqrt(dx*dx + dy*dy) || 1;
            const pull = 3.3 * (1 - Math.min(d / 520, 1));
            bossGame.player.x += (dx / d) * pull;
            bossGame.player.y += (dy / d) * pull;
            bossGame.player.x = clamp(bossGame.player.x, 18, w - 18);
            bossGame.player.y = clamp(bossGame.player.y, 120, h - 18);
            spawnParticle(bossGame.player.x, bossGame.player.y, "üíî");
          }
        } else {
          blackholeGif.style.opacity = "0";
        }
      } else {
        blackholeGif.style.opacity = "0";
      }

      if (bossGame.pattern === "spray"){
        if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
          const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
          const spread = 0.20 + 0.10 * intensity;
          fireBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.75*intensity, "heart");
        }
      } else if (bossGame.pattern === "ring"){
        if (bossGame.phaseTimer < dt + 0.02){
          const n = 10 + Math.floor(intensity*4);
          for (let i=0;i<n;i++){
            const a = (Math.PI*2) * (i/n);
            fireBullet(a, 2.35 + 0.7*intensity, "orb");
          }
          spawnParticle(bossGame.boss.x, bossGame.boss.y, "üíó");
        }
      } else if (bossGame.pattern === "dash"){
        if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
          const laneY = 150 + Math.random() * (h - 190);
          bossGame.bullets.push({ x:-20, y:laneY, vx: 6.2 + 1.25*intensity, vy:0, r:9, kind:"dash" });
        }
      } else if (bossGame.pattern === "spiral"){
        if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
          const base = bossGame.boss.wob * 2.2;
          fireBullet(base, 2.15 + 0.95*intensity, "heart");
        }
      }

      for (const b of bossGame.bullets){ b.x += b.vx; b.y += b.vy; }
      bossGame.bullets = bossGame.bullets.filter(b => b.x > -70 && b.x < w+70 && b.y > -70 && b.y < h+70);

      for (const p of bossGame.beams){ p.x += p.vx; p.y += p.vy; }
      bossGame.beams = bossGame.beams.filter(p => p.y > -50);

      for (const pt of bossGame.particles){
        pt.x += pt.vx; pt.y += pt.vy; pt.vy += 0.03; pt.life -= 1;
      }
      bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

      for (let i=bossGame.beams.length-1;i>=0;i--){
        const p = bossGame.beams[i];
        if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
          bossGame.beams.splice(i,1);
          bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
          spawnParticle(bossGame.boss.x, bossGame.boss.y, "‚ú®");
          setBossBars();
          if (bossGame.boss.hp <= 0) winBossFight();
        }
      }

      if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
      for (let i=bossGame.bullets.length-1;i>=0;i--){
        const b = bossGame.bullets[i];
        if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
          bossGame.bullets.splice(i,1);
          if (bossGame.player.inv <= 0){
            bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
            bossGame.player.inv = 0.9;
            spawnParticle(bossGame.player.x, bossGame.player.y, "üí•");
            setBossBars();
            if (bossGame.player.hp <= 0) loseBossFight();
          }
        }
      }
    }

    function drawBoss(){
      const w = bossCanvas.getBoundingClientRect().width;
      const h = bossCanvas.getBoundingClientRect().height;

      bossCtx.clearRect(0,0,w,h);

      const g = bossCtx.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, "rgba(2, 6, 23, 0.75)");
      g.addColorStop(1, "rgba(88, 28, 135, 0.45)");
      bossCtx.fillStyle = g;
      bossCtx.fillRect(0,0,w,h);

      bossCtx.fillStyle = "rgba(0,0,0,0.16)";
      bossCtx.fillRect(0,0,w,h);

      drawBossSprite(bossCtx, bossGame.boss.x, bossGame.boss.y);

      const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
      bossCtx.globalAlpha = blink;
      drawHeart(bossCtx, bossGame.player.x, bossGame.player.y, 14, "#ef4444");
      bossCtx.globalAlpha = 1;

      for (const b of bossGame.bullets){
        if (b.kind === "orb"){
          bossCtx.globalAlpha = 0.92;
          bossCtx.beginPath();
          bossCtx.arc(b.x,b.y,b.r,0,Math.PI*2);
          bossCtx.fillStyle = "#a78bfa";
          bossCtx.fill();
          bossCtx.globalAlpha = 1;
        } else if (b.kind === "dash"){
          bossCtx.globalAlpha = 0.95;
          bossCtx.fillStyle = "#fb7185";
          rr(bossCtx, b.x-14, b.y-5, 28, 10, 6);
          bossCtx.fill();
          bossCtx.globalAlpha = 1;
        } else {
          bossCtx.globalAlpha = 0.92;
          drawHeart(bossCtx, b.x, b.y, b.r, "#f43f5e");
          bossCtx.globalAlpha = 1;
        }
      }

      for (const p of bossGame.beams){
        bossCtx.globalAlpha = 0.88;
        bossCtx.fillStyle = "#22c55e";
        rr(bossCtx, p.x-3, p.y-12, 6, 24, 6);
        bossCtx.fill();
        bossCtx.globalAlpha = 1;
      }

      for (const pt of bossGame.particles){
        bossCtx.globalAlpha = clamp(pt.life/40, 0, 1);
        bossCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
        bossCtx.fillText(pt.emoji, pt.x, pt.y);
      }
      bossCtx.globalAlpha = 1;
    }

    function bossLoop(ts){
      if (!bossGame.running) return;
      if (!bossGame.lastTs) bossGame.lastTs = ts;
      const dt = Math.min(0.033, (ts - bossGame.lastTs) / 1000);
      bossGame.lastTs = ts;

      updateBoss(dt);
      drawBoss();

      bossGame.raf = requestAnimationFrame(bossLoop);
    }

    bossCanvas.addEventListener("pointerdown", () => {
      if (!bossGame.running) return;
      shoot();
    });

    bossStart.addEventListener("click", () => {
      resetBossFight();
      bossGame.running = true;
      bossOverlay.style.opacity = "0";
      bossStart.style.opacity = "0";
      bossStart.style.pointerEvents = "none";
      bossMsg.textContent = "Boss is being dramatic üò≥ Hit him with LOVE BEAMS.";
      document.body.classList.add("boss-mode");
      bossGame.lastTs = 0;
      bossGame.raf = requestAnimationFrame(bossLoop);
    });

    resetBossFight();

    /* =========================================================
       Romance arcade system (spellbook + tokens + battle)
    ========================================================= */
    const tcgCard = $("tcgCard");
    const altArtBtn = $("altArtBtn");
    const artCaption = $("artCaption");
    const cardArt = $("cardArt");
    const flavorQuote = $("flavorQuote");
    const loveLetterLine = $("loveLetterLine");
    const loveLineUnlocks = $("loveLineUnlocks");
    const cinematicOverlay = $("cinematicOverlay");
    const cinematicLine = $("cinematicLine");

    const romancePhaseEl = $("romancePhase");
    const affectionFill = $("affectionFill");
    const nervesFill = $("nervesFill");
    const affectionText = $("affectionText");
    const nervesText = $("nervesText");
    const manaPoolMini = $("manaPoolMini");
    const achievementsMini = $("achievementsMini");

    const openDateModal = $("openDateModal");
    const dateModal = $("dateModal");
    const closeDateModal = $("closeDateModal");
    const spellList = $("spellList");
    const spellStack = $("spellStack");
    const chosenDate = $("chosenDate");
    const manaSpent = $("manaSpent");
    const comboBonus = $("comboBonus");
    const synergyPanel = $("synergyPanel");
    const resolveStackBtn = $("resolveStack");
    const stackUndo = $("stackUndo");
    const stackClear = $("stackClear");

    const tokenBtn = $("tokenBtn");
    const craftBtn = $("craftBtn");
    const tokenGrid = $("tokenGrid");
    const tokenCount = $("tokenCount");
    const giftCount = $("giftCount");
    const tokenLootLog = $("tokenLootLog");
    const inventoryPanel = $("inventoryPanel");

    const battleText = $("battleText");
    const battleStatus = $("battleStatus");
    const enemyHPBar = $("enemyHPBar");
    const youHPBar = $("youHPBar");
    const enemyAff = $("enemyAff");
    const youNerves = $("youNerves");
    const youNervesBar = $("youNervesBar");

    const MOVE_BTNS = document.querySelectorAll("button[data-move]");

    const STATE = {
      affection: 0,
      nerves: 25,
      phase: 1,
      mana: { choc:0, heart:0, popcorn:0, sparkle:0 },

      loveLinesUnlocked: 0,
      achievements: new Set(),

      stack: [],
      tokens: [],
      gifts: { bouquet:0, chocoBox:0, candleKit:0, dateTicket:0 },

      enemyHP: 100,
      youHP: 100,
      enemyAffection: 0,

      status: { cozy:0, confident:0, starry:0 },
      turnLock: false
    };

    const LOVE_LINES = [
      "‚ÄúIf love were a format, I‚Äôd still pick you first.‚Äù",
      "‚ÄúYour laugh is my favorite soundtrack.‚Äù",
      "‚ÄúI brought dessert‚Ä¶ but you‚Äôre the sweetest part.‚Äù",
      "‚ÄúIf my heart had a commander, it‚Äôd be you.‚Äù",
      "‚ÄúTonight‚Äôs forecast: 100% chance of me adoring you.‚Äù",
      "‚ÄúI‚Äôd shuffle the universe just to draw you.‚Äù",
      "‚ÄúYour kindness is the rarest pull.‚Äù",
      "‚ÄúNo matter the matchup, I‚Äôm on your team.‚Äù"
    ];

    const QUOTES = [
      "‚ÄúI would choose you in every draft.‚Äù",
      "‚ÄúYou‚Äôre my favorite top-deck.‚Äù",
      "‚ÄúI‚Äôm not bluffing. I like you.‚Äù",
      "‚ÄúLet‚Äôs resolve this into forever.‚Äù",
      "‚ÄúYou‚Äôre the only combo I need.‚Äù"
    ];

    const ALT_ARTS = [
      { caption:"‚ÄúDinner Date Foil‚Äù", art:"üïØÔ∏èüåπüç∑‚ú®" },
      { caption:"‚ÄúStargaze Promo‚Äù", art:"üåô‚ú®üí´üíñ" },
      { caption:"‚ÄúCozy Couch Secret Rare‚Äù", art:"üõãÔ∏èüçøüíûüß∏" },
      { caption:"‚ÄúChocolate Edition‚Äù", art:"üç´üíùüçìüíó" }
    ];

    function fmtMana(m){ return `üç´${m.choc} ‚ù§Ô∏è${m.heart} üçø${m.popcorn} ‚ú®${m.sparkle}`; }

    function addAchievement(name){
      if (STATE.achievements.has(name)) return;
      STATE.achievements.add(name);
      achievementsMini.textContent = [...STATE.achievements].slice(-3).join(" ‚Ä¢ ") || "‚Äî none yet ‚Äî";
    }

    function unlockLoveLine(){
      if (STATE.loveLinesUnlocked >= LOVE_LINES.length) return;
      STATE.loveLinesUnlocked += 1;
      loveLetterLine.textContent = LOVE_LINES[STATE.loveLinesUnlocked - 1];
      loveLineUnlocks.textContent = `${STATE.loveLinesUnlocked}/${LOVE_LINES.length} unlocked üíå`;
    }

    function updateHUD(){
      STATE.affection = clamp(STATE.affection,0,100);
      STATE.nerves = clamp(STATE.nerves,0,100);

      affectionFill.style.width = `${STATE.affection}%`;
      nervesFill.style.width = `${STATE.nerves}%`;
      affectionText.textContent = `${Math.round(STATE.affection)}%`;
      nervesText.textContent = `${Math.round(STATE.nerves)}%`;
      manaPoolMini.textContent = fmtMana(STATE.mana);

      let newPhase = 1;
      if (STATE.affection >= 66) newPhase = 3;
      else if (STATE.affection >= 33) newPhase = 2;

      if (newPhase !== STATE.phase){
        STATE.phase = newPhase;
        romancePhaseEl.textContent = newPhase === 1 ? "I" : (newPhase === 2 ? "II" : "III");
        addAchievement(`Phase ${romancePhaseEl.textContent}`);
        unlockLoveLine();
      }
    }

    function setBars(){
      enemyHPBar.style.width = `${clamp(STATE.enemyHP,0,100)}%`;
      youHPBar.style.width = `${clamp(STATE.youHP,0,100)}%`;
      enemyAff.textContent = `${Math.round(clamp(STATE.enemyAffection,0,100))}%`;
      youNerves.textContent = `${Math.round(clamp(STATE.nerves,0,100))}%`;
      youNervesBar.style.width = `${clamp(STATE.nerves,0,100)}%`;

      if (STATE.enemyHP <= 0){
        battleStatus.textContent = "Victory üíù";
      } else if (STATE.youHP <= 0){
        battleStatus.textContent = "Bonked üí•";
      } else if (STATE.enemyAffection >= 80){
        battleStatus.textContent = "Heart Melt üíû";
      } else {
        battleStatus.textContent = "Neutral";
      }
    }

    function setCardTiltFromEvent(e){
      const r = tcgCard.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width;
      const py = (e.clientY - r.top) / r.height;
      const rx = (py - 0.5) * -10;
      const ry = (px - 0.5) * 12;
      tcgCard.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    }
    tcgCard.addEventListener("mousemove", setCardTiltFromEvent);
    tcgCard.addEventListener("mouseleave", () => tcgCard.style.transform = "perspective(900px) rotateX(0deg) rotateY(0deg)");

    function showCinematic(line){
      cinematicLine.textContent = line;
      cinematicOverlay.classList.remove("hidden");
      safeConfetti({ particleCount: 80, spread: 70, origin: { y: 0.4 } });
    }
    cinematicOverlay.addEventListener("click", () => cinematicOverlay.classList.add("hidden"));

    let altIndex = 0;
    altArtBtn.addEventListener("click", () => {
      showCinematic(QUOTES[Math.floor(Math.random()*QUOTES.length)]);
      altIndex = (altIndex + 1) % ALT_ARTS.length;
      const alt = ALT_ARTS[altIndex];
      cardArt.textContent = alt.art;
      artCaption.textContent = alt.caption;

      STATE.affection += 2.5;
      STATE.nerves -= 1.0;
      unlockLoveLine();
      addAchievement("Alt art revealed");
      updateHUD();
      setBars();
    });

    const SPELLS = [
      { name:"Playlist of Us", rarity:"Uncommon", cost:{ sparkle:1 }, tags:["playlist","cozy"],
        text:"Reduce Nerves and add Confidence.",
        onResolve:(ctx)=>{ STATE.nerves -= 8; STATE.status.confident += 2; STATE.affection += 4; } },

      { name:"Candlelight Ritual", rarity:"Rare", cost:{ heart:1, sparkle:1 }, tags:["candle","cozy"],
        text:"Cozy buff. Extra affection if after Playlist.",
        onResolve:(ctx)=>{ STATE.status.cozy += 3; STATE.affection += ctx.has("playlist") ? 10 : 6; STATE.nerves -= 4; } },

      { name:"Stargaze (Two Player)", rarity:"Mythic", cost:{ sparkle:2 }, tags:["stars"],
        text:"Big affection. Bonus love line if after Candlelight.",
        onResolve:(ctx)=>{ STATE.affection += ctx.has("candle") ? 14 : 10; STATE.status.starry += 3; if (ctx.has("candle")) unlockLoveLine(); } },

      { name:"Shared Dessert", rarity:"Common", cost:{ choc:1 }, tags:["dessert"],
        text:"Heal a bit; calm nerves.",
        onResolve:(ctx)=>{ STATE.youHP = clamp(STATE.youHP + 8, 0, 100); STATE.nerves -= 3; STATE.affection += 3; } },

      { name:"Movie Night (Kicker: Blankets)", rarity:"Uncommon", cost:{ popcorn:1, heart:1 }, tags:["movie","cozy"],
        text:"Cozy buff. Stronger if Candle Kit crafted.",
        onResolve:(ctx)=>{ const bonus = (STATE.gifts.candleKit > 0) ? 2 : 1; STATE.status.cozy += 2 * bonus; STATE.affection += 5; STATE.nerves -= 2; } },

      { name:"Handhold (Split Second)", rarity:"Rare", cost:{ heart:2 }, tags:["handhold"],
        text:"Huge nerves reduction.",
        onResolve:(ctx)=>{ STATE.nerves -= 14; STATE.affection += 6; } },

      { name:"Surprise Flower Drop", rarity:"Common", cost:{ heart:1 }, tags:["flowers"],
        text:"Small affection; extra love line if Bouquet crafted.",
        onResolve:(ctx)=>{ STATE.affection += 4; if (STATE.gifts.bouquet > 0) unlockLoveLine(); } },
    ];

    function spellCostText(cost){
      const parts=[];
      if (cost.choc) parts.push(`üç´${cost.choc}`);
      if (cost.heart) parts.push(`‚ù§Ô∏è${cost.heart}`);
      if (cost.popcorn) parts.push(`üçø${cost.popcorn}`);
      if (cost.sparkle) parts.push(`‚ú®${cost.sparkle}`);
      return parts.join(" ");
    }

    function manaEnough(cost){
      return STATE.mana.choc >= (cost.choc||0) &&
             STATE.mana.heart >= (cost.heart||0) &&
             STATE.mana.popcorn >= (cost.popcorn||0) &&
             STATE.mana.sparkle >= (cost.sparkle||0);
    }

    function spendMana(cost){
      STATE.mana.choc -= (cost.choc||0);
      STATE.mana.heart -= (cost.heart||0);
      STATE.mana.popcorn -= (cost.popcorn||0);
      STATE.mana.sparkle -= (cost.sparkle||0);
    }

    function computeCombo(){
      const tags = new Set(STATE.stack.flatMap(s => s.tags));
      const has = (t)=>tags.has(t);
      if (has("playlist") && has("candle") && has("stars")) return "‚ú® Perfect Date Combo";
      if (has("movie") && has("cozy")) return "üõãÔ∏è Cozy Combo";
      if (has("dessert") && has("handhold")) return "üç∞ Brave Sweetheart Combo";
      return "";
    }

    function updateSynergy(){
      const combo = computeCombo();
      comboBonus.textContent = combo || "None";
      if (!combo){
        synergyPanel.textContent = "Add spells to see combo effects.";
        return;
      }
      if (combo.includes("Perfect Date")){
        synergyPanel.innerHTML = `<div><b>${combo}</b></div>
          <div class="mt-2 opacity-90">Resolve: +Affection, -Nerves, grants Starry + Cozy + Confident, unlocks extra line üíå</div>`;
      } else if (combo.includes("Cozy")){
        synergyPanel.innerHTML = `<div><b>${combo}</b></div>
          <div class="mt-2 opacity-90">Resolve: Cozy stacks last longer, pressure reduced.</div>`;
      } else {
        synergyPanel.innerHTML = `<div><b>${combo}</b></div>
          <div class="mt-2 opacity-90">Resolve: big nerves drop + affection spike.</div>`;
      }
    }

    function renderSpellList(){
      spellList.innerHTML = "";
      SPELLS.forEach(sp => {
        const btn = document.createElement("button");
        btn.className = "rounded-2xl p-4 bg-white/85 border border-white/60 shadow active:scale-95 transition text-left";
        btn.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="font-black text-slate-800/80">${sp.name}</div>
            <div class="text-xs font-black text-slate-700/70">${sp.rarity}</div>
          </div>
          <div class="mt-1 text-xs font-black text-slate-700/70">Cost: ${spellCostText(sp.cost) || "Free"}</div>
          <div class="mt-2 text-sm font-semibold text-slate-800/80">${sp.text}</div>
          <div class="mt-2 text-xs font-black text-slate-700/70">Tags: ${sp.tags.join(", ")}</div>
        `;
        btn.addEventListener("click", () => {
          if (!manaEnough(sp.cost)){
            battleText.textContent = "Not enough mana üíî (Create tokens first!)";
            return;
          }
          spendMana(sp.cost);
          STATE.stack.push(sp);
          addAchievement("Added to stack");
          renderStack();
          updateSynergy();
          updateHUD();
          setBars();
        });
        spellList.appendChild(btn);
      });
    }

    function renderStack(){
      if (STATE.stack.length === 0){
        spellStack.innerHTML = `<div class="opacity-70">‚Äî empty ‚Äî</div>`;
        chosenDate.innerHTML = `Selected spell: <b>None yet</b>`;
        manaSpent.textContent = fmtMana(STATE.mana);
        comboBonus.textContent = "None";
        return;
      }

      spellStack.innerHTML = "";
      STATE.stack.slice().reverse().forEach((sp, idx) => {
        const row = document.createElement("div");
        row.className = "rounded-xl bg-white/85 border border-white/60 p-3 shadow flex items-center justify-between gap-2";
        row.innerHTML = `
          <div>
            <div class="font-black">${sp.name}</div>
            <div class="text-xs font-black text-slate-700/70">${sp.rarity} ‚Ä¢ ${spellCostText(sp.cost) || "Free"}</div>
          </div>
          <div class="text-xs font-black text-slate-700/70">#${STATE.stack.length - idx}</div>
        `;
        spellStack.appendChild(row);
      });

      const top = STATE.stack[STATE.stack.length - 1];
      chosenDate.innerHTML = `Selected spell: <b>${top.name}</b>`;
      manaSpent.textContent = fmtMana(STATE.mana);
      comboBonus.textContent = computeCombo() || "None";
    }

    function resolveStack(){
      if (STATE.stack.length === 0 || STATE.turnLock) return;
      STATE.turnLock = true;
      addAchievement("Resolved stack");
      battleText.textContent = "Resolving the stack‚Ä¶ ‚ú®";

      const tags = new Set(STATE.stack.flatMap(s => s.tags));
      const ctx = { has:(t)=>tags.has(t) };

      let i = STATE.stack.length - 1;
      const tick = () => {
        if (i < 0){
          const combo = computeCombo();
          if (combo.includes("Perfect Date")){
            STATE.affection += 8;
            STATE.nerves -= 6;
            STATE.status.cozy += 2;
            STATE.status.confident += 2;
            STATE.status.starry += 2;
            unlockLoveLine();
          }

          STATE.stack = [];
          renderStack();
          updateSynergy();
          updateHUD();

          battleText.textContent = "Stack resolved üíñ Your aura is dangerously charming.";
          safeConfetti({ particleCount: 120, spread: 90, origin: { y: 0.7 } });
          STATE.turnLock = false;
          setBars();
          return;
        }

        const sp = STATE.stack[i];
        battleText.textContent = `‚ú® Resolving: ${sp.name}`;
        sp.onResolve(ctx);
        updateHUD();
        setBars();
        i -= 1;
        setTimeout(tick, 520);
      };
      tick();
    }

    openDateModal.addEventListener("click", () => {
      dateModal.classList.remove("hidden");
      renderSpellList();
      renderStack();
      updateSynergy();
    });

    closeDateModal.addEventListener("click", () => dateModal.classList.add("hidden"));
    dateModal.addEventListener("click", (e) => {
      if (e.target && e.target.dataset && e.target.dataset.close) dateModal.classList.add("hidden");
    });

    stackUndo.addEventListener("click", () => {
      if (STATE.stack.length === 0) return;
      const sp = STATE.stack.pop();
      STATE.mana.choc += (sp.cost.choc||0);
      STATE.mana.heart += (sp.cost.heart||0);
      STATE.mana.popcorn += (sp.cost.popcorn||0);
      STATE.mana.sparkle += (sp.cost.sparkle||0);
      renderStack(); updateSynergy(); updateHUD(); setBars();
    });

    stackClear.addEventListener("click", () => {
      while (STATE.stack.length){
        const sp = STATE.stack.pop();
        STATE.mana.choc += (sp.cost.choc||0);
        STATE.mana.heart += (sp.cost.heart||0);
        STATE.mana.popcorn += (sp.cost.popcorn||0);
        STATE.mana.sparkle += (sp.cost.sparkle||0);
      }
      renderStack(); updateSynergy(); updateHUD(); setBars();
    });

    resolveStackBtn.addEventListener("click", resolveStack);

    // ---- Tokens ----
    const TOKEN_TABLE = [
      { emoji:"üåπ", type:"rose",    mana:{ heart:1 },   w:30 },
      { emoji:"üç´", type:"choc",    mana:{ choc:1 },    w:26 },
      { emoji:"üçø", type:"popcorn", mana:{ popcorn:1 }, w:18 },
      { emoji:"‚ú®", type:"sparkle", mana:{ sparkle:1 }, w:22 },
      { emoji:"üïØÔ∏è", type:"candle", mana:{ sparkle:1 }, w:12 },
      { emoji:"‚ù§Ô∏è", type:"heart",  mana:{ heart:1 },   w:16 },
    ];

    const RARITIES = [
      { name:"Common", chance:0.70, glow:"none" },
      { name:"Uncommon", chance:0.22, glow:"0 10px 30px rgba(99,102,241,0.20)" },
      { name:"Rare", chance:0.07, glow:"0 12px 38px rgba(236,72,153,0.22)" },
      { name:"Mythic", chance:0.01, glow:"0 16px 55px rgba(34,197,94,0.22)" },
    ];

    function rollRarity(){
      const r = Math.random(); let acc = 0;
      for (const rr of RARITIES){
        acc += rr.chance;
        if (r <= acc) return rr;
      }
      return RARITIES[0];
    }

    function weightedPick(items){
      const total = items.reduce((a,i)=>a+i.w,0);
      let r = Math.random()*total;
      for (const it of items){
        r -= it.w;
        if (r <= 0) return it;
      }
      return items[0];
    }

    function addManaFromToken(tok){
      if (tok.mana.choc) STATE.mana.choc += tok.mana.choc;
      if (tok.mana.heart) STATE.mana.heart += tok.mana.heart;
      if (tok.mana.popcorn) STATE.mana.popcorn += tok.mana.popcorn;
      if (tok.mana.sparkle) STATE.mana.sparkle += tok.mana.sparkle;
    }

    function logLoot(msg){
      tokenLootLog.textContent = `Loot log: ${msg}`;
    }

    function pushTokenToGrid(tok){
      const el = document.createElement("div");
      el.className = "rounded-xl bg-white/80 border border-white/60 shadow flex items-center justify-center text-xl select-none";
      el.style.boxShadow = tok.rarity.glow;
      el.title = `${tok.emoji} ${tok.rarity.name}`;
      el.textContent = tok.emoji;
      tokenGrid.appendChild(el);
    }

    function renderInventory(){
      const counts = {};
      for (const t of STATE.tokens) counts[t.type] = (counts[t.type]||0) + 1;

      const pretty = (k) => {
        const m = TOKEN_TABLE.find(x=>x.type===k);
        return m ? m.emoji : "üíñ";
      };

      const lines = Object.keys(counts).map(k => `${pretty(k)} ${k}: <b>${counts[k]}</b>`);

      const g = STATE.gifts;
      const giftsLine = [
        `üíê Bouquet: <b>${g.bouquet}</b>`,
        `üç´ Chocolate Box: <b>${g.chocoBox}</b>`,
        `üïØÔ∏è Candle Kit: <b>${g.candleKit}</b>`,
        `üéüÔ∏è Date Ticket: <b>${g.dateTicket}</b>`
      ].join(" ‚Ä¢ ");

      inventoryPanel.innerHTML = `
        <div>${lines.length ? lines.join(" ‚Ä¢ ") : "‚Äî empty ‚Äî"}</div>
        <div class="mt-2 opacity-90">${giftsLine}</div>
      `;
    }

    function totalGifts(){
      return Object.values(STATE.gifts).reduce((a,b)=>a+b,0);
    }

    function hasCounts(req){
      const counts = {};
      for (const t of STATE.tokens) counts[t.type] = (counts[t.type]||0)+1;
      return Object.entries(req).every(([k,v]) => (counts[k]||0) >= v);
    }

    function consumeTokens(req){
      if (!hasCounts(req)) return false;
      const needed = { ...req };
      const remaining = [];
      for (const t of STATE.tokens){
        if (needed[t.type] > 0) needed[t.type] -= 1;
        else remaining.push(t);
      }
      STATE.tokens = remaining;

      tokenGrid.innerHTML = "";
      STATE.tokens.forEach(pushTokenToGrid);
      tokenCount.textContent = String(STATE.tokens.length);
      renderInventory();
      return true;
    }

    tokenBtn.addEventListener("click", () => {
      const rarity = rollRarity();
      const base = weightedPick(TOKEN_TABLE);
      const mult = rarity.name==="Mythic" ? 3 : (rarity.name==="Rare" ? 2 : 1);

      const tok = {
        emoji: base.emoji,
        type: base.type,
        mana: {
          choc: (base.mana.choc||0)*mult,
          heart: (base.mana.heart||0)*mult,
          popcorn: (base.mana.popcorn||0)*mult,
          sparkle: (base.mana.sparkle||0)*mult
        },
        rarity
      };

      STATE.tokens.push(tok);
      addManaFromToken(tok);

      tokenCount.textContent = String(STATE.tokens.length);
      pushTokenToGrid(tok);
      renderInventory();

      STATE.affection += (rarity.name==="Mythic" ? 4 : 1.5);
      STATE.nerves -= 0.6;

      if (STATE.tokens.length >= 10) addAchievement("Token hoarder");
      if (rarity.name === "Mythic") addAchievement("Mythic pull!");
      logLoot(`${tok.rarity.name} ${tok.emoji} (+mana)`);
      updateHUD();
      setBars();
      safeConfetti({ particleCount: rarity.name==="Mythic" ? 140 : 50, spread: 80, origin: { y: 0.75 } });
    });

    craftBtn.addEventListener("click", () => {
      const recipes = [
        { name:"Bouquet", key:"bouquet", req:{ rose:2, sparkle:1 }, emoji:"üíê" },
        { name:"Chocolate Box", key:"chocoBox", req:{ choc:2, heart:1 }, emoji:"üç´" },
        { name:"Candle Kit", key:"candleKit", req:{ candle:1, sparkle:1, heart:1 }, emoji:"üïØÔ∏è" },
        { name:"Date Ticket", key:"dateTicket", req:{ popcorn:2, heart:1 }, emoji:"üéüÔ∏è" },
      ];

      // pick first craftable recipe (or tell them none)
      const craftable = recipes.find(r => hasCounts(r.req));
      if (!craftable){
        logLoot("Not enough tokens to craft üíî");
        battleText.textContent = "Need more tokens to craft a gift.";
        return;
      }

      consumeTokens(craftable.req);
      STATE.gifts[craftable.key] += 1;
      giftCount.textContent = String(totalGifts());
      addAchievement(`Crafted ${craftable.name}`);
      logLoot(`Crafted ${craftable.emoji} ${craftable.name}!`);
      STATE.affection += 6;
      STATE.nerves -= 2;

      // Gift buffs
      if (craftable.key === "bouquet") unlockLoveLine();
      if (craftable.key === "dateTicket") STATE.enemyAffection += 6;

      updateHUD();
      setBars();
      safeConfetti({ particleCount: 90, spread: 90, origin: { y: 0.75 } });
    });

    // ---- Battle moves ----
    function enemyTurn(){
      if (STATE.enemyHP <= 0 || STATE.youHP <= 0) return;

      // enemy behavior: reacts to your buffs
      const base = 6 + Math.random()*6;
      const nerveHit = (STATE.status.confident > 0 ? base*0.45 : base*0.75);

      STATE.nerves += nerveHit;
      STATE.youHP -= (STATE.status.cozy > 0 ? base*0.55 : base*0.75);

      // enemy affection rises as you get affectionate
      STATE.enemyAffection += 2.2 + (STATE.status.starry > 0 ? 1.5 : 0.6);

      battleText.textContent = "Enemy: suspiciously charmed‚Ä¶ but still dramatic üí´";
      setBars();
      updateHUD();
    }

    function applyMove(name){
      if (STATE.turnLock) return;
      if (STATE.enemyHP <= 0 || STATE.youHP <= 0){
        battleText.textContent = "Battle is over. Refresh for a full reset üíû";
        return;
      }

      STATE.turnLock = true;

      if (name === "Compliment Beam"){
        const dmg = 10 + (STATE.status.confident*2);
        STATE.enemyHP -= dmg;
        STATE.enemyAffection += 10;
        STATE.affection += 4;
        battleText.textContent = `Compliment Beam! Enemy HP -${Math.round(dmg)} üíò`;
      } else if (name === "Snack Shield"){
        const heal = 9 + (STATE.gifts.chocoBox > 0 ? 4 : 0);
        STATE.youHP = clamp(STATE.youHP + heal, 0, 100);
        STATE.nerves -= 8;
        STATE.affection += 2;
        battleText.textContent = `Snack Shield! You healed +${Math.round(heal)} üç´`;
      } else if (name === "Laugh Attack"){
        const spike = 6 + Math.random()*6;
        STATE.enemyAffection += 14;
        STATE.enemyHP -= spike;
        STATE.nerves -= 6;
        STATE.affection += 3;
        battleText.textContent = `Laugh Attack! Enemy melts a little üòÜüíû`;
      } else if (name === "Cozy Aura"){
        STATE.status.cozy += 2;
        STATE.status.confident += 1;
        STATE.nerves -= 4;
        STATE.affection += 3;
        battleText.textContent = "Cozy Aura! You feel safer üõãÔ∏è‚ú®";
      }

      // decay buffs gently
      STATE.status.cozy = Math.max(0, STATE.status.cozy - 0.2);
      STATE.status.confident = Math.max(0, STATE.status.confident - 0.15);
      STATE.status.starry = Math.max(0, STATE.status.starry - 0.1);

      setBars();
      updateHUD();

      // check victory
      if (STATE.enemyHP <= 0){
        battleText.textContent = "Victory! The wild Valentine surrendered üíù";
        addAchievement("Battle win");
        unlockLoveLine();
        safeConfetti({ particleCount: 180, spread: 95, origin: { y: 0.7 } });
        STATE.turnLock = false;
        return;
      }

      // enemy response
      setTimeout(() => {
        enemyTurn();

        if (STATE.youHP <= 0){
          battleText.textContent = "You got bonked üí• Try crafting gifts / reducing nerves!";
          addAchievement("Battle loss");
        } else if (STATE.enemyAffection >= 100){
          battleText.textContent = "Heart Melt! Enemy affection maxed üíû";
          addAchievement("Heart Melt");
          unlockLoveLine();
          safeConfetti({ particleCount: 140, spread: 90, origin: { y: 0.7 } });
        }

        setBars();
        updateHUD();
        STATE.turnLock = false;
      }, 540);
    }

    MOVE_BTNS.forEach(btn => {
      btn.addEventListener("click", () => applyMove(btn.dataset.move));
    });

    // init
    renderInventory();
    updateHUD();
    setBars();

  })();
  </script>

  <!-- =========================================================
       PLATFORMER SCRIPT (separate, fixed)
       Fixes:
       - was inserted into HTML without <script> tag (now valid)
       - uses correct element IDs (platCanvas, platStart, platOverlay, platMsg, platCount)
       - defines missing helpers: clamp2, roundRectPath, drawHeartShape
       - uses separate key set so it won‚Äôt fight boss keys
  ========================================================== -->
  <script>
  (() => {
    "use strict";

    const platCanvas = document.getElementById("platCanvas");
    const platCtx = platCanvas.getContext("2d");
    const platStartBtn = document.getElementById("platStart");
    const platOverlay = document.getElementById("platOverlay");
    const platMsg = document.getElementById("platMsg");
    const platCountEl = document.getElementById("platCount");

    function fitCanvasToCSS(canvas, ctx){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.floor(rect.width  * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    fitCanvasToCSS(platCanvas, platCtx);

    // platformer-only keys
    const platKeys = new Set();
    window.addEventListener("keydown", (e) => {
      if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," ", "Shift", "x"].includes(e.key)){
        platKeys.add(e.key);
        if (e.key === " ") e.preventDefault();
      }
    }, { passive:false });
    window.addEventListener("keyup", (e) => platKeys.delete(e.key));

    // helpers
    function clamp2(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function rectsOverlap(a, b){
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }
    function rand(min, max){ return min + Math.random()*(max-min); }

    function roundRectPath(ctx, x,y,w,h,r){
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y,   x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x,   y+h, r);
      ctx.arcTo(x,   y+h, x,   y,   r);
      ctx.arcTo(x,   y,   x+w, y,   r);
      ctx.closePath();
    }

    function drawHeartShape(ctx, x, y, s){
      ctx.beginPath();
      ctx.moveTo(x, y + s*0.25);
      ctx.bezierCurveTo(x - s, y - s*0.35, x - s*0.6, y - s, x, y - s*0.45);
      ctx.bezierCurveTo(x + s*0.6, y - s, x + s, y - s*0.35, x, y + s*0.25);
      ctx.closePath();
    }

    const VDAY = {
      pink: "#ff4d8d",
      hotPink: "#ff2d6d",
      blush: "#ffd1dc",
      cream: "#fff5f7",
      lavender: "#d8ccff",
      mint: "#bff7e6",
      cocoa: "#6b3f2a",
      ink: "rgba(15,23,42,0.20)"
    };

    const SWEETS = ["üç´", "üåπ", "üíñ", "üçì", "üßÅ", "üç¨", "üç™"];

    // ‚ÄúRooms‚Äù (camera snap)
    const ROOM_W = 520;
    const ROOM_COUNT = 12;
    const LEVEL_W = ROOM_W * ROOM_COUNT;

    const platGame = {
      running: false,
      heartsTarget: 36,
      heartsGot: 0,

      camX: 0,
      levelW: LEVEL_W,

      gravity: 0.72,
      maxFall: 16.2,
      accel: 0.70,
      maxRun: 4.95,
      friction: 0.76,

      jumpVel: -9.45,
      wallJumpX: 6.15,
      wallJumpY: -9.10,
      wallSlideMax: 2.65,

      coyoteMax: 0.035,
      jumpBufferMax: 0.045,

      dashSpeed: 10.2,
      dashDuration: 0.115,
      dashCooldown: 0.070,

      featherMaxT: 4.25,
      featherAccel: 0.55,
      featherMaxV: 5.8,
      featherDamp: 0.90,

      bSideTreatReset: true,

      player: {
        x: 60, y: 160, w: 18, h: 22,
        vx: 0, vy: 0,
        onGround: false,
        onWall: 0,
        facing: 1,
        coyote: 0,
        jumpBuffer: 0,
        dashAvail: 1,
        dashT: 0,
        dashCd: 0,
        featherT: 0
      },

      segment: 0,
      segCommitted: [],
      segCurrentCount: 0,

      spawn: { x: 60, y: 160 },
      deaths: 0,

      platforms: [],
      movers: [],
      crumble: [],

      hazards: [],
      hazardMovers: [],
      windZones: [],
      noWallZones: [],

      hearts: [],
      dashCrystals: [],
      feathers: [],
      checkpoints: [],

      goal: { x: LEVEL_W - 95, y: 128, w: 28, h: 28 },

      bg: { lights: [], sparkles: [], skyline: [] },

      prev: { jump: false, dash: false }
    };

    function initDinnerBackground(){
      const w = platCanvas.getBoundingClientRect().width;
      const h = platCanvas.getBoundingClientRect().height;

      platGame.bg.lights = Array.from({ length: 22 }, (_, i) => ({
        t: i / 21,
        phase: rand(0, Math.PI*2),
        a: rand(0.45, 0.98)
      }));

      platGame.bg.sparkles = Array.from({ length: 30 }, () => ({
        x: rand(0, w),
        y: rand(0, h*0.65),
        r: rand(2, 8),
        a: rand(0.05, 0.17),
        phase: rand(0, Math.PI*2)
      }));

      platGame.bg.skyline = Array.from({ length: 36 }, (_, i) => ({
        x: i * 70,
        w: rand(35, 72),
        h: rand(30, 130),
        windows: Math.floor(rand(2, 6))
      }));
    }

    function drawDinnerBackground(ctx, w, h, cam, t){
      const sky = ctx.createLinearGradient(0,0,0,h);
      sky.addColorStop(0, "rgba(22, 6, 34, 1)");
      sky.addColorStop(0.55, "rgba(88, 18, 70, 1)");
      sky.addColorStop(1, "rgba(255, 77, 141, 0.30)");
      ctx.fillStyle = sky;
      ctx.fillRect(0,0,w,h);

      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      for (const s of platGame.bg.sparkles){
        const pulse = 0.5 + 0.5*Math.sin(t*1.6 + s.phase);
        ctx.globalAlpha = s.a * (0.6 + 0.6*pulse);
        ctx.beginPath();
        ctx.ellipse(s.x, s.y, s.r*(0.9+pulse*0.4), s.r*(0.9+pulse*0.4), 0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255, 245, 247, 1)";
        ctx.fill();
      }
      ctx.restore();
      ctx.globalAlpha = 1;

      const wx = w*0.12, wy = h*0.08, ww = w*0.76, wh = h*0.58;

      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = "rgba(10, 8, 18, 0.55)";
      roundRectPath(ctx, wx-10, wy-10, ww+20, wh+20, 22);
      ctx.fill();

      ctx.fillStyle = "rgba(255, 255, 255, 0.06)";
      roundRectPath(ctx, wx, wy, ww, wh, 18);
      ctx.fill();

      ctx.strokeStyle = "rgba(255, 245, 247, 0.18)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(wx + ww*0.5, wy); ctx.lineTo(wx + ww*0.5, wy+wh);
      ctx.moveTo(wx, wy+wh*0.55); ctx.lineTo(wx+ww, wy+wh*0.55);
      ctx.stroke();
      ctx.restore();

      const px = -cam * 0.12;
      const baseY = wy + wh*0.92;

      ctx.save();
      roundRectPath(ctx, wx, wy, ww, wh, 18);
      ctx.clip();

      ctx.globalAlpha = 0.35;
      const glow = ctx.createLinearGradient(0, wy+wh*0.3, 0, baseY);
      glow.addColorStop(0, "rgba(255, 77, 141, 0.10)");
      glow.addColorStop(1, "rgba(255, 245, 247, 0.04)");
      ctx.fillStyle = glow;
      ctx.fillRect(wx, wy, ww, wh);

      ctx.globalAlpha = 0.9;
      for (const b of platGame.bg.skyline){
        const bx = wx + ((b.x + px) % (ww + 160)) - 80;
        const by = baseY - b.h;
        ctx.fillStyle = "rgba(12, 10, 22, 0.95)";
        ctx.fillRect(bx, by, b.w, b.h);

        ctx.globalAlpha = 0.12 + 0.10*Math.sin(t*0.8 + (b.x*0.03));
        ctx.fillStyle = "rgba(255, 245, 247, 1)";
        for (let r=0;r<b.windows;r++){
          const wy2 = by + 8 + r*(b.h/(b.windows+1));
          ctx.fillRect(bx + 8, wy2, 6, 4);
          if (b.w > 45) ctx.fillRect(bx + 20, wy2, 6, 4);
          if (b.w > 60) ctx.fillRect(bx + 32, wy2, 6, 4);
        }
        ctx.globalAlpha = 0.9;
      }

      ctx.restore();
      ctx.globalAlpha = 1;

      ctx.save();
      ctx.globalAlpha = 0.9;
      ctx.strokeStyle = "rgba(255, 245, 247, 0.25)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(w*0.08, h*0.07);
      ctx.quadraticCurveTo(w*0.5, h*0.02, w*0.92, h*0.07);
      ctx.stroke();

      for (const bulb of platGame.bg.lights){
        const x = w*0.08 + bulb.t*(w*0.84);
        const y = h*0.07 + Math.sin(bulb.t*Math.PI)*(-8);
        const tw = 0.45 + 0.55*Math.sin(t*3.2 + bulb.phase);
        ctx.globalAlpha = bulb.a * (0.35 + 0.65*tw);

        ctx.beginPath();
        ctx.ellipse(x, y+10, 4.5, 6, 0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255, 245, 247, 1)";
        ctx.fill();

        ctx.globalAlpha *= 0.45;
        ctx.beginPath();
        ctx.ellipse(x, y+10, 10, 14, 0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255, 77, 141, 1)";
        ctx.fill();
      }
      ctx.restore();
      ctx.globalAlpha = 1;

      ctx.save();
      ctx.globalAlpha = 0.95;
      const ty = h*0.70;
      ctx.fillStyle = "rgba(15, 10, 24, 0.75)";
      ctx.fillRect(0, ty, w, h-ty);

      const cloth = ctx.createLinearGradient(0, ty, 0, h);
      cloth.addColorStop(0, "rgba(255, 209, 220, 0.25)");
      cloth.addColorStop(1, "rgba(255, 245, 247, 0.10)");
      ctx.fillStyle = cloth;
      ctx.fillRect(0, ty+10, w, h-ty-10);

      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = "rgba(255, 245, 247, 0.65)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.ellipse(w*0.40, ty+55, 32, 14, 0, 0, Math.PI*2);
      ctx.ellipse(w*0.60, ty+55, 32, 14, 0, 0, Math.PI*2);
      ctx.stroke();

      const flick = 0.5 + 0.5*Math.sin(t*8.5);
      function candle(cx, cy){
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = "rgba(255,245,247,0.85)";
        roundRectPath(ctx, cx-6, cy-18, 12, 22, 6);
        ctx.fill();

        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.ellipse(cx, cy-25, 5, 8 + flick*2, 0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255, 190, 90, 1)";
        ctx.fill();

        ctx.globalAlpha = 0.18 + flick*0.10;
        ctx.beginPath();
        ctx.ellipse(cx, cy-25, 18, 26, 0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255, 77, 141, 1)";
        ctx.fill();
      }
      candle(w*0.50, ty+42);
      candle(w*0.48, ty+52);

      ctx.globalAlpha = 0.9;
      ctx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
      ctx.fillText("üåπ", w*0.52, ty+78);
      ctx.restore();
    }

    function drawSprinklePlatform(ctx, x, y, w, h, alpha=1){
      ctx.save();
      ctx.globalAlpha = alpha;

      ctx.globalAlpha *= 0.18;
      ctx.fillStyle = "#000";
      roundRectPath(ctx, x+2, y+4, w, h, 14);
      ctx.fill();

      ctx.globalAlpha = alpha;

      const g = ctx.createLinearGradient(x, y, x, y+h);
      g.addColorStop(0, VDAY.cream);
      g.addColorStop(1, VDAY.blush);

      ctx.fillStyle = g;
      ctx.strokeStyle = VDAY.ink;
      ctx.lineWidth = 2;
      roundRectPath(ctx, x, y, w, h, 14);
      ctx.fill();
      ctx.stroke();

      ctx.globalAlpha = alpha*0.7;
      ctx.fillStyle = "#ffffff";
      roundRectPath(ctx, x+8, y+6, Math.max(0, w-16), Math.max(0, h-12), 12);
      ctx.fill();
      ctx.globalAlpha = alpha;

      for (let i = 0; i < Math.floor(w / 22); i++){
        const sx = x + 14 + i*22 + (Math.random()*4);
        const sy = y + 8 + (Math.random()*(h-16));
        ctx.save();
        ctx.translate(sx, sy);
        ctx.rotate((Math.random()*0.8)-0.4);
        ctx.globalAlpha = alpha*0.9;
        ctx.fillStyle = Math.random() < 0.5 ? VDAY.lavender : VDAY.mint;
        ctx.fillRect(-5, -1.5, 10, 3);
        ctx.restore();
      }

      ctx.font = "12px system-ui, Apple Color Emoji, Segoe UI Emoji";
      ctx.globalAlpha = alpha*0.35;
      const count = Math.max(1, Math.floor(w / 90));
      for (let i=0;i<count;i++){
        ctx.fillText("üíó", x + 18 + i*(w/(count)), y + h - 6);
      }

      ctx.restore();
    }

    function drawCupidHeart(ctx, cx, cy, size){
      ctx.save();
      ctx.translate(cx, cy);

      ctx.fillStyle = VDAY.hotPink;
      drawHeartShape(ctx, 0, 2, size);
      ctx.fill();

      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "#fff";
      drawHeartShape(ctx, -3, -2, size*0.55);
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.strokeStyle = "rgba(255,255,255,0.9)";
      ctx.lineWidth = 2;
      ctx.lineCap = "round";

      ctx.beginPath();
      ctx.moveTo(-size*0.9, -1);
      ctx.quadraticCurveTo(-size*1.25, -size*0.45, -size*0.75, -size*0.85);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(-size*0.75, 2);
      ctx.quadraticCurveTo(-size*1.1, -size*0.2, -size*0.65, -size*0.6);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(size*0.9, -1);
      ctx.quadraticCurveTo(size*1.25, -size*0.45, size*0.75, -size*0.85);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(size*0.75, 2);
      ctx.quadraticCurveTo(size*1.1, -size*0.2, size*0.65, -size*0.6);
      ctx.stroke();

      ctx.strokeStyle = "rgba(255,255,255,0.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-size*0.1, size*0.95);
      ctx.lineTo(size*0.9, size*0.15);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(size*0.85, size*0.15);
      ctx.lineTo(size*0.65, size*0.1);
      ctx.lineTo(size*0.75, size*0.3);
      ctx.stroke();

      ctx.restore();
    }

    function drawSpikes(ctx, s){
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = "rgba(255, 45, 109, 0.90)";
      ctx.strokeStyle = "rgba(15,23,42,0.18)";
      ctx.lineWidth = 1;

      const count = Math.max(1, Math.floor((s.w || s.h) / 10));
      ctx.beginPath();

      if (s.dir === "up"){
        const y = s.y + s.h;
        for (let i=0;i<count;i++){
          const x0 = s.x + (i*(s.w/count));
          const x1 = s.x + ((i+1)*(s.w/count));
          const xm = (x0+x1)/2;
          ctx.moveTo(x0, y); ctx.lineTo(xm, s.y); ctx.lineTo(x1, y);
        }
      } else if (s.dir === "down"){
        const y = s.y;
        for (let i=0;i<count;i++){
          const x0 = s.x + (i*(s.w/count));
          const x1 = s.x + ((i+1)*(s.w/count));
          const xm = (x0+x1)/2;
          ctx.moveTo(x0, y); ctx.lineTo(xm, s.y + s.h); ctx.lineTo(x1, y);
        }
      } else if (s.dir === "left"){
        const x = s.x + s.w;
        for (let i=0;i<count;i++){
          const y0 = s.y + (i*(s.h/count));
          const y1 = s.y + ((i+1)*(s.h/count));
          const ym = (y0+y1)/2;
          ctx.moveTo(x, y0); ctx.lineTo(s.x, ym); ctx.lineTo(x, y1);
        }
      } else {
        const x = s.x;
        for (let i=0;i<count;i++){
          const y0 = s.y + (i*(s.h/count));
          const y1 = s.y + ((i+1)*(s.h/count));
          const ym = (y0+y1)/2;
          ctx.moveTo(x, y0); ctx.lineTo(s.x + s.w, ym); ctx.lineTo(x, y1);
        }
      }

      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      ctx.restore();
    }

    // Level building helpers
    function addPlatform(x,y,w,h, opt={}){ platGame.platforms.push({ x,y,w,h, ...opt }); }
    function addSpikes(x,y,w,h,dir){ platGame.hazards.push({ x,y,w,h,dir }); }
    function addHazardMover(x,y,w,h, axis, range, speed){
      platGame.hazardMovers.push({ x,y,w,h, axis, range, speed, t:0 });
    }
    function addWindZone(x,y,w,h, ax, ay){ platGame.windZones.push({ x,y,w,h, ax, ay }); }
    function addNoWallZone(x,y,w,h){ platGame.noWallZones.push({ x,y,w,h }); }
    function addCrystal(x,y, dashOnly=false){ platGame.dashCrystals.push({ x,y, used:false, dashOnly }); }
    function addFeather(x,y){ platGame.feathers.push({ x,y, used:false }); }
    function addCheckpoint(x,y, segNext){ platGame.checkpoints.push({ x,y,w:26,h:40, hit:false, segNext }); }
    function addTreat(x,y, seg){
      platGame.hearts.push({ x,y, taken:false, seg, emoji: SWEETS[Math.floor(Math.random()*SWEETS.length)] });
    }

    function resetPlatformer(){
      platGame.running = false;
      platGame.deaths = 0;

      platGame.segment = 0;
      platGame.segCommitted = [0,0,0,0];
      platGame.segCurrentCount = 0;

      platGame.heartsGot = 0;
      platCountEl.textContent = "0";

      platOverlay.style.opacity = "1";
      platStartBtn.style.opacity = "1";
      platStartBtn.style.pointerEvents = "auto";
      platStartBtn.textContent = "Start C-Side++++ üíû";

      const p = platGame.player;
      p.x = 60; p.y = 160;
      p.vx = 0; p.vy = 0;
      p.onGround = false;
      p.onWall = 0;
      p.facing = 1;
      p.coyote = 0;
      p.jumpBuffer = 0;
      p.dashAvail = 1;
      p.dashT = 0;
      p.dashCd = 0;
      p.featherT = 0;

      platGame.spawn = { x: 60, y: 160 };
      platGame.camX = 0;

      platGame.platforms = [];
      platGame.movers = [];
      platGame.crumble = [];
      platGame.hazards = [];
      platGame.hazardMovers = [];
      platGame.windZones = [];
      platGame.noWallZones = [];
      platGame.hearts = [];
      platGame.dashCrystals = [];
      platGame.feathers = [];
      platGame.checkpoints = [];

      const GROUND_Y = 350;
      addPlatform(0, GROUND_Y, platGame.levelW, 95, { id:"ground" });
      const R = (i) => i * ROOM_W;

      // ROOM 0
      addPlatform(R(0)+0,   310, 240, 22);
      addPlatform(R(0)+270, 270, 60, 16);
      addPlatform(R(0)+350, 235, 58, 16, { crumble:true });
      addPlatform(R(0)+435, 260, 56, 16);
      addSpikes  (R(0)+240, 332, 30, 18, "up");
      addSpikes  (R(0)+330, 332, 20, 18, "up");
      addTreat   (R(0)+120, 265, 0);
      addTreat   (R(0)+295, 235, 0);
      addCrystal (R(0)+460, 210, false);

      // ROOM 1
      addPlatform(R(1)+120, 305, 90, 18);
      addPlatform(R(1)+255, 200, 22, 150);
      addPlatform(R(1)+345, 140, 22, 210);
      addNoWallZone(R(1)+220, 90, 260, 190);
      addSpikes(R(1)+277, 230, 14, 105, "right");
      addSpikes(R(1)+331, 190, 14, 140, "left");
      addTreat(R(1)+150, 260, 0);
      addTreat(R(1)+360, 110, 0);
      addCrystal(R(1)+410, 120, true);

      // ROOM 2
      addPlatform(R(2)+60,  300, 85, 16);
      addPlatform(R(2)+190, 235, 70, 14, { moving:true, axis:"x", range: 120, speed: 1.95 });
      addPlatform(R(2)+350, 190, 70, 14, { moving:true, axis:"y", range: 75,  speed: 1.65 });
      addPlatform(R(2)+455, 235, 70, 14, { moving:true, axis:"x", range: 115, speed: 2.15 });
      addSpikes(R(2)+0,  332, 520, 18, "up");
      addWindZone(R(2)+0, 80, 520, 250, +0.020, -0.006);
      addTreat(R(2)+85,  255, 0);
      addTreat(R(2)+420, 150, 0);
      addCrystal(R(2)+250, 170, false);

      // ROOM 3 checkpoint
      addPlatform(R(3)+40,  300, 70, 16);
      addPlatform(R(3)+430, 300, 70, 16);
      addSpikes(R(3)+120, 190, 12, 160, "right");
      addSpikes(R(3)+390, 190, 12, 160, "left");
      addSpikes(R(3)+130, 332, 260, 18, "up");
      addWindZone(R(3)+140, 90, 240, 200, 0.0, -0.020);
      addFeather(R(3)+260, 170);
      addTreat(R(3)+240, 130, 0);
      addCheckpoint(R(3)+470, 255, 1);

      // ROOM 4
      addPlatform(R(4)+20,  308, 120, 18, { conveyor:+1.05 });
      addPlatform(R(4)+170, 275, 120, 18, { conveyor:-1.05 });
      addPlatform(R(4)+320, 245, 110, 18, { conveyor:+1.15 });
      addSpikes(R(4)+0, 332, 520, 18, "up");
      addPlatform(R(4)+60,  205, 52, 16, { crumble:true });
      addPlatform(R(4)+135, 180, 52, 16, { crumble:true });
      addPlatform(R(4)+210, 155, 52, 16, { crumble:true });
      addPlatform(R(4)+285, 130, 52, 16, { crumble:true });
      addPlatform(R(4)+360, 155, 52, 16, { crumble:true });
      addTreat(R(4)+85,  255, 1);
      addTreat(R(4)+205, 235, 1);
      addTreat(R(4)+300, 210, 1);
      addCrystal(R(4)+400, 120, true);

      // ROOM 5
      addPlatform(R(5)+60,  260, 54, 16);
      addPlatform(R(5)+140, 220, 54, 16, { crumble:true });
      addPlatform(R(5)+220, 180, 54, 16);
      addPlatform(R(5)+300, 220, 54, 16, { crumble:true });
      addPlatform(R(5)+380, 260, 54, 16);
      addSpikes(R(5)+0, 332, 520, 18, "up");
      addHazardMover(R(5)+165, 290, 34, 34, "y", 110, 2.15);
      addHazardMover(R(5)+265, 295, 34, 34, "y", 95,  2.35);
      addHazardMover(R(5)+365, 292, 34, 34, "y", 120, 2.55);
      addWindZone(R(5)+0, 95, 520, 180, -0.018, 0.0);
      addTreat(R(5)+90,  210, 1);
      addTreat(R(5)+250, 150, 1);
      addTreat(R(5)+410, 210, 1);
      addCrystal(R(5)+455, 160, false);

      // ROOM 6 checkpoint
      addPlatform(R(6)+40,  308, 120, 18);
      addPlatform(R(6)+220, 150, 22, 200);
      addPlatform(R(6)+320, 110, 22, 240);
      addPlatform(R(6)+420, 150, 22, 200);
      addSpikes(R(6)+242, 180, 14, 150, "right");
      addSpikes(R(6)+306, 140, 14, 190, "left");
      addSpikes(R(6)+442, 180, 14, 150, "right");
      addNoWallZone(R(6)+180, 90, 300, 160);
      addSpikes(R(6)+180, 332, 340, 18, "up");
      addTreat(R(6)+70,  265, 1);
      addTreat(R(6)+340, 85,  1);
      addCheckpoint(R(6)+480, 255, 2);

      // ROOM 7
      addPlatform(R(7)+40,  300, 70, 16);
      addPlatform(R(7)+420, 300, 70, 16);
      addSpikes(R(7)+110, 190, 12, 160, "right");
      addSpikes(R(7)+398, 190, 12, 160, "left");
      addSpikes(R(7)+122, 332, 276, 18, "up");
      addWindZone(R(7)+140, 90, 240, 80,  +0.020, -0.010);
      addWindZone(R(7)+140, 170,240, 80,  -0.020, -0.010);
      addFeather(R(7)+260, 165);
      addCrystal(R(7)+260, 110, true);
      addTreat(R(7)+240, 125, 2);
      addTreat(R(7)+280, 125, 2);

      // ROOM 8
      addSpikes(R(8)+0, 332, 520, 18, "up");
      addPlatform(R(8)+60,  270, 70, 14, { moving:true, axis:"x", range: 160, speed: 2.55 });
      addPlatform(R(8)+220, 210, 70, 14, { moving:true, axis:"y", range: 95,  speed: 2.25 });
      addPlatform(R(8)+380, 160, 70, 14, { moving:true, axis:"x", range: 160, speed: 2.75 });
      addWindZone(R(8)+0, 90, 520, 240, +0.010, 0.0);
      addTreat(R(8)+95,  220, 2);
      addTreat(R(8)+405, 115, 2);
      addCrystal(R(8)+260, 160, false);

      // ROOM 9
      addSpikes(R(9)+0, 332, 520, 18, "up");
      for (let i=0;i<6;i++){
        addPlatform(R(9)+60 + i*70, 255 - i*18, 52, 16, { crumble:true });
        addTreat(R(9)+70 + i*70, 220 - i*18, 2);
      }
      addHazardMover(R(9)+280, 285, 34, 34, "y", 140, 2.75);
      addHazardMover(R(9)+360, 285, 34, 34, "y", 120, 2.95);
      addNoWallZone(R(9)+140, 85, 320, 170);
      addCrystal(R(9)+470, 150, true);

      // ROOM 10 checkpoint
      addPlatform(R(10)+20, 308, 110, 18);
      addPlatform(R(10)+170, 190, 22, 160);
      addPlatform(R(10)+270, 140, 22, 210);
      addSpikes(R(10)+192, 215, 14, 120, "right");
      addSpikes(R(10)+256, 160, 14, 175, "left");
      addWindZone(R(10)+0, 100, 520, 230, -0.012, 0.0);
      addTreat(R(10)+60, 265, 2);
      addCheckpoint(R(10)+480, 255, 3);

      // ROOM 11 FINAL
      addSpikes(R(11)+0, 332, 520, 18, "up");
      addPlatform(R(11)+60,  260, 54, 16);
      addPlatform(R(11)+145, 220, 54, 16, { crumble:true });
      addPlatform(R(11)+230, 180, 54, 16);
      addPlatform(R(11)+315, 220, 54, 16, { crumble:true });
      addPlatform(R(11)+400, 260, 54, 16);
      addSpikes(R(11)+130, 140, 14, 190, "right");
      addSpikes(R(11)+376, 140, 14, 190, "left");
      addFeather(R(11)+260, 145);
      addCrystal(R(11)+260, 105, true);
      addTreat(R(11)+95,  210, 3);
      addTreat(R(11)+250, 135, 3);
      addTreat(R(11)+410, 210, 3);

      addPlatform(platGame.goal.x - 30, platGame.goal.y + 40, 120, 16);

      // movers state
      platGame.movers = platGame.platforms
        .filter(p => p.moving)
        .map(p => ({ ref: p, t: 0, lastX: p.x, lastY: p.y, dx: 0, dy: 0 }));

      // crumble state
      platGame.crumble = platGame.platforms
        .filter(p => p.crumble)
        .map(p => ({ ref: p, state: "solid", t: 0, respawnT: 0 }));

      initDinnerBackground();
      platMsg.innerHTML = `ALL OF THEM mode üíò Camera-snap rooms, wind, dash-only crystals, feathers, and treat-reset deaths. Good luck, lover.`;
    }

    function recomputeHeartsGot(){
      const committed = platGame.segCommitted.reduce((a,b)=>a+b,0);
      platGame.heartsGot = committed + platGame.segCurrentCount;
      platCountEl.textContent = String(platGame.heartsGot);
    }

    function resetCurrentSegmentTreats(){
      for (const h of platGame.hearts){
        if (h.seg === platGame.segment) h.taken = false;
      }
      platGame.segCurrentCount = 0;
      recomputeHeartsGot();
    }

    function diePlatformer(){
      const p = platGame.player;
      platGame.deaths += 1;

      for (const c of platGame.dashCrystals) c.used = false;
      for (const f of platGame.feathers) f.used = false;

      for (const c of platGame.crumble){
        c.state = "solid";
        c.t = 0;
        c.respawnT = 0;
      }

      if (platGame.bSideTreatReset) resetCurrentSegmentTreats();

      p.x = platGame.spawn.x;
      p.y = platGame.spawn.y;
      p.vx = 0; p.vy = 0;
      p.onGround = false;
      p.onWall = 0;
      p.coyote = 0;
      p.jumpBuffer = 0;
      p.dashAvail = 1;
      p.dashT = 0;
      p.dashCd = 0;
      p.featherT = 0;

      platMsg.innerHTML = `üíî Respawn! Deaths: <b>${platGame.deaths}</b> ‚Ä¢ Segment: <b>${platGame.segment+1}</b>/${platGame.segCommitted.length}`;
      try { confetti({ particleCount: 20, spread: 70, origin: { y: 0.55 } }); } catch {}
    }

    function updateMovingPlatforms(dt){
      for (const m of platGame.movers){
        const p = m.ref;
        m.lastX = p.x; m.lastY = p.y;

        m.t += dt * p.speed;
        if (p.axis === "x"){
          p.x = (p.baseX ?? (p.baseX = p.x)) + Math.sin(m.t * Math.PI * 2) * p.range;
        } else {
          p.y = (p.baseY ?? (p.baseY = p.y)) + Math.sin(m.t * Math.PI * 2) * p.range;
        }

        m.dx = p.x - m.lastX;
        m.dy = p.y - m.lastY;
      }
    }

    function updateHazardMovers(dt){
      for (const hz of platGame.hazardMovers){
        hz.t += dt * hz.speed;
        const s = Math.sin(hz.t * Math.PI * 2);
        if (hz.axis === "y"){
          hz.y = (hz.baseY ?? (hz.baseY = hz.y)) + s * hz.range;
        } else {
          hz.x = (hz.baseX ?? (hz.baseX = hz.x)) + s * hz.range;
        }
      }
    }

    function updateCrumble(dt){
      for (const c of platGame.crumble){
        if (c.state === "solid") continue;
        if (c.state === "falling"){
          c.t -= dt;
          if (c.t <= 0){
            c.state = "gone";
            c.respawnT = 1.15;
          }
        } else if (c.state === "gone"){
          c.respawnT -= dt;
          if (c.respawnT <= 0){
            c.state = "solid";
            c.t = 0;
          }
        }
      }
    }

    function isPlatformSolid(plat){
      if (!plat.crumble) return true;
      const c = platGame.crumble.find(x => x.ref === plat);
      return c ? (c.state !== "gone") : true;
    }

    function inZone(list, p){
      const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
      for (const z of list){
        if (rectsOverlap(pb, z)) return true;
      }
      return false;
    }

    function moveAndCollide(dt){
      const p = platGame.player;
      p.onWall = 0;

      p.x += p.vx;
      for (const plat of platGame.platforms){
        if (!isPlatformSolid(plat)) continue;
        const a = { x: p.x, y: p.y, w: p.w, h: p.h };
        const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
        if (!rectsOverlap(a,b)) continue;

        if (p.vx > 0){
          p.x = plat.x - p.w; p.vx = 0; p.onWall = +1;
        } else if (p.vx < 0){
          p.x = plat.x + plat.w; p.vx = 0; p.onWall = -1;
        }
      }

      p.y += p.vy;
      p.onGround = false;
      let landedOn = null;

      for (const plat of platGame.platforms){
        if (!isPlatformSolid(plat)) continue;
        const a = { x: p.x, y: p.y, w: p.w, h: p.h };
        const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
        if (!rectsOverlap(a,b)) continue;

        if (p.vy > 0){
          p.y = plat.y - p.h;
          p.vy = 0;
          p.onGround = true;
          landedOn = plat;

          if (plat.moving){
            const mover = platGame.movers.find(m => m.ref === plat);
            if (mover){ p.x += mover.dx; p.y += mover.dy; }
          }
        } else if (p.vy < 0){
          p.y = plat.y + plat.h;
          p.vy = 0;
        }
      }

      if (landedOn && landedOn.conveyor){ p.x += landedOn.conveyor; }

      if (landedOn && landedOn.crumble){
        const c = platGame.crumble.find(x => x.ref === landedOn);
        if (c && c.state === "solid"){
          c.state = "falling";
          c.t = 0.20;
        }
      }
    }

    function updatePlatformer(dt){
      const w = platCanvas.getBoundingClientRect().width;

      const left  = platKeys.has("ArrowLeft")  || platKeys.has("a");
      const right = platKeys.has("ArrowRight") || platKeys.has("d");
      const up    = platKeys.has("ArrowUp")    || platKeys.has("w");
      const down  = platKeys.has("ArrowDown")  || platKeys.has("s");
      const jumpHeld = up || platKeys.has(" ") || platKeys.has("Spacebar");
      const dashHeld = platKeys.has("Shift") || platKeys.has("x");

      const pressedJump = jumpHeld && !platGame.prev.jump;
      const pressedDash = dashHeld && !platGame.prev.dash;
      platGame.prev.jump = jumpHeld;
      platGame.prev.dash = dashHeld;

      const p = platGame.player;

      if (left) p.facing = -1;
      if (right) p.facing = +1;

      updateMovingPlatforms(dt);
      updateHazardMovers(dt);
      updateCrumble(dt);

      p.jumpBuffer = Math.max(0, p.jumpBuffer - dt);
      p.coyote = Math.max(0, p.coyote - dt);
      if (pressedJump) p.jumpBuffer = platGame.jumpBufferMax;

      p.dashCd = Math.max(0, p.dashCd - dt);
      p.dashT  = Math.max(0, p.dashT  - dt);

      p.featherT = Math.max(0, p.featherT - dt);
      const feathering = p.featherT > 0;

      if (p.onGround) p.coyote = platGame.coyoteMax;

      for (const wz of platGame.windZones){
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        if (rectsOverlap(pb, wz)){
          p.vx += wz.ax * (dt * 60);
          p.vy += wz.ay * (dt * 60);
        }
      }

      if (feathering){
        p.vx *= platGame.featherDamp;
        p.vy *= platGame.featherDamp;

        const fx = (right ? 1 : 0) - (left ? 1 : 0);
        const fy = (down  ? 1 : 0) - (up   ? 1 : 0);

        p.vx += fx * platGame.featherAccel;
        p.vy += fy * platGame.featherAccel;

        p.vx = clamp2(p.vx, -platGame.featherMaxV, platGame.featherMaxV);
        p.vy = clamp2(p.vy, -platGame.featherMaxV, platGame.featherMaxV);
      } else {
        if (p.dashT <= 0){
          if (left)  p.vx -= platGame.accel;
          if (right) p.vx += platGame.accel;
          if (!left && !right) p.vx *= platGame.friction;
          p.vx = clamp2(p.vx, -platGame.maxRun, platGame.maxRun);
        }

        if (p.dashT <= 0){
          p.vy += platGame.gravity;
          p.vy = clamp2(p.vy, -22, platGame.maxFall);
        }
      }

      moveAndCollide(dt);

      const noWallHere = inZone(platGame.noWallZones, p);

      if (!feathering && !noWallHere && !p.onGround && p.onWall !== 0 && p.dashT <= 0 && p.vy > 0){
        p.vy = Math.min(p.vy, platGame.wallSlideMax);
      }

      if (p.jumpBuffer > 0){
        if (p.onGround || p.coyote > 0){
          p.vy = platGame.jumpVel;
          p.onGround = false;
          p.coyote = 0;
          p.jumpBuffer = 0;
        } else if (!feathering && !noWallHere && p.onWall !== 0){
          p.vy = platGame.wallJumpY;
          p.vx = -p.onWall * platGame.wallJumpX;
          p.jumpBuffer = 0;
        }
      }

      if (pressedDash && p.dashAvail > 0 && p.dashCd <= 0 && p.dashT <= 0){
        let dx = (right ? 1 : 0) - (left ? 1 : 0);
        let dy = (down  ? 1 : 0) - (up   ? 1 : 0);

        if (dx === 0 && dy === 0){
          dx = p.facing || 1;
          dy = 0;
        }

        const len = Math.hypot(dx, dy) || 1;
        dx /= len; dy /= len;

        p.vx = dx * platGame.dashSpeed;
        p.vy = dy * platGame.dashSpeed;
        p.dashAvail -= 1;
        p.dashT = platGame.dashDuration;
        p.dashCd = platGame.dashCooldown;
        p.onGround = false;

        try { confetti({ particleCount: 14, spread: 45, origin: { y: 0.6 } }); } catch {}
      }

      p.x = clamp2(p.x, 0, platGame.levelW - p.w);
      if (p.y > 560) diePlatformer();

      for (const h of platGame.hearts){
        if (h.taken) continue;
        const hb = { x: h.x - 9, y: h.y - 12, w: 20, h: 20 };
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        if (rectsOverlap(pb, hb)){
          h.taken = true;
          if (h.seg === platGame.segment){ platGame.segCurrentCount += 1; }
          recomputeHeartsGot();
          try { confetti({ particleCount: 45, spread: 80, origin: { y: 0.7 } }); } catch {}
          platMsg.innerHTML = `Sweet! üíû ${platGame.heartsGot}/${platGame.heartsTarget} ‚Ä¢ Deaths: <b>${platGame.deaths}</b> ‚Ä¢ Segment: <b>${platGame.segment+1}</b>`;
        }
      }

      for (const c of platGame.dashCrystals){
        if (c.used) continue;
        const cb = { x: c.x - 10, y: c.y - 10, w: 20, h: 20 };
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        if (!rectsOverlap(pb, cb)) continue;
        if (c.dashOnly && p.dashT <= 0) continue;

        c.used = true;
        p.dashAvail = 1;
        try { confetti({ particleCount: 30, spread: 70, origin: { y: 0.6 } }); } catch {}
        platMsg.innerHTML = `Dash refilled üíé ‚Ä¢ Deaths: <b>${platGame.deaths}</b>`;
      }

      for (const f of platGame.feathers){
        if (f.used) continue;
        const fb = { x: f.x - 10, y: f.y - 10, w: 20, h: 20 };
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        if (rectsOverlap(pb, fb)){
          f.used = true;
          p.featherT = platGame.featherMaxT;
          try { confetti({ particleCount: 24, spread: 70, origin: { y: 0.6 } }); } catch {}
          platMsg.innerHTML = `Feather flight ü™∂ for ${platGame.featherMaxT.toFixed(2)}s ‚Ä¢ Don‚Äôt touch üíî`;
        }
      }

      for (const cp of platGame.checkpoints){
        const cpb = { x: cp.x, y: cp.y, w: cp.w, h: cp.h };
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        if (cp.hit) continue;

        if (rectsOverlap(pb, cpb)){
          cp.hit = true;
          platGame.segCommitted[platGame.segment] = platGame.segCurrentCount;
          platGame.segment = Math.min(cp.segNext, platGame.segCommitted.length - 1);
          platGame.segCurrentCount = 0;
          recomputeHeartsGot();
          platGame.spawn = { x: cp.x, y: cp.y - 30 };
          try { confetti({ particleCount: 90, spread: 95, origin: { y: 0.6 } }); } catch {}
          platMsg.innerHTML = `Checkpoint üíå Segment advanced! ‚Ä¢ Deaths: <b>${platGame.deaths}</b>`;
        }
      }

      {
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        for (const hz of platGame.hazards){
          if (rectsOverlap(pb, hz)){ diePlatformer(); break; }
        }
      }
      {
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        for (const hz of platGame.hazardMovers){
          const hb = { x: hz.x, y: hz.y, w: hz.w, h: hz.h };
          if (rectsOverlap(pb, hb)){ diePlatformer(); break; }
        }
      }

      const roomIndex = Math.max(0, Math.min(ROOM_COUNT-1, Math.floor((p.x + p.w/2) / ROOM_W)));
      const targetCam = roomIndex * ROOM_W;
      platGame.camX = clamp2(targetCam, 0, platGame.levelW - w);

      const goal = platGame.goal;
      const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
      const gb = { x: goal.x, y: goal.y, w: goal.w, h: goal.h };
      if (rectsOverlap(pb, gb) && platGame.heartsGot >= platGame.heartsTarget){
        winPlatformer();
      }
    }

    function drawPlatformer(){
      const w = platCanvas.getBoundingClientRect().width;
      const h = platCanvas.getBoundingClientRect().height;
      platCtx.clearRect(0,0,w,h);

      const t = performance.now()/1000;
      if (!platGame.bg.lights || platGame.bg.lights.length === 0) initDinnerBackground();
      drawDinnerBackground(platCtx, w, h, platGame.camX, t);

      const cam = platGame.camX;
      platCtx.save();
      platCtx.translate(-cam, 0);

      for (const plat of platGame.platforms){
        if (plat.crumble){
          const c = platGame.crumble.find(x => x.ref === plat);
          const alpha =
            !c ? 1 :
            c.state === "solid" ? 1 :
            c.state === "falling" ? (0.55 + 0.45*(c.t/0.20)) :
            0;
          if (alpha > 0.02) drawSprinklePlatform(platCtx, plat.x, plat.y, plat.w, plat.h, alpha);
        } else {
          drawSprinklePlatform(platCtx, plat.x, plat.y, plat.w, plat.h, 1);
        }

        if (plat.conveyor){
          platCtx.save();
          platCtx.globalAlpha = 0.65;
          platCtx.font = "14px system-ui, Apple Color Emoji, Segoe UI Emoji";
          platCtx.fillText(plat.conveyor > 0 ? "‚û°Ô∏è" : "‚¨ÖÔ∏è", plat.x + plat.w/2 - 7, plat.y + plat.h - 4);
          platCtx.restore();
        }
      }

      for (const wz of platGame.windZones){
        platCtx.save();
        platCtx.globalAlpha = 0.12;
        platCtx.fillStyle = "rgba(255,245,247,1)";
        roundRectPath(platCtx, wz.x, wz.y, wz.w, wz.h, 16);
        platCtx.fill();
        platCtx.restore();
      }

      for (const nz of platGame.noWallZones){
        platCtx.save();
        platCtx.globalAlpha = 0.10;
        platCtx.fillStyle = "rgba(0,0,0,1)";
        roundRectPath(platCtx, nz.x, nz.y, nz.w, nz.h, 16);
        platCtx.fill();
        platCtx.restore();
      }

      for (const hz of platGame.hazards) drawSpikes(platCtx, hz);

      platCtx.save();
      platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
      for (const hz of platGame.hazardMovers){
        const bob = Math.sin((performance.now()/180) + hz.x*0.01) * 2;
        platCtx.globalAlpha = 0.95;
        platCtx.fillText("üíî", hz.x + hz.w/2 - 10, hz.y + hz.h/2 + 8 + bob);
      }
      platCtx.restore();

      platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
      for (const c of platGame.dashCrystals){
        if (c.used) continue;
        const bob = Math.sin((performance.now()/240) + c.x*0.02) * 2;
        platCtx.globalAlpha = c.dashOnly ? 0.85 : 0.98;
        platCtx.fillText(c.dashOnly ? "üí†" : "üíé", c.x - 10, c.y + 10 + bob);
      }
      platCtx.globalAlpha = 1;

      platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
      for (const f of platGame.feathers){
        if (f.used) continue;
        const bob = Math.sin((performance.now()/220) + f.x*0.02) * 2;
        platCtx.globalAlpha = 0.95;
        platCtx.fillText("ü™∂", f.x - 10, f.y + 10 + bob);
      }
      platCtx.globalAlpha = 1;

      for (const cp of platGame.checkpoints){
        platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
        platCtx.globalAlpha = cp.hit ? 1 : 0.65;
        platCtx.fillText(cp.hit ? "üíå" : "üìç", cp.x - 8, cp.y + 22);
      }
      platCtx.globalAlpha = 1;

      platCtx.font = "20px system-ui, Apple Color Emoji, Segoe UI Emoji";
      for (const hrt of platGame.hearts){
        if (hrt.taken) continue;
        const bob = Math.sin((performance.now()/250) + hrt.x*0.02) * 2;
        platCtx.fillText(hrt.emoji, hrt.x - 9, hrt.y + 6 + bob);
      }

      platCtx.font = "28px system-ui, Apple Color Emoji, Segoe UI Emoji";
      platCtx.fillText("üíù", platGame.goal.x - 6, platGame.goal.y + 26);

      const p = platGame.player;
      platCtx.save();
      platCtx.translate(p.x + p.w/2, p.y + p.h/2);
      const floaty = p.onGround ? 0 : Math.sin(performance.now()/120) * 1.5;
      drawCupidHeart(platCtx, 0, 2 + floaty, 13.5);

      if (p.dashT > 0){
        platCtx.globalAlpha = 0.22;
        platCtx.beginPath();
        platCtx.ellipse(0, 4, 26, 14, 0, 0, Math.PI*2);
        platCtx.fillStyle = "#fff";
        platCtx.fill();
        platCtx.globalAlpha = 1;
      }

      if (p.featherT > 0){
        platCtx.globalAlpha = 0.20;
        platCtx.beginPath();
        platCtx.ellipse(0, 4, 30, 18, 0, 0, Math.PI*2);
        platCtx.fillStyle = "rgba(255,245,247,1)";
        platCtx.fill();
        platCtx.globalAlpha = 1;
      }

      platCtx.restore();
      platCtx.restore();
    }

    let platRaf = null;
    let platLast = 0;

    function platformerLoop(ts){
      if (!platGame.running) return;
      if (!platLast) platLast = ts;

      const dt = Math.min(0.033, (ts - platLast) / 1000);
      platLast = ts;

      const steps = Math.max(1, Math.floor(dt / 0.016));
      const stepDt = dt / steps;
      for (let i=0;i<steps;i++) updatePlatformer(stepDt);

      drawPlatformer();
      platRaf = requestAnimationFrame(platformerLoop);
    }

    function startPlatformer(){
      resetPlatformer();
      platGame.running = true;
      platOverlay.style.opacity = "0";
      platStartBtn.style.opacity = "0";
      platStartBtn.style.pointerEvents = "none";

      platLast = 0;
      platRaf = requestAnimationFrame(platformerLoop);
    }

    function stopPlatformer(showOverlay = true){
      platGame.running = false;
      if (platRaf) cancelAnimationFrame(platRaf);
      platRaf = null;
      if (showOverlay){
        platOverlay.style.opacity = "1";
        platStartBtn.style.opacity = "1";
        platStartBtn.style.pointerEvents = "auto";
      }
    }

    function winPlatformer(){
      stopPlatformer(false);
      platOverlay.style.opacity = "1";
      platOverlay.innerHTML = `
        <div class="text-slate-800/90">
          <div class="text-4xl font-extrabold">DATE NIGHT DELIVERED üíù</div>
          <div class="text-sm font-semibold mt-2">C-Side++++ ‚ÄúALL OF THEM‚Äù cleared. True love. True pain. üíò</div>
          <div class="text-xs font-semibold mt-2 opacity-80">Deaths: ${platGame.deaths}</div>
        </div>
      `;
      platStartBtn.style.opacity = "1";
      platStartBtn.style.pointerEvents = "auto";
      platStartBtn.textContent = "Run It Back üíû";
      platMsg.innerHTML = `Perfect delivery üíñ`;
      try { confetti({ particleCount: 320, spread: 110, origin: { y: 0.65 } }); } catch {}
    }

    platStartBtn.addEventListener("click", startPlatformer);
    resetPlatformer();

    window.addEventListener("resize", () => {
      fitCanvasToCSS(platCanvas, platCtx);
      initDinnerBackground();
    });
  })();
  </script>

</body>
</html>
