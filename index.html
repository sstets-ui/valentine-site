<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Will you be my Valentine Andrew Getzow?</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
      /* --------- Complex dreamy background --------- */
      body {
        background:
          radial-gradient(900px 520px at 20% 15%, rgba(255, 182, 193, 0.55), transparent 60%),
          radial-gradient(900px 520px at 80% 25%, rgba(255, 105, 180, 0.28), transparent 60%),
          radial-gradient(900px 520px at 55% 85%, rgba(147, 197, 253, 0.35), transparent 60%),
          linear-gradient(180deg, #fff1f2 0%, #ffe4e6 40%, #fdf2f8 70%, #eff6ff 100%);
      }

      /* Boss mode tint */
      body.boss-mode::before{
        content:"";
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        background:
          radial-gradient(900px 520px at 55% 55%, rgba(15, 23, 42, 0.55), transparent 65%),
          linear-gradient(180deg, rgba(15,23,42,0.25), rgba(0,0,0,0.10));
        opacity: 0.85;
        mix-blend-mode: multiply;
      }

      /* ---------- BIG FULL-WIDTH TITLE ---------- */
      #bigTitle{
        position: relative;
        z-index: 3;
        text-align: center;
        font-weight: 900;
        letter-spacing: -0.02em;
        line-height: 0.95;
        font-size: clamp(2.2rem, 6vw, 4.6rem);
        color: #ffffff;
        text-shadow:
          0 4px 0 rgba(0,0,0,0.15),
          0 10px 28px rgba(0,0,0,0.22);
        margin-bottom: 1.25rem;
      }

      #bigTitle span{
        display: inline-block;
        padding: 0.18em 0.42em;
        border-radius: 999px;
        background: rgba(244, 63, 94, 0.20);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.35);
      }

      #titlePill{
        position: relative;
        display: inline-block;
        overflow: hidden;
      }

      #letsGo{
        position: absolute;
        right: 22px;
        top: 50%;
        transform: translateY(-50%) rotate(-12deg) scale(0.7);
        font-weight: 1000;
        font-size: clamp(1.15rem, 3vw, 2.1rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(0,0,0,0.92);
        text-shadow: 0 10px 18px rgba(0,0,0,0.18);
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
        z-index: 6;
      }
      #letsGo.show{
        opacity: 1;
        animation: letsGoPop 650ms cubic-bezier(.2,.9,.2,1) forwards;
      }
      @keyframes letsGoPop{
        0%   { transform: translateY(-50%) rotate(-12deg) scale(0.55); opacity: 0; }
        60%  { transform: translateY(-50%) rotate(-12deg) scale(1.05); opacity: 1; }
        100% { transform: translateY(-50%) rotate(-12deg) scale(0.92); opacity: 1; }
      }

      #bg {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      .blob {
        position: absolute;
        width: 520px;
        height: 520px;
        border-radius: 999px;
        filter: blur(55px);
        opacity: 0.55;
        transform: translate3d(0,0,0);
        mix-blend-mode: multiply;
        will-change: transform;
      }

      .blob.a {
        left: -140px;
        top: -160px;
        background: radial-gradient(circle at 30% 30%, rgba(244, 63, 94, 0.55), rgba(255, 182, 193, 0.25) 55%, transparent 70%);
        animation: floatA 14s ease-in-out infinite;
      }
      .blob.b {
        right: -160px;
        top: -120px;
        background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.45), rgba(147, 197, 253, 0.22) 55%, transparent 70%);
        animation: floatB 16s ease-in-out infinite;
      }
      .blob.c {
        left: 10%;
        bottom: -210px;
        background: radial-gradient(circle at 30% 30%, rgba(147, 197, 253, 0.45), rgba(244, 63, 94, 0.18) 55%, transparent 70%);
        animation: floatC 18s ease-in-out infinite;
      }

      @keyframes floatA { 0%,100%{ transform: translate(0,0) scale(1);} 50%{ transform: translate(80px,60px) scale(1.08);} }
      @keyframes floatB { 0%,100%{ transform: translate(0,0) scale(1);} 50%{ transform: translate(-90px,70px) scale(1.06);} }
      @keyframes floatC { 0%,100%{ transform: translate(0,0) scale(1);} 50%{ transform: translate(120px,-60px) scale(1.1);} }

      body.boss-mode .blob.a{ animation-duration: 9s; }
      body.boss-mode .blob.b{ animation-duration: 10s; }
      body.boss-mode .blob.c{ animation-duration: 11s; }

      .noise {
        position: absolute;
        inset: 0;
        opacity: 0.10;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
        background-size: 180px 180px;
      }

      .pixel-grid{
        position:absolute;
        inset:0;
        opacity:.08;
        background-image:
          linear-gradient(to right, rgba(15,23,42,.25) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(15,23,42,.25) 1px, transparent 1px);
        background-size: 26px 26px;
        mix-blend-mode: overlay;
      }

      .pixel-vibe { text-shadow: 0 2px 0 rgba(0,0,0,0.08); }
      .mascot-bounce { animation: mascotBounce 1.8s ease-in-out infinite; }
      @keyframes mascotBounce { 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-6px); } }

      #powerups{
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }
      .powerup{
        position: absolute;
        bottom: -40px;
        opacity: 0;
        animation: puFloat linear forwards;
        filter: drop-shadow(0 6px 10px rgba(0,0,0,0.12));
        will-change: transform, opacity;
        user-select: none;
      }
      @keyframes puFloat{
        0%   { transform: translateY(0) translateX(0) scale(.9) rotate(0deg); opacity: 0; }
        12%  { opacity: .9; }
        100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.2) rotate(var(--rot)); opacity: 0; }
      }

      #hearts {
        position: fixed;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
        z-index: 2;
      }
      .heart {
        position: absolute;
        bottom: -40px;
        will-change: transform, opacity;
        animation: floatUp linear forwards;
        filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08));
        user-select: none;
      }
      @keyframes floatUp {
        0%   { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
        10%  { opacity: 0.85; }
        100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1.15); opacity: 0; }
      }

      .card {
        position: relative;
        z-index: 3;
        background: rgba(255, 255, 255, 0.78);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.65);
        box-shadow: 0 22px 70px rgba(0,0,0,0.14);
      }

      #valImage {
        background: linear-gradient(135deg, rgba(255,192,203,0.25), rgba(173,216,230,0.25));
      }

      .svg-heart{
        width: 56px;
        height: 50px;
        border: 0;
        background: transparent;
        padding: 0;
        cursor: pointer;
        position: relative;
        filter: drop-shadow(0 10px 14px rgba(0,0,0,.16));
        transition: transform .12s ease, filter .12s ease, opacity .12s ease;
        will-change: transform;
      }
      .svg-heart svg{ width: 100%; height: 100%; display: block; }
      .svg-heart.yes path{ fill: #ef4444; }
      .svg-heart.no  path{ fill: #f43f5e; }

      .svg-heart span{
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(-4px);
        color: white;
        font-weight: 900;
        font-size: 11px;
        letter-spacing: .7px;
        text-shadow: 0 1px 2px rgba(0,0,0,.25);
        user-select: none;
        pointer-events: none;
      }
      .svg-heart:hover{
        transform: scale(1.06);
        filter: drop-shadow(0 12px 18px rgba(0,0,0,.18));
      }
      .svg-heart:active{ transform: scale(.96); }
      .svg-heart:focus-visible{
        outline: 3px solid rgba(239, 68, 68, .35);
        outline-offset: 6px;
      }
    </style>
  </head>

  <body class="min-h-screen flex flex-col items-center justify-center p-6">
    <div id="bg" aria-hidden="true">
      <div class="blob a"></div>
      <div class="blob b"></div>
      <div class="blob c"></div>
      <div class="noise"></div>
      <div class="pixel-grid"></div>
    </div>

    <div id="powerups" aria-hidden="true"></div>
    <div id="hearts" aria-hidden="true"></div>

    <h1 id="bigTitle" class="w-full px-4">
      <span id="titlePill">
        Will you be my Valentine Andrew Getzow? Pretty Pleases? üíò
        <span id="letsGo">LETS GOOOO</span>
      </span>
    </h1>

    <!-- ===================== BOSS FIGHT PANEL ===================== -->
    <div class="relative z-[3] w-full max-w-5xl mb-6 px-2">
      <div class="rounded-3xl border border-white/60 bg-white/70 backdrop-blur-xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3">
          <div class="font-extrabold text-slate-700 pixel-vibe">üëæ Boss Fight: MAGALOR (Love Edition)</div>
          <div class="flex items-center gap-3 text-xs font-black text-slate-700/80">
            <span>Move: WASD/Arrows</span>
            <span>‚Ä¢</span>
            <span>Attack: Space / Tap</span>
          </div>
        </div>

        <div class="px-5 pb-5">
          <!-- HUD -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
            <div>
              <div class="text-xs font-black text-slate-700/80 mb-1">YOU üíñ</div>
              <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                <div id="playerHPBar" class="h-full w-full bg-gradient-to-r from-rose-500 to-pink-500"></div>
              </div>
            </div>

            <div>
              <div class="text-xs font-black text-slate-700/80 mb-1">MAGALOR ‚òÑÔ∏è</div>
              <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                <div id="bossHPBar" class="h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"></div>
              </div>
            </div>

            <div>
              <div class="text-xs font-black text-slate-700/80 mb-1">LOVE METER üíò</div>
              <div class="h-3 rounded-full bg-white/80 border border-white/60 overflow-hidden">
                <div id="loveBar" class="h-full w-0 bg-gradient-to-r from-pink-500 via-rose-400 to-amber-300"></div>
              </div>
            </div>
          </div>

          <!-- Arena -->
          <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
            <canvas id="bossCanvas" class="w-full block h-[320px]"></canvas>

            <!-- BIG LAUGH FLASH -->
            <div id="laughFlash"
                 class="absolute top-6 left-1/2 -translate-x-1/2 text-3xl sm:text-5xl font-black tracking-widest text-slate-900 drop-shadow-lg opacity-0 pointer-events-none">
              MAGALOR: HAHAHA!
            </div>

            <div id="bossOverlay"
                 class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
              <div class="text-slate-800/80">
                <div class="text-2xl font-extrabold">Defeat MAGALOR to unlock the question üíò</div>
                <div class="text-sm font-semibold mt-2">Dodge the cursed hearts. Shoot love beams.</div>
              </div>
            </div>

            <button id="bossStart"
              class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #6366f1, #ec4899, #fb7185);">
              Start Boss Fight
            </button>
          </div>

          <div id="bossMsg" class="mt-3 text-sm font-semibold text-slate-700/80">
            Tip: NO is locked üòà Beat MAGALOR first.
          </div>
        </div>
      </div>
    </div>
    <!-- ===================== /BOSS FIGHT PANEL ===================== -->

    <!-- ===================== PLATFORMER PANEL ===================== -->
    <div class="relative z-[3] w-full max-w-5xl mb-6 px-2">
      <div class="rounded-3xl border border-white/60 bg-white/70 backdrop-blur-xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3">
          <div class="font-extrabold text-slate-700 pixel-vibe">üïπÔ∏è Platformer: Collect the Hearts</div>
          <div class="flex items-center gap-3 text-xs font-black text-slate-700/80">
            <span>Move: A/D or ‚Üê/‚Üí</span>
            <span>‚Ä¢</span>
            <span>Jump: W/‚Üë/Space</span>
          </div>
        </div>

        <div class="px-5 pb-5">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3 items-center">
            <div class="sm:col-span-2 text-sm font-semibold text-slate-700/80" id="platMsg">
              Collect <b>7</b> hearts üíñ and touch the <b>love letter</b> üíå.
            </div>
            <div class="text-xs font-black text-slate-700/80 text-right">
              Hearts: <span id="platCount">0</span>/7
            </div>
          </div>

          <div class="relative rounded-2xl border border-white/60 bg-white/55 overflow-hidden">
            <canvas id="platCanvas" class="w-full block h-[280px]"></canvas>

            <div id="platOverlay"
                 class="absolute inset-0 flex items-center justify-center text-center px-6 pointer-events-none">
              <div class="text-slate-800/80">
                <div class="text-2xl font-extrabold">Tiny Love Quest üíå</div>
                <div class="text-sm font-semibold mt-2">Jump on platforms, grab hearts, reach the letter.</div>
              </div>
            </div>

            <button id="platStart"
              class="absolute bottom-4 left-1/2 -translate-x-1/2 rounded-full px-6 py-3 font-extrabold text-white shadow-lg active:scale-95 transition"
              style="background: linear-gradient(135deg, #fb7185, #ec4899, #60a5fa);">
              Start Platformer
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- ===================== /PLATFORMER PANEL ===================== -->

    <div class="card rounded-3xl p-7 max-w-md w-full text-center">
      <div class="mx-auto mb-3 w-28 mascot-bounce">
        <div class="w-24 h-24 mx-auto">
          <svg viewBox="0 0 128 128" class="w-full h-full drop-shadow-sm" aria-hidden="true">
            <path d="M40 24 L64 10 L88 24 L82 44 H46 Z" fill="#fbbf24"/>
            <circle cx="64" cy="22" r="6" fill="#f59e0b"/>
            <ellipse cx="64" cy="62" rx="34" ry="28" fill="#60a5fa"/>
            <ellipse cx="64" cy="70" rx="26" ry="18" fill="#93c5fd" opacity="0.9"/>
            <ellipse cx="52" cy="58" rx="7" ry="10" fill="#0f172a"/>
            <ellipse cx="76" cy="58" rx="7" ry="10" fill="#0f172a"/>
            <circle cx="50" cy="55" r="2" fill="#fff"/>
            <circle cx="74" cy="55" r="2" fill="#fff"/>
            <path d="M64 64 C56 62 56 74 64 76 C72 74 72 62 64 64 Z" fill="#f59e0b"/>
            <path d="M30 92 C34 78 48 72 64 72 C80 72 94 78 98 92
                     C90 108 78 118 64 118 C50 118 38 108 30 92 Z"
                  fill="#ef4444"/>
            <path d="M38 94 C44 104 54 110 64 110 C74 110 84 104 90 94"
                  stroke="#fff" stroke-width="8" stroke-linecap="round" opacity="0.9"/>
            <rect x="92" y="70" width="8" height="30" rx="3" fill="#334155"/>
            <rect x="84" y="60" width="26" height="14" rx="6" fill="#475569"/>
            <circle cx="84" cy="67" r="6" fill="#475569"/>
          </svg>
        </div>

        <div class="mt-1 text-center font-extrabold text-sm tracking-wide text-slate-800/80 pixel-vibe">
          2/14/26
        </div>
      </div>

      <img id="valImage" class="w-full h-64 object-cover rounded-xl mb-5" alt="Valentine gif" />

      <div class="flex gap-6 justify-center mt-2">
        <button id="yesBtn" class="svg-heart yes" type="button" aria-label="Yes">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>YES</span>
        </button>

        <button id="noBtn" class="svg-heart no" type="button" aria-label="No">
          <svg viewBox="0 0 32 29" aria-hidden="true">
            <path d="M23.6,0c-3,0-5.2,1.7-6.6,3.6C15.6,1.7,13.4,0,10.4,0C4.9,0,0.8,4.9,1.1,10.4
              c0.6,9.2,14.9,18.2,15.9,18.6c1-0.4,15.3-9.4,15.9-18.6C33.2,4.9,29.1,0,23.6,0z"/>
          </svg>
          <span>NO</span>
        </button>
      </div>

      <p id="hint" class="text-sm text-gray-600 mt-4">
        Tip: click a button. If a GIF host blocks embeds, it‚Äôll auto-try another link.
      </p>
    </div>

    <script>
      // ------------------ Moving hearts ------------------
      const heartsLayer = document.getElementById("hearts");
      function spawnHeart() {
        const el = document.createElement("span");
        el.className = "heart";
        el.textContent = Math.random() > 0.25 ? "üíó" : "üíñ";
        const left = Math.random() * 100;
        const size = 14 + Math.random() * 28;
        const dur  = 5 + Math.random() * 7;
        const drift = (Math.random() * 60 - 30) + "px";
        el.style.left = left + "vw";
        el.style.fontSize = size + "px";
        el.style.opacity = (0.30 + Math.random() * 0.50).toFixed(2);
        el.style.animationDuration = dur + "s";
        el.style.setProperty("--drift", drift);
        heartsLayer.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000 + 100);
      }
      for (let i = 0; i < 14; i++) spawnHeart();
      setInterval(spawnHeart, 220);

      // ------------------ Power-ups particles ------------------
      const powerupsLayer = document.getElementById("powerups");
      function spawnPowerup(){
        const el = document.createElement("span");
        el.className = "powerup";
        const items = ["‚≠ê","ü™ô","‚ú®","üíñ","üéÆ","üíå","üåπ"];
        el.textContent = items[Math.floor(Math.random() * items.length)];
        const left = Math.random() * 100;
        const size = 14 + Math.random() * 22;
        const dur  = 6 + Math.random() * 8;
        const drift = (Math.random() * 80 - 40) + "px";
        const rot = (Math.random() * 160 - 80) + "deg";
        el.style.left = left + "vw";
        el.style.fontSize = size + "px";
        el.style.animationDuration = dur + "s";
        el.style.setProperty("--drift", drift);
        el.style.setProperty("--rot", rot);
        powerupsLayer.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000 + 200);
      }
      for (let i = 0; i < 10; i++) spawnPowerup();
      setInterval(spawnPowerup, 600);

      // ------------------ GIF loader ------------------
      const valImage = document.getElementById("valImage");
      const hint = document.getElementById("hint");

      function setImageTry(urls, failMessage) {
        let i = 0;
        const tryNext = () => {
          if (i >= urls.length) { hint.textContent = failMessage; return; }
          const url = urls[i++];
          const probe = new Image();
          probe.onload = () => { valImage.src = url; hint.textContent = ""; };
          probe.onerror = () => tryNext();
          probe.src = url;
        };
        tryNext();
      }

      const yesBtn = document.getElementById("yesBtn");
      const noBtn = document.getElementById("noBtn");

      const GIFS = {
        start: ["https://media1.tenor.com/m/rcvI6iu2HrYAAAAd/pokemon-eevee-eevee.gif"],
        yesMain: ["https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif"],
        yesFinal: [
          "https://media1.tenor.com/m/hmEGDJNxK0cAAAAd/eevee.gif",
          "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcnd5OW94bW81Zzg5MXpyMHB6eTE0azRiMGU5OHhlYTl4MmNiMHh6biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/TqK5V0YnrWaR2/200.gif"
        ],
        no: ["https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExanJvMHd5MXBwYjJsaWUxeTNrc3ptdHYzNnpndDhncXoyYzN0bnJxZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/oabY4xGwzUB8c/giphy.gif"]
      };

      setImageTry(GIFS.start, "Start GIF failed to load.");

      // ------------------ Lock NO until boss is beaten ------------------
      let noLocked = true;
      function lockNoButton() {
        noLocked = true;
        noBtn.disabled = true;
        noBtn.style.opacity = "0.55";
        noBtn.style.cursor = "not-allowed";
        noBtn.style.filter = "grayscale(0.15) drop-shadow(0 10px 14px rgba(0,0,0,.16))";
        const label = noBtn.querySelector("span");
        if (label) label.textContent = "LOCKED";
      }
      function unlockNoButton() {
        noLocked = false;
        noBtn.disabled = false;
        noBtn.style.opacity = "1";
        noBtn.style.cursor = "pointer";
        noBtn.style.filter = "drop-shadow(0 10px 14px rgba(0,0,0,.16))";
        const label = noBtn.querySelector("span");
        if (label) label.textContent = "NO";
      }
      lockNoButton();

      // ------------------ Chest-fanfare ------------------
      function playGlueSong() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const ctx = new AudioCtx();
          if (ctx.state === "suspended") ctx.resume();

          const now = ctx.currentTime;
          const bpm = 132;
          const beat = 60 / bpm;

          const delay = ctx.createDelay(1.0);
          delay.delayTime.value = 0.12;

          const feedback = ctx.createGain();
          feedback.gain.value = 0.25;

          const wet = ctx.createGain();
          wet.gain.value = 0.35;

          const dry = ctx.createGain();
          dry.gain.value = 0.85;

          delay.connect(feedback);
          feedback.connect(delay);
          delay.connect(wet);
          wet.connect(ctx.destination);
          dry.connect(ctx.destination);

          const noteToFreq = (note) => {
            if (note === "REST") return null;
            const m = /^([A-G])(#|b)?(\d)$/.exec(note);
            if (!m) return null;

            const [, letter, accidental, octaveStr] = m;
            const octave = Number(octaveStr);
            const SEMI = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };

            let n = SEMI[letter];
            if (accidental === "#") n += 1;
            if (accidental === "b") n -= 1;

            const midi = (octave + 1) * 12 + n;
            return 440 * Math.pow(2, (midi - 69) / 12);
          };

          function schedule(sequence, {
            type = "triangle",
            volume = 0.12,
            offset = 0,
            detune = 0,
            toDelay = true
          } = {}) {
            let t = now + offset;
            for (const step of sequence) {
              const dur = step.beats * beat;
              const freq = noteToFreq(step.note);
              if (freq) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);
                osc.detune.setValueAtTime(detune, t);

                const attack = Math.min(0.012, dur * 0.25);
                const release = Math.min(0.09, dur * 0.45);

                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(volume, t + attack);
                gain.gain.setValueAtTime(volume, t + Math.max(attack, dur - release));
                gain.gain.linearRampToValueAtTime(0, t + dur);

                osc.connect(gain);
                gain.connect(dry);
                if (toDelay) gain.connect(delay);

                osc.start(t);
                osc.stop(t + dur);
              }
              t += dur;
            }
            return t;
          }

          const lead = [
            { note: "C5", beats: 0.5 }, { note: "E5", beats: 0.5 }, { note: "G5", beats: 0.5 }, { note: "C6", beats: 1.5 },
            { note: "B5", beats: 0.5 }, { note: "C6", beats: 2 },
            { note: "G5", beats: 0.5 }, { note: "C6", beats: 2.5 }
          ];
          const harmony = [
            { note: "E4", beats: 0.5 }, { note: "G4", beats: 0.5 }, { note: "C5", beats: 0.5 }, { note: "E5", beats: 1.5 },
            { note: "D5", beats: 0.5 }, { note: "E5", beats: 2 },
            { note: "C5", beats: 0.5 }, { note: "E5", beats: 2.5 }
          ];

          const t1 = schedule(lead,    { type: "triangle", volume: 0.14, offset: 0.00, detune: +4 });
          const t2 = schedule(harmony, { type: "sine",     volume: 0.10, offset: 0.02, detune: -3 });

          const end = Math.max(t1, t2);
          setTimeout(() => ctx.close().catch(() => {}), Math.ceil((end - now + 0.35) * 1000));
        } catch {}
      }

      let yesFinalTimer = null;

      // ------------------ NO button gets huge + runs away ------------------
      let noScale = 1;
      let noDodges = 0;

      function applyNoTransform(extra = "") {
        const capped = Math.min(noScale, 4.5);
        noBtn.style.transform = `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) ${extra}`;
      }

      noBtn.addEventListener("mouseenter", () => {
        if (noLocked) return;
        if (noDodges < 2) return;

        const rect = noBtn.getBoundingClientRect();
        const pad = 12;
        const maxX = window.innerWidth - rect.width - pad;
        const maxY = window.innerHeight - rect.height - pad;

        const tx = Math.floor(Math.random() * maxX) - rect.left + pad;
        const ty = Math.floor(Math.random() * maxY) - rect.top + pad;

        noBtn.dataset.tx = tx;
        noBtn.dataset.ty = ty;

        noBtn.style.transition = "transform 0.15s ease";
        applyNoTransform();
      });

      // ------------------ Battle music (looped) ------------------
      let battleCtx = null;
      let battleMaster = null;
      let battleInterval = null;
      let battleStep = 0;
      let battleIntensity = 1;

      function noiseHit(ctx, time, duration, volume, cutoffHz) {
        const bufferSize = Math.floor(ctx.sampleRate * duration);
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);

        const src = ctx.createBufferSource();
        src.buffer = buffer;

        const filter = ctx.createBiquadFilter();
        filter.type = "lowpass";
        filter.frequency.setValueAtTime(cutoffHz, time);

        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(volume, time + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);

        src.connect(filter).connect(gain).connect(battleMaster);
        src.start(time);
        src.stop(time + duration);
      }

      function noteToFreqBattle(note) {
        const m = /^([A-G])(#|b)?(\d)$/.exec(note);
        if (!m) return null;
        const [, letter, accidental, octaveStr] = m;
        const octave = Number(octaveStr);
        const SEMI = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
        let n = SEMI[letter];
        if (accidental === "#") n += 1;
        if (accidental === "b") n -= 1;
        const midi = (octave + 1) * 12 + n;
        return 440 * Math.pow(2, (midi - 69) / 12);
      }

      function startBattleMusic(intensity = 1) {
        if (battleCtx) return;

        battleIntensity = intensity;

        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        battleCtx = new AudioCtx();
        if (battleCtx.state === "suspended") battleCtx.resume();

        battleMaster = battleCtx.createGain();
        battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
        battleMaster.connect(battleCtx.destination);

        battleStep = 0;

        const tick = () => {
          if (!battleCtx) return;

          const capped = Math.max(1, Math.min(battleIntensity, 6));
          const bpm = 120 + capped * 10;
          const stepDur = 60 / bpm / 2;
          const t = battleCtx.currentTime + 0.02;

          const riff = ["E3","G3","A3","G3","E3","D3","E3","B2"];
          const lead = ["E4","G4","A4","B4","A4","G4","E4","D4"];

          const bassNote = riff[battleStep % riff.length];
          const bassOsc = battleCtx.createOscillator();
          bassOsc.type = "sawtooth";
          bassOsc.frequency.setValueAtTime(noteToFreqBattle(bassNote), t);

          const bassGain = battleCtx.createGain();
          bassGain.gain.setValueAtTime(0, t);
          bassGain.gain.linearRampToValueAtTime(0.12 + capped * 0.01, t + 0.01);
          bassGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur);

          const bassFilter = battleCtx.createBiquadFilter();
          bassFilter.type = "lowpass";
          bassFilter.frequency.setValueAtTime(600 + capped * 180, t);

          bassOsc.connect(bassFilter).connect(bassGain).connect(battleMaster);
          bassOsc.start(t);
          bassOsc.stop(t + stepDur);

          if (battleStep % 2 === 0) {
            const leadNote = lead[(battleStep / 2) % lead.length];
            const leadOsc = battleCtx.createOscillator();
            leadOsc.type = "square";
            leadOsc.frequency.setValueAtTime(noteToFreqBattle(leadNote), t);

            const leadGain = battleCtx.createGain();
            leadGain.gain.setValueAtTime(0, t);
            leadGain.gain.linearRampToValueAtTime(0.07 + capped * 0.008, t + 0.008);
            leadGain.gain.exponentialRampToValueAtTime(0.0001, t + stepDur * 0.9);

            leadOsc.connect(leadGain).connect(battleMaster);
            leadOsc.start(t);
            leadOsc.stop(t + stepDur * 0.9);
          }

          const isKick = battleStep % 4 === 0 || battleStep % 4 === 2;
          const isSnare = battleStep % 4 === 1 || battleStep % 4 === 3;

          if (isKick)  noiseHit(battleCtx, t, 0.06, 0.10 + capped * 0.01, 220 + capped * 20);
          if (isSnare) noiseHit(battleCtx, t, 0.05, 0.06 + capped * 0.008, 1200 + capped * 120);
          noiseHit(battleCtx, t, 0.02, 0.03 + capped * 0.004, 6000 + capped * 300);

          battleStep++;
        };

        battleInterval = setInterval(tick, 90);
        tick();
      }

      function updateBattleIntensity(intensity) {
        battleIntensity = intensity;
        if (!battleCtx) return;
        battleMaster.gain.value = 0.12 + Math.min(battleIntensity, 6) * 0.02;
      }

      function stopBattleMusic() {
        if (battleInterval) clearInterval(battleInterval);
        battleInterval = null;
        if (battleCtx) {
          const ctx = battleCtx;
          battleCtx = null;
          battleMaster = null;
          setTimeout(() => ctx.close().catch(() => {}), 50);
        }
      }

      // ================== MAGALOR BOSS FIGHT ==================
      const bossCanvas = document.getElementById("bossCanvas");
      const bossStartBtn = document.getElementById("bossStart");
      const bossOverlay = document.getElementById("bossOverlay");
      const bossMsg = document.getElementById("bossMsg");
      const playerHPBar = document.getElementById("playerHPBar");
      const bossHPBar = document.getElementById("bossHPBar");
      const loveBar = document.getElementById("loveBar");
      const laughFlash = document.getElementById("laughFlash");

      const defaultBossOverlayHTML = bossOverlay.innerHTML;

      let bossCtx2 = bossCanvas.getContext("2d");
      let bossRaf = null;

      function fitCanvasToCSS(canvas, ctx) {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      fitCanvasToCSS(bossCanvas, bossCtx2);
      window.addEventListener("resize", () => fitCanvasToCSS(bossCanvas, bossCtx2));

      // Shared keys for both mini-games
      const keys = new Set();
      window.addEventListener("keydown", (e) => {
        if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"," "].includes(e.key)) {
          keys.add(e.key);
          if (e.key === " ") e.preventDefault();
        }
      });
      window.addEventListener("keyup", (e) => keys.delete(e.key));

      // Boss touch controls
      let bossTouchActive = false;
      let bossTouchX = 0, bossTouchY = 0;
      bossCanvas.addEventListener("pointerdown", (e) => {
        bossTouchActive = true;
        const r = bossCanvas.getBoundingClientRect();
        bossTouchX = e.clientX - r.left;
        bossTouchY = e.clientY - r.top;
        if (bossGame.running) bossShoot();
      });
      bossCanvas.addEventListener("pointermove", (e) => {
        if (!bossTouchActive) return;
        const r = bossCanvas.getBoundingClientRect();
        bossTouchX = e.clientX - r.left;
        bossTouchY = e.clientY - r.top;
      });
      window.addEventListener("pointerup", () => (bossTouchActive = false));

      const bossGame = {
        running: false,
        t: 0,
        lastShot: 0,
        phaseTimer: 0,
        pattern: "spray",
        phase2: false,
        blackHole: { active: false, timer: 0, cool: 2.0 },
        bullets: [],
        beams: [],
        particles: [],
        player: { x: 120, y: 220, r: 10, hp: 5, maxHp: 5, inv: 0 },
        boss:   { x: 0, y: 0, r: 28, hp: 100, maxHp: 100, wob: 0 }
      };

      function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
      function dist2(ax, ay, bx, by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

      function setBossBars(){
        playerHPBar.style.width = (bossGame.player.hp / bossGame.player.maxHp * 100) + "%";
        bossHPBar.style.width = (bossGame.boss.hp / bossGame.boss.maxHp * 100) + "%";
        const lovePct = (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 100;
        loveBar.style.width = lovePct.toFixed(1) + "%";
      }

      function magalorLaugh() {
        if (!laughFlash) return;
        laughFlash.style.opacity = "1";
        try {
          laughFlash.animate(
            [
              { transform: "translateX(-50%) scale(0.85)", opacity: 0 },
              { transform: "translateX(-50%) scale(1.05)", opacity: 1, offset: 0.35 },
              { transform: "translateX(-50%) scale(1.0)", opacity: 1, offset: 0.75 },
              { transform: "translateX(-50%) scale(0.95)", opacity: 0 }
            ],
            { duration: 900, easing: "cubic-bezier(.2,.9,.2,1)" }
          );
        } catch {}
        setTimeout(() => (laughFlash.style.opacity = "0"), 900);
      }

      function resetBossFight(){
        bossGame.running = false;
        bossGame.t = 0;
        bossGame.lastShot = 0;
        bossGame.phaseTimer = 0;
        bossGame.pattern = "spray";
        bossGame.phase2 = false;
        bossGame.blackHole.active = false;
        bossGame.blackHole.timer = 0;
        bossGame.blackHole.cool = 2.0;

        bossGame.bullets.length = 0;
        bossGame.beams.length = 0;
        bossGame.particles.length = 0;

        bossGame.player.x = 120;
        bossGame.player.y = 230;
        bossGame.player.hp = bossGame.player.maxHp = 5;
        bossGame.player.inv = 0;

        bossGame.boss.hp = bossGame.boss.maxHp = 100;
        bossGame.boss.wob = 0;

        setBossBars();
        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = defaultBossOverlayHTML;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Start Boss Fight";
      }

      function spawnBossParticle(x,y,emoji){
        bossGame.particles.push({
          x,y,
          vx:(Math.random()*2-1)*1.2,
          vy:(Math.random()*2-1)*1.2 - 0.8,
          life: 40 + Math.random()*20,
          emoji
        });
      }

      function bossShoot(){
        const now = performance.now();
        if (now - bossGame.lastShot < 120) return;
        bossGame.lastShot = now;

        bossGame.beams.push({
          x: bossGame.player.x,
          y: bossGame.player.y - 12,
          vx: 0,
          vy: -7.6,
          r: 6
        });

        spawnBossParticle(bossGame.player.x, bossGame.player.y-10, "üíû");
      }

      function fireBossBullet(angle, speed, kind="heart"){
        bossGame.bullets.push({
          x: bossGame.boss.x,
          y: bossGame.boss.y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          r: kind === "orb" ? 8 : 7,
          kind
        });
      }

      function chooseBossPattern(){
        const hpPct = bossGame.boss.hp / bossGame.boss.maxHp;
        const pool = hpPct > 0.65 ? ["spray","ring"]
                  : hpPct > 0.30 ? ["spray","ring","dash"]
                  : ["spray","ring","dash","spiral"];
        bossGame.pattern = pool[Math.floor(Math.random()*pool.length)];
        bossGame.phaseTimer = 0;
      }

      function roundRectPath(ctx, x, y, w, h, r) {
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }

      function drawHeartShape(ctx, x, y, size){
        ctx.beginPath();
        ctx.moveTo(x, y + size*0.25);
        ctx.bezierCurveTo(x - size, y - size*0.35, x - size*0.6, y - size, x, y - size*0.45);
        ctx.bezierCurveTo(x + size*0.6, y - size, x + size, y - size*0.35, x, y + size*0.25);
        ctx.closePath();
      }

      function updateBoss(dt){
        bossGame.t += dt;

        const w = bossCanvas.getBoundingClientRect().width;
        const h = bossCanvas.getBoundingClientRect().height;

        // Boss float
        bossGame.boss.wob += dt;
        bossGame.boss.x = w * 0.5 + Math.cos(bossGame.boss.wob * 0.9) * 95;
        bossGame.boss.y = 92 + Math.sin(bossGame.boss.wob * 1.1) * 16;

        // Player move
        let mx = 0, my = 0;
        if (keys.has("ArrowLeft") || keys.has("a")) mx -= 1;
        if (keys.has("ArrowRight") || keys.has("d")) mx += 1;
        if (keys.has("ArrowUp") || keys.has("w")) my -= 1;
        if (keys.has("ArrowDown") || keys.has("s")) my += 1;

        if (bossTouchActive){
          const dx = bossTouchX - bossGame.player.x;
          const dy = bossTouchY - bossGame.player.y;
          mx = clamp(dx / 30, -1, 1);
          my = clamp(dy / 30, -1, 1);
        }

        const speed = 4.25;
        bossGame.player.x = clamp(bossGame.player.x + mx * speed, 18, w - 18);
        bossGame.player.y = clamp(bossGame.player.y + my * speed, 120, h - 18);

        // Shoot
        if (keys.has(" ")) bossShoot();

        bossGame.phaseTimer += dt;
        const intensity = 1 + (1 - bossGame.boss.hp / bossGame.boss.maxHp) * 1.7;
        if (bossGame.phaseTimer > 2.2) chooseBossPattern();

        // Phase 2 + black hole
        if (!bossGame.phase2 && bossGame.boss.hp <= bossGame.boss.maxHp * 0.5) {
          bossGame.phase2 = true;
          magalorLaugh();
          bossMsg.textContent = "PHASE 2 üò≥ MAGALOR opened a black hole (it‚Äôs‚Ä¶ oddly romantic?)";
          try { updateBattleIntensity(5); } catch {}
          spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üñ§");
          spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíò");
        }

        if (bossGame.phase2) {
          bossGame.blackHole.cool -= dt;

          if (!bossGame.blackHole.active && bossGame.blackHole.cool <= 0) {
            bossGame.blackHole.active = true;
            bossGame.blackHole.timer = 1.6;
            bossGame.blackHole.cool = 4.2;
            magalorLaugh();
            bossMsg.textContent = "MAGALOR casts: BLACK HOLE PULL üñ§üí´ (hold on to love!)";
          }

          if (bossGame.blackHole.active) {
            bossGame.blackHole.timer -= dt;
            if (bossGame.blackHole.timer <= 0) {
              bossGame.blackHole.active = false;
              bossMsg.textContent = "Keep going!! Turn him from menace to Valentine üò§üíû";
            } else {
              const dx = bossGame.boss.x - bossGame.player.x;
              const dy = bossGame.boss.y - bossGame.player.y;
              const d = Math.sqrt(dx*dx + dy*dy) || 1;
              const pull = 3.3 * (1 - Math.min(d / 520, 1));
              bossGame.player.x += (dx / d) * pull;
              bossGame.player.y += (dy / d) * pull;
              bossGame.player.x = clamp(bossGame.player.x, 18, w - 18);
              bossGame.player.y = clamp(bossGame.player.y, 120, h - 18);
              spawnBossParticle(bossGame.player.x, bossGame.player.y, "üíî");
            }
          }
        }

        // Patterns (now heart themed)
        if (bossGame.pattern === "spray"){
          if (Math.floor(bossGame.t * 12) !== Math.floor((bossGame.t - dt) * 12)){
            const ang = Math.atan2(bossGame.player.y - bossGame.boss.y, bossGame.player.x - bossGame.boss.x);
            const spread = 0.20 + 0.10 * intensity;
            fireBossBullet(ang + (Math.random()*2-1)*spread, 3.0 + 0.75*intensity, "heart");
          }
        } else if (bossGame.pattern === "ring"){
          if (bossGame.phaseTimer < dt + 0.02){
            const n = 10 + Math.floor(intensity*4);
            for (let i=0;i<n;i++){
              const a = (Math.PI*2) * (i/n);
              fireBossBullet(a, 2.35 + 0.7*intensity, "orb");
            }
            spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíó");
          }
        } else if (bossGame.pattern === "dash"){
          if (Math.floor(bossGame.t * 5) !== Math.floor((bossGame.t - dt) * 5)){
            const laneY = 150 + Math.random() * (h - 190);
            bossGame.bullets.push({
              x: -20, y: laneY, vx: 6.2 + 1.25*intensity, vy: 0, r: 9, kind:"dash"
            });
          }
        } else if (bossGame.pattern === "spiral"){
          if (Math.floor(bossGame.t * 14) !== Math.floor((bossGame.t - dt) * 14)){
            const base = bossGame.boss.wob * 2.2;
            fireBossBullet(base, 2.15 + 0.95*intensity, "heart");
          }
        }

        // Update bullets
        for (const b of bossGame.bullets){
          b.x += b.vx;
          b.y += b.vy;
        }
        bossGame.bullets = bossGame.bullets.filter(b => b.x > -70 && b.x < w+70 && b.y > -70 && b.y < h+70);

        // Update beams
        for (const p of bossGame.beams){
          p.x += p.vx;
          p.y += p.vy;
        }
        bossGame.beams = bossGame.beams.filter(p => p.y > -50);

        // Particles
        for (const pt of bossGame.particles){
          pt.x += pt.vx;
          pt.y += pt.vy;
          pt.vy += 0.03;
          pt.life -= 1;
        }
        bossGame.particles = bossGame.particles.filter(pt => pt.life > 0);

        // Collisions: beams -> boss
        for (let i = bossGame.beams.length - 1; i >= 0; i--){
          const p = bossGame.beams[i];
          if (dist2(p.x,p.y, bossGame.boss.x,bossGame.boss.y) < (p.r + bossGame.boss.r) ** 2){
            bossGame.beams.splice(i,1);
            bossGame.boss.hp = Math.max(0, bossGame.boss.hp - 2);
            spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "‚ú®");
            spawnBossParticle(bossGame.boss.x, bossGame.boss.y, "üíò");
            setBossBars();
            if (bossGame.boss.hp <= 0) winBossFight();
          }
        }

        // Collisions: bullets -> player
        if (bossGame.player.inv > 0) bossGame.player.inv -= dt;
        for (let i = bossGame.bullets.length - 1; i >= 0; i--){
          const b = bossGame.bullets[i];
          if (dist2(b.x,b.y, bossGame.player.x,bossGame.player.y) < (b.r + bossGame.player.r) ** 2){
            bossGame.bullets.splice(i,1);
            if (bossGame.player.inv <= 0){
              bossGame.player.hp = Math.max(0, bossGame.player.hp - 1);
              bossGame.player.inv = 0.9;
              spawnBossParticle(bossGame.player.x, bossGame.player.y, "üí•");
              spawnBossParticle(bossGame.player.x, bossGame.player.y, "üíî");
              setBossBars();
              if (bossGame.player.hp <= 0) loseBossFight();
            }
          }
        }
      }

      function drawMagolorLikeBoss(ctx, x, y, scale, mood = 0){
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);

        // cape shadow/glow
        ctx.globalAlpha = 0.22;
        ctx.beginPath();
        ctx.ellipse(0, 14, 54, 28, 0, 0, Math.PI*2);
        ctx.fillStyle = "#7c3aed";
        ctx.fill();
        ctx.globalAlpha = 1;

        // main cloak (dark navy)
        ctx.beginPath();
        ctx.moveTo(-52, 10);
        ctx.quadraticCurveTo(0, 64, 52, 10);
        ctx.quadraticCurveTo(0, 36, -52, 10);
        ctx.closePath();
        ctx.fillStyle = "#0b1224";
        ctx.fill();

        // cloak inner highlight
        ctx.globalAlpha = 0.18;
        ctx.beginPath();
        ctx.moveTo(-34, 14);
        ctx.quadraticCurveTo(0, 50, 34, 14);
        ctx.quadraticCurveTo(0, 28, -34, 14);
        ctx.closePath();
        ctx.fillStyle = "#60a5fa";
        ctx.fill();
        ctx.globalAlpha = 1;

        // hood (blue)
        ctx.beginPath();
        ctx.ellipse(0, -6, 44, 38, 0, 0, Math.PI*2);
        ctx.fillStyle = "#2563eb";
        ctx.fill();

        // ear tips (like Magolor hood points)
        ctx.beginPath();
        ctx.moveTo(-24, -30);
        ctx.lineTo(-52, -58);
        ctx.lineTo(-28, -60);
        ctx.closePath();
        ctx.fillStyle = "#3b82f6";
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(24, -30);
        ctx.lineTo(52, -58);
        ctx.lineTo(28, -60);
        ctx.closePath();
        ctx.fillStyle = "#3b82f6";
        ctx.fill();

        // ear whites
        ctx.beginPath();
        ctx.moveTo(-40, -58);
        ctx.lineTo(-52, -58);
        ctx.lineTo(-44, -70);
        ctx.closePath();
        ctx.fillStyle = "#f8fafc";
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(40, -58);
        ctx.lineTo(52, -58);
        ctx.lineTo(44, -70);
        ctx.closePath();
        ctx.fillStyle = "#f8fafc";
        ctx.fill();

        // gold trim on hood
        ctx.globalAlpha = 0.9;
        ctx.beginPath();
        ctx.ellipse(0, -6, 44, 38, 0, Math.PI*0.12, Math.PI*0.88);
        ctx.strokeStyle = "#fbbf24";
        ctx.lineWidth = 6;
        ctx.stroke();
        ctx.globalAlpha = 1;

        // face (dark)
        ctx.beginPath();
        ctx.ellipse(0, -6, 30, 24, 0, 0, Math.PI*2);
        ctx.fillStyle = "#0b1020";
        ctx.fill();

        // eyes (yellow)
        const blink = 1 - Math.min(0.65, Math.max(0, mood));
        ctx.beginPath();
        ctx.ellipse(-10, -10, 5, 12*blink, 0, 0, Math.PI*2);
        ctx.ellipse( 10, -10, 5, 12*blink, 0, 0, Math.PI*2);
        ctx.fillStyle = "#fde047";
        ctx.fill();

        // scarf (white)
        ctx.beginPath();
        ctx.roundRect(-46, 4, 92, 24, 12);
        ctx.fillStyle = "#f8fafc";
        ctx.fill();

        // scarf inner shadow
        ctx.globalAlpha = 0.12;
        ctx.beginPath();
        ctx.roundRect(-42, 8, 84, 16, 10);
        ctx.fillStyle = "#0f172a";
        ctx.fill();
        ctx.globalAlpha = 1;

        // buckle (blue)
        ctx.beginPath();
        ctx.roundRect(18, 8, 22, 16, 6);
        ctx.fillStyle = "#60a5fa";
        ctx.fill();
        ctx.strokeStyle = "#2563eb";
        ctx.lineWidth = 2;
        ctx.stroke();

        // little crown/gear-ish gold detail
        ctx.beginPath();
        ctx.moveTo(-14, -38);
        ctx.lineTo(0, -54);
        ctx.lineTo(14, -38);
        ctx.closePath();
        ctx.fillStyle = "#f59e0b";
        ctx.fill();

        // hands (puffy yellow)
        ctx.beginPath();
        ctx.ellipse(-56, 10, 14, 12, 0, 0, Math.PI*2);
        ctx.ellipse( 56, 10, 14, 12, 0, 0, Math.PI*2);
        ctx.fillStyle = "#fde68a";
        ctx.fill();

        // tiny romantic sparkles
        ctx.globalAlpha = 0.65;
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(-26, -44, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc( 26, -44, 2, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;

        ctx.restore();
      }

      function drawBoss(){
        const w = bossCanvas.getBoundingClientRect().width;
        const h = bossCanvas.getBoundingClientRect().height;

        bossCtx2.clearRect(0,0,w,h);

        // Romantic arena gradient
        const g = bossCtx2.createLinearGradient(0,0,0,h);
        g.addColorStop(0, "rgba(251, 113, 133, 0.20)");
        g.addColorStop(0.55, "rgba(236, 72, 153, 0.12)");
        g.addColorStop(1, "rgba(96, 165, 250, 0.16)");
        bossCtx2.fillStyle = g;
        bossCtx2.fillRect(0,0,w,h);

        // grid
        bossCtx2.globalAlpha = 0.10;
        bossCtx2.strokeStyle = "#0f172a";
        bossCtx2.lineWidth = 1;
        for (let x=0;x<w;x+=24){ bossCtx2.beginPath(); bossCtx2.moveTo(x,0); bossCtx2.lineTo(x,h); bossCtx2.stroke(); }
        for (let y=0;y<h;y+=24){ bossCtx2.beginPath(); bossCtx2.moveTo(0,y); bossCtx2.lineTo(w,y); bossCtx2.stroke(); }
        bossCtx2.globalAlpha = 1;

        // black hole visual
        if (bossGame.phase2 && bossGame.blackHole.active) {
          bossCtx2.save();
          bossCtx2.translate(bossGame.boss.x, bossGame.boss.y);
          bossCtx2.globalAlpha = 0.22;
          bossCtx2.beginPath();
          bossCtx2.arc(0, 14, 72, 0, Math.PI * 2);
          bossCtx2.fillStyle = "#0b1020";
          bossCtx2.fill();

          bossCtx2.globalAlpha = 0.45;
          bossCtx2.beginPath();
          bossCtx2.arc(0, 14, 46, 0, Math.PI * 2);
          bossCtx2.fillStyle = "#111827";
          bossCtx2.fill();

          bossCtx2.globalAlpha = 0.8;
          bossCtx2.strokeStyle = "#ec4899";
          bossCtx2.lineWidth = 3;
          bossCtx2.beginPath();
          bossCtx2.arc(0, 14, 60, 0, Math.PI * 2);
          bossCtx2.stroke();
          bossCtx2.restore();
          bossCtx2.globalAlpha = 1;
        }

        // Boss sprite (Magolor-inspired)
        drawMagolorLikeBoss(bossCtx2, bossGame.boss.x, bossGame.boss.y, 0.70, 0);

        // Player heart
        bossCtx2.save();
        bossCtx2.translate(bossGame.player.x, bossGame.player.y);
        const blink = bossGame.player.inv > 0 ? (Math.floor(performance.now()/90)%2 ? 0.35 : 1) : 1;
        bossCtx2.globalAlpha = blink;
        bossCtx2.fillStyle = "#ef4444";
        bossCtx2.beginPath();
        bossCtx2.moveTo(0, 9);
        bossCtx2.bezierCurveTo(-16, -4, -10, -20, 0, -10);
        bossCtx2.bezierCurveTo(10, -20, 16, -4, 0, 9);
        bossCtx2.fill();
        bossCtx2.restore();

        // Bullets (heart themed)
        for (const b of bossGame.bullets){
          bossCtx2.save();
          bossCtx2.translate(b.x, b.y);
          if (b.kind === "orb"){
            bossCtx2.globalAlpha = 0.92;
            bossCtx2.beginPath(); bossCtx2.arc(0,0,b.r,0,Math.PI*2);
            bossCtx2.fillStyle = "#a78bfa";
            bossCtx2.fill();

            bossCtx2.globalAlpha = 0.75;
            drawHeartShape(bossCtx2, 0, 1, 6);
            bossCtx2.fillStyle = "#fb7185";
            bossCtx2.fill();
          } else if (b.kind === "dash"){
            bossCtx2.globalAlpha = 0.95;
            roundRectPath(bossCtx2, -14, -5, 28, 10, 6);
            bossCtx2.fillStyle = "#fb7185";
            bossCtx2.fill();

            bossCtx2.globalAlpha = 0.6;
            drawHeartShape(bossCtx2, 0, -6, 6);
            bossCtx2.fillStyle = "#fff";
            bossCtx2.fill();
          } else {
            bossCtx2.globalAlpha = 0.92;
            drawHeartShape(bossCtx2, 0, 0, b.r);
            bossCtx2.fillStyle = "#f43f5e";
            bossCtx2.fill();

            bossCtx2.globalAlpha = 0.45;
            drawHeartShape(bossCtx2, -1, -2, b.r * 0.55);
            bossCtx2.fillStyle = "#fff";
            bossCtx2.fill();
          }
          bossCtx2.restore();
        }
        bossCtx2.globalAlpha = 1;

        // Love beams
        for (const p of bossGame.beams){
          bossCtx2.save();
          bossCtx2.translate(p.x, p.y);
          bossCtx2.globalAlpha = 0.85;
          roundRectPath(bossCtx2, -3, -12, 6, 24, 6);
          bossCtx2.fillStyle = "#22c55e";
          bossCtx2.fill();
          bossCtx2.globalAlpha = 0.95;
          drawHeartShape(bossCtx2, 0, -14, 6);
          bossCtx2.fillStyle = "#fff";
          bossCtx2.fill();
          bossCtx2.restore();
        }

        // Emoji particles
        for (const pt of bossGame.particles){
          bossCtx2.globalAlpha = Math.max(0, Math.min(1, pt.life/40));
          bossCtx2.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
          bossCtx2.fillText(pt.emoji, pt.x, pt.y);
        }
        bossCtx2.globalAlpha = 1;
      }

      let bossLast = 0;
      function bossLoop(ts){
        if (!bossGame.running) return;
        if (!bossLast) bossLast = ts;
        const dt = Math.min(0.033, (ts - bossLast) / 1000);
        bossLast = ts;

        updateBoss(dt);
        drawBoss();
        bossRaf = requestAnimationFrame(bossLoop);
      }

      function startBossFight(){
        // stop platformer if running (so controls feel clean)
        stopPlatformer(false);

        resetBossFight();
        bossGame.running = true;

        bossOverlay.style.opacity = "0";
        bossStartBtn.style.opacity = "0";
        bossStartBtn.style.pointerEvents = "none";

        bossMsg.textContent = "MAGALOR is being dramatic üò≥ Hit him with LOVE BEAMS.";
        document.body.classList.add("boss-mode");
        try { startBattleMusic(3); } catch {}

        bossLast = 0;
        bossRaf = requestAnimationFrame(bossLoop);
      }

      function stopBossFight(){
        bossGame.running = false;
        if (bossRaf) cancelAnimationFrame(bossRaf);
        bossRaf = null;
        try { stopBattleMusic(); } catch {}
        document.body.classList.remove("boss-mode");
      }

      function winBossFight(){
        stopBossFight();

        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = `
          <div class="text-slate-800/80">
            <div class="text-3xl font-extrabold">MAGALOR DEFEATED üíò</div>
            <div class="text-sm font-semibold mt-2">Unlocked! Now click <b>YES</b> üò§üíû</div>
          </div>
        `;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Rematch (optional)";

        bossMsg.textContent = "Unlocked! NO is now available‚Ä¶ but that‚Äôs not very romance-coded üòå";
        unlockNoButton();

        try { confetti({ particleCount: 220, spread: 85, origin: { y: 0.6 } }); } catch {}
        try {
          yesBtn.animate(
            [{ transform: "scale(1)" }, { transform: "scale(1.12)" }, { transform: "scale(1)" }],
            { duration: 700, iterations: 3 }
          );
        } catch {}
      }

      function loseBossFight(){
        stopBossFight();

        bossOverlay.style.opacity = "1";
        bossOverlay.innerHTML = `
          <div class="text-slate-800/80">
            <div class="text-3xl font-extrabold">You got bonked üí•</div>
            <div class="text-sm font-semibold mt-2">Try again‚Ä¶ turn chaos into cuddles üò§</div>
          </div>
        `;

        bossStartBtn.style.opacity = "1";
        bossStartBtn.style.pointerEvents = "auto";
        bossStartBtn.textContent = "Try Again";
        bossMsg.textContent = "Tip: Move in circles while shooting!";
      }

      bossStartBtn.addEventListener("click", startBossFight);
      resetBossFight();

      // ================== PLATFORMER ==================
      const platCanvas = document.getElementById("platCanvas");
      const platCtx = platCanvas.getContext("2d");
      const platStartBtn = document.getElementById("platStart");
      const platOverlay = document.getElementById("platOverlay");
      const platMsg = document.getElementById("platMsg");
      const platCountEl = document.getElementById("platCount");

      let platRaf = null;
      let platLast = 0;

      fitCanvasToCSS(platCanvas, platCtx);
      window.addEventListener("resize", () => fitCanvasToCSS(platCanvas, platCtx));

      const platGame = {
        running: false,
        heartsTarget: 7,
        heartsGot: 0,
        camX: 0,
        levelW: 1500,
        gravity: 0.55,
        player: { x: 60, y: 160, w: 18, h: 22, vx: 0, vy: 0, onGround: false },
        platforms: [],
        hearts: [],
        goal: { x: 1420, y: 140, w: 24, h: 24 }
      };

      function resetPlatformer(){
        platGame.running = false;
        platGame.heartsGot = 0;
        platCountEl.textContent = "0";
        platMsg.innerHTML = `Collect <b>${platGame.heartsTarget}</b> hearts üíñ and touch the <b>love letter</b> üíå.`;
        platOverlay.style.opacity = "1";
        platStartBtn.style.opacity = "1";
        platStartBtn.style.pointerEvents = "auto";
        platStartBtn.textContent = "Start Platformer";

        platGame.player.x = 60;
        platGame.player.y = 160;
        platGame.player.vx = 0;
        platGame.player.vy = 0;
        platGame.player.onGround = false;
        platGame.camX = 0;

        // Platforms (simple cute level)
        platGame.platforms = [
          { x: 0,   y: 220, w: 420, h: 22 },
          { x: 460, y: 195, w: 170, h: 18 },
          { x: 680, y: 170, w: 160, h: 18 },
          { x: 890, y: 205, w: 190, h: 18 },
          { x: 1120,y: 170, w: 200, h: 18 },
          { x: 1360,y: 210, w: 160, h: 18 },
          { x: 0,   y: 260, w: 1500, h: 40 }, // ground underlay
        ];

        // Hearts
        platGame.hearts = [
          { x: 140, y: 180, taken: false },
          { x: 320, y: 170, taken: false },
          { x: 520, y: 150, taken: false },
          { x: 730, y: 125, taken: false },
          { x: 940, y: 160, taken: false },
          { x: 1180,y: 125, taken: false },
          { x: 1370,y: 165, taken: false },
        ];
      }

      function rectsOverlap(a, b){
        return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
      }

      function updatePlatformer(){
        const w = platCanvas.getBoundingClientRect().width;
        const h = platCanvas.getBoundingClientRect().height;

        // movement
        const left = keys.has("ArrowLeft") || keys.has("a");
        const right = keys.has("ArrowRight") || keys.has("d");
        const jump = keys.has("ArrowUp") || keys.has("w") || keys.has(" ");

        const p = platGame.player;
        const accel = 0.55;
        const maxV = 4.2;
        const friction = 0.82;

        if (left) p.vx -= accel;
        if (right) p.vx += accel;
        if (!left && !right) p.vx *= friction;
        p.vx = clamp(p.vx, -maxV, maxV);

        if (jump && p.onGround){
          p.vy = -9.3;
          p.onGround = false;
        }

        // gravity
        p.vy += platGame.gravity;
        p.vy = clamp(p.vy, -20, 12);

        // integrate
        p.x += p.vx;
        p.y += p.vy;

        // bounds
        p.x = clamp(p.x, 0, platGame.levelW - p.w);
        if (p.y > 340) { p.y = 120; p.vy = 0; } // fall reset

        // collisions with platforms
        p.onGround = false;
        for (const plat of platGame.platforms){
          const a = { x: p.x, y: p.y, w: p.w, h: p.h };
          const b = { x: plat.x, y: plat.y, w: plat.w, h: plat.h };
          if (rectsOverlap(a,b)){
            // resolve from top mostly (platformer feel)
            if (p.vy > 0 && (p.y + p.h - p.vy) <= plat.y + 2){
              p.y = plat.y - p.h;
              p.vy = 0;
              p.onGround = true;
            } else if (p.vy < 0 && (p.y - p.vy) >= plat.y + plat.h - 2){
              p.y = plat.y + plat.h;
              p.vy = 0;
            }
          }
        }

        // collect hearts
        for (const heart of platGame.hearts){
          if (heart.taken) continue;
          const hb = { x: heart.x - 8, y: heart.y - 8, w: 16, h: 16 };
          const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
          if (rectsOverlap(pb, hb)){
            heart.taken = true;
            platGame.heartsGot += 1;
            platCountEl.textContent = String(platGame.heartsGot);
            try { confetti({ particleCount: 60, spread: 55, origin: { y: 0.7 } }); } catch {}
            platMsg.innerHTML = `Aww üíñ ${platGame.heartsGot}/${platGame.heartsTarget} collected!`;
          }
        }

        // camera follows
        platGame.camX = clamp(p.x - w*0.35, 0, platGame.levelW - w);

        // win condition
        const goal = platGame.goal;
        const pb = { x: p.x, y: p.y, w: p.w, h: p.h };
        const gb = { x: goal.x, y: goal.y, w: goal.w, h: goal.h };
        if (rectsOverlap(pb, gb) && platGame.heartsGot >= platGame.heartsTarget){
          winPlatformer();
        } else if (rectsOverlap(pb, gb) && platGame.heartsGot < platGame.heartsTarget){
          platMsg.innerHTML = `You found the üíå‚Ä¶ but it needs more hearts! (${platGame.heartsGot}/${platGame.heartsTarget})`;
        }
      }

      function drawPlatformer(){
        const w = platCanvas.getBoundingClientRect().width;
        const h = platCanvas.getBoundingClientRect().height;
        platCtx.clearRect(0,0,w,h);

        // background gradient
        const g = platCtx.createLinearGradient(0,0,0,h);
        g.addColorStop(0, "rgba(255, 192, 203, 0.20)");
        g.addColorStop(1, "rgba(173, 216, 230, 0.22)");
        platCtx.fillStyle = g;
        platCtx.fillRect(0,0,w,h);

        // tiny stars
        platCtx.globalAlpha = 0.18;
        for (let i=0;i<18;i++){
          const sx = (i*97 + 40) % 700;
          const sy = (i*41 + 18) % 180;
          platCtx.fillText("‚ú®", sx, sy);
        }
        platCtx.globalAlpha = 1;

        const cam = platGame.camX;
        platCtx.save();
        platCtx.translate(-cam, 0);

        // platforms
        for (const plat of platGame.platforms){
          platCtx.globalAlpha = 0.95;
          platCtx.fillStyle = "#ffffff";
          platCtx.strokeStyle = "rgba(15, 23, 42, 0.15)";
          platCtx.lineWidth = 2;
          roundRectPath(platCtx, plat.x, plat.y, plat.w, plat.h, 12);
          platCtx.fill();
          platCtx.stroke();

          // candy stripe
          platCtx.globalAlpha = 0.16;
          platCtx.fillStyle = "#fb7185";
          for (let x=plat.x+10; x<plat.x+plat.w-10; x+=22){
            roundRectPath(platCtx, x, plat.y+6, 10, plat.h-12, 6);
            platCtx.fill();
          }
          platCtx.globalAlpha = 1;
        }

        // hearts
        for (const heart of platGame.hearts){
          if (heart.taken) continue;
          platCtx.font = "18px system-ui, Apple Color Emoji, Segoe UI Emoji";
          platCtx.fillText("üíñ", heart.x - 8, heart.y + 6);
        }

        // goal letter
        platCtx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
        platCtx.fillText("üíå", platGame.goal.x - 4, platGame.goal.y + 20);

        // player (cute)
        const p = platGame.player;
        platCtx.save();
        platCtx.translate(p.x + p.w/2, p.y + p.h/2);
        platCtx.fillStyle = "#ef4444";
        drawHeartShape(platCtx, 0, 2, 14);
        platCtx.fill();
        platCtx.restore();

        platCtx.restore();
      }

      function platformerLoop(ts){
        if (!platGame.running) return;
        if (!platLast) platLast = ts;
        const dt = Math.min(0.033, (ts - platLast) / 1000);
        platLast = ts;

        // use dt lightly (physics are frame-ish)
        for (let i=0;i<Math.max(1, Math.floor(dt/0.016)); i++){
          updatePlatformer();
        }
        drawPlatformer();
        platRaf = requestAnimationFrame(platformerLoop);
      }

      function startPlatformer(){
        // stop boss fight if running
        stopBossFight();

        resetPlatformer();
        platGame.running = true;

        platOverlay.style.opacity = "0";
        platStartBtn.style.opacity = "0";
        platStartBtn.style.pointerEvents = "none";
        platMsg.innerHTML = `Go go go üíû Collect ${platGame.heartsTarget} hearts!`;

        platLast = 0;
        platRaf = requestAnimationFrame(platformerLoop);
      }

      function stopPlatformer(showOverlay = true){
        platGame.running = false;
        if (platRaf) cancelAnimationFrame(platRaf);
        platRaf = null;
        if (showOverlay){
          platOverlay.style.opacity = "1";
          platStartBtn.style.opacity = "1";
          platStartBtn.style.pointerEvents = "auto";
        }
      }

      function winPlatformer(){
        stopPlatformer(false);
        platOverlay.style.opacity = "1";
        platOverlay.innerHTML = `
          <div class="text-slate-800/80">
            <div class="text-3xl font-extrabold">LOVE QUEST COMPLETE üíå</div>
            <div class="text-sm font-semibold mt-2">Okay‚Ä¶ that was adorable. Now go click <b>YES</b> üíû</div>
          </div>
        `;
        platStartBtn.style.opacity = "1";
        platStartBtn.style.pointerEvents = "auto";
        platStartBtn.textContent = "Play Again";
        platMsg.innerHTML = `Awwww üíñ You did it!`;
        try { confetti({ particleCount: 180, spread: 90, origin: { y: 0.65 } }); } catch {}
        try {
          yesBtn.animate(
            [{ transform: "scale(1)" }, { transform: "scale(1.12)" }, { transform: "scale(1)" }],
            { duration: 700, iterations: 2 }
          );
        } catch {}
      }

      platStartBtn.addEventListener("click", startPlatformer);
      resetPlatformer();

      // ------------------ YES / NO click handlers ------------------
      yesBtn.addEventListener("click", () => {
        document.getElementById("letsGo")?.classList.add("show");

        stopBattleMusic();
        document.body.classList.remove("boss-mode");

        setImageTry(GIFS.yesMain, "YES GIF failed to load.");
        hint.textContent = "You are now my Valentine FOREVER...er I mean um, for uh 2026! üíô";
        noBtn.style.display = "none";

        playGlueSong();
        confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } });

        if (yesFinalTimer) clearTimeout(yesFinalTimer);
        yesFinalTimer = setTimeout(() => {
          setImageTry(GIFS.yesFinal, "Final Eevee GIF failed to load.");
        }, 2000);
      });

      noBtn.addEventListener("click", () => {
        if (noLocked) {
          hint.textContent = "NO is locked üòà Defeat MAGALOR first!";
          try {
            noBtn.animate(
              [
                { transform: "scale(1)" },
                { transform: "scale(1.08) rotate(-6deg)" },
                { transform: "scale(1.08) rotate(6deg)" },
                { transform: "scale(1)" },
              ],
              { duration: 320, iterations: 1 }
            );
          } catch {}
          return;
        }

        setImageTry(GIFS.no, "NO GIF failed to load.");
        hint.textContent = "No (Are you sure about that?) üò≥";

        noScale *= 1.35;
        noDodges += 1;

        startBattleMusic(noDodges);
        updateBattleIntensity(noDodges);

        const capped = Math.min(noScale, 4.5);
        noBtn.animate(
          [
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(0deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(-7deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(7deg)` },
            { transform: `translate(${noBtn.dataset.tx || 0}px, ${noBtn.dataset.ty || 0}px) scale(${capped}) rotate(0deg)` },
          ],
          { duration: 220, iterations: 1 }
        );
        applyNoTransform();
      });
    </script>
  </body>
</html>
